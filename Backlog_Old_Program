
REPORT  zrsd0028b  MESSAGE-ID 00 NO STANDARD PAGE HEADING
                  LINE-SIZE 132
                  LINE-COUNT 65.
TYPE-POOLS: slis.
INCLUDE <icon>.
INCLUDE <symbol>.


*Table delcear.
TABLES: vbak, "Sales Document: Header Data
        vbap, "Sales Document: Item Data
        vbep, "Sales Document: Schedule Line Data
        v_vbup_cds, "Sales Document: Item Status
        v_vbuk_cds, "Sales Document: Header Status and Administrative Data
        vbfa, "Sales Document Flow
        vbpa, "Sales Document: Partner
        cvi_cust_ct_link, "Connec. Between Relationship + Activity Partner for Customer
        v_contact, "Customer Master Contact Person
        mara, "material master
        marc, "Plant Data for Material
        mard, "Storage Location Data for Material
        mvke,
        ekko, "Purchasing Document Header
        ekpo, "Purchasing Document: Item data
        eket, "Scheduling Agreement Schedule Lines
        ekbe, "History per Purchasing Document
        ekpv, "Shipping Data For Stock Transfer of PO doc. Item
        knvp, "Customer Master Partner Functions
        knvv, "Customer data sales document
        likp, "SD Document: Delivery Header Data
        lips, "SD Document: Delivery Item Data
        nast, "Message Status
        prodhs, "Structure of Product Hierarchy (T179)
        pa0002, "HR Master Record: Infotype 0002 (Personal Data)
        ztsd_30,
        ztsd_revise,
        t001,   "Company Codes
        t001w,  "Plants/Branches
        t001k,  "Valuation area
        t179,  "Materials: Product Hierarchies
        kna1,
        vbkd,   "bussiness data.
***Add By Hermit 2005/07/11,8/4
        tvkol,  "Main storage condition table.
        caufv,
        tvak,  "Sales Document type
        tvro,   "Route transit day
        cdhdr,
        cdpos,
        t024w,
* add by poki 20060713
        ztpp_25,
**Add By Hermit 2008/01/10
        v_konv_cds,
        adrc,
        adr6,
        stxh,  "Order Text
        ztpp_45,
        ztmm_127,
        ztmm_44,
        ztmm_45,  " Xuan.Kao 20151217 MPN
        ztmm_46,  " Xuan.Kao 20151217 MPN
        t024,     " Xuan.Kao 20150212 Material's Purchasing Group on Sales
        t002,     " Xuan.Kao 20150720 SO Head Sales note from customer
        knb1,
        ztpp_05,ztco_zbco551.  " rong 20190814 add


**********  add by Ted.Tsao begin, 2008/11/26 ****************

DATA: BEGIN OF tvbep OCCURS 0 ,
        vbeln LIKE vbep-vbeln,
        posnr LIKE vbep-posnr,
        bmeng LIKE vbep-bmeng,
      END OF tvbep.

DATA: BEGIN OF qtime    OCCURS 0,
        xdesc(20),
        xdate(20),
        xtime(10),
      END OF qtime.

DATA: p_1st(8),
      should1(3).
RANGES: r_soso   FOR  vbap-vbeln,
        r_zsrv   FOR  mara-mtart,
        datetmp  FOR  vbep-edatu.

DATA: BEGIN OF exceptso   OCCURS 0 ,
        vbeln LIKE vbap-vbeln,
        posnr LIKE vbap-posnr,
      END OF exceptso.


DATA  newold(03).
DATA  tmpchr(03).
DATA  tmpf2(08).
DATA  tmpf3(08).
DATA: eof1(05),
      eof2(05),
      eof3(05),
      eof4(05),
      eof5(05),
      eof6(05),
      match_flag,
      exit_while,
      index1     TYPE i,
      index2     TYPE i,
      index3     TYPE i,
      index4     TYPE i,
      index5     TYPE i,
      index6     TYPE i,
      j1         TYPE i,
      j2         TYPE i,
      j3         TYPE i,
      j4         TYPE i,
      first_rec  LIKE sy-tabix,
      last_index LIKE sy-tabix.

DATA: u_file  LIKE rlgrap-filename.
**********  add by Ted.Tsao end ****************
*declear internal table
DATA: BEGIN OF i1 ,                                         "OCCURS 0,
        seqno(10)         TYPE n,
        mtart             LIKE mara-mtart,  "material type
        bismt             LIKE mara-bismt,  "Old material number
        mstav             LIKE mara-mstav,  "Cross-distribution-chain material status
        sobsl             LIKE marc-sobsl,  "Special procurement
        plifz             LIKE marc-plifz,  "plant delivery LT time
        ladgr             LIKE marc-ladgr, " loading group
        sortl             LIKE kna1-sortl,
        brsch             LIKE kna1-brsch,   " Industry key
        vbeln             LIKE vbak-vbeln,  "sales order

        ernam             LIKE vbak-ernam,  "Name of Person who Created the Object
        auart             LIKE vbak-auart,  "Sales Document Type
        bstnk             LIKE vbkd-bstkd,  "Po number
        bstdk             LIKE vbkd-bstdk,  " Xuan.Kao 20190910 Customer PO Date
        vkorg             LIKE vbak-vkorg,  "Sales Organization
        vbtyp             LIKE vbak-vbtyp,   "SD document category
        kunnr             LIKE vbak-kunnr,  "SOLD-TO PARTY
        shipto            LIKE vbak-kunnr,  " ship to party
        billto            LIKE vbak-kunnr,  " bill to party
        endcust           LIKE vbak-kunnr,  "End Customer
        "---20251118 HW Add Parcel Shippment Info
        zzcarr            LIKE vbak-zzcarr, "Carrier
        zzcarr_type       LIKE vbak-zzcarr_type, "Carrier Type
        zzcoll            LIKE vbak-zzcoll, "Collect
        zzpayer           LIKE vbak-zzpayer, "Payer
        zzcharge          LIKE vbak-zzcharge, "Custom Charge
        zzinsurance       LIKE vbak-zzinsurance, "Insurance
        zzpdetail         LIKE vbak-zzpdetail, "Inovice Print Detail
        zzcolshpact       LIKE vbak-zzcolshpact, "Collect Shipping Acc
        "---
        adrnr             LIKE vbpa-adrnr,   "address
****Add By Hermit 2005/11/17 for EU request
        soldtonm          LIKE kna1-name1, "sold-to name
        shiptonm          LIKE kna1-name1, "Ship to
        billtonm          LIKE kna1-name1, "Bill to name
        endcustnm         LIKE kna1-name1, "End Customer name
        vkbur             LIKE vbak-vkbur,  "Sales Office
        vkgrp             LIKE vbak-vkgrp,  "Sales Group
        audat             LIKE vbak-audat,  "Document date
        vsbed             LIKE vbak-vsbed,   "Shipping conditions
        ship_desc(20)     TYPE c,    " shipping description
        posnr             LIKE vbap-posnr,  "Sales Document Item
        uepos             LIKE vbap-uepos,  "Higher-level item
        pstyv             LIKE vbap-pstyv,  "Sales document item category
        matnr             LIKE vbap-matnr,  "Material
        prodh             LIKE vbap-prodh,  " Product hierarchy
        prodh2            LIKE prodhs-prodh2,
        prodh3            LIKE prodhs-prodh3,
        netwr             LIKE vbap-netwr, "Net value of Document currency
        waerk             LIKE vbap-waerk,  "SD document currency
        kdmat             LIKE vbap-kdmat,  " CPN
        kwmeng            LIKE vbap-kwmeng, "order quantity in sales units
        kbmeng            LIKE vbap-kbmeng, "confirmed quantity in sales unit
        vrkme             LIKE vbap-vrkme,  "Sales unit
        posnv             LIKE vbap-posnv,  "Originating item
        werks             LIKE vbap-werks,  "Plant
        lgort             LIKE vbap-lgort,  "Storage location
**  Add By Hermit 2005/07/09
        erdat             LIKE vbap-erdat,   "create date
        splant            LIKE vbap-werks,  "Delv Plant
        slgort            LIKE mard-lgort,  "TWMX Stor loc
        slgpbe            LIKE mard-lgpbe,  "BIN
        unconfqty         LIKE vbep-bmeng, "Unconfirmed qty
        schline           LIKE vbep-etenr, "schedule line
        schqty            LIKE vbap-kbmeng, "sched qty
        opendn            LIKE vbap-kbmeng, "open D/N
        dnqty             LIKE vbap-kbmeng,  "Sch D/N
        adnqty            LIKE vbap-kbmeng,  "already D/N
        odnamt            LIKE vbap-netwr,  "Sch D/N amount
        adnamt            LIKE vbap-netwr,  "already D/N amount
        ondockdt          LIKE vbap-erdat, "on-dock date
        uncnfamt          LIKE vbap-netwr, "unconf amount
        erzet             LIKE vbak-erzet, "Entry time
** End of Hermit
*      netpr  LIKE vbap-netpr,  "net price
** chris 20121017
*      netpr  LIKE T8JVB52-EXRATE15, "net price
        netpr(16)         TYPE p DECIMALS 5,
        opamt             LIKE vbap-netwr,
        kzwi2             LIKE vbap-kzwi2,  " Subtotal 2 from pricing
        kpein             LIKE vbap-kpein,  "Condition pricing unit

        route             LIKE vbap-route,  "Route
*     ABGRU  LIKE vbap-ABGRU,  "Reason for rejection of sales orders
        dnamt             LIKE vbap-netwr,  "DN Amount
        lfsta             LIKE vbup-lfsta,  "delivery status
        fksta             LIKE vbup-fksta,  "billing status
        absta             LIKE vbup-absta,  "rejection status
        wbsta             LIKE vbup-wbsta,  "Goods movement status
        kosta             LIKE vbup-kosta,  "PICKING
        status            LIKE vbup-fksta,
        cmgst             LIKE vbuk-cmgst,  "credit block.
        dncmgst           LIKE vbuk-cmgst, "DN credit block

        bzirk             LIKE vbkd-bzirk,  " Sales district
        sdabw             LIKE vbkd-sdabw,  "Special processing indicator
        inco1             LIKE vbkd-inco1,  "Incoterms code
        inco2             LIKE vbkd-inco2,  "Incoterms description

        edatu             LIKE vbep-edatu,  "delivery date
        redatu            LIKE vbep-edatu,  "Request date
        blogdt            LIKE vbep-edatu,  "backlog date
        oedatu            LIKE vbep-edatu,  "Order date
        cedatu            LIKE vbep-edatu,  "confirm date
        wmeng             LIKE vbep-wmeng,  "Order quantity in sales units
        bmeng             LIKE vbep-bmeng,  "Confirmed quantity
        lifsk             LIKE vbak-lifsk,
        wemng             LIKE eket-wemng,
        eindt             LIKE eket-eindt,  "delivery date for sto
        slfdt             LIKE eket-slfdt,  "DTO static del date
        dat01             LIKE eket-dat01,  "commited date
        mbdat             LIKE eket-mbdat,  "Material availability date
        menge             LIKE eket-menge,  "Scheduled quantity

        labst             LIKE mard-labst,  "Valuated stock with unrestricted use

        dvbeln            LIKE likp-vbeln,
        lfimg             LIKE lips-lfimg,
        sname(40),
        pernr             LIKE vbpa-pernr,
        isname(40),                                         "090303
        ipernr            LIKE vbpa-pernr,                  "090303
*      z1name(40),
*      z1pernr LIKE vbpa-pernr,
        z2name(40),
        z2pernr           LIKE vbpa-pernr,
        z3name(40),
        z3pernr           LIKE vbpa-pernr,
        zaname(40),
        zapernr           LIKE vbpa-pernr,
        zbname(40),
        zbpernr           LIKE vbpa-pernr,
        apparnr           LIKE vbpa-parnr,            " Contact Person
        apname(40),                                " Contact Person
        katr8             LIKE kna1-katr8,
        katr9             LIKE kna1-katr9,            " Xuan.Kao 20160215 SO Head Attribute 9
*      z3name(40),
*      z3pernr LIKE vbpa-pernr,
*      z4name(40),
*      z4pernr LIKE vbpa-pernr,

        vstat             LIKE nast-vstat,
*    ortyp(4),
        ebeln             LIKE ekko-ebeln,  "stock transfer order number
        ebelp             LIKE ekpo-ebelp,  "stock transfer order item
        bukrs             LIKE ekko-bukrs,  " company code
        bstyp             LIKE ekko-bstyp,  "Purchasing document category
        bsart             LIKE ekko-bsart,  "Purchasing Document Type
        lifnr             LIKE ekko-lifnr,  "VENDOR FOR STO TO GET SALES PERSON
        waers             LIKE ekko-waers,  "PO currency
        reswk             LIKE ekko-reswk,  "Supplying (issuing) plan
        otype(4),                "Order Type(SO&STO)
        pstyp             LIKE ekpo-pstyp,  "po item category
        meins             LIKE ekpo-meins,  "order unit for sto
        peinh             LIKE ekpo-peinh,  " price unit.
*     bstkd  LIKE vbkd-bstkd,  "Customer PO
        elikz             LIKE ekpo-elikz,  "PO delivery completed
        wepos             LIKE ekpo-wepos,  "Goods Receipt Indicator
        erekz             LIKE ekpo-erekz,  "Final invoice indicator
        zterm             LIKE knvv-zterm,  " payment term
        stprs             LIKE mbew-stprs,  " cost of the item.
        stwaers           LIKE t001-waers, " cost currency
        sosto             TYPE c,
*** Add By hermit 2005/11/03 for EU request
        empid             LIKE pa0002-pernr, "Employee ID
        vorna             LIKE pa0002-vorna, "first name
        nachn             LIKE pa0002-nachn, "last name
** Add By Hermit 2005/11/22 for STO create date
        aedat             LIKE ekko-aedat,
        vmsta             LIKE mvke-vmsta,
** Add By Hermit 2006/03/31
        firstdelv         LIKE ekko-aedat,  "STO first delv date
        firstmatv         LIKE ekko-aedat,  "STO first material available date
        create_date       LIKE ekpo-create_date,
        create_time       LIKE ekpo-create_time,
        ean11             LIKE ekpo-ean11,
        ambdat            LIKE eket-mbdat,  "Actual Material availability date
        availqty          LIKE vbap-kbmeng, "QOH - all DN QTY
* add by poki 20060713
        odtxt(255)        TYPE c,  "Order text
        maabc             LIKE marc-maabc,
        eisbe             LIKE marc-eisbe,
* add by hermit 2006/11/20
        itemtxt(255)      TYPE c, "Item text
        f04txt(255)       TYPE c,          " Xuan.Kao 20231220 STO Item Delivery text
        ekorg             LIKE ekko-ekorg, "purchasing org
        smmsta            LIKE marc-mmsta,  "Supply plant status
        slabst            LIKE mard-labst,  "Supply plant  with unrestricted use
** Add By Hermit 20070330
        lifsp             LIKE vbep-lifsp,
        zz_abgru          LIKE vbap-zz_abgru,
** Add by Hermit 20070508
        afnam             LIKE ekpo-afnam,
        zz_first          LIKE ekpo-zz_first,
        zz_mbdat          LIKE ekpo-zz_mbdat,
        zz_edatu          LIKE vbap-zz_edatu,
        commit_date       LIKE ekpo-commit_date,
        commit_date1      LIKE ekpo-commit_date1,
        zz_reason         LIKE vbap-zz_reason,
        zz_reason_text    LIKE vbap-zz_reason_text,
        zz_abgru_text     LIKE vbap-zz_abgru_text,
        zbuffer           LIKE ztpp_25-zbuffer,
        zpi01             LIKE vbap-netwr,  "Add Intercompany SO price
        zpi01amt          LIKE vbap-netwr, "Intercompany SO price
        katr4             LIKE kna1-katr4,

        kbetr             LIKE  konv-kbetr ,  " for PB00 price sto
        kpein1            LIKE  konv-kpein ,                              " PB00 Unit
        bstkd             LIKE vbkd-bstkd,                  "20081215
        bstkd_e           LIKE vbkd-bstkd_e,                "20090819
        ihrez_e           LIKE vbkd-ihrez_e,                "20090819
        zso_text          TYPE tline-tdline,
* TOM 2010/11/29
*    g_LABST  type mard-labst,
*    g_cykc  type mard-labst,
* Chris 2011/02/01
        smtp_addr         TYPE adr6-smtp_addr,
* Chris 2011/06/14
        vdatu             LIKE vbak-vdatu,
        zzkatr11          LIKE vbak-zzkatr11,
* Add By Chris 20111213
        arktx             LIKE vbap-arktx,
*Add By Hermit 20120131
        prdplant          LIKE marc-werks,
*chris 20120504
        blatt             LIKE mara-blatt,
        zz_zdatu          LIKE vbap-zz_zdatu,
*chirs 20120716
        zz_sdatu          LIKE vbap-zz_sdatu,
        vsnmr_v           LIKE vbak-vsnmr_v,
        eaipd             LIKE ztpp_45-eaipd,
        eaipg             LIKE ztpp_45-eaipg,
*donald 20120808
        zrname(40),                "Key-in Person
        zrpernr           LIKE vbpa-pernr,
*chris 20120821
        matnr_old         LIKE ztmm_127-matnr_old, " ADS old material
*chris 20120830
        ekgrp             LIKE ekko-ekgrp,
        ekgrp_desc        LIKE t024-eknam,           " Xuan.Kao 20211118 Purchasing Group Name For STO
*chris 20121024
        frgke             LIKE ekko-frgke,
*chris 20130206
        zprdplc           LIKE ztmm_44-zprdplc,
        zmaktx            LIKE ztmm_44-maktx,            " Xuan.Kao 20151217 Material Description(Chinese)
        ztrademark        LIKE ztmm_44-ztrademark,   " Xuan.Kao 20151217 Brand
        ematn             LIKE ztmm_45-ematn,             " Xuan.Kao 20151217 MPN
*chris 20140703 KNB1-EKVBD
        zekvbd            LIKE knb1-ekvbd,
*donald 20141028
        reprate(8)        TYPE c,
        zexternal_note    LIKE zssd_dn-z_note,       "Ticket 11889 " Xuan.Kao 20220830 Debug External Note Length
        sekgrp            LIKE marc-ekgrp,                 " Xuan.Kao 20150212 Material's Purchasing Group on Sales
        sekgrp_desc       LIKE t024-eknam,            " Xuan.Kao 20150212 Material's Purchasing Group on Sales
        psobsl            LIKE marc-sobsl,                 " Xuan.Kao 20150506 Material's Special procurement in Demand Plant
        zzcaps            LIKE mara-zzcaps,                " Xuan.Kao 20160329 Material CAPS indicator
        subsector         LIKE ztsd_123a-subsector,     " Xuan.Kao 20160608 Sub-Sector
        vgbel             LIKE vbap-vgbel,                  " Xuan.Kao 20160628 Reference doc.
        erdat_qt          LIKE vbak-erdat,               " Xuan.Kao 20160628 Quotation Create Date
        kodat             LIKE likp-kodat,                  " Xuan.Kao 20160628 DN Picking Date
        wadat             LIKE likp-wadat,                  " Xuan.Kao 20160628 DN Planned GI Date
        wadat_ist         LIKE likp-wadat_ist,          " Xuan.Kao 20160628 DN Actual GI Date
        salesnote         LIKE zssd_dn-z_note,          " Xuan.Kao 20150720 SO Head Sales note from customer
        shipinstr         LIKE zssd_dn-z_note,          " Timo.Rusnjak 20210414 SO Head Shipping Instruction
        forwserv          LIKE zssd_dn-z_note,           " Timo.Rusnjak 20210715 SO Head Forwarder Service
        kondm             LIKE vbap-kondm,                  " Xuan.Kao 20161222 Material Pricing Group
        sh_adrnr          LIKE vbpa-adrnr,                  " Xuan.Kao 20211108 Ship to Party Address Code
        verpr             TYPE p DECIMALS 5,                " Xuan.Kao 20181219 SO GP view
        currentgptxt      LIKE zssd_gp-currentgptxt, " Xuan.Kao 20181219 SO GP view
**donald 20141028
        gp                LIKE vbrp-netwr,
        autlf             LIKE vbak-autlf,
        buff(1),                              " 20180123 buffer order indicator
*add by rong 20181002, Requirement from Sylvia
        country_ship      LIKE adrc-country,
        city_ship         LIKE adrc-city1,
        region_ship       LIKE adrc-region,
        post_ship         LIKE adrc-post_code1,
        street_ship       LIKE adrc-street,
**add by rong 20181113, Delivery block description
        vtext             LIKE tvlst-vtext,
        od_block(20),
        ddtext            LIKE dd07t-ddtext,  "delay reason code descipition
        abgrux_text       LIKE dd07t-ddtext,  "Imperfect reason code descripirion
**add by rong 20190115, customer country, states
        stock_qty         LIKE mard-labst,
        avai_qty          LIKE mard-labst,
        land1             LIKE kna1-land1,
        regio             LIKE kna1-regio,
        first_date        LIKE vbep-bddat,
**add by rong 20190404, fields from ZRSD1440
        action_by         LIKE ztsd_tracking_01-action_by,
        name_action       LIKE pa0001-ename,
        zreason           LIKE ztsd_tracking_01-zreason,
        zreason_text      LIKE ztsd_tracking_02-zreason_text,
        zcomm_id          LIKE ztsd_tracking_01-zcomm_id,
        zcomm_text        LIKE ztsd_tracking_03-zcomm_text,
        zhold             LIKE ztsd_tracking_01-zhold,
        datab             LIKE ztsd_tracking_01-datab,
        d_audat           LIKE vbak-audat,
        pernr_zv          LIKE vbpa-pernr,
        zvname(40),
        prdnote           LIKE zssd_dn-z_note,              " 20200225
**add by rong 20200326, add fields Contact email 1~3
        eaddress1         LIKE pa0105-usrid_long,
        eaddress2         LIKE pa0105-usrid_long,
        eaddress3         LIKE pa0105-usrid_long,
        zz_cdatu          LIKE vbap-zz_cdatu,               " 20200525
**add by rong 20201218
        vtweg             LIKE vbak-vtweg,
        spart             LIKE vbak-spart,
        wamng             LIKE eket-wamng,            "double add on 20230208 DN POSTING QTY
        wostatus(10),
        mvgr2             LIKE mvke-mvgr2,
**add by rong 20240819  get data reference zrsdgp06
        gpdate            LIKE sy-datlo,
        mingptxt(10),
        cost              TYPE netwr,
        currentgptxt2(10),
        dsnam             LIKE t024d-dsnam,   "double add on 20250308 spply plant mrp controller name eoa:1128521
        abtnr             LIKE vbkd-abtnr,                  "20250815
      END OF i1.
DATA: t_adr6 LIKE adr6 OCCURS 0 WITH HEADER LINE.
*To keep delivery when delivery more than 1
DATA: i2 LIKE i1 OCCURS 0 WITH HEADER LINE.
DATA: a1 LIKE i1 OCCURS 10 WITH HEADER LINE. "for alv using
**Add By Hermit 2005/07/25 for schedule line
DATA: i3 LIKE i1 OCCURS 0 WITH HEADER LINE.
DATA: BEGIN OF d1 OCCURS 0  ,
        vbeln          LIKE vbak-vbeln,  "sales order
        posnr          LIKE vbap-posnr,  "Sales Document Item
        matnr          LIKE vbap-matnr,  "Material
        kbmeng         LIKE vbap-kbmeng, "confirmed quantity in sales unit  "Unbilling Qty
        cedatu         LIKE vbep-edatu,  "confirm date
        netpr(16)      TYPE p DECIMALS 5, "Unit Price
        opamt          LIKE vbap-netwr,      "Unbilling Amount
        waerk          LIKE vbap-waerk,  "SD document currency
        sobsl          LIKE marc-sobsl,  "Special procurement
********SGA

        seqno(10)      TYPE n,
        mtart          LIKE mara-mtart,  "material type
        bismt          LIKE mara-bismt,  "Old material number
        mstav          LIKE mara-mstav,  "Cross-distribution-chain material status

        plifz          LIKE marc-plifz,  "plant delivery LT time
        ladgr          LIKE marc-ladgr, " loading group
        sortl          LIKE kna1-sortl,
        brsch          LIKE kna1-brsch,   " Industry key


        ernam          LIKE vbak-ernam,  "Name of Person who Created the Object
        auart          LIKE vbak-auart,  "Sales Document Type
        bstnk          LIKE vbkd-bstkd,  "Po number
        bstdk          LIKE vbkd-bstdk,  " Xuan.Kao 20190910 Customer PO Date
        vkorg          LIKE vbak-vkorg,  "Sales Organization
        vbtyp          LIKE vbak-vbtyp,   "SD document category
        kunnr          LIKE vbak-kunnr,  "SOLD-TO PARTY
        shipto         LIKE vbak-kunnr,  " ship to party
        billto         LIKE vbak-kunnr,  " bill to party
        endcust        LIKE vbak-kunnr,  "End Customer
        adrnr          LIKE vbpa-adrnr,   "address
****Add By Hermit 2005/11/17 for EU request
        soldtonm       LIKE kna1-name1, "sold-to name
        shiptonm       LIKE kna1-name1, "Ship to
        billtonm       LIKE kna1-name1, "Bill to name
        endcustnm      LIKE kna1-name1, "End Customer name
        vkbur          LIKE vbak-vkbur,  "Sales Office
        vkgrp          LIKE vbak-vkgrp,  "Sales Group
        audat          LIKE vbak-audat,  "Document date
        vsbed          LIKE vbak-vsbed,   "Shipping conditions
        ship_desc(20)  TYPE c,    " shipping description

        uepos          LIKE vbap-uepos,  "Higher-level item
        pstyv          LIKE vbap-pstyv,  "Sales document item category

        prodh          LIKE vbap-prodh,  " Product hierarchy
        prodh2         LIKE prodhs-prodh2,
        prodh3         LIKE prodhs-prodh3,
        netwr          LIKE vbap-netwr, "Net value of Document currency

        kdmat          LIKE vbap-kdmat,  " CPN
        kwmeng         LIKE vbap-kwmeng, "order quantity in sales units

        vrkme          LIKE vbap-vrkme,  "Sales unit
        posnv          LIKE vbap-posnv,  "Originating item
        werks          LIKE vbap-werks,  "Plant
        lgort          LIKE vbap-lgort,  "Storage location
**  Add By Hermit 2005/07/09
        erdat          LIKE vbap-erdat,   "create date
        splant         LIKE vbap-werks,  "Delv Plant
        slgort         LIKE mard-lgort,  "TWMX Stor loc
        slgpbe         LIKE mard-lgpbe,  "BIN
        unconfqty      LIKE vbep-bmeng, "Unconfirmed qty
        schline        LIKE vbep-etenr, "schedule line
        schqty         LIKE vbap-kbmeng, "sched qty
        opendn         LIKE vbap-kbmeng, "open D/N
        dnqty          LIKE vbap-kbmeng,  "Sch D/N
        adnqty         LIKE vbap-kbmeng,  "already D/N
        odnamt         LIKE vbap-netwr,  "Sch D/N amount
        adnamt         LIKE vbap-netwr,  "already D/N amount
        ondockdt       LIKE vbap-erdat, "on-dock date
        uncnfamt       LIKE vbap-netwr, "unconf amount
        erzet          LIKE vbak-erzet, "Entry time
** End of Hermit
*      netpr  LIKE vbap-netpr,  "net price
** chris 20121017
*      netpr  LIKE T8JVB52-EXRATE15, "net price


        kzwi2          LIKE vbap-kzwi2,  " Subtotal 2 from pricing
        kpein          LIKE vbap-kpein,  "Condition pricing unit

        route          LIKE vbap-route,  "Route
*     ABGRU  LIKE vbap-ABGRU,  "Reason for rejection of sales orders
        dnamt          LIKE vbap-netwr,  "DN Amount
        lfsta          LIKE vbup-lfsta,  "delivery status
        fksta          LIKE vbup-fksta,  "billing status
        absta          LIKE vbup-absta,  "rejection status
        wbsta          LIKE vbup-wbsta,  "Goods movement status
        kosta          LIKE vbup-kosta,  "PICKING
        status         LIKE vbup-fksta,
        cmgst          LIKE vbuk-cmgst,  "credit block.
        dncmgst        LIKE vbuk-cmgst, "DN credit block

        bzirk          LIKE vbkd-bzirk,  " Sales district
        sdabw          LIKE vbkd-sdabw,  "Special processing indicator
        inco1          LIKE vbkd-inco1,  "Incoterms code
        inco2          LIKE vbkd-inco2,  "Incoterms description

        edatu          LIKE vbep-edatu,  "delivery date
        redatu         LIKE vbep-edatu,  "Request date
        blogdt         LIKE vbep-edatu,  "backlog date
        oedatu         LIKE vbep-edatu,  "Order date

        wmeng          LIKE vbep-wmeng,  "Order quantity in sales units
        bmeng          LIKE vbep-bmeng,  "Confirmed quantity
        lifsk          LIKE vbak-lifsk,
        wemng          LIKE eket-wemng,
        eindt          LIKE eket-eindt,  "delivery date for sto
        slfdt          LIKE eket-slfdt,  "DTO static del date
        dat01          LIKE eket-dat01,  "commited date
        mbdat          LIKE eket-mbdat,  "Material availability date
        menge          LIKE eket-menge,  "Scheduled quantity

        labst          LIKE mard-labst,  "Valuated stock with unrestricted use

        dvbeln         LIKE likp-vbeln,
        lfimg          LIKE lips-lfimg,
        sname(40),
        pernr          LIKE vbpa-pernr,
        isname(40),                                         "090303
        ipernr         LIKE vbpa-pernr,                     "090303
*      z1name(40),
*      z1pernr LIKE vbpa-pernr,
        z2name(40),
        z2pernr        LIKE vbpa-pernr,
        z3name(40),
        z3pernr        LIKE vbpa-pernr,
        zaname(40),
        zapernr        LIKE vbpa-pernr,
        zbname(40),
        zbpernr        LIKE vbpa-pernr,
        katr8          LIKE kna1-katr8,
        katr9          LIKE kna1-katr9,            " Xuan.Kao 20160215 SO Head Attribute 9
*      z3name(40),
*      z3pernr LIKE vbpa-pernr,
*      z4name(40),
*      z4pernr LIKE vbpa-pernr,

        vstat          LIKE nast-vstat,
*    ortyp(4),
        ebeln          LIKE ekko-ebeln,  "stock transfer order number
        ebelp          LIKE ekpo-ebelp,  "stock transfer order item
        bukrs          LIKE ekko-bukrs,  " company code
        bstyp          LIKE ekko-bstyp,  "Purchasing document category
        bsart          LIKE ekko-bsart,  "Purchasing Document Type
        lifnr          LIKE ekko-lifnr,  "VENDOR FOR STO TO GET SALES PERSON
        waers          LIKE ekko-waers,  "PO currency
        reswk          LIKE ekko-reswk,  "Supplying (issuing) plan
        otype(4),                "Order Type(SO&STO)
        pstyp          LIKE ekpo-pstyp,  "po item category
        meins          LIKE ekpo-meins,  "order unit for sto
        peinh          LIKE ekpo-peinh,  " price unit.
*     bstkd  LIKE vbkd-bstkd,  "Customer PO
        elikz          LIKE ekpo-elikz,  "PO delivery completed
        wepos          LIKE ekpo-wepos,  "Goods Receipt Indicator
        erekz          LIKE ekpo-erekz,  "Final invoice indicator
        zterm          LIKE knvv-zterm,  " payment term
        stprs          LIKE mbew-stprs,  " cost of the item.
        stwaers        LIKE t001-waers, " cost currency
        sosto          TYPE c,
*** Add By hermit 2005/11/03 for EU request
        empid          LIKE pa0002-pernr, "Employee ID
        vorna          LIKE pa0002-vorna, "first name
        nachn          LIKE pa0002-nachn, "last name
** Add By Hermit 2005/11/22 for STO create date
        aedat          LIKE ekko-aedat,
        vmsta          LIKE mvke-vmsta,
** Add By Hermit 2006/03/31
        firstdelv      LIKE ekko-aedat,  "STO first delv date
        firstmatv      LIKE ekko-aedat,  "STO first material available date
        create_date    LIKE ekpo-create_date,
        create_time    LIKE ekpo-create_time,
        ean11          LIKE ekpo-ean11,
        ambdat         LIKE eket-mbdat,  "Actual Material availability date
        availqty       LIKE vbap-kbmeng, "QOH - all DN QTY
* add by poki 20060713
        odtxt(255)     TYPE c,  "Order text
        maabc          LIKE marc-maabc,
        eisbe          LIKE marc-eisbe,
* add by hermit 2006/11/20
        itemtxt(255)   TYPE c, "Item text
        f04txt(255)    TYPE c,          " Xuan.Kao 20231220 STO Item Delivery text
        ekorg          LIKE ekko-ekorg, "purchasing org
        smmsta         LIKE marc-mmsta,  "Supply plant status
        slabst         LIKE mard-labst,  "Supply plant  with unrestricted use
** Add By Hermit 20070330
        lifsp          LIKE vbep-lifsp,
        zz_abgru       LIKE vbap-zz_abgru,
** Add by Hermit 20070508
        afnam          LIKE ekpo-afnam,
        zz_first       LIKE ekpo-zz_first,
        zz_mbdat       LIKE ekpo-zz_mbdat,
        zz_edatu       LIKE vbap-zz_edatu,
        commit_date    LIKE ekpo-commit_date,
        commit_date1   LIKE ekpo-commit_date1,
        zz_reason      LIKE vbap-zz_reason,
        zz_reason_text LIKE vbap-zz_reason_text,
        zz_abgru_text  LIKE vbap-zz_abgru_text,
        zbuffer        LIKE ztpp_25-zbuffer,
        zpi01          LIKE vbap-netwr,  "Add Intercompany SO price
        zpi01amt       LIKE vbap-netwr, "Intercompany SO price
        katr4          LIKE kna1-katr4,

        kbetr          LIKE  konv-kbetr ,  " for PB00 price sto
        kpein1         LIKE  konv-kpein ,                              " PB00 Unit
        bstkd          LIKE vbkd-bstkd,                     "20081215
        bstkd_e        LIKE vbkd-bstkd_e,                   "20090819
        ihrez_e        LIKE vbkd-ihrez_e,                   "20090819
        zso_text       TYPE tline-tdline,
* TOM 2010/11/29
*    g_LABST  type mard-labst,
*    g_cykc  type mard-labst,
* Chris 2011/02/01
        smtp_addr      TYPE adr6-smtp_addr,
* Chris 2011/06/14
        vdatu          LIKE vbak-vdatu,
        zzkatr11       LIKE vbak-zzkatr11,
* Add By Chris 20111213
        arktx          LIKE vbap-arktx,
*Add By Hermit 20120131
        prdplant       LIKE marc-werks,
*chris 20120504
        blatt          LIKE mara-blatt,
        zz_zdatu       LIKE vbap-zz_zdatu,
*chirs 20120716
        zz_sdatu       LIKE vbap-zz_sdatu,
        vsnmr_v        LIKE vbak-vsnmr_v,
        eaipd          LIKE ztpp_45-eaipd,
        eaipg          LIKE ztpp_45-eaipg,
*donald 20120808
        zrname(40),                "Key-in Person
        zrpernr        LIKE vbpa-pernr,
*chris 20120821
        matnr_old      LIKE ztmm_127-matnr_old, " ADS old material
*chris 20120830
        ekgrp          LIKE ekko-ekgrp,
        ekgrp_desc     LIKE t024-eknam,           " Xuan.Kao 20211118 Purchasing Group Name For STO
*chris 20121024
        frgke          LIKE ekko-frgke,
*chris 20130206
        zprdplc        LIKE ztmm_44-zprdplc,
        zmaktx         LIKE ztmm_44-maktx,            " Xuan.Kao 20151217 Material Description(Chinese)
        ztrademark     LIKE ztmm_44-ztrademark,   " Xuan.Kao 20151217 Brand
        ematn          LIKE ztmm_45-ematn,             " Xuan.Kao 20151217 MPN
*chris 20140703 KNB1-EKVBD
        zekvbd         LIKE knb1-ekvbd,
*donald 20141028
        reprate(8)     TYPE c,
        zexternal_note LIKE zssd_dn-z_note,       "Ticket 11889 " Xuan.Kao 20220830 Debug External Note Length
        sekgrp         LIKE marc-ekgrp,               " Xuan.Kao 20150212 Material's Purchasing Group on Sales
        sekgrp_desc    LIKE t024-eknam,          " Xuan.Kao 20150212 Material's Purchasing Group on Sales
        psobsl         LIKE marc-sobsl,               " Xuan.Kao 20150506 Material's Special procurement in Demand Plant
        zzcaps         LIKE mara-zzcaps,              " Xuan.Kao 20160329 Material CAPS indicator
        subsector      LIKE ztsd_123a-subsector,   " Xuan.Kao 20160608 Sub-Sector
        vgbel          LIKE vbap-vgbel,                " Xuan.Kao 20160628 Reference doc.
        erdat_qt       LIKE vbak-erdat,             " Xuan.Kao 20160628 Quotation Create Date
        kodat          LIKE likp-kodat,                " Xuan.Kao 20160628 DN Picking Date
        wadat          LIKE likp-wadat,                " Xuan.Kao 20160628 DN Planned GI Date
        wadat_ist      LIKE likp-wadat_ist,        " Xuan.Kao 20160628 DN Actual GI Date
        salesnote      LIKE zssd_dn-z_note,        " Xuan.Kao 20150720 SO Head Sales note from customer
        shipinstr      LIKE zssd_dn-z_note,        " Timo.Rusnjak 20210414 SO Head Shipping Instruction
        forwserv       LIKE zssd_dn-z_note,         " Timo.Rusnjak 20210715 SO Head Forwarder Service
        kondm          LIKE vbap-kondm,                " Xuan.Kao 20161222 Material Pricing Group
        sh_adrnr       LIKE vbpa-adrnr,                " Xuan.Kao 20211108 Ship to Party Address Code
**donald 20141028
        gp             LIKE vbrp-netwr,
        autlf          LIKE vbak-autlf,
        prdnote        LIKE zssd_dn-z_note,
        zz_cdatu       LIKE vbap-zz_cdatu,                  "20200525
      END OF d1.
**End of Add
*20210621
DATA: BEGIN OF d9 OCCURS 0  ,
        werks  LIKE vbap-werks,  "Delv Plant
        vkorg  LIKE vbak-vkorg,  "Sales Organization
        mtart  LIKE mara-mtart,  "material type
        cedatu LIKE vbep-edatu,  "confirm date
        matnr  LIKE vbap-matnr,  "Material
        opamt  LIKE vbap-netwr,  "Unbilling Amount
        kbmeng LIKE vbap-kbmeng, "confirmed quantity in sales unit  "Unbilling Qty
      END OF d9.
*20210621


DATA: BEGIN OF output_itab2_addon_cnh OCCURS 1.
        INCLUDE STRUCTURE ztsd_zrsd28b_cnh.
DATA: END OF output_itab2_addon_cnh.

DATA: BEGIN OF output_itab2_addon OCCURS 1.
        INCLUDE STRUCTURE ztsd_zrsd28b_raw.
DATA: END OF output_itab2_addon.


DATA: BEGIN OF output_itab2_addon_cn10 OCCURS 1.
        INCLUDE STRUCTURE ztsd_zrsd28b_rbu.
DATA: END OF output_itab2_addon_cn10.


DATA: BEGIN OF output_itab2_addon_base OCCURS 1.
        INCLUDE STRUCTURE ztsd_zrsd28b.
DATA: END OF output_itab2_addon_base.

DATA: BEGIN OF output_itab8_addon OCCURS 1.
        INCLUDE STRUCTURE ztsd_zrsd28b_b8.
DATA: END OF output_itab8_addon.

DATA: BEGIN OF d2 OCCURS 0,           "double add on 20190722 for download to table

        vbeln       LIKE vbak-vbeln,  "sales order
        posnr       LIKE vbap-posnr,  "Sales Document Item
        schline     LIKE vbep-etenr, "schedule line
        matnr       LIKE vbap-matnr,  "Material
        kwmeng      LIKE vbap-kwmeng, "order quantity in sales units

        bmeng       LIKE vbep-bmeng,  "Confirmed quantity
        "  Amout LIKE vbrp-netwr,    "conrimed qty * standard price
        cedatu      LIKE vbep-edatu,  "confirm date
        oedatu      LIKE vbep-edatu,  "Order date
        zz_first    LIKE ekpo-zz_first,
        eisbe       LIKE marc-eisbe,

        waerk       LIKE vbap-waerk,  "SD document currency
        otype(4),                "Order Type(SO&STO)
        mtart       LIKE mara-mtart,  "material type
        werks       LIKE vbap-werks,  "Plant
        maabc       LIKE marc-maabc,

        splant      LIKE vbap-werks,  "Delv Plant
        erdat       LIKE vbap-erdat,   "create date
        waers       LIKE ekko-waers,  "PO currency
        prdplant    LIKE marc-werks,
        eaipd       LIKE ztpp_45-eaipd,
        eaipg       LIKE ztpp_45-eaipg,

        "  wmeng  LIKE vbep-wmeng,  "Order quantity in sales units
        "  bmeng  LIKE vbep-bmeng,  "Confirmed quantity
        kbmeng      LIKE vbap-kbmeng, "confirmed quantity in sales unit  "Unbilling Qty  "DOUBLE20210525
        opamt       LIKE vbap-netwr,      "Unbilling Amount  "DOUBLE20210525
        dvbeln      LIKE likp-vbeln,  "DN Number DOUBLE ADD 20221009
        wamng       LIKE eket-wamng, "double add on 20230208 DN POSTING QTY
        sname       LIKE ztsd_zrsd28b_rbu-sname,   "20240417 add for ctos dashboard
        redatu      LIKE ztsd_zrsd28b_rbu-redatu,
        billtonm    LIKE ztsd_zrsd28b_rbu-billtonm,
        zrname      LIKE ztsd_zrsd28b_rbu-zrname,
        endcustnm   LIKE kna1-name1,

        sobsl       LIKE marc-sobsl,  "Special procurement "20250530 FOR TW INTO LAKE
        route       LIKE vbap-route,  "Route "20250530 FOR TW INTO LAKE
        commit_date LIKE ekpo-commit_date, "20250530 FOR TW INTO LAKE
        zz_zdatu    LIKE vbap-zz_zdatu, "20250530 FOR TW INTO LAKE

        pernr       LIKE i1-pernr,   " 20250618 ADD  BY DOUBLE FOR CTOS MINISGA
        zrpernr     LIKE i1-zrpernr, " 20250618 ADD  BY DOUBLE FOR CTOS MINISGA


      END OF d2.



DATA: BEGIN OF d3 OCCURS 0,           "double add on 20211208 for download to table

        vbeln    LIKE vbak-vbeln,  "sales order
        posnr    LIKE vbap-posnr,  "Sales Document Item
        schline  LIKE vbep-etenr, "schedule line
        matnr    LIKE vbap-matnr,  "Material
        kwmeng   LIKE vbap-kwmeng, "order quantity in sales units

        bmeng    LIKE vbep-bmeng,  "Confirmed quantity
        "  Amout LIKE vbrp-netwr,    "conrimed qty * standard price
        cedatu   LIKE vbep-edatu,  "confirm date
        oedatu   LIKE vbep-edatu,  "Order date
        zz_first LIKE ekpo-zz_first,
        eisbe    LIKE marc-eisbe,

        waerk    LIKE vbap-waerk,  "SD document currency
        otype(4),                "Order Type(SO&STO)
        mtart    LIKE mara-mtart,  "material type
        werks    LIKE vbap-werks,  "Plant
        maabc    LIKE marc-maabc,

        splant   LIKE vbap-werks,  "Delv Plant
        erdat    LIKE vbap-erdat,   "create date
        waers    LIKE ekko-waers,  "PO currency
        prdplant LIKE marc-werks,
        eaipd    LIKE ztpp_45-eaipd,
        eaipg    LIKE ztpp_45-eaipg,

        "  wmeng  LIKE vbep-wmeng,  "Order quantity in sales units
        "  bmeng  LIKE vbep-bmeng,  "Confirmed quantity
        kbmeng   LIKE vbap-kbmeng, "confirmed quantity in sales unit  "Unbilling Qty  "DOUBLE20210525
        opamt    LIKE vbap-netwr,      "Unbilling Amount  "DOUBLE20210525
        wamng    LIKE eket-wamng,            "double add on 20230208 DN POSTING QTY

      END OF d3.

*DATA: inast LIKE nast OCCURS 10 WITH HEADER LINE.
DATA: iekbe LIKE ekbe OCCURS 0 WITH HEADER LINE.
DATA : ivbep LIKE vbep OCCURS 0 WITH HEADER LINE.
DATA : ieket LIKE eket OCCURS 0 WITH HEADER LINE.
DATA: BEGIN OF it001 OCCURS 0.
        INCLUDE STRUCTURE t001.
DATA:   bwkey LIKE t001k-bwkey.
DATA: werks LIKE t001w-werks.
DATA: END OF it001.
DATA: ivbfa LIKE vbfa OCCURS 0 WITH HEADER LINE.
*declare variant
DATA: g_index  LIKE sy-tabix,
      g_recode,
      g_s1, "for status 1
      g_s2, "for status 2
      g_s3, "for status 3
      g_s4, "for status 4
* 20050415 HANS MODIFIED START.
*      g_cnt(10) TYPE p,
*      g_seq(10) TYPE p.
* 20050415 HANS MODIFED END.
      g_cnt    TYPE i,
      g_seq    TYPE i,
      p_type1v,
      p_type2v,
      p_cur1v,
      p_cur2v.
DATA: l_display_cost(1). "20231012 rong
DATA: l_display_gp(1). "20240821 rong
* 20050512 HANS MODIFIED START.
*for  SO
DATA:it_vbep LIKE vbep OCCURS 0,
     wa_vbep LIKE vbep.


DATA: BEGIN OF it_vbpa OCCURS 0,
        vbeln LIKE vbpa-vbeln, " Sales and Distribution Document Number
        posnr LIKE vbpa-posnr, " Item number of the SD document
        parvw LIKE vbpa-parvw, " Partner function
        kunnr LIKE vbpa-kunnr, " Customer Number 1
        pernr LIKE vbpa-pernr, " Personnel Number
        adrnr LIKE vbpa-adrnr, " address
      END OF it_vbpa .

DATA: wa_vbpa LIKE it_vbpa .

*** Xuan.Kao 20230522 Send Email format for P000-Start ***
DATA: BEGIN OF mail_p000 OCCURS 0,
        kunnr      LIKE vbak-kunnr,     " Sold to Party
        soldtonm   LIKE kna1-name1,     " Sold to Party Desc.
        vbeln      LIKE vbak-vbeln,     " Sales Document
        posnr      LIKE vbap-posnr,     " Sales Document Item
        matnr      LIKE vbap-matnr,     " Material
        kwmeng     LIKE vbap-kwmeng,    " Order Qty
        kbmeng     LIKE vbap-kbmeng,    " Unbilling Qty
        erdat      LIKE vbap-erdat,     " Created on
        redatu     LIKE vbep-edatu,     " Request Date
        cedatu     LIKE vbep-edatu,     " Confirm Date
        opamt      LIKE vbap-netwr,     " Unbilling Amount
        slabst     LIKE mard-labst,     " Supply plant on hand qty
        zz_reason  LIKE vbap-zz_reason, " Delay Reason Code
        maabc      LIKE marc-maabc,     " ABC Indicator
        ipernr     LIKE vbpa-pernr,     " Sales Person ID (VE ID)
        isname(40),                    " Sales Person Name (VE Name)
        empid      LIKE pa0002-pernr,   " Employee ID (ER_ZM ID)
        vorna      LIKE pa0002-vorna,   " Employee Name (ER_ZM Name)
        pernr_zv   LIKE vbpa-pernr,     " SO notify person ID (ZV ID)
        zvname(40),                    " SO notify person Name (ZV Name)
        blatt      LIKE mara-blatt,     " GIP code
        dispo      LIKE marc-dispo,     " MRP Controller
      END OF mail_p000.
*20230630
DATA: BEGIN OF mail_p001 OCCURS 0,
        kunnr      LIKE vbak-kunnr,     " Sold to Party
        soldtonm   LIKE kna1-name1,     " Sold to Party Desc.
        vbeln      LIKE vbak-vbeln,     " Sales Document
        posnr      LIKE vbap-posnr,     " Sales Document Item
        matnr      LIKE vbap-matnr,     " Material
*        kwmeng     LIKE vbap-kwmeng,    " Order Qty
        kbmeng     LIKE vbap-kbmeng,    " Unbilling Qty
*        erdat      LIKE vbap-erdat,     " Created on
*        redatu     LIKE vbep-edatu,     " Request Date
*        cedatu     LIKE vbep-edatu,     " Confirm Date
        opamt      LIKE vbap-netwr,     " Unbilling Amount
        slabst     LIKE mard-labst,     " Supply plant on hand qty
*        zz_reason  LIKE vbap-zz_reason, " Delay Reason Code
        ipernr     LIKE vbpa-pernr,     " Sales Person ID (VE ID)
        isname(40),                    " Sales Person Name (VE Name)
        empid      LIKE pa0002-pernr,   " Employee ID (ER_ZM ID)
        vorna      LIKE pa0002-vorna,   " Employee Name (ER_ZM Name)
        pernr_zv   LIKE vbpa-pernr,     " SO notify person ID (ZV ID)
        zvname(40),                    " SO notify person Name (ZV Name)
        blatt      LIKE mara-blatt,     " GIP code
        maabc      LIKE marc-maabc,     " ABC Indicator
        dispo      LIKE marc-dispo,     " MRP Controller
      END OF mail_p001.

DATA: atpdsx LIKE atpds OCCURS 0 WITH HEADER LINE.
DATA: l_atpcs LIKE atpcs  OCCURS 0 WITH HEADER LINE.
DATA: p_atpca LIKE atpca.
DATA: l_temp LIKE atpds-qty.
DATA: l_atp LIKE atpds-qty.
DATA: l_bill_qty(30).
DATA: l_bill_amt(30).
DATA: l_atp_qty(30).
DATA: lt_ztmm_15 LIKE ztmm_15 OCCURS 0 WITH HEADER LINE.
DATA: mail_subject TYPE string.
DATA: mail_text LIKE zstext1024 OCCURS 0 WITH HEADER LINE.
DATA: mail_footer LIKE zstext1024 OCCURS 0 WITH HEADER LINE.
DATA: t_header LIKE zstext1024 OCCURS 0 WITH HEADER LINE.

DATA: mail_reclist  LIKE somlreci1 OCCURS 0 WITH HEADER LINE.
DATA: mail_filename TYPE string.
*** Xuan.Kao 20230522 Send Email format for P000-End ***

RANGES: s_shbi       FOR  vbpa-parvw.
RANGES: s_parvw      FOR vbpa-parvw.
RANGES: sto_parvw     FOR vbpa-parvw.
*RANGES: s_mara_matnr FOR mara-matnr.
DATA: so_index LIKE sy-tabix.

DATA: p_factor TYPE p DECIMALS 3.

* soview
*     VBELN          Like   VBAK-VBELN         ,
*     POSNR          Like   VBAP-POSNR         ,
*     ERNAM          Like   VBAK-ERNAM         ,
*     AUART          Like   VBAK-AUART         ,
*     BSTNK          Like   VBAK-BSTNK         ,
*     KUNNR          Like   VBAK-KUNNR         ,
*     VKORG          Like   VBAK-VKORG         ,
*     VBTYP          Like   VBAK-VBTYP         ,
*     MATNR          Like   VBAP-MATNR         ,
*     PRODH          Like   VBAP-PRODH         ,
*     NETWR          Like   VBAP-NETWR         ,
*     WAERK          Like   VBAP-WAERK         ,
*     KWMENG         Like   VBAP-KWMENG        ,
*     KBMENG         Like   VBAP-KBMENG        ,
*     POSNV          Like   VBAP-POSNV         ,
*     WERKS          Like   VBAP-WERKS         ,
*     LGORT          Like   VBAP-LGORT         ,
*     NETPR          Like   VBAP-NETPR         ,
*     KPEIN          Like   VBAP-KPEIN         ,
*     KZWI2          Like   VBAP-KZWI2         ,
*     VRKME          Like   VBAP-VRKME         ,
*     LFSTA          Like   VBUP-LFSTA         ,
*     FKSTA          Like   VBUP-FKSTA         ,
*     ABSTA          Like   VBUP-ABSTA         ,
*     WBSTA          Like   VBUP-WBSTA         ,
*     KOSTA          Like   VBUP-KOSTA         ,
*     CMGST          Like   VBUK-CMGST         ,
*     VSBED          Like   VBAK-VSBED         ,
*     VKGRP          Like   VBAK-VKGRP         ,
*     VKBUR          Like   VBAK-VKBUR         ,
*     ABGRU          Like   VBAP-ABGRU         ,
*     ROUTE          Like   VBAP-ROUTE         ,
*     AUDAT          Like   VBAK-AUDAT         ,
*     PSTYV          Like   VBAP-PSTYV         ,
*     ERDAT          Like   VBAP-ERDAT         ,
*     ERZET          Like   VBAK-ERZET         ,
*     LIFSK          Like   VBAK-LIFSK         ,
*     UEPOS          Like   VBAP-UEPOS         ,
*     ZZ_ABGRU       Like   VBAP-ZZ_ABGRU      ,
*     ZZ_EDATU        Like  VBAP-ZZ_EDATU      ,
*     ZZ_REASON      Like   VBAP-ZZ_REASON     ,
*     ZZ_REASON_TEXT Like   VBAP-ZZ_REASON_TEXT,
*     ZZ_ABGRU_TEXT	 Like  VBAP-ZZ_ABGRU_TEXT	,
*     KDMAT	         Like  VBAP-KDMAT	        ,


DATA: BEGIN OF  it_soview OCCURS 0.
        INCLUDE STRUCTURE zsoview.
DATA:   prodh2  LIKE prodhs-prodh2, "product group
        prodh3  LIKE prodhs-prodh3, "product line
*      kdmat  LIKE vbap-kdmat,
        mtart   LIKE mara-mtart,  "material type
        bismt   LIKE mara-bismt,   "Old material number
        mstav   LIKE mara-mstav,  "Cross-distribution-chain material status
        lgpbe   LIKE mard-lgpbe,
        labst   LIKE  mard-labst,
        sobsl   LIKE marc-sobsl,
        plifz   LIKE  marc-plifz,
        ladgr   LIKE  marc-ladgr, " Storage costs indicator
        bukrs   LIKE  ekko-bukrs, "company code
        stprs   LIKE mbew-stprs,  " cost of the item.
        stwaers LIKE t001-waers, " cost currency
        stpeinh LIKE mbew-peinh,  "price unit.
        bzirk   LIKE vbkd-bzirk,
        sdabw   LIKE vbkd-sdabw,
        inco1   LIKE vbkd-inco1,
        inco2   LIKE vbkd-inco2,
        zterm   LIKE vbkd-zterm,
        bstkd   LIKE vbkd-bstkd,                            "20081215
        bstkd_e LIKE vbkd-bstkd_e,                          "20090819
        ihrez_e LIKE vbkd-ihrez_e,                          "20090819
        blatt   LIKE mara-blatt,                        " chris 20120504
        eaipd   LIKE ztpp_45-eaipd,
        eaipg   LIKE ztpp_45-eaipg,
        abtnr   LIKE vbkd-abtnr,                            "20250815
      END OF it_soview.

DATA : BEGIN OF itab_vbak OCCURS 0,
         vbeln LIKE vbak-vbeln,
         vkorg LIKE vbak-vkorg,
         vtweg LIKE vbak-vtweg,
         spart LIKE vbak-spart,
       END OF itab_vbak.
RANGES: s_vtweg FOR vbak-vtweg,
        s_spart FOR vbak-spart.
RANGES: s_wrk02 FOR t460a-wrk02.

*for STO
DATA: BEGIN OF  it_stoview  OCCURS 0.
        INCLUDE STRUCTURE zstoview.
DATA:   prodh   LIKE vbap-prodh,  " Product hierarchy
        prodh2  LIKE prodhs-prodh2, "product group
        prodh3  LIKE prodhs-prodh3, "product line
        mtart   LIKE mara-mtart,  "material type
        bismt   LIKE mara-bismt,   "Old material number
        mstav   LIKE mara-mstav,  "Cross-distribution-chain material status
        lgpbe   LIKE mard-lgpbe,  "storage bin
        labst   LIKE mard-labst,   "Valuated stock with unrestricted use
        sobsl   LIKE marc-sobsl,
        plifz   LIKE marc-plifz,
        ladgr   LIKE marc-ladgr, "Loading group
        stprs   LIKE mbew-stprs,  " cost of the item.
        stwaers LIKE t001-waers,
        stpeinh LIKE mbew-peinh,  "price unit.
        audat   LIKE vbak-audat,  "for i1 document date
        kbetr   LIKE  konv-kbetr ,  " for PB00 price
        kpein1  LIKE  konv-kpein ,                           " PB00 Unit
* chris 20120504
        blatt   LIKE mara-blatt,
        eaipd   LIKE ztpp_45-eaipd,
        eaipg   LIKE ztpp_45-eaipg,
        kschl   LIKE konv-kschl, "Conditon Type
      END OF it_stoview.
DATA: it_stoview_bak LIKE it_stoview OCCURS 0 WITH HEADER LINE.

DATA: it_knvv LIKE knvv OCCURS 0 WITH HEADER LINE.

DATA: BEGIN OF it_knvvvp OCCURS 0,
        kunnr LIKE knvv-kunnr, " Customer Number 1
        vkorg LIKE knvv-vkorg, " Sales Organization
        vtweg LIKE knvv-vtweg, " Distribution Channel
        spart LIKE knvv-spart, " Division
        vwerk LIKE knvv-vwerk, " Delivering Plant (Own or External)
        vkgrp LIKE knvv-vkgrp, " Sales group
        vkbur LIKE knvv-vkbur, " Sales office
        bzirk LIKE knvv-bzirk, " slaes disctrict
        zterm LIKE knvv-zterm, " payment term
        parvw LIKE knvp-parvw, " Partner function
        pernr LIKE knvp-pernr, " Personnel Number
      END OF it_knvvvp .

DATA: BEGIN OF it_mara OCCURS 0,
        matnr LIKE mara-matnr, " Material Number
        bismt LIKE mara-bismt, " Old material number
        prdha LIKE mara-prdha, " Product hierarchy
        mtart LIKE mara-mtart, " Material Type
        mstav LIKE mara-mstav, " Cross-distribution-chain material status
* chris 20120504
        blatt LIKE mara-blatt,
      END OF it_mara .

DATA: BEGIN OF it_ztpp_45 OCCURS 0,
        prdln LIKE ztpp_45-prdln, " Material Number
        eaipg LIKE ztpp_45-eaipg, " Old material number
        eaipd LIKE ztpp_45-eaipd, " Product hierarchy
      END OF it_ztpp_45.



DATA: BEGIN OF it_mard OCCURS 0,
        matnr LIKE mard-matnr, " Material Number
        werks LIKE mard-werks, " Plant
        lgort LIKE mard-lgort, " Storage Location
        labst LIKE mard-labst, " Valuated stock with unrestricted use
        lgpbe LIKE mard-lgpbe, " Storage bin
      END OF it_mard .


DATA: BEGIN OF itab_wrk2 OCCURS 0,
        wrk02 LIKE t460a-wrk02, " Plant
      END OF itab_wrk2 .

DATA: wa_mard LIKE mard.

DATA: BEGIN OF it_gp_down OCCURS 0,
        splant(4), "Delv/Supply Plant
        vbeln(20),  "SO/STO Order
        posnr(10),  "Order Item
        matnr(50),  "Material
        mtart(10),  "Material Type
        kbmeng(30),  "Unbilling Qty
        oedatu(15), "Order Date
        cedatu(15), "Confirm Date
        netpr(30),  "Unit Price
        opamt(30),  "Unbilling Amount
        curr(10), "Currency
        actcost(30),  "Actual Cost
        unitgp(30), "Unit GP
        totalgp(30),  "Total GP
        werks(4),  "Plant
        otype(4), "Order Type
        dispo(10), "MRP Controller
        dsnam(40), "MRP Controller Name
        ernam(40) "User ID (Created By)
        .
DATA: END OF it_gp_down.

DATA: BEGIN OF it_marc OCCURS 0,
        mandt LIKE marc-mandt, " Client
        matnr LIKE marc-matnr, " Material Number
        werks LIKE marc-werks, " Plant
        plifz LIKE marc-plifz, " Planned delivery time in days
        sobsl LIKE marc-sobsl, " Special procurement type
        ladgr LIKE marc-ladgr, " Loading group
      END OF it_marc .

DATA: it_ekko LIKE ekko OCCURS 0 WITH HEADER LINE.
DATA: it_konv  TYPE konv .

***Add By Hermit 2005/08/04
DATA : transit_day TYPE i,
       po_date     LIKE eket-bedat,
       p_pass(1)   TYPE c,
       so_fstmatdt LIKE vbep-mbdat.


* 20050512 HANS MODIFIED end.

DATA: dlvplant LIKE vbap-werks. " Xuan.Kao 20160308 Delivery Plant For Country of origin,Material Description(Chinese),Brand,MPN.

*** Xuan.Kao 20150720 SO Head Sales note from customer-Start ***
DATA: tmp_tdname LIKE thead-tdname,
      tmp_id     LIKE thead-tdid,
      tmp_tline  LIKE tline OCCURS 0 WITH HEADER LINE.
*** Xuan.Kao 20150720 SO Head Sales note from customer-End ***

*** Xuan.Kao 20181219 SO GP view-Start ***
DATA: username TYPE string.
DATA: gp_vkorg LIKE ztmm_15-zmalgp.
DATA: gp_view(1).
DATA: gp_factor TYPE p DECIMALS 3.
DATA: tbl_gp LIKE zssd_gp OCCURS 0 WITH HEADER LINE.
DATA: tmp_tbl_gp LIKE zssd_gp OCCURS 0 WITH HEADER LINE.
*** Xuan.Kao 20181219 SO GP view-End ***

DATA: lv_ap_bp TYPE bu_partner.

**add by rong 20181116, for B+B
INCLUDE: zrsd0028btop.
** endn

DATA: BEGIN OF it_gp OCCURS 0,
        sosto    TYPE c,   "SO='X'  STO=''
        splant   LIKE vbap-werks, "Delv/Supply Plant
        vbeln    LIKE vbep-vbeln,  "SO/STO Order
        posnr    LIKE vbep-posnr,  "Order Item
        matnr    LIKE vbap-matnr,  "Material
        mtart    LIKE mara-mtart,  "Material Type
        kbmeng   LIKE vbap-kbmeng,  "Unbilling Qty
        oedatu   LIKE vbep-edatu, "Order Date
        cedatu   LIKE vbep-edatu, "Confirm Date
        netpr    TYPE p DECIMALS 5,  "Unit Price
        opamt    LIKE vbap-netwr,  "Unbilling Amount
        curr     LIKE vbap-waerk, "Currency
        actcost  TYPE p DECIMALS 5,  "Actual Cost
        unitgp   TYPE p DECIMALS 5, "Unit GP
        totalgp  TYPE p DECIMALS 5,  "Total GP
        "PRDPLANT LIKE  marc-werks,  "Production plant
        werks    LIKE vbap-werks,  "Plant
        otype(4), "Order Type
        dispo    LIKE marc-dispo, "MRP Controller
        dsnam    LIKE t024d-dsnam, "MRP Controller Name
        ernam    LIKE vbak-ernam  "Name of Person who Created the Object
        .
DATA: END OF it_gp.

DEFINE alv_title_field.
  CLEAR: t_fieldcat.
  t_fieldcat-fieldname     = &1.
  t_fieldcat-ref_fieldname = &1.
  t_fieldcat-ref_tabname   = &2.
  t_fieldcat-no_out        = &3.
  t_fieldcat-key           = &4.
  APPEND t_fieldcat TO g_fieldcat.

  CLEAR: wa_fieldcat.
  wa_fieldcat-fieldname     = &1.
  wa_fieldcat-ref_field     = &1.
  wa_fieldcat-ref_table   = &2.
  wa_fieldcat-no_out        = &3.
  wa_fieldcat-key           = &4.
  APPEND wa_fieldcat TO gt_fieldcat.

END-OF-DEFINITION.

DEFINE alv_desc_field.
  CLEAR: t_fieldcat.
  t_fieldcat-fieldname     = &1.
  t_fieldcat-seltext_l     = &2.
  t_fieldcat-no_out        = &3.
*  t_fieldcat-cfieldname    = &4.
*  t_fieldcat-ref_fieldname = &1.
*  t_fieldcat-ref_tabname   = &2.
  APPEND t_fieldcat TO g_fieldcat.

  CLEAR: wa_fieldcat.
  wa_fieldcat-fieldname     = &1.
  wa_fieldcat-scrtext_l     = &2.
  wa_fieldcat-no_out        = &3.
  APPEND wa_fieldcat TO gt_fieldcat.
END-OF-DEFINITION.

DEFINE alv_total_field.
  CLEAR: t_fieldcat.
  t_fieldcat-fieldname     = &1.
  t_fieldcat-seltext_l     = &2.
  t_fieldcat-no_out        = &3.
*  t_fieldcat-do_sum        = ''.
  t_fieldcat-cfieldname    = &4.
  APPEND t_fieldcat TO g_fieldcat.

  CLEAR: wa_fieldcat.
  wa_fieldcat-fieldname     = &1.
  wa_fieldcat-scrtext_l     = &2.
  wa_fieldcat-no_out        = &3.
*  t_fieldcat-do_sum        = ''.
  wa_fieldcat-cfieldname    = &4.
  APPEND wa_fieldcat TO gt_fieldcat.

END-OF-DEFINITION.

DEFINE alv_qty_field.
  CLEAR: t_fieldcat.
  t_fieldcat-fieldname     = &1.
  t_fieldcat-seltext_l     = &2.
*  t_fieldcat-no_out        = &3.
*  t_fieldcat-do_sum        = 'X'.
  t_fieldcat-qfieldname    = &3.
  APPEND t_fieldcat TO g_fieldcat.

  CLEAR: wa_fieldcat.
  wa_fieldcat-fieldname     = &1.
  wa_fieldcat-scrtext_l     = &2.
  wa_fieldcat-qfieldname    = &3.
  APPEND wa_fieldcat TO gt_fieldcat.

END-OF-DEFINITION.


DEFINE alv_sort.
  CLEAR: t_sort.
  t_sort-fieldname = &1.
  t_sort-up        = 'X'.
  t_sort-group     = &2.
  APPEND t_sort TO g_sort.
END-OF-DEFINITION.

DEFINE alv_sort_subtotal.
  CLEAR: t_sort.
  t_sort-fieldname = &1.
  t_sort-up        = 'X'.
  t_sort-group     = &2.
  t_sort-subtot    = 'X'.
  APPEND t_sort TO g_sort.
END-OF-DEFINITION.

DEFINE give_range_value.
  CLEAR  &2.
  &2-sign   ='I'.
  &2-option ='EQ'.
  &2-low    = &1.
  APPEND &2.
END-OF-DEFINITION.


** ALV Report
TYPE-POOLS: slis.
DATA: g_fieldcat     TYPE slis_t_fieldcat_alv.
DATA  gt_fieldcat TYPE TABLE OF lvc_s_fcat WITH HEADER LINE.
DATA  wa_fieldcat TYPE lvc_s_fcat.
DATA: t_fieldcat     TYPE slis_fieldcat_alv.
DATA: g_layout       TYPE slis_layout_alv.
DATA: g_variant      LIKE disvariant.
DATA: g_events       TYPE slis_t_event.
DATA: t_events       TYPE slis_alv_event.
DATA: g_print        TYPE slis_print_alv.
DATA: g_title        TYPE lvc_title.
DATA: g_sort         TYPE slis_t_sortinfo_alv .
DATA: t_sort         TYPE slis_sortinfo_alv.
DATA: g_user_command TYPE slis_formname VALUE 'USER_COMMAND'.
DATA: g_status TYPE slis_formname VALUE 'STANDARD_02'.
*DATA: g_status TYPE slis_formname VALUE 'STANDARD'.
DATA: next_month  LIKE vbep-edatu,
      last3_month LIKE vbep-edatu,
      this_month  LIKE vbep-edatu.

CONSTANTS: c_c01(1)  VALUE 'C',
           c_a01(1)  VALUE 'A',
           c_b01(1)  VALUE 'B',
           c_j01(1)  VALUE 'J',
           c_v01(1)  VALUE '1',
           c_v02(1)  VALUE '2',
           c_v03(1)  VALUE '3',
           c_v04(1)  VALUE '4',
           c_v08(1)  VALUE '8',
           c_v00(1)  VALUE '0',
           c_ve(02)  VALUE 'VE',
           c_v2(02)  VALUE 'V2',
           c_ef(02)  VALUE 'EF',
           c_ld00(4) VALUE 'LD00',
           c_neu(3)  VALUE 'NEU',
           c_vl(1)   VALUE 'L',   " added by Hans .
           c_sh(02)  VALUE 'WE'. " party func. -ship to party

DATA: p_file3 LIKE rlgrap-filename VALUE '/usr/sap/trans/interface/MM/SAP2PMC/ZRSD0028B_TWH1.txt'.
*-------------------------------------------------------------*
*Selection screen start
*-------------------------------------------------------------*
SELECTION-SCREEN BEGIN OF BLOCK bk1 WITH FRAME TITLE TEXT-s01.
  SELECT-OPTIONS: s_org  FOR vbak-vkorg NO INTERVALS OBLIGATORY.
**add by rong 20201218
  PARAMETERS: p_vtweg LIKE vbak-vtweg,
              p_spart LIKE vbak-spart.
**end

*Type and po number
  SELECTION-SCREEN BEGIN OF LINE.
    SELECTION-SCREEN COMMENT 1(5) TEXT-s02. "text of type
    SELECTION-SCREEN POSITION 7.
    PARAMETERS: p_type1 AS CHECKBOX DEFAULT 'X'. "sales order
    SELECTION-SCREEN COMMENT 9(11) TEXT-s03." Sales order
    SELECTION-SCREEN POSITION 21.
    PARAMETERS: p_type2 AS CHECKBOX. "STO
    SELECTION-SCREEN COMMENT 23(3) TEXT-s04.  "sto
    SELECTION-SCREEN COMMENT 33(8) TEXT-s05.  "PO number
    SELECTION-SCREEN POSITION 41.
    SELECT-OPTIONS: s_bstnk FOR vbak-bstnk.  "PO number
  SELECTION-SCREEN END OF LINE.

  SELECT-OPTIONS: s_ebelnn FOR ekko-ebeln NO-DISPLAY.

  SELECT-OPTIONS: s_auart FOR vbak-auart. "order type
  SELECT-OPTIONS: s_vbeln FOR vbak-vbeln . "sales order
  SELECT-OPTIONS: s_posnr FOR vbap-posnr. "sales order item for debug

  SELECT-OPTIONS: s_pstyv FOR vbap-pstyv. "SO item category.
  SELECT-OPTIONS:s_lifsk FOR vbak-lifsk. "SO Delivery block
*STO type and STO number
  SELECT-OPTIONS: s_bsart FOR ekko-bsart.
*20210512 per Polar request
* DEFAULT 'STO' OPTION EQ SIGN I."STO type
  SELECT-OPTIONS: s_ebeln FOR ekko-ebeln."STO number
**20240821 rong add
  PARAMETERS: p_gp AS CHECKBOX.
  SELECTION-SCREEN ULINE.

**Add By Hermit 2005/07/08

  SELECTION-SCREEN BEGIN OF BLOCK bk9 WITH FRAME TITLE TEXT-003.
    SELECTION-SCREEN BEGIN OF LINE.
      PARAMETERS : p_rado1 RADIOBUTTON GROUP rad1.
      SELECTION-SCREEN COMMENT 3(18) TEXT-006.  "Confirm
      PARAMETERS : p_rado2 RADIOBUTTON GROUP rad1.
      SELECTION-SCREEN COMMENT 25(20) TEXT-007. "Unconfirm
      PARAMETERS : p_rado3 RADIOBUTTON GROUP rad1.
      SELECTION-SCREEN COMMENT 48(5) TEXT-008.  "ALL
    SELECTION-SCREEN END OF LINE.
    SELECT-OPTIONS: s_edatu FOR vbep-edatu. " confirmed date
    SELECT-OPTIONS: s_datu FOR vbep-edatu.  " Request date
    SELECT-OPTIONS: s_cdat FOR vbap-erdat.  " create date
    SELECTION-SCREEN BEGIN OF LINE.
      PARAMETERS : p_rado4 RADIOBUTTON GROUP rad2.
      SELECTION-SCREEN COMMENT 3(18) TEXT-b01.  "Confirm
      PARAMETERS : p_rado5 RADIOBUTTON GROUP rad2.
      SELECTION-SCREEN COMMENT 25(20) TEXT-b02. "Unconfirm
      PARAMETERS : p_rado6 RADIOBUTTON GROUP rad2 DEFAULT  'X'.
      SELECTION-SCREEN COMMENT 48(5) TEXT-b03.  "ALL
    SELECTION-SCREEN END OF LINE.
  SELECTION-SCREEN END OF BLOCK bk9 .
***End of modification

*confirmed date, currency convert or not
**change request 20050511 Hans added start.

*PARAMETERS: P_STS5 AS CHECKBOX. "Exclude un-confirmed items

**change request 20050511 Hans added end.

  SELECTION-SCREEN BEGIN OF LINE.
    SELECTION-SCREEN COMMENT 1(9) TEXT-s11.
    SELECTION-SCREEN COMMENT 13(08) TEXT-s12.
    SELECTION-SCREEN COMMENT 23(16) TEXT-s13.
    SELECTION-SCREEN POSITION 10.
    PARAMETERS: p_cur1 RADIOBUTTON GROUP gr1 DEFAULT 'X'. "currency
    SELECTION-SCREEN POSITION 21.     "convert currency
    PARAMETERS: p_cur2 RADIOBUTTON GROUP gr1. "DEFAULT 'X'.
    SELECTION-SCREEN POSITION 39.   "target currency
    PARAMETERS: p_waers LIKE tcurc-waers DEFAULT 'USD'.
  SELECTION-SCREEN END OF LINE.

*status
  SELECTION-SCREEN BEGIN OF LINE.
    SELECTION-SCREEN COMMENT 1(7) TEXT-s14. "status
    SELECTION-SCREEN COMMENT 11(13) TEXT-s15. "not yet DN
*Hans modified start.
*SELECTION-SCREEN COMMENT 25(17) text-s16. "not yet picked
*SELECTION-SCREEN COMMENT 44(15) text-s17. "not yet post
*SELECTION-SCREEN COMMENT 61(7) text-s18.  "post
    SELECTION-SCREEN COMMENT 27(17) TEXT-s16. "not yet picked
    SELECTION-SCREEN COMMENT 47(15) TEXT-s17. "not yet post
    SELECTION-SCREEN COMMENT 65(7) TEXT-s18.  "post
*hans modified end.
    SELECTION-SCREEN POSITION 9.
    PARAMETERS: p_sts1 AS CHECKBOX DEFAULT 'X'. "not yet DN
    SELECTION-SCREEN POSITION 25.
    PARAMETERS: p_sts2 AS CHECKBOX DEFAULT 'X'. "not yet picked
    SELECTION-SCREEN POSITION 45.
    PARAMETERS: p_sts3 AS CHECKBOX. "not yet post
    SELECTION-SCREEN POSITION 63.
    PARAMETERS: p_sts4 AS CHECKBOX. "post
  SELECTION-SCREEN END OF LINE.


  SELECTION-SCREEN ULINE.
  SELECTION-SCREEN BEGIN OF BLOCK bk3 WITH FRAME TITLE TEXT-t03.
*SELECT-OPTIONS: S_PORG  FOR EKKO-EKORG NO INTERVALS.
    SELECT-OPTIONS: s_mbdat FOR eket-mbdat. "Material availability date
    SELECT-OPTIONS: s_reswk FOR ekko-reswk. "supply plant
    SELECT-OPTIONS: s_zkunnr FOR ekko-zz_kunnr.  "customer code
    SELECT-OPTIONS: s_reslo FOR ekpo-reslo.  "customer code
* chris 20120830
    SELECT-OPTIONS: s_ekgrp FOR ekko-ekgrp .  "purchase group
  SELECTION-SCREEN END OF BLOCK bk3 .

  SELECTION-SCREEN ULINE.

  SELECT-OPTIONS: "s_reswk FOR ekko-reswk, "supply plant
                  s_werks FOR vbap-werks, "Received plant
                  s_lgort FOR vbap-lgort, "Received storage location
                  s_lgpbe FOR mard-lgpbe, "storage bin
                  s_matnr FOR vbap-matnr. "material

  SELECTION-SCREEN ULINE.
*--Add By Hermit 20120131 Production plant
  SELECT-OPTIONS: s_prod  FOR marc-werks.
*sold-to party, user id, ship-to party, shipping condition, sales
*office,
*prd. group, sales group, prd.line, sales person and material
*"sales org
** mark by Hermit 2006/11/24
**PARAMETERS: P_VKORG LIKE VBAK-VKORG DEFAULT 'TW01' OBLIGATORY.
**change request 20050511 Hans added start.
  SELECT-OPTIONS: s_route  FOR vbap-route. " NO-EXTENSION NO INTERVALS.
  SELECT-OPTIONS: s_ladgr  FOR marc-ladgr NO-EXTENSION NO INTERVALS.
**change request 20050511 Hans added end .

*SO credit block
*PARAMETERS: p_cmgst  AS CHECKBOX.
  SELECT-OPTIONS: s_brsch FOR kna1-brsch NO-EXTENSION NO INTERVALS.

  SELECT-OPTIONS: s_cmgst FOR v_vbuk_cds-cmgst. "NO-EXTENSION NO INTERVALS.
*DN credit block
*PARAMETERS: p_dncmg   AS CHECKBOX.
  SELECT-OPTIONS: s_dncmg FOR v_vbuk_cds-cmgst. "NO-EXTENSION NO INTERVALS.

* special procurement key add by 20050623 Vivian.
  SELECT-OPTIONS: s_sobsl FOR marc-sobsl.

  SELECT-OPTIONS: s_kunag  FOR likp-kunag, "sold-to party
                  s_billto FOR vbak-kunnr, "Bill to party
                  s_ernam  FOR vbak-ernam,  "user id
** Add By Hermit 2005/11/03 for EU request
                  s_pernr1  FOR pa0002-pernr,  "employee id
                  s_kunnr  FOR likp-kunnr,  "ship-to party
                  s_vsbed  FOR vbak-vsbed,  "shipping condition
                  s_vkbur  FOR vbak-vkbur,  "sales office
                  s_vkgrp  FOR vbak-vkgrp, "sales group
                  s_prodh2 FOR prodhs-prodh2, "prd.group
                  s_prodh3 FOR prodhs-prodh3, "prd. line
                  s_pernr  FOR pa0002-pernr, "sales person
                  s_maabc FOR marc-maabc, "ABC indicator
* chris 20120504
                  s_blatt FOR mara-blatt, "GIP code
                  s_eaipd FOR ztpp_45-eaipd,
                  s_eaipg FOR ztpp_45-eaipg,
                  so_werks FOR vbap-werks,
                  s_uepos FOR vbap-uepos NO INTERVALS. "Higher-level item

*** Xuan.Kao 20150720 SO Head Sales note from customer-Start ***
  SELECTION-SCREEN BEGIN OF LINE.
    SELECTION-SCREEN POSITION 1.
    PARAMETERS: s_note AS CHECKBOX.
    SELECTION-SCREEN COMMENT 3(24) TEXT-s35.
  SELECTION-SCREEN END OF LINE.
*** Xuan.Kao 20150720 SO Head Sales note from customer-End ***
*** Timo.Rusnjak 20210414 SO Head Shipping Instruction-Start ***
  SELECTION-SCREEN BEGIN OF LINE.
    SELECTION-SCREEN POSITION 1.
    PARAMETERS: s_instr AS CHECKBOX.
    SELECTION-SCREEN COMMENT 3(24) TEXT-s37.
  SELECTION-SCREEN END OF LINE.
*** Timo.Rusnjak 20210414 SO Head Shipping Instruction-End ***

  SELECT-OPTIONS: s_kondm FOR vbap-kondm.     " Xuan.Kao 20161222 Material Pricing Group
*
  SELECTION-SCREEN BEGIN OF LINE.
    SELECTION-SCREEN POSITION 1.
    PARAMETERS: s_buff AS CHECKBOX.
    SELECTION-SCREEN COMMENT 3(30) TEXT-s36.
  SELECTION-SCREEN END OF LINE.
*
  SELECTION-SCREEN: BEGIN OF LINE.
    PARAMETERS: r_server AS CHECKBOX.
    SELECTION-SCREEN: COMMENT (29) TEXT-f47.
  SELECTION-SCREEN: END OF LINE.

  SELECTION-SCREEN: BEGIN OF LINE. "double add on 20190722 for download to table
    PARAMETERS: r_dn2tb AS CHECKBOX.
    SELECTION-SCREEN: COMMENT (29) TEXT-f49.
  SELECTION-SCREEN: END OF LINE.
  SELECTION-SCREEN: BEGIN OF LINE. "double add on 20190722 for download to table
    PARAMETERS: r_dn2tb8 AS CHECKBOX.
    SELECTION-SCREEN: COMMENT (29) TEXT-f88.
  SELECTION-SCREEN: END OF LINE.

  SELECTION-SCREEN: BEGIN OF LINE. "double add on 20230317 for download to table
    PARAMETERS: r_dn2tbr AS CHECKBOX.
    SELECTION-SCREEN: COMMENT (29) TEXT-f99.
  SELECTION-SCREEN: END OF LINE.

  SELECTION-SCREEN: BEGIN OF LINE. "double add on 20130801 for download to table for globle
    PARAMETERS: r_dn2tbg AS CHECKBOX.
    SELECTION-SCREEN: COMMENT (29) TEXT-f77.
  SELECTION-SCREEN: END OF LINE.

  SELECTION-SCREEN: BEGIN OF LINE. "double add on 20240429 for download to table for CUST NAME MAPPING MATERIALS
    PARAMETERS: r_dn2cus AS CHECKBOX.
    SELECTION-SCREEN: COMMENT (29) TEXT-f87.
  SELECTION-SCREEN: END OF LINE.

*SELECTION-SCREEN: BEGIN OF LINE.
  PARAMETERS: p_file1 LIKE rlgrap-filename
     DEFAULT '/usr/sap/trans/interface/MM/SAP2PMC/ZRSD0028B.txt'.
*SELECTION-SCREEN: END OF LINE.

  SELECTION-SCREEN: BEGIN OF LINE.
    PARAMETERS: r_svr2 AS CHECKBOX.
    SELECTION-SCREEN: COMMENT (29) TEXT-f48.
    PARAMETERS: p_file2 LIKE rlgrap-filename
       DEFAULT '/usr/sap/trans/interface/MM/ZRSD0028B/OVERDUE-SO-STO.txt'.
  SELECTION-SCREEN: END OF LINE.

  SELECTION-SCREEN: BEGIN OF LINE.
    PARAMETERS: r_svr3 AS CHECKBOX USER-COMMAND u3.
    SELECTION-SCREEN: COMMENT (29) TEXT-f51.
    PARAMETERS: p_file4 LIKE rlgrap-filename
       DEFAULT '/usr/sap/trans/interface/SD/out/AEUKPI/AEU_BACKLOG.xls'.
    SELECTION-SCREEN: COMMENT (12) TEXT-f52.
    PARAMETERS: p_dtfrt TYPE char1 AS LISTBOX VISIBLE LENGTH 20.
  SELECTION-SCREEN: END OF LINE.

  SELECTION-SCREEN: BEGIN OF LINE.
    PARAMETERS: r_svr6 AS CHECKBOX .
    SELECTION-SCREEN: COMMENT (34) TEXT-f61.
    PARAMETERS: p_file6 LIKE rlgrap-filename
       DEFAULT '/usr/sap/trans/interface/MM/ZRSD0028B/CO/MaterialGP.csv'.
  SELECTION-SCREEN: END OF LINE.

***Add Send Mail Option by jane on 2018/08/03>>
  SELECTION-SCREEN BEGIN OF BLOCK mail WITH FRAME TITLE TEXT-u01.

    SELECTION-SCREEN BEGIN OF LINE.
      PARAMETERS: r_mail1 AS CHECKBOX.
      SELECTION-SCREEN COMMENT 3(40) TEXT-u02.
    SELECTION-SCREEN END OF LINE.
    SELECTION-SCREEN BEGIN OF LINE.
      PARAMETERS: r_mailb AS CHECKBOX.
      SELECTION-SCREEN COMMENT 3(40) TEXT-u03.
    SELECTION-SCREEN END OF LINE.
    SELECTION-SCREEN BEGIN OF LINE.
      PARAMETERS: r_mails AS CHECKBOX.
      SELECTION-SCREEN COMMENT 3(70) TEXT-u04.
    SELECTION-SCREEN END OF LINE.
    SELECTION-SCREEN BEGIN OF LINE.
      PARAMETERS: r_mailm AS CHECKBOX USER-COMMAND u1.
      SELECTION-SCREEN COMMENT 3(70) TEXT-u05 .
    SELECTION-SCREEN END OF LINE.
**ADD BY XIUJIE.
    SELECTION-SCREEN BEGIN OF LINE.
      PARAMETERS: r_maild AS CHECKBOX USER-COMMAND u2.
      SELECTION-SCREEN COMMENT 3(70) TEXT-u06 .
    SELECTION-SCREEN END OF LINE.
**END
    SELECTION-SCREEN BEGIN OF LINE.
      PARAMETERS: p_mailgp AS CHECKBOX USER-COMMAND u3.
      SELECTION-SCREEN COMMENT 3(70) TEXT-u07 .
    SELECTION-SCREEN END OF LINE.

    PARAMETERS: p_mailp AS CHECKBOX.                  " Xuan.Kao 20230522 Send Email format for P000

    SELECTION-SCREEN: BEGIN OF BLOCK direct
      WITH FRAME TITLE TEXT-f59.
      SELECTION-SCREEN BEGIN OF LINE.
        PARAMETERS: p_addr1 LIKE ztsd_mail_add-receiver  MODIF ID h1.
      SELECTION-SCREEN END OF LINE.
      SELECTION-SCREEN BEGIN OF LINE.
        PARAMETERS: p_addr2 LIKE ztsd_mail_add-receiver  MODIF ID h1.
      SELECTION-SCREEN END OF LINE.
      SELECTION-SCREEN BEGIN OF LINE.
        PARAMETERS: p_addr3 LIKE ztsd_mail_add-receiver  MODIF ID h1.
      SELECTION-SCREEN END OF LINE.
      SELECTION-SCREEN BEGIN OF LINE.
        PARAMETERS: p_addr4 LIKE ztsd_mail_add-receiver  MODIF ID h1.
      SELECTION-SCREEN END OF LINE.
      SELECTION-SCREEN BEGIN OF LINE.
        PARAMETERS: p_addr5 LIKE ztsd_mail_add-receiver  MODIF ID h1.
      SELECTION-SCREEN END OF LINE.
      SELECTION-SCREEN BEGIN OF LINE.
        PARAMETERS: p_addr6 LIKE ztsd_mail_add-receiver  MODIF ID h1.
      SELECTION-SCREEN END OF LINE.
    SELECTION-SCREEN: END OF BLOCK direct.
  SELECTION-SCREEN END OF BLOCK mail.
***<<

  SELECTION-SCREEN BEGIN OF BLOCK disp WITH FRAME TITLE TEXT-l01.
    PARAMETERS: alv_def LIKE disvariant-variant.
  SELECTION-SCREEN END OF BLOCK disp.

SELECTION-SCREEN END OF BLOCK bk1.

**add by rong 20181116, for B+B
INCLUDE: zrsd0028bf00.
** end
*-------------------------------------------------------------*
*Selection screen end
*-------------------------------------------------------------*
INITIALIZATION.
  CLEAR g_variant.
* 2012/02/06 Ethan add
*20210512 Polar request
*  s_bsart-sign = 'I'.
*  s_bsart-option = 'EQ'.
*  s_bsart-low = 'RSTO'.
*  APPEND s_bsart.  CLEAR s_bsart.
* 2012/02/06 End

AT SELECTION-SCREEN ON VALUE-REQUEST FOR alv_def.
  PERFORM alv_f4.

  give_range_value 'WE' s_shbi.   "partner func for ship to
  give_range_value 'RE' s_shbi.   "partner func for bill to
  give_range_value 'VE' s_shbi.   "partner func for sales person
*  give_range_value 'Z1' s_shbi.   "TW OP
  give_range_value 'Z2' s_shbi.   "Sales employee 2
*  give_range_value 'Z3' s_shbi.   "Sales employee 3
*  give_range_value 'Z4' s_shbi.   "Sales employee 4
** Add By Hermit 2005/11/03
  give_range_value 'ZM' s_shbi. "employee id
  give_range_value 'EM' s_shbi. "end customer

  give_range_value 'VE' sto_parvw. " ship to party
  give_range_value 'WE' sto_parvw. " sales person
  give_range_value 'VE' sto_parvw. "partner func for sales person
** Add By Hermit 2005/11/03
  give_range_value 'ZM' sto_parvw. "employee id

*  give_range_value 'VE' s_parvw. " ship to party
*  give_range_value 'WE' s_parvw. " sales person
*  give_range_value 'VE' s_parvw. "partner func for sales person

* Add by Ted 2005/09/27 ()
  this_month = sy-datum.
  IF this_month+6(2) = '01' .
    this_month = this_month - 1 .
  ENDIF.
  this_month = this_month - this_month+6(2) + 1.

  last3_month = this_month - 83.
  last3_month = last3_month - last3_month+6(2) + 1.

  next_month = this_month + 37.
  next_month = next_month - next_month+6(2) + 1.



AT SELECTION-SCREEN.
  IF p_type1 = 'X'.
    IF s_org[] IS INITIAL.
      MESSAGE 'Please Entry Sales org' TYPE 'E'.
    ENDIF.
  ENDIF.
*   IF P_TYPE2 = 'X'.
*    IF S_PORG[] IS INITIAL.
*       MESSAGE 'Please Entry Purchasing org' TYPE 'E'.
*    ENDIF.
* ENDIF.

  IF p_cur2 <> space.
    IF p_waers = space.
      MESSAGE i208 WITH TEXT-m03.
      SUBMIT zrsd0028b VIA SELECTION-SCREEN.
    ENDIF.
  ENDIF.

  IF p_sts1 = space AND p_sts2 = space AND
     p_sts3 = space AND p_sts4 = space.
    MESSAGE i208 WITH TEXT-m04.
    SUBMIT zrsd0028b VIA SELECTION-SCREEN.


  ENDIF.

AT SELECTION-SCREEN OUTPUT.
  PERFORM modify_screen.
**********  add by Siva begin, 2021/08/12 ****************

*** Xuan.Kao 20230522 Send Email format for P000-Start ***
  LOOP AT SCREEN.
    IF ( sy-sysid = 'RDP' ) AND ( sy-uname <> 'IT01.ACL' ).
      IF screen-name = 'P_MAILP'.
        screen-active = '0'.
      ENDIF.
    ENDIF.
    MODIFY SCREEN.
  ENDLOOP.
*** Xuan.Kao 20230522 Send Email format for P000-End ***

  PERFORM dropdown_fill.

START-OF-SELECTION.

  PERFORM authority-check.
**********  add by Ted.Tsao begin, 2008/11/26 ****************
  newold = 'Y'.

  REFRESH qtime.
  CLEAR qtime.
  qtime-xdesc = 'begin' .
  qtime-xdate = sy-datum.
  qtime-xtime = sy-uzeit.
  APPEND qtime.
  CLEAR: tmpchr, tmpf2, tmpf3.
  SELECT SINGLE ctrl_ref1 ctrl_ref2 ctrl_ref3
    INTO (tmpchr, tmpf2, tmpf3)
    FROM zctrl
    WHERE ctrl_cate = 'ZRSD28B'
  AND ctrl_no = 'yesno' .
  IF sy-subrc = 0.
    IF newold = 'Y'.     "
      IF tmpchr = 'N'.
        newold = 'N'.  "  run
      ELSE.
        newold = tmpchr.
      ENDIF.
    ENDIF.
  ENDIF.
**********  add by Ted.Tsao end, 2008/11/26 ****************

  PERFORM check_input. "rong 20200217

  REFRESH:  i2, it001, s_ebelnn, a1.
  CLEAR: a1, it001, s_ebelnn, i1, i2, a1, g_s1,
         g_s2, g_s3, g_s4.
  PERFORM set_criteria_value.

  PERFORM get_data.
*  20050418 HANS MODIFIED START.
  PERFORM process_data_hans.
*  20050418 HANS MODIFIED END.

* BEGIN TICKET 11889 : GET EXTERNAL NOTE
  PERFORM get_external_note.
* END TICKET 11889 : GET EXTERNAL NOTE

  PERFORM printtime.
* 20170714 by daniel add download to server for akmc pmc platform
  IF NOT a1[] IS INITIAL  AND r_server = 'X' AND
   ( sy-uname = 'DDIC' OR sy-uname = 'IT01.CN' OR sy-uname = 'EUEDI01' OR sy-uname = 'IT03.ADLOG' OR sy-uname = 'EUIT01' OR sy-uname = 'IT01.ACL' ).
    REFRESH:d1.
    CLEAR  :d1.
    LOOP AT a1.
      MOVE-CORRESPONDING a1 TO d1.
      APPEND d1.
      CLEAR  d1.
    ENDLOOP.
    PERFORM download_data USING p_file1.
    "double add for ctos AOP so shortage on 20241101
    IF s_org-low = 'CN10' AND p_sts1 <>  space.
      PERFORM  process-addontable-data-cn10.
    ENDIF.
  ENDIF.
***
*20210621
  IF NOT a1[] IS INITIAL  AND r_server = 'X' AND p_file1 = '' AND
     ( sy-uname = 'DDIC' OR sy-uname = 'IT01.CN' OR sy-uname = 'EUEDI01' OR sy-uname = 'IT03.ADLOG' OR sy-uname = 'EUIT01' OR sy-uname = 'IT01.ACL' ).
    REFRESH:d9.
    CLEAR  :d9.
    LOOP AT a1.
      MOVE-CORRESPONDING a1 TO d9.
      APPEND d9.
      CLEAR  d9.
    ENDLOOP.
    PERFORM download_data_a USING p_file3.
  ENDIF.
* 20190722 by double add download to table
  IF NOT a1[] IS INITIAL  AND ( r_dn2tb = 'X' OR r_dn2tbr = 'X' OR r_dn2tbg = 'X' OR r_dn2cus = 'X' ) AND  ( sy-uname = 'DDIC' OR sy-uname = 'IT01.CN' OR sy-uname = 'DOUBLE.SUN' OR sy-uname = 'EUEDI01' OR sy-uname = 'IT03.ADLOG' OR sy-uname = 'EUIT01' ).
    REFRESH:d2.
    CLEAR  :d2.
    LOOP AT a1.
      MOVE-CORRESPONDING a1 TO d2.
      APPEND d2.
      CLEAR  d2.
    ENDLOOP.
    PERFORM  process-addontable-data.
  ENDIF.
  "2211208 by double add download to table
  IF NOT a1[] IS INITIAL  AND r_dn2tb8 = 'X' AND  ( sy-uname = 'DDIC' OR sy-uname = 'IT01.CN' OR sy-uname = 'DOUBLE.SUN' OR sy-uname = 'EUEDI01' OR sy-uname = 'IT03.ADLOG' OR sy-uname = 'EUIT01' ).
    REFRESH:d3.
    CLEAR  :d3.
    LOOP AT a1.
      MOVE-CORRESPONDING a1 TO d3.
      APPEND d3.
      CLEAR  d3.
    ENDLOOP.
    PERFORM  process-addontable-data-b8.
  ENDIF.

* Add by jane on 2018/07/31 for download data to >>
  IF NOT a1[] IS INITIAL  AND r_svr2 = 'X' AND  ( sy-uname = 'JANE.ZHANG' OR sy-uname = 'IT01.CN' ).
    PERFORM download-overdue-data USING p_file2.
  ENDIF.
*******************************************************<<

* Add by Timo on 2021/07/15 for download XLSX data to Server>>
  IF NOT a1[] IS INITIAL  AND r_svr3 = 'X' AND  ( sy-uname = 'DDIC' OR sy-uname = 'IT01.CN' OR sy-uname = 'DOUBLE.SUN' OR sy-uname = 'EUEDI01' OR sy-uname = 'IT03.ADLOG' OR sy-uname = 'EUIT01' ).
    PERFORM download_aeu_backlog USING p_file4.
  ENDIF.
*******************************************************<<
* Add by jane on 2018/08/08 for send mail>>
  IF r_mail1 = 'X'.
    PERFORM send-mail-overdue.
  ENDIF.
*****************************************<<
**Add by rong on 20181104, display total data if layout is  '/B+B LINE'
  IF alv_def = '/B+B LINE' OR alv_def = '/B+B SH LINE'  OR r_mailb = 'X' .
    PERFORM process_total_data.
  ENDIF.
** end
**add bt rong on 20200131,add send email to sales
  IF r_mails = 'X'.

  ENDIF.
**end

* Add by jane on 20220526
  IF NOT a1[] IS INITIAL  AND r_svr6 = 'X'.
    PERFORM down_material_gp.
  ENDIF.
**end
  DATA: i TYPE i VALUE 1.
** change by xiujie
  IF NOT a1[] IS INITIAL.
    IF sy-batch = 'X' AND ( sy-slset = 'US_GPBLOCK' OR sy-slset = 'US_GPBLCK_DIST' OR sy-slset = 'ZANA_HAYDENT' )." AND alv_def = 'ZUS_GP_BLOCK' .  "add by rong 20220128
      PERFORM send_email_variant.
    ENDIF.
    IF r_mailb = 'X' OR  r_mails = 'X' OR  r_mailm = 'X'OR r_maild = 'X'.
      IF r_mailb = 'X'.
        PERFORM send_mail_to_bb.
      ENDIF.
      IF r_maild = 'X'.
        PERFORM send_mail_to_dn.
      ENDIF.
      IF r_mails = 'X' OR  r_mailm = 'X'.
        CLEAR mail_result. REFRESH mail_result.
        IF r_mailm = 'X'.
          PERFORM process_email_sales_data USING 'O'.
          PERFORM send_mail_to_sales USING 'O'.
        ENDIF.
        IF r_mails = 'X'.
          PERFORM process_email_sales_data USING 'VE'.
          PERFORM send_mail_to_sales USING 'VE'.
          PERFORM process_email_sales_data USING 'ZV'.
          PERFORM send_mail_to_sales USING 'ZV'.
        ENDIF.
        LOOP AT mail_result.
          WRITE mail_result-message.
        ENDLOOP.
      ENDIF.
    ELSE.
      PERFORM write_data.
    ENDIF.
  ELSE.
    MESSAGE i208 WITH TEXT-m02.
*    SUBMIT sy-repid VIA SELECTION-SCREEN.
    SUBMIT zrsd0028b VIA SELECTION-SCREEN.

  ENDIF.

***20230630 P000-Start ***
  IF ( a1[] IS NOT INITIAL ) AND ( p_mailp = 'X' ).
    CLEAR: mail_p000, mail_p000[].
    CLEAR: mail_reclist, mail_reclist[].
    CLEAR: mail_filename.

    LOOP AT a1.
      MOVE-CORRESPONDING a1 TO mail_p000.

      CLEAR: atpdsx,atpdsx[].
      CLEAR: l_atpcs,l_atpcs[],p_atpca.

      l_atpcs-matnr  = a1-matnr.
      l_atpcs-werks  = a1-werks.
      l_atpcs-berid  = a1-werks.
      l_atpcs-prreg  = 'A'.
      l_atpcs-chmod  = 'EXP'.
      l_atpcs-delkz  = 'VC'.
      l_atpcs-bdter  = sy-datum.
      l_atpcs-xline  = '1'.
      l_atpcs-trtyp  = 'A'.
      l_atpcs-idxatp = '1'.
      l_atpcs-resmd  = 'X'.
      l_atpcs-chkflg = 'X'.

      p_atpca-anwdg  = '8'.
      p_atpca-anwdg_orig = 'A'.
      p_atpca-azerg  = 'T'.
      p_atpca-rdmod  = 'A'.
      p_atpca-xenqmd = 'N'.

      APPEND l_atpcs .

      l_atp   = 0.
      SELECT SINGLE * FROM marc
       WHERE matnr = a1-matnr AND werks = a1-werks.
*
      IF marc-mtvfp <> ''.
        CALL FUNCTION 'AVAILABILITY_CHECK_S4'
          TABLES
            p_atpcsx = l_atpcs
            p_atpdsx = atpdsx
          CHANGING
            p_atpca  = p_atpca     "ANWDG, AZERG, PLAUF RDMOD
          EXCEPTIONS
            error    = 1
            OTHERS   = 2.
        IF sy-subrc = 0.
          DELETE atpdsx WHERE atpab <> 2.
          DELETE atpdsx WHERE qty = 0.
          LOOP AT atpdsx WHERE atpab <> '50'.
            l_atp   = l_atp + atpdsx-qty.
          ENDLOOP.
        ENDIF.
        mail_p000-slabst = l_atp.
      ENDIF.
      SELECT SINGLE dispo INTO mail_p000-dispo
          FROM marc
         WHERE matnr = a1-matnr
           AND werks = a1-werks.
      APPEND mail_p000.

    ENDLOOP.

    LOOP AT mail_p000.
      mail_reclist-rec_type = 'U'.

      SELECT SINGLE usrid_long INTO mail_reclist-receiver
        FROM pa0105
       WHERE pernr = mail_p000-ipernr
         AND usrid_long LIKE '%@%'
         AND subty = 'MAIL'.
      IF sy-subrc = 0.
        APPEND mail_reclist.
      ENDIF.

      SELECT SINGLE usrid_long INTO mail_reclist-receiver
        FROM pa0105
       WHERE pernr = mail_p000-empid
         AND usrid_long LIKE '%@%'
         AND subty = 'MAIL'.
      IF sy-subrc = 0.
        APPEND mail_reclist.
      ENDIF.

      SELECT SINGLE usrid_long INTO mail_reclist-receiver
        FROM pa0105
       WHERE pernr = mail_p000-pernr_zv
         AND usrid_long LIKE '%@%'
         AND subty = 'MAIL'.
      IF sy-subrc = 0.
        APPEND mail_reclist.
      ENDIF.

      SELECT SINGLE usrkey INTO mail_reclist-receiver
        FROM t024d
       WHERE werks = 'TWH1'
         AND dispo = mail_p000-blatt
         AND usrkey LIKE '%@%'.
      IF sy-subrc = 0.
        APPEND mail_reclist.
      ENDIF.

      SELECT SINGLE usrkey INTO mail_reclist-receiver
        FROM t024d
       WHERE werks = 'TWH1'
         AND dispo = mail_p000-dispo
         AND usrkey LIKE '%@%'.
      IF sy-subrc = 0.
        APPEND mail_reclist.
      ENDIF.
    ENDLOOP.

    CLEAR: lt_ztmm_15, lt_ztmm_15[].
    SELECT smtp_addr INTO CORRESPONDING FIELDS OF TABLE lt_ztmm_15
      FROM ztmm_15
     WHERE zmalgp = 'ZRSD28B-P000'.
    LOOP AT lt_ztmm_15.
      mail_reclist-receiver = lt_ztmm_15-smtp_addr.
      mail_reclist-rec_type = 'U'.
      APPEND mail_reclist.
      CLEAR: mail_reclist.
    ENDLOOP.
    SORT mail_reclist BY receiver.
    DELETE ADJACENT DUPLICATES FROM mail_reclist COMPARING ALL FIELDS.

    CONCATENATE 'Sales Order Backlog To P000-' sy-datum '-' sy-uzeit INTO mail_filename.

    CLEAR: mail_text, mail_text[].
    CONCATENATE 'SOLD-TO '     '|'
                'SOLD-TO NAME' '|'
                'SO'           '|'
                'SO ITEM'      '|'
                'Material'     '|'
                'Unbilled Qty' '|'
                'Unbilled Amt' '|'
                'ATP'          '|'
                'Sales Person' '|'
                'Employee'     '|'
                'SO Notify'    '|'
                'GIP'          '|'
                'ABC'          '|'
            INTO mail_text-line.
    APPEND mail_text.
    CLEAR mail_text.

    LOOP AT mail_p000.
      CLEAR : l_bill_qty,l_bill_amt,l_atp_qty.
      SHIFT mail_p000-vbeln LEFT DELETING LEADING '0'.
      SHIFT mail_p000-posnr LEFT DELETING LEADING '0'.
      SHIFT mail_p000-matnr LEFT DELETING LEADING '0'.
      MOVE  mail_p000-kbmeng TO l_bill_qty.
      MOVE  mail_p000-opamt  TO l_bill_amt.
      MOVE  mail_p000-slabst TO l_atp_qty.
      CONCATENATE mail_p000-kunnr      '|'
                  mail_p000-soldtonm   '|'
                  mail_p000-vbeln      '|'
                  mail_p000-posnr      '|'
                  mail_p000-matnr      '|'
                  l_bill_qty           '|'
                  l_bill_amt           '|'
                  l_atp_qty            '|'
                  mail_p000-isname     '|'
                  mail_p000-vorna      '|'
                  mail_p000-zvname     '|'
                  mail_p000-blatt      '|'
                  mail_p000-maabc      '|'
            INTO mail_text-line.
      APPEND mail_text.
      CLEAR mail_text.
    ENDLOOP.

    CLEAR: mail_footer, mail_footer[].
    mail_footer-line = 'Mail send by ZRSD0028B, Do not reply.'.
    APPEND mail_footer.

*  CONCATENATE 'Sales Order [P000] Backlog' sy-datum+0(4) '/' sy-datum+4(2) '/' sy-datum+6(2) INTO mail_subject.
    mail_subject = 'Action needed for Sales order P000 Backlog'.

    CLEAR: t_header,t_header[].
    t_header-line = 'Warm reminding ~'.
    APPEND t_header.
    t_header-line = 'Please refer to the list of [P000] Sales order Backlog as below, which are pending for action taken to push customer pick up the goods soonest or find new sales order to consume the stock.'.
    APPEND t_header.

    CALL FUNCTION 'Z_SEND_MAIL_HTML'
      EXPORTING
        pi_title         = mail_subject
        pi_dear          = 'Dear Sales team,'
        pi_content1      = ''
        pi_content2      = ''
      TABLES
        pt_mail_receiver = mail_reclist
        pt_text          = mail_text
        pt_header        = t_header
        pt_footer        = mail_footer.

*    PERFORM send_mail_general TABLES mail_p000 mail_reclist USING 'P000' mail_filename.
  ENDIF.

END-OF-SELECTION.

*-------------------------------
*---Authority Check
* Add By Hermit 2010/10/22
*-------------------------------
FORM authority-check.
  DATA : c_msg(48) TYPE c.
  DATA : BEGIN OF itaborg OCCURS 1,
           vkorg LIKE t001w-vkorg,
         END OF itaborg.
  DATA : tplant LIKE t001w OCCURS 0 WITH HEADER LINE.
  l_display_cost = 'X'.
  l_display_gp = 'X'.
  SELECT DISTINCT vkorg FROM t001w INTO TABLE itaborg
         WHERE vkorg IN s_org
  AND vkorg <> ''.
  LOOP AT itaborg.
    AUTHORITY-CHECK OBJECT 'ZR1VBRKVKO'
       ID 'ACTVT' FIELD '03'
       ID 'VKORG' FIELD itaborg-vkorg.
    IF sy-subrc <> 0.
      CONCATENATE 'You do not have authority to run Sales org:'
      itaborg-vkorg INTO c_msg SEPARATED BY space.
      MESSAGE i208 WITH c_msg.
      STOP.
    ENDIF.
    AUTHORITY-CHECK OBJECT 'Z_SD_COST'
      ID 'VKORG' FIELD itaborg-vkorg
      ID 'ACTVT' FIELD '03'.
    IF sy-subrc <> 0.
      l_display_cost = ''.
    ENDIF.
**20240821 dispaly GP information
    AUTHORITY-CHECK OBJECT 'Z_SD_GP'
      ID 'VKORG' FIELD itaborg-vkorg
      ID 'ACTVT' FIELD '03'.
    IF sy-subrc <> 0 AND p_gp = 'X'.
      l_display_gp = ''.
      CONCATENATE 'You do not have authority' 'get GP Infomation' INTO c_msg SEPARATED BY space.
      MESSAGE c_msg TYPE 'I'.
      LEAVE LIST-PROCESSING.
    ENDIF.
  ENDLOOP.


*  SELECT * FROM t001w INTO TABLE tplant
*         WHERE werks IN s_werks
*           AND kunnr <> space
*           AND lifnr <> space.

*  LOOP AT tplant.
*    AUTHORITY-CHECK OBJECT 'ZR1MATEWRK'
*           ID 'ACTVT' FIELD '03'
*           ID 'WERKS' FIELD tplant-werks.
*    IF sy-subrc <> 0.
*      s_werks-sign   = 'E'.
*      s_werks-option = 'EQ'.
*      s_werks-low    = tplant-werks.
*      APPEND s_werks.
*    ENDIF.
**    IF sy-subrc <> 0.
**
**      CONCATENATE 'You do not have authority to run plant:'
**        tplant-werks INTO c_msg SEPARATED BY space.
**      MESSAGE i208 WITH c_msg.
**      STOP.
**    ENDIF.
*  ENDLOOP.


ENDFORM.                    "AUTHORITY-CHECK
*&---------------------------------------------------------------------*
*&      Form  ALV_F4
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM alv_f4 .
  g_variant-report = sy-repid.
  CALL FUNCTION 'REUSE_ALV_VARIANT_F4'
    EXPORTING
      is_variant = g_variant
      i_save     = 'A'
    IMPORTING
      es_variant = g_variant
    EXCEPTIONS
      not_found  = 2.
  IF sy-subrc = 2.
    MESSAGE ID sy-msgid TYPE 'S' NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ELSE.
    alv_def = g_variant-variant.
  ENDIF.

ENDFORM.                                                    " alv_f4

*-----------------------------------------------------------------------
*    FORM PF_STATUS_SET
*-----------------------------------------------------------------------
FORM standard_02 USING  extab TYPE slis_t_extab.
*refresh extab.
*  SET PF-STATUS 'STANDA02' EXCLUDING extab.
  SET PF-STATUS  'STANDARD'  EXCLUDING extab.

ENDFORM.                    "STANDARD_02

*&---------------------------------------------------------------------*
*&      Form  get_data
*&---------------------------------------------------------------------*
FORM get_data .
  DATA: so_lines  TYPE i,
        sto_lines TYPE i.
  IF p_type1 <> space.               "sales order
    PERFORM get_sales_order_data.
  ENDIF.
  IF p_type2 <> space.
    PERFORM get_sto_order_data.
  ENDIF.

  DESCRIBE TABLE it_soview  LINES so_lines.
  DESCRIBE TABLE it_stoview LINES sto_lines.
  IF p_type1 = 'X' AND p_type2 = 'X'.
    IF so_lines = 0 AND sto_lines = 0.
      MESSAGE i208 WITH TEXT-m02.
      LEAVE TO TRANSACTION sy-tcode.

    ENDIF.
  ENDIF.

ENDFORM.                    " get_data
*&---------------------------------------------------------------------*
*&      Form  write_data
*&---------------------------------------------------------------------*
FORM write_data .

  PERFORM assign_alv_title.

  PERFORM fill_zsotext.
*add by poki for layout setting.
  g_variant-report = sy-repid.
  g_variant-variant = alv_def.
*end add

***** prince add for removing zero items.
  DELETE a1
  WHERE werks EQ space
  AND   kbmeng = 0
  AND   opamt = 0.
***** prince add for removing zero items.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      i_callback_program       = sy-repid
      i_callback_pf_status_set = g_status
      i_callback_user_command  = g_user_command
      is_layout                = g_layout
      it_fieldcat              = g_fieldcat
      i_save                   = 'A'
      is_variant               = g_variant
      it_events                = g_events
      is_print                 = g_print
    TABLES
      t_outtab                 = a1
    EXCEPTIONS
      program_error            = 1
      OTHERS                   = 2.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.




ENDFORM.                    " write_data


*TOP-OF-PAGE.
*&---------------------------------------------------------------------*
*&      Form  write_title
*&---------------------------------------------------------------------*
FORM write_title .

*ALV Header declarations
  DATA: t_header      TYPE slis_t_listheader,
        wa_header     TYPE slis_listheader,
        t_line        LIKE wa_header-info,
        ld_lines      TYPE i,
        ld_linesc(10) TYPE c.

  DATA: p_pernrl(8),
        p_pernrh(8),
        p_edatul(10),
        p_edatuh(10).

  IF  NOT s_pernr IS INITIAL.
*When sales person not selected and then dispaly space
    IF s_pernr-low IS INITIAL.
      p_pernrl = space.
    ELSE.
      WRITE s_pernr-low TO p_pernrl RIGHT-JUSTIFIED.
    ENDIF.
    IF s_pernr-high IS INITIAL.
      p_pernrl = space.
    ELSE.
      WRITE s_pernr-high TO p_pernrh RIGHT-JUSTIFIED.
    ENDIF.
  ENDIF.
*SET CRITERIA LINE1 FOR TYPE AND PO NUMBER
*  wa_header-typ = 'S'.
*  CONCATENATE text-s02 p_type1 text-s03 p_type2 INTO wa_header-key
*  SEPARATED BY ' '.
*
*  wa_header-info(3) = text-s04.
*  wa_header-info+7(8) = text-s05.
*  wa_header-info+16(20) = s_bstnk-low.
*  wa_header-info+36(2) = text-t01.
*  wa_header-info+38(20) = s_bstnk-high.
*  APPEND wa_header TO t_header.
*  CLEAR wa_header.

* Type SO or STO
  CLEAR t_line.


  t_line = '    '.
  CLEAR wa_header.
  wa_header-typ = 'S'.
  MOVE TEXT-s02  TO wa_header-key.
  IF p_type1v IS INITIAL.
    CONCATENATE  p_type2v TEXT-s04
    INTO  wa_header-info
    SEPARATED BY ' '.
  ELSEIF p_type2v IS INITIAL.

    CONCATENATE  p_type1v TEXT-s03
      INTO  wa_header-info
      SEPARATED BY ' '.
  ELSE.
    CONCATENATE p_type1v TEXT-s03 t_line p_type2v TEXT-s04
    INTO  wa_header-info
    SEPARATED BY ' '.

  ENDIF.
  APPEND wa_header TO t_header.


* Po number
  IF NOT s_bstnk IS INITIAL.
    CLEAR t_line.
    IF s_bstnk-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.
    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s05.
    CONCATENATE s_bstnk-low t_line s_bstnk-high
      INTO  wa_header-info
      SEPARATED BY space.
    APPEND wa_header TO t_header.
  ENDIF.

*SET CRITERIA LINE2 FOR ORDER TYPE AND SALES ORDER
  IF  NOT s_auart IS INITIAL.
    CLEAR t_line.
    IF s_auart-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s06.

    CONCATENATE s_auart-low t_line s_auart-high
     INTO  wa_header-info
     SEPARATED BY ' '.

*  wa_header-info+1(4) = s_auart-high.
*  wa_header-info+7(12) = text-s07.
*  wa_header-info+20(10) = s_vbeln-low.
*  wa_header-info+31(2) = text-t01.
*  wa_header-info+34(10) = s_vbeln-high.
    APPEND wa_header TO t_header.
    CLEAR wa_header.
  ENDIF.

*  SO number
  IF NOT s_vbeln IS INITIAL.

    CLEAR t_line.
    IF s_vbeln-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.
    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s07.
    CONCATENATE s_vbeln-low t_line s_vbeln-high
      INTO  wa_header-info
      SEPARATED BY space.
    APPEND wa_header TO t_header.
  ENDIF.

  IF NOT p_type2 IS INITIAL.
*SET CRITERIA LINE3 FOR STO TYPE AND STO ORDER
    IF  NOT s_bsart IS INITIAL.
      CLEAR t_line.
      IF s_bsart-high IS INITIAL.
        t_line = ''.
      ELSE.
        t_line = TEXT-t01.
      ENDIF.

      CLEAR wa_header.
      wa_header-typ = 'S'.
      wa_header-key(11) = TEXT-s08.
      CONCATENATE s_bsart-low t_line s_bsart-high
        INTO  wa_header-info
        SEPARATED BY space.

      APPEND wa_header TO t_header.
    ENDIF.
  ENDIF.
*  STO number
  IF NOT s_ebeln IS INITIAL.
    CLEAR t_line.
    IF s_ebeln-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s09.
    CONCATENATE s_ebeln-low t_line s_ebeln-high
      INTO  wa_header-info
      SEPARATED BY space.
    APPEND wa_header TO t_header.
  ENDIF.



*SET URDER LINE
*  CLEAR wa_header.
*  wa_header-typ = 'S'.
*  wa_header-key = '____________________'.
*  wa_header-info =
*  '____________________________________________________________'.
*  APPEND wa_header TO t_header.


*set criteria line 4 for delivery date
  CLEAR wa_header.
  IF NOT s_edatu IS INITIAL.
    CONCATENATE s_edatu-low(4) s_edatu-low+4(2) s_edatu-low+6(2)
    INTO p_edatul SEPARATED BY '/'.

    IF NOT s_edatu-high IS INITIAL.
      CLEAR  p_edatuh.
      CONCATENATE s_edatu-high(4) s_edatu-high+4(2) s_edatu-high+6(2)
      INTO p_edatuh SEPARATED BY '/'.
      CLEAR t_line.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
* 20050415 Hans modified start .
*  wa_header-key(14) = text-s10.
*  wa_header-info+(10) = p_edatul.
*  wa_header-info+11(2) = text-t01.
*  wa_header-info+14(10) = p_edatuh.
    WRITE TEXT-s10  TO wa_header-key(14).
    WRITE  p_edatul TO wa_header-info(10) .
    WRITE t_line  TO wa_header-info+11(2).
    WRITE  p_edatuh TO wa_header-info+14(10) .
* 20050415 Hans modified end
    APPEND wa_header TO t_header.
    CLEAR wa_header.
  ENDIF.


* currency & exchane rate by jack
  CLEAR wa_header.
  wa_header-typ = 'S'.
*  CONCATENATE text-s11 p_cur1 text-s32 INTO wa_header-key
*  SEPARATED BY space.
  MOVE  TEXT-s11  TO wa_header-key.

* currency & exchane rate by jack
  IF p_cur1 = 'X'.
    CONCATENATE p_cur1v TEXT-s32 p_cur2v TEXT-s34
     INTO wa_header-info
     SEPARATED  BY space.
  ELSEIF p_cur2 = 'X'.
    CONCATENATE p_cur2v TEXT-s33 TEXT-t01 p_waers
     INTO wa_header-info
     SEPARATED BY space.
  ENDIF.
  APPEND wa_header TO t_header.
  CLEAR wa_header.

*status

  CLEAR wa_header.
  wa_header-typ = 'S'.
  MOVE TEXT-s14  TO wa_header-key.

  CONCATENATE p_sts1 TEXT-s15 p_sts2 TEXT-s16
  p_sts3 TEXT-s17 p_sts4 TEXT-s18
  INTO wa_header-info SEPARATED BY space.
  APPEND wa_header TO t_header.
  CLEAR wa_header.

*SET URDER LINE
*  CLEAR wa_header.
*  wa_header-typ = 'S'.
*  wa_header-key = '____________________'.
*  wa_header-info =
*  '____________________________________________________________'.
*  APPEND wa_header TO t_header.
*  CLEAR wa_header.

*set plant
  IF NOT s_werks IS INITIAL.
    CLEAR t_line.
    IF s_werks-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    MOVE TEXT-s19 TO wa_header-key . " SEPARATED BY space.
    CONCATENATE  s_werks-low t_line s_werks-high
    INTO wa_header-info  SEPARATED BY space.
    APPEND wa_header TO t_header.
  ENDIF.

*Storage location and
  IF NOT s_lgort IS INITIAL.
    CLEAR t_line.
    IF s_lgort-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    MOVE TEXT-s20 TO wa_header-key .
    CONCATENATE s_lgort-low t_line  s_lgort-high
    INTO wa_header-info SEPARATED BY space.
  ENDIF.
  APPEND wa_header TO t_header.

*storage bin
  IF NOT s_lgpbe IS INITIAL.
    CLEAR t_line.
    IF s_lgpbe-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    MOVE TEXT-s21 TO wa_header-key .
    CONCATENATE s_lgpbe-low t_line  s_lgpbe-high
    INTO wa_header-info SEPARATED BY space.
  ENDIF.
  APPEND wa_header TO t_header.


*material
  IF NOT s_matnr IS INITIAL.
    CLEAR t_line.
    IF s_lgpbe-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s31.
    wa_header-info(18) = s_matnr-low.
    wa_header-info+19(2) = t_line.
    wa_header-info+22(10) = s_matnr-high.
    APPEND wa_header TO t_header.
    CLEAR wa_header.
  ENDIF.

*SET URDER LINE
*  CLEAR wa_header.
*  wa_header-typ = 'S'.
*  wa_header-key = '____________________'.
*  wa_header-info =
*  '____________________________________________________________'.
*  APPEND wa_header TO t_header.
*  CLEAR wa_header.

*sold to party and user id
  IF NOT s_kunag IS INITIAL.
    CLEAR t_line.
    IF s_kunag-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s22.
    wa_header-info(10) = s_kunag-low.
    wa_header-info+11(2) = t_line.
    wa_header-info+14(10) = s_kunag-low.
    APPEND wa_header TO t_header.
  ENDIF.

*user id
  IF NOT s_ernam IS INITIAL.
    CLEAR wa_header.
    CLEAR t_line.
    IF s_ernam-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    wa_header-typ = 'S'.
    wa_header-key = TEXT-s23.
    wa_header-info(12) = s_ernam-low.
    wa_header-info+13(2) = t_line.
    wa_header-info+15(12) = s_ernam-high.
    APPEND wa_header TO t_header.
  ENDIF.

*Ship to party
  IF NOT s_kunnr IS INITIAL.
    CLEAR wa_header.
    CLEAR t_line.
    IF s_kunnr-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s24.
    wa_header-info(10) = s_kunnr-low.
    wa_header-info+11(2) = t_line.
    wa_header-info+13(12) = s_kunnr-low.
    APPEND wa_header TO t_header.
  ENDIF.

*Shipping condition
  IF NOT s_vsbed IS INITIAL.
    CLEAR wa_header.
    CLEAR t_line.
    IF s_vsbed-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s25.
    wa_header-info(2) = s_vsbed-low.
    wa_header-info+3(2) = t_line.
    wa_header-info+5(2) = s_vsbed-low.
    APPEND wa_header TO t_header.
    CLEAR wa_header.
  ENDIF.
*sales office
  IF NOT s_vkbur IS INITIAL.
    CLEAR wa_header.
    CLEAR t_line.
    IF s_vkbur-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s26.
    CONCATENATE s_vkbur-low t_line  s_vkbur-high
     INTO wa_header-info SEPARATED BY space.
    APPEND wa_header TO t_header.
  ENDIF.
*sales group
  IF NOT s_vkgrp IS INITIAL.
    CLEAR wa_header.
    CLEAR t_line.
    IF s_vkgrp-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s28.
    CONCATENATE s_vkgrp-low t_line  s_vkgrp-high
      INTO wa_header-info SEPARATED BY space.
    APPEND wa_header TO t_header.
  ENDIF.


*product group
  IF NOT s_prodh2 IS INITIAL.
    CLEAR wa_header.
    CLEAR t_line.
    IF s_prodh2-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s27.
    CONCATENATE s_prodh2-low t_line  s_prodh2-high
      INTO wa_header-info SEPARATED BY space.
    APPEND wa_header TO t_header.
  ENDIF.

* prd. line
  IF NOT s_prodh3 IS INITIAL.
    CLEAR wa_header.
    CLEAR t_line.
    IF s_prodh3-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s29.
    CONCATENATE s_prodh3-low t_line  s_prodh3-high
     INTO wa_header-info SEPARATED BY space.
    APPEND wa_header TO t_header.
  ENDIF.

*sales person
  IF NOT s_pernr IS INITIAL.

    CLEAR t_line.
    IF s_pernr-high IS INITIAL.
      t_line = ''.
    ELSE.
      t_line = TEXT-t01.
    ENDIF.

    CLEAR wa_header.
    wa_header-typ = 'S'.
    wa_header-key = TEXT-s30.
    wa_header-info(8) = p_pernrl.
    wa_header-info+9(2) = t_line.
    wa_header-info+12(8) = p_pernrh.
    APPEND wa_header TO t_header.
  ENDIF.


*SET blank line
  CLEAR wa_header.
  wa_header-typ = 'S'.
  wa_header-key = ' '.
  wa_header-info = ' '.
  APPEND wa_header TO t_header.
  CLEAR wa_header.

  CALL FUNCTION 'REUSE_ALV_COMMENTARY_WRITE'
    EXPORTING
      it_list_commentary = t_header.


ENDFORM.                    " write_title
*&---------------------------------------------------------------------*
*&      Form  assign_alv_title
*&---------------------------------------------------------------------*
FORM assign_alv_title .
  g_layout-colwidth_optimize = 'X'.
  g_title = sy-title.
  REFRESH: g_sort.
  alv_sort 'SEQNO'  'UL'.
  CLEAR: gt_fieldcat.
  REFRESH: g_fieldcat,gt_fieldcat.
***************************************************
***************************************************
*  alv_title_field 'WERKS' 'T001W'  space 'X' .
*  alv_title_field 'MATNR' 'MARA' space .
*   alv_title_field 'LGORT' 'VBAP'  space 'X' .
  alv_title_field 'WAERK' 'VBAP' space  ''.
*  alv_title_field 'KOMAT' 'VBAP' space  ''.
  alv_title_field 'VTWEG' 'VBAK' space  ''.  "add by rong,20201218
  alv_title_field 'SPART' 'VBAK' space  ''.  "add by rong,20201218

  alv_title_field 'VBELN' 'VBAK' space  'X'.
*  alv_title_field 'BSTNK' 'VBAK' space 'X'.
  alv_title_field 'EBELN' 'EKKO' space  'X'.
  alv_title_field 'POSNR' 'VBAP' space  'X' .
  alv_title_field 'UEPOS' 'VBAP' space  'X' .

  "---20251118 HW
  alv_title_field 'ZZCARR'      'VBAK' space  '' .
  alv_title_field 'ZZCARR_TYPE' 'VBAK' space  '' .
  alv_title_field 'ZZCOLL'      'VBAK' space  '' .
  alv_title_field 'ZZPAYER'     'VBAK' space  '' .
  alv_title_field 'ZZCHARGE'    'VBAK' space  '' .
  alv_title_field 'ZZINSURANCE' 'VBAK' space  '' .
  alv_title_field 'ZZPDETAIL'   'VBAK' space  '' .
  alv_title_field 'ZZCOLSHPACT' 'VBAK' space  '' .


  alv_desc_field 'SCHLINE' 'Sch. Line' ''.

  alv_title_field 'PSTYV' 'VBAP' space  ''.
  alv_title_field 'PSTYP' 'EKPO' space  ''.

*  alv_desc_field 'VBELN' 'Sales Doc.'  space  .
***unmark by Hermit Cho 10/20/2005
  alv_desc_field 'BSTNK' 'Customer PO' space   .
  alv_desc_field 'BSTDK' 'Customer PO Date' space.              " Xuan.Kao 20190910 Customer PO Date
  alv_desc_field 'BSTKD' 'Item Customer PO' space.          "20081215
  alv_desc_field 'BSTKD_E' 'Ship to Customer PO' space.     "20090819
  alv_desc_field 'IHREZ_E' 'Ship to your reference' space.  "20090819


*  alv_desc_field 'POSNR' 'SO Item'    space  .
***********
*  alv_desc_field 'KUNNR' 'Customer ID'  space   .
*  alv_desc_field 'SORTL' 'Search Term'  space   .
*  alv_desc_field 'MATNR' 'Material'    space   .

*  alv_title_field 'KUNNR' 'VBAK' space  ''.
  alv_desc_field 'SORTL' 'Search Term'  space   .
  alv_desc_field 'KATR4' 'ATTR 4'  space   .
  alv_title_field 'MATNR' 'VBAP' space  ''.
  alv_title_field 'KDMAT' 'VBAP' space  ''.

***********************


*  alv_desc_field 'MTART' 'Material Type'  '' .
*  alv_desc_field 'MSTAV' 'Material Status'  space  .
*  alv_desc_field 'SOBSL' 'Special procurement'  space .
*  alv_desc_field 'PLIFZ' 'delivery LT time' '' .
*  alv_desc_field 'LADGR' 'Loading Group'    '' .
*  alv_desc_field 'AUART' 'Sales Document Type'  '' .
*  alv_desc_field 'VKORG' 'Sales Org'    '' .
*  alv_desc_field 'VBTYP' 'SD Document Cat.'  '' .
*  alv_desc_field 'KUNNR' 'Sold to Party'     '' .
*  alv_desc_field 'SHIPTO' 'Ship to Party'    '' .
*  alv_desc_field 'BILLTO' 'Bill to Party'    '' .
*  alv_desc_field 'VSBED' 'Shipping cond.'    'X' .


  alv_desc_field 'OTYPE' 'Order Type'   ''.
  alv_title_field 'MTART' 'MARA' space  ''.
  alv_title_field 'MSTAV' 'MARA' space  ''.
  alv_title_field 'SOBSL' 'MARC' space  ''.
  alv_title_field 'PLIFZ' 'MARC' space  ''.
  alv_title_field 'LADGR' 'MARC' space  ''.
  alv_title_field 'AUART' 'VBAK' space  ''.
  alv_title_field 'WERKS' 'T001W'  space '' .
  alv_title_field 'LGORT' 'VBAP'  space '' .
** add by Hermit 2006/08/31
  alv_title_field 'MAABC' 'MARC'  space '' .
**add by rong 20190815
  alv_desc_field  'D_AUDAT' 'Reference Date' space.
**end

  alv_title_field 'EISBE' 'MARC' space  '' .


***Add By Hermit 2005/07/08
  alv_desc_field  'SPLANT' 'Delv/Supply Plant' ''.
  alv_desc_field  'SLGORT' 'Issue Stor Loc' ''.
  alv_desc_field 'SLGPBE' 'Issue Bin' ''.
****
  alv_title_field 'VKORG' 'VBAK' space  ''.
  alv_title_field 'VBTYP' 'VBAK' space  '' .

  alv_desc_field 'KUNNR' 'Sold to Party'     '' .
  alv_desc_field 'SHIPTO' 'Ship to Party'    '' .
*add by rong 20181002 ,Require from Syliva
  alv_desc_field 'COUNTRY_SHIP' 'Ship_to Country '    '' .
  alv_desc_field 'CITY_SHIP'    'Ship_to City'    '' .
  alv_desc_field 'REGION_SHIP'  'Ship_to State'    '' .
  alv_desc_field 'POST_SHIP'    'Ship_to zip'    '' .
  alv_desc_field 'STREET_SHIP'  'Ship_to street 1'    '' .
**end rong
  alv_desc_field 'BILLTO' 'Bill to Party'    '' .
  alv_desc_field 'ENDCUST' 'End Customer'    '' .

*** Add by Hermit 2005/11/17 for EU request
  alv_desc_field 'SOLDTONM' 'Sold to Party Desc.'     '' .
  alv_desc_field 'SHIPTONM' 'Ship to Party Desc.'    '' .
  alv_desc_field 'BILLTONM' 'Bill to Party Desc'    '' .
  alv_desc_field 'ENDCUSTNM' 'End Customer Desc'    '' .

  alv_title_field 'VSBED' 'VBAK' space  ''.
  alv_desc_field 'SHIP_DESC' 'Shipping cond.'    '' .
*******************

********************

*  alv_desc_field 'VKBUR' 'Sales Office'      '' .
*  alv_desc_field 'VKGRP' 'Sales Group'       '' .
*  alv_desc_field 'PRODH' 'Product hierarchy' '' .
*  alv_desc_field 'ROUTE' 'Route'             '' .

  alv_title_field 'VKBUR' 'VBAK' space  ''.
  alv_title_field 'VKGRP' 'VBAK' space  ''.
  alv_title_field 'PRODH' 'VBAP' space  ''.
  alv_title_field 'ROUTE' 'VBAP' space  ''.

*********************

  alv_desc_field 'PRODH2' 'Prd. Group' space .
  alv_desc_field 'PRODH3' 'Prd. Line' space .
*  alv_desc_field 'BISMT'  'Article' space .
  alv_title_field 'BISMT'  'MARA' space  ''.
  alv_title_field 'BRSCH'  'KNA1' space  ''.
  alv_desc_field  'OEDATU' 'Order Date'    space .
  alv_desc_field  'ONDOCKDT' 'On Dock Date'    space .
* Chris 2011/06/14
  alv_total_field 'VDATU'  'Req.Delv Date' space ''.

  alv_desc_field  'REDATU' 'Request Date'   space .
  alv_desc_field  'CEDATU' 'Confirm Date' space .
*** Add By Hermit 2006/04/04
  alv_desc_field  'FIRSTDELV' '1st Delv Date'   space .
  alv_desc_field  'FIRSTMATV' '1st Material Avail Date' space .
***end of Add
  alv_desc_field  'BLOGDT' 'Backlog Date' space .
  alv_title_field 'MBDAT'  'EKET' space '' .
  alv_qty_field   'KWMENG' 'Order Qty'   space.
***Add By Hermit 2005/07/27
  alv_desc_field  'SCHQTY'  'Sched.Line Qty' space.
***End Add
  alv_qty_field   'KBMENG' 'Unbilling Qty'    'VRKME'.
  alv_qty_field   'WAMNG' 'DN Issued Qty'   space.  "DOUBLE ADD ON 20230208
*** Add By Hermit 2005/07/13
  alv_desc_field  'BMENG'  'Confirmed Qty' space.
  alv_desc_field  'UNCONFQTY' 'Unconfirmed Qty' space.
** Add By Hermit 2006/05/25
  alv_desc_field  'AVAILQTY' 'Available QTY' space.
** add By Hermit 2007/03/30
  alv_desc_field  'LIFSP' 'Item Delivery Block' space.
  alv_desc_field  'ZZ_ABGRU' 'Imperfect Reason Code' space.
  alv_desc_field  'ABGRUX_TEXT' 'Imperfect Reason Text1' space.
  alv_desc_field  'ZZ_ABGRU_TEXT' 'Imperfect Reason Text' space.
  alv_desc_field  'ZZ_REASON' 'Delay Reason Code' space.
  alv_desc_field  'ZZ_REASON_TEXT' 'Delay Reason Text' space.
  alv_desc_field  'DDTEXT' 'Delay Reason Text1' space.
*** End of Add Hermit
  alv_qty_field   'LABST'  'Demand Plant on hand qty' space.
  alv_qty_field   'SLABST'  'Supply plant on hand qty' space.

*  alv_desc_field 'VRKME'  'Unit of Measure' space .
  alv_title_field 'VRKME' 'VBAP' space  ''.
  IF p_waers <> 'TWD'.
*    alv_total_field 'NETPR'  'Unit Price' space 'WAERK'.
    alv_total_field 'NETPR'  'Unit Price' space space.

*    alv_total_field 'OPAMT'  'Unbilling Amount' space 'WAERK'.
    alv_total_field 'OPAMT'  'Unbilling Amount' space space.
    IF l_display_cost = 'X'.  "20231012 rong
      alv_total_field 'ZPI01'  'PI01 Price' space 'WAERK'.
    ENDIF.
    alv_total_field 'ZPI01AMT'  'Unbilling PI01Amt' space 'WAERK'.
*    alv_total_field 'ODNAMT' 'Sch. Already DN Amt' space 'WAERK' .
    alv_total_field 'ODNAMT' 'Sch. Already DN Amt' space space.
*    alv_total_field 'UNCNFAMT'  'Unconfirmed Amount' space 'WAERK'.
    alv_total_field 'UNCNFAMT'  'Unconfirmed Amount' space space.
*    alv_total_field 'DNAMT' 'un-DN Amt' space 'WAERK'.
    alv_total_field 'DNAMT' 'un-DN Amt' space space.
*    alv_total_field 'ADNAMT' 'DN Amt' space 'WAERK'.
    alv_total_field 'ADNAMT' 'DN Amt' space space.

  ELSE.
    alv_desc_field 'NETPR'  'Unit Price' space.
    alv_desc_field 'OPAMT'  'Unbilling Amount' space.
    IF l_display_cost = 'X'.  "20231012 rong
      alv_desc_field 'ZPI01'  'PI01 Price' space.
    ENDIF.
    alv_desc_field 'ZPI01AMT'  'Unbilling PI01Amt' space.
    alv_desc_field 'ODNAMT' 'Sch. Already DN Amt' space.
    alv_desc_field 'UNCNFAMT'  'Unconfirmed Amount' space.
    alv_desc_field 'DNAMT' 'un-DN Amt' space.
    alv_desc_field 'ADNAMT' 'DN Amt' space.

  ENDIF.

*  alv_desc_field 'WAERK'  'Currency'      space .

  alv_desc_field 'LIFSK'  'Delivery Block' space .
  alv_desc_field 'VTEXT'  'Delivery Block Descripiton' space .
*  alv_desc_field 'CMGST'  'Credit Block'   space .
  alv_title_field 'CMGST' 'VBUK' space  ''.

  alv_desc_field 'DVBELN' 'Delivery Note'  space .

********************************************
*  alv_desc_field 'LFSTA' 'Delivery Status'  '' .
*  alv_desc_field 'FKSTA' 'Billing Status'   '' .
*  alv_desc_field 'ABSTA' 'Rejection Status' '' .
*  alv_desc_field 'WBSTA' 'Goods Mov Status' '' .
*  alv_desc_field 'KOSTA' 'Picking Status'   '' .

  alv_title_field 'LFSTA'  'VBUP' space '' .
  alv_title_field 'FKSTA'  'VBUP' space  '' .
  alv_title_field 'ABSTA'  'VBUP' space '' .
  alv_title_field 'WBSTA'  'VBUP' space '' .
  alv_title_field 'KOSTA'  'VBUP' space  '' .
*************************************************

  alv_desc_field 'DNCMGST' 'DN Credit Block' space .
  alv_desc_field 'OD_BLOCK' 'DN Credit Block Desc' space .
*  ALV_QTY_FIELD  'LFIMG'  'DN Qty' 'VRKME' .
** Add By Hermit 2005/07/28
  alv_desc_field 'LFIMG' 'Un-DN qty' space .
  alv_desc_field 'DNQTY' 'Sch.Already DN qty' space .
  alv_desc_field 'ADNQTY' 'Already DN qty' space .
  alv_title_field 'ERDAT' 'VBAK'  space '' .
  alv_title_field 'ERZET' 'VBAK'  space '' .
** Add By Hermit 2006/05/25
  alv_desc_field 'AMBDAT' 'Actual Material Avail Date' space .

  alv_desc_field 'STATUS' 'Status' space .
  alv_desc_field 'SNAME'  'Sales Person' space .
  alv_desc_field 'PERNR'  'Sales Person no' space .

  alv_desc_field 'ISNAME'  'Item Sales Person' space.       "090303
  alv_desc_field 'IPERNR' 'Item Person no' space.           "090303

***Add By Hermit 2005/11/03 For EU request
  alv_desc_field 'EMPID'  'Employee ID' space .
  alv_desc_field 'VORNA'  'Employee First Name' space .
  alv_desc_field 'NACHN'  'Employee Last Name' space .
  alv_desc_field 'SMMSTA'  'Supply plant Material status' space .

  alv_desc_field 'PERNR_ZV' 'SO notify person ID' space .
  alv_desc_field 'ZVNAME'   'SO notify person Name' space .

*  alv_desc_field 'Z1NAME'  'TW OP' space .
*  alv_desc_field 'Z1PERNR'  'TW OP Person no' space .
  alv_desc_field 'Z2NAME'   'Sales Employee2' space .
  alv_desc_field 'Z2PERNR'  'Sales Employee2 no' space .
  alv_desc_field 'Z3NAME'   'Z3 Sales Employee 3' space .
  alv_desc_field 'Z3PERNR'  'Z3 Sales Employee 3 no' space .
  alv_desc_field 'ZANAME'   'ZA Revenue split sale 2' space .
  alv_desc_field 'ZAPERNR'  'ZA Revenue split sale 2 no' space .
  alv_desc_field 'ZBNAME'   'ZB Revenue split sale 3' space .
  alv_desc_field 'ZBPERNR'  'ZB Revenue split sale 3 no' space .
  alv_desc_field 'APNAME'   'AP Contact Person' space .
  alv_desc_field 'APPARNR'  'AP Contact Person no' space .
  alv_desc_field 'KATR8'    'Attribute 8' space .
  alv_desc_field 'KATR9'    'Attribute 9' space .           " Xuan.Kao 20160215 SO Head Attribute 9

** add by Hermit 2006/11/20
  alv_desc_field 'ITEMTXT' 'Item Text' space .
  alv_desc_field 'F04TXT'  'STO Item Delivery Text' space . " Xuan.Kao 20231220 STO Item Delivery text
  alv_title_field 'EKORG' 'EKKO'  space '' .

*  alv_desc_field 'Z3NAME'  'Sales Employee3' space .
*  alv_desc_field 'Z3PERNR'  'Sales Employee3 no' space .
*  alv_desc_field 'Z4NAME'  'Sales Employee4' space .
*  alv_desc_field 'Z4PERNR'  'Sales Employee4 no' space .

  alv_desc_field 'VSTAT'  'Print Flag' space .
  alv_desc_field 'OTYPE'  'Order Type' space .
  alv_desc_field 'ERNAM'  'User ID' space .
  alv_desc_field 'SDABW'  'Special processing indicator' space .
***********************************
*  alv_desc_field 'ZTERM'  'Payment Term' space .
*  alv_desc_field 'INCO1'  'INCO Term' space .
*  alv_desc_field 'INCO2'  'Description' space .
  alv_title_field 'ZTERM'  'KNVV' space  '' .
  alv_title_field 'INCO1'  'EKKO' space  '' .
  alv_title_field 'INCO2'  'EKKO' space  '' .
***********************************
***20181115 rong , un-display two field as follow,require from Sylvia
*  alv_total_field 'STPRS'  'Cost of Item' space 'STWAERS'.
*  alv_desc_field 'STWAERS'  'Cost Currency' space .
***20181115 end
************************************
*  alv_desc_field 'BUKRS'   'Company Code' space .
*  alv_desc_field 'WERKS'   'Plant' space .
*  alv_desc_field 'RESWK'   'Supply Plant' space .
*  alv_desc_field 'BZIRK'   'Sales district' space .
  alv_title_field 'BUKRS'  'EKKO' space  '' .
*  alv_title_field 'WERKS'  'LFA1' space  '' .
  alv_title_field 'RESWK'  'EKKO' space  '' .
  alv_title_field 'BZIRK'  'VBKD' space  '' .
********************************************
*  alv_desc_field 'EBELN' 'Order Number' 'X' .
*  alv_desc_field 'EBELP' 'Order Item' 'X' .
*  alv_desc_field 'BSTYP' 'PO doc Cat.' '' .
*  alv_desc_field 'BSART' 'PO doc Typ.' '' .
*  alv_desc_field 'LIFNR' 'Vendor' '' .
*  alv_desc_field 'WAERS' 'PO Curr.' 'X' .
*  alv_desc_field 'MEINS' 'STO Unit' 'X' .
*  alv_desc_field 'PEINH' 'Price Unit' 'X' .
*  alv_desc_field 'ELIKZ' 'PO delivery completed' '' .
*  alv_desc_field 'WEPOS' 'GR Indicator' '' .
*  alv_desc_field 'EREKZ' 'Invoice Indicator' '' .

*  ALV_TITLE_FIELD 'EBELN' 'EKKO' SPACE  '' .
  alv_title_field 'EBELP' 'EKPO' space  '' .
  alv_title_field 'BSTYP' 'EKKO' 'X'  '' .
  alv_title_field 'BSART' 'EKKO' 'X'  '' .
  alv_title_field 'LIFNR' 'EKKO' space  '' .
  alv_title_field 'WAERS' 'EKKO' space  '' .
  alv_title_field 'MEINS' 'EKPO' space  '' .
  alv_title_field 'PEINH' 'EKPO' space  '' .
  alv_title_field 'ELIKZ' 'EKPO' space  '' .
  alv_title_field 'WEPOS' 'EKPO' space  '' .
  alv_title_field 'EREKZ' 'EKPO' space  '' .
*add by poki 20060713
  alv_desc_field 'ODTXT'  'Order Text' space .
** add by Hermit 20070508
  alv_title_field 'AFNAM' 'EKPO' space  '' .
  alv_desc_field 'ZZ_FIRST'  'Orginal first Delv date' space .
  alv_desc_field 'ZZ_MBDAT'  'Orginal first Mat. Avail. date' space .
  alv_desc_field 'COMMIT_DATE' 'First Commit Date' space.
  alv_desc_field 'ZBUFFER' 'P/T Buffers Day' space.
  alv_desc_field 'ZSO_TEXT'  'eQuotn Text' space .
* TOM 2010/11/29
*  alv_desc_field 'G_LABST' 'inventory' space.
*  alv_desc_field 'G_CYKC' 'differences inventory' space.
  alv_total_field 'KBETR'  'PB00 Price' space 'WAERK'.
* Chris 2011/02/01
  alv_total_field 'SMTP_ADDR'  'Sold-to E-MAIL' space ''.
**add by chris 20111213
  alv_desc_field 'ARKTX' 'Material Description' space.
***Add by hermit 20120131
  alv_desc_field 'PRDPLANT' 'Production plant' space.
* chris 20120504
  alv_desc_field 'BLATT' 'GIP code' space.
  alv_desc_field 'ZZ_ZDATU' '1st committed date' space.
* chris 20120716
  alv_desc_field 'ZZ_SDATU' '1st Full ATP' space.
  alv_desc_field 'VSNMR_V' 'Version' space.
  alv_desc_field 'EAIPD' 'EAIPD' space.
  alv_desc_field 'EAIPG' 'EAIPG' space.
* donald 20120808
  alv_desc_field 'ZRNAME' 'Keyin' space.
  alv_desc_field 'ZRPERNR' 'Keyin no' space.
* chris 20120821
  alv_desc_field 'MATNR_OLD' 'ADS old material' space.
* chris 20120830
  alv_desc_field 'EKGRP ' 'Pur.Group For STO' space.                " Xuan.Kao 20150212 Change Word:Pur.GroupPur.Group For STO
  alv_desc_field 'EKGRP_DESC' 'Pur.Group Name For STO' space.       " Xuan.Kao 20211118 Purchasing Group Name For STO
* chris 20121024
  alv_desc_field 'FRGKE ' 'Release Indicator' space.
* chris 20130206
  alv_desc_field 'ZPRDPLC' 'Country of origin' space.       " Xuan.Kao 20151105 Change Word:Country OriginlCountry of origin
  alv_desc_field 'ZMAKTX' 'Material Description(Chinese)' space.    " Xuan.Kao 20151217 Material Description(Chinese)
  alv_desc_field 'ZTRADEMARK' 'Brand' space.                        " Xuan.Kao 20151217 Brand
  alv_desc_field 'EMATN' 'MPN' space.                               " Xuan.Kao 20151217 MPN
  alv_desc_field 'ZEXTERNAL_NOTE' 'External Note' space.   "Ticket 11889
  alv_desc_field 'SEKGRP' 'Purch. Group on Sales Material' space.            " Xuan.Kao 20150212 Material's Purchasing Group on Sales
  alv_desc_field 'SEKGRP_DESC' 'Purch. Group Name on Sales Material' space.  " Xuan.Kao 20150212 Material's Purchasing Group on Sales
  alv_desc_field 'PSOBSL' 'SP Key in Demand Plant' space.                    " Xuan.Kao 20150506 Material's Special procurement in Demand Plant
  alv_title_field 'ZZCAPS' 'MARA' space ''.                                  " Xuan.Kao 20160329 Material CAPS indicator
  alv_desc_field 'SUBSECTOR' 'Sub-Sector' space.                             " Xuan.Kao 20160608 Sub-Sector
  alv_desc_field 'ERDAT_QT' 'Quotation Create Date' space.                   " Xuan.Kao 20160628 Quotation Create Date
  alv_desc_field 'KODAT' 'DN Picking Date' space.                            " Xuan.Kao 20160628 DN Picking Date
  alv_desc_field 'WADAT' 'DN Planned GI Date' space.                         " Xuan.Kao 20160628 DN Planned GI Date
  alv_desc_field 'WADAT_IST' 'DN Actual GI Date' space.                      " Xuan.Kao 20160628 DN Actual GI Date
  alv_desc_field 'SALESNOTE' 'Sales note from customer' space.               " Timo.Rusnjak 20210414 SO Head Shipping Instruction
  alv_desc_field 'SHIPINSTR' 'Shipping instruction' space.               " Timo.Rusnjak 20210414 SO Head Shipping Instruction
  alv_desc_field 'FORWSERV' 'Forwarder Service' space.               " Timo.Rusnjak 20210715 SO Head Forwarder Service
  alv_desc_field 'KONDM' 'Material Pricing Group' space.                     " Xuan.Kao 20161222 Material Pricing Group
  alv_desc_field 'SH_ADRNR' 'Ship to Party Address Code' space.              " Xuan.Kao 20211108 Ship to Party Address Code
*** Xuan.Kao 20181219 SO GP view-Start ***
  IF gp_view = 'X'.
    alv_total_field 'VERPR' 'Cost' space space.
    alv_desc_field 'CURRENTGPTXT' 'Current GP' space.
  ENDIF.
*** Xuan.Kao 20181219 SO GP view-End ***
** rong 20190115
  IF alv_def = '/B+B LINE' OR alv_def = '/B+B SH LINE' .
    alv_desc_field 'LAND1' 'Sold To Country' space.
    alv_desc_field 'REGIO' 'Sold To States' space.
    alv_desc_field 'STOCK_QTY'  'Stock' space.
    alv_desc_field 'AVAI_QTY'   'Availability ' space.
    alv_desc_field 'FIRST_DATE'   'First Date ' space.
  ENDIF.
** rong end
** rong 20190404 add fields from zrsd1440
  alv_desc_field 'ACTION_BY'      'Action By' space.
  alv_desc_field 'NAME_ACTION'    'Action By Whom' space.
  alv_desc_field 'ZREASON'        'Reason Code' space.
  alv_desc_field 'ZREASON_TEXT'   'Reason Code Description ' space.
  alv_desc_field 'ZCOMM_ID'       'Comment ID' space.
  alv_desc_field 'ZCOMM_TEXT'     'Comment Description' space.
  alv_desc_field 'ZHOLD'          'Order is on hold (Y/N)' space.
  alv_desc_field 'DATAB'          'Start Date ' space.
**end 20190404
* donald 20141028
  alv_desc_field 'REPRATE' 'Rep Rate' space.
* donald 20150330
  IF l_display_cost = 'X'.                                  "20231012
    alv_total_field 'GP'  'GP%' space space.
  ENDIF.
  REFRESH g_events. CLEAR g_events.
* chris 20140703
  alv_desc_field 'ZEKVBD' 'Buying Group' space.
  alv_desc_field 'AUTLF'  'Comp dlv.' space.
  alv_desc_field 'BUFF'   'BUFF' space.
  alv_desc_field 'PRDNOTE' 'Production note' space.
* rong 20200326
  alv_desc_field 'EADDRESS1' 'Contact email 1' space.
  alv_desc_field 'EADDRESS2' 'Contact email 2' space.
  alv_desc_field 'EADDRESS3' 'Contact email 3' space.
* 20200525
  alv_desc_field 'ZZ_CDATU'  'Cst Req. Date' space.
* AEU-SAP 20230713
  alv_desc_field 'WOSTATUS'  'WO Status' space.
*20231130
  alv_desc_field 'MVGR2'  'SHTC' space.
**20240819 rong add
  IF p_gp = 'X' AND l_display_gp = 'X'.
    alv_desc_field 'GPDATE'  'GP Date' space.
    alv_desc_field 'MINGPTXT'  'MinGP' space.
    alv_desc_field 'COST'  'ExtCost' space.
    alv_desc_field 'CURRENTGPTXT2'  'Current GP' space.
  ENDIF.

  alv_desc_field 'DSNAM' 'MRP Name(STO)' space.  "DOUBLE ADD ON 20250306
  alv_desc_field 'ABTNR' 'Department' space.                "20250815
  REFRESH g_events. CLEAR g_events.

*hans add.
  PERFORM event_init USING g_events[].

ENDFORM.                    " assign_alv_title
*&---------------------------------------------------------------------*
*&      Form  set_criteria_value
*&---------------------------------------------------------------------*
FORM set_criteria_value .
  DATA: p_ebeln(10) TYPE n.

  IF p_sts1 <> space.
    p_sts1 = 'V'.       "not yet DN
    g_s1 = c_v01.       "for status 1
  ENDIF.

  IF p_sts2 <> space.
    p_sts2 = 'V'.
    g_s2 = c_v02.
  ENDIF.

  IF p_sts3 <> space.
    p_sts3 = 'V'.
    g_s3 = c_v03.
  ENDIF.

  IF p_sts4 <> space.
    p_sts4 = 'V'.
    g_s4 = c_v04.
  ENDIF.

  IF NOT p_type1 IS INITIAL.
    p_type1v = 'V'.
  ENDIF.
  IF NOT p_type2 IS INITIAL.
    p_type2v = 'V'.
  ENDIF.
  IF p_cur1 IS INITIAL.
    p_cur2v = 'V'.
  ELSE.
    p_cur1v = 'V'.
  ENDIF.

*  IF p_cur2 <> space.
*    IF NOT s_werks[] IS INITIAL.
*      SELECT * FROM t001w AS a
*      INNER JOIN t001k AS b ON a~bwkey = b~bwkey
*      INNER JOIN t001 AS c ON b~bukrs = c~bukrs
*      APPENDING CORRESPONDING FIELDS OF TABLE it001
*      WHERE werks IN s_werks.
*    ELSE.
*      SELECT * FROM t001w AS a
*      INNER JOIN t001k AS b ON a~bwkey = b~bwkey
*      INNER JOIN t001 AS c ON b~bukrs = c~bukrs
*      APPENDING CORRESPONDING FIELDS OF TABLE it001.
*    ENDIF.
*  ENDIF.

*to convert po number
  IF p_type2 <> space AND NOT s_bstnk[] IS INITIAL.
*   Hans added start..
    LOOP AT s_bstnk.
      MOVE-CORRESPONDING s_bstnk TO s_ebelnn.
      APPEND s_ebelnn.
    ENDLOOP.
  ENDIF.

  SORT s_ebelnn BY sign option low high.
  DELETE ADJACENT DUPLICATES FROM  s_ebelnn
  COMPARING ALL FIELDS .

*  Hans added end .


ENDFORM.                    " set_criteria_value
*&---------------------------------------------------------------------*
*&      Form  convert_amt
*&---------------------------------------------------------------------*
FORM convert_amt  USING  p_netpr
                         p_stwaers
                         p_waers
                         order_no
                         order_line
                         ordtype
                         p_pi01
                  CHANGING netpr opamt p_waerk wpi01.

  DATA: u_kursk LIKE vbkd-kursk,
        u_bzirk LIKE vbkd-bzirk,
        us_rate TYPE p DECIMALS 5.  " LIKE vbrk-kurrf.
  DATA : w_amount(18).
  DEFINE convert_local_price_i.
    w_amount = &2.
    CALL FUNCTION 'CURRENCY_AMOUNT_IDOC_TO_SAP'
      EXPORTING
        currency    = &1
        idoc_amount = w_amount
      IMPORTING
        sap_amount  = w_amount.
    &3 = w_amount.
  END-OF-DEFINITION.

*  SO , exchange rate
  CLEAR: u_kursk, u_bzirk.
  SELECT SINGLE auart FROM tvak INTO tvak-auart
  WHERE auart = ordtype.
  IF sy-subrc = 0. "ORDTYPE = 'ZOR'.
    SELECT SINGLE kursk bzirk INTO (u_kursk, u_bzirk)
       FROM vbkd
   WHERE vbeln = order_no
    AND posnr = order_line.

    IF u_kursk IS INITIAL.
      SELECT SINGLE kursk bzirk INTO (u_kursk, u_bzirk)
        FROM vbkd
        WHERE vbeln = order_no
      AND posnr = '000000'.
    ENDIF.
  ELSE.
    SELECT SINGLE wkurs INTO u_kursk
       FROM ekko
    WHERE ebeln = order_no.

  ENDIF.

  IF p_waers <> 'TWD'.
    PERFORM convert_amount_to_idoc USING p_waerk
                                         p_netpr
                                         p_pi01
                                CHANGING netpr wpi01.
  ENDIF.

* 2006/04/25 revised by Hermit
*  PERFORM read_exchange_rate USING 'USD' p_stwaers  SY-DATLO
*                             CHANGING us_rate.
  PERFORM read_exchange_rate USING p_stwaers p_waers   sy-datlo
                             CHANGING us_rate.

  netpr = netpr * us_rate.
  wpi01 = wpi01 * us_rate.
* IF p_waers <> 'TWD'.      " Xuan.Kao 20150402 Disable,Debug Convert Currency=TWD.
  convert_local_price_i p_waers netpr netpr.
  convert_local_price_i p_waers wpi01 wpi01.
* ENDIF.

  opamt = netpr.

  p_waerk  = p_waers.
ENDFORM.                    " convert_amt
*&---------------------------------------------------------------------*
*&      Form  process_so_hans
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_P_DFLAG  text
*----------------------------------------------------------------------*
FORM process_so_hans  CHANGING dflag.
  DATA: p_vstat  LIKE nast-vstat,
        p_lfimg  LIKE lips-lfimg,
        p_bqty   LIKE lips-lfimg,
        p_dvbeln LIKE lips-vbeln,
        p_dnqty  LIKE lips-lfimg,
        p_tqty   LIKE lips-lfimg,
        p_posnr  LIKE lips-posnr.
  DATA: ita_vbpa LIKE it_vbpa OCCURS 0 WITH HEADER LINE.
  DATA: l_vbpa_vbeln TYPE vbpa-vbeln.
  DATA: g_factor TYPE p DECIMALS 3.
  DATA: w_del_item TYPE c.
*** Add By Hermit for calculating Confirm qty and unconfirm qty
  DATA : cqty LIKE vbep-bmeng,
         uqty LIKE vbep-bmeng.
*** End Of Add Hermit

  DATA : m_gp LIKE i1-netpr.

*get old material number, material status
  CLEAR mvke.
  SELECT SINGLE * FROM mvke WHERE matnr = i1-matnr
                              AND vkorg = i1-vkorg
*                              AND VKORG = P_VKORG
  AND vtweg = '00'.
  IF NOT mvke-vmsta IS INITIAL.
    i1-mstav = mvke-vmsta.
  ENDIF.
*20231130
  i1-mvgr2 = mvke-mvgr2.
  PERFORM get_so_first_matdate.
***Add By Hermit To get Delv plant and issue stor bin
** First get delv plant and shipping point
** second,get main stor condition from material data
** final step, get stor and bin from main stor. table
  SELECT SINGLE werks vstel lgort kdmat FROM vbap
      INTO (vbap-werks,vbap-vstel,vbap-lgort ,vbap-kdmat)
      WHERE vbeln = i1-vbeln
        AND posnr = i1-posnr
  AND matnr = i1-matnr.

  IF sy-subrc = 0.
    IF vbap-lgort IS INITIAL.
      i1-splant = vbap-werks.
      i1-kdmat = vbap-kdmat.
      "Get main stor condition
      SELECT SINGLE raube FROM mara INTO mara-raube
      WHERE matnr = i1-matnr.
      IF sy-subrc = 0.
        "Get stor loc from main storage condition
        SELECT SINGLE lgort FROM tvkol INTO tvkol-lgort
            WHERE vstel = vbap-vstel
              AND werks = vbap-werks
        AND raube = mara-raube.
        IF sy-subrc = 0.
          SELECT SINGLE lgpbe FROM mard INTO mard-lgpbe
             WHERE matnr = i1-matnr
               AND werks = vbap-werks
          AND lgort = tvkol-lgort.
          IF sy-subrc = 0.
            i1-slgort = tvkol-lgort.
            i1-slgpbe = mard-lgpbe.
          ENDIF.
        ENDIF.
      ENDIF.
    ELSE.
      SELECT SINGLE lgpbe FROM mard INTO mard-lgpbe
         WHERE matnr = i1-matnr
           AND werks = vbap-werks
      AND lgort = vbap-lgort.
      IF sy-subrc = 0.
        i1-slgort = vbap-lgort.
        i1-slgpbe = mard-lgpbe.
      ENDIF.

    ENDIF.
  ENDIF.

*** End of Hermit


***20081215 begin
  READ TABLE it_soview WITH KEY vbeln = i1-vbeln
                                posnr = i1-posnr.
  IF sy-subrc = 0.
    i1-bstkd = it_soview-bstkd.
    i1-bstkd_e = it_soview-bstkd_e.
    i1-ihrez_e = it_soview-ihrez_e.

  ENDIF.
*** 20081215 end

  DATA: objname(70) TYPE c.
  DATA: t_lines LIKE tline OCCURS 0 WITH HEADER LINE.
  DATA: l_tdspras LIKE stxh-tdspras.
*20240307
*  CONCATENATE i1-vbeln i1-posnr INTO objname." separated by space.
  MOVE i1-vbeln TO objname+0.
  MOVE i1-posnr TO objname+10.
  CLEAR: i1-odtxt,l_tdspras.
*20220614 performance tuning
*  SELECT * FROM stxh
  SELECT tdspras INTO l_tdspras FROM stxh
  WHERE tdobject = 'VBBP'
  AND tdname = objname
  AND tdid = 'ZICM'.

    CLEAR t_lines.
    REFRESH t_lines.
    CALL FUNCTION 'READ_TEXT'
      EXPORTING
        id        = 'ZICM'
        language  = l_tdspras "!!! ZH ZF
        name      = objname
        object    = 'VBBP'
      TABLES
        lines     = t_lines
      EXCEPTIONS
        not_found = 1.
    IF sy-subrc = '0'.
      READ TABLE t_lines INDEX 1.
      CONCATENATE i1-odtxt t_lines-tdline INTO i1-odtxt.
    ENDIF.
  ENDSELECT.
*endof poki

*  CLEAR mara.
*  SELECT SINGLE * FROM mara WHERE matnr = i1-matnr.
*  i1-bismt    = mara-bismt.
*  IF i1-mstav = space.
*     i1-mstav =  mara-mstav. " material status
*  ENDIF.

* check ship to party.
*  IF NOT s_kunnr[] IS INITIAL.
*    SELECT SINGLE * FROM vbpa
*    WHERE kunnr IN s_kunnr
*    AND vbeln = i1-vbeln
*    AND parvw = c_sh.
*    IF sy-subrc <> 0.
*      dflag = 'X'. EXIT.
*    ENDIF.
*  ENDIF.

*  IF s_kunnr[] IS INITIAL AND s_pernr[] IS INITIAL.
  REFRESH ita_vbpa.
* get ship to/ bill to party id/sales person.
  SELECT  * FROM vbpa
         INTO CORRESPONDING FIELDS OF TABLE ita_vbpa
         WHERE  vbeln = i1-vbeln
  AND    parvw IN s_shbi.

  LOOP AT ita_vbpa.
* 20211117 fix partner function by item issue  - performance issue
    SELECT SINGLE vbeln INTO l_vbpa_vbeln FROM vbpa
       WHERE vbeln = ita_vbpa-vbeln
         AND posnr = i1-posnr
         AND parvw = ita_vbpa-parvw.
    IF sy-subrc = 0.
      DELETE ita_vbpa WHERE vbeln = ita_vbpa-vbeln
                        AND parvw = ita_vbpa-parvw
                        AND posnr <> i1-posnr.
    ELSE.
      DELETE ita_vbpa WHERE vbeln = ita_vbpa-vbeln
                        AND parvw = ita_vbpa-parvw
                        AND posnr <> '000000'.
    ENDIF.
  ENDLOOP.
* 20210413
  LOOP AT ita_vbpa.
    CASE ita_vbpa-parvw.
      WHEN 'WE'.   "ship to
        i1-shipto = ita_vbpa-kunnr.
**add by rong 20181002, Requrie from Sylvia
        SELECT SINGLE country city1 region post_code1 street
          INTO (i1-country_ship,i1-city_ship,i1-region_ship,i1-post_ship,i1-street_ship)
          FROM adrc WHERE addrnumber = ita_vbpa-adrnr
                      AND date_from <= sy-datlo
                      AND date_to >= sy-datlo
        AND nation = ''.
**add end
      WHEN 'EM'.   "end customer
        i1-endcust = ita_vbpa-kunnr.
        i1-adrnr   = ita_vbpa-adrnr.

      WHEN 'RE'.   "bill to
        i1-billto = ita_vbpa-kunnr.
      WHEN  'VE'.   "sales person
        i1-pernr  = ita_vbpa-pernr.
*      WHEN  'Z1'.   "sales person
*        i1-z1pernr  = ita_vbpa-pernr.
      WHEN  'Z2'.   "sales person
        i1-z2pernr  = ita_vbpa-pernr.
      WHEN  'Z3'.   "sales person
        i1-z3pernr  = ita_vbpa-pernr.
      WHEN  'ZA'.   "sales person
        i1-zapernr  = ita_vbpa-pernr.
      WHEN  'ZB'.   "sales person
        i1-zbpernr  = ita_vbpa-pernr.
** Add By Hermit 2005/11/03
      WHEN 'ZM'.  "Employee id
        i1-empid = ita_vbpa-pernr.
        SELECT vorna nachn FROM pa0002
            INTO (pa0002-vorna,pa0002-nachn)
            WHERE pernr = ita_vbpa-pernr.
        ENDSELECT.
        IF sy-subrc = 0.
          i1-vorna = pa0002-vorna.
          i1-nachn = pa0002-nachn.
        ENDIF.
*      WHEN  'Z3'.   "sales person
*        i1-z3pernr  = ita_vbpa-pernr.
*      WHEN  'Z4'.   "sales person
*        i1-z4pernr  = ita_vbpa-pernr.
    ENDCASE.
  ENDLOOP.

*090303
  CLEAR vbpa.
  SELECT SINGLE * FROM vbpa
  WHERE vbeln = i1-vbeln
    AND posnr = i1-posnr
  AND parvw = 'VE'.

  IF sy-subrc = 0.
    i1-ipernr = vbpa-pernr.
  ELSE.
    CLEAR vbpa.
    SELECT SINGLE * FROM vbpa
     WHERE vbeln =  i1-vbeln
    AND parvw = 'VE'.
    i1-ipernr = vbpa-pernr.
  ENDIF.
**20200214 add by rong
  CLEAR vbpa.
  SELECT SINGLE * FROM vbpa
  WHERE vbeln = i1-vbeln
    AND posnr = i1-posnr
  AND parvw = 'ZV'.

  IF sy-subrc = 0.
    i1-pernr_zv = vbpa-pernr.
  ELSE.
    CLEAR vbpa.
    SELECT SINGLE * FROM vbpa
     WHERE vbeln =  i1-vbeln
    AND parvw = 'ZV'.
    i1-pernr_zv = vbpa-pernr.
  ENDIF.
**20200326 add by rong
  CLEAR vbpa.
  SELECT SINGLE * FROM vbpa
  WHERE vbeln = i1-vbeln
  AND parvw = 'AP'.
  IF sy-subrc = 0.
    i1-apparnr = vbpa-parnr. "Contact Person Number
    CLEAR v_contact.
    SELECT SINGLE * FROM v_contact WHERE kunnr = i1-kunnr AND parnr = vbpa-parnr. "Get Contact Person Name
    CONCATENATE v_contact-name_first v_contact-name_last INTO  i1-apname SEPARATED BY ' '.
    CLEAR t_adr6. REFRESH t_adr6.
    SELECT * INTO TABLE t_adr6 FROM adr6 "SINGLE adr6~smtp_addr
      WHERE addrnumber = vbpa-adrnr
    AND  persnumber = vbpa-adrnp.
    IF sy-subrc = 0.
      LOOP AT t_adr6.
        CASE sy-tabix.
          WHEN 1.
            i1-eaddress1 = t_adr6-smtp_addr.
          WHEN 2.
            i1-eaddress2 = t_adr6-smtp_addr.
          WHEN 3.
            i1-eaddress3 = t_adr6-smtp_addr.
        ENDCASE.
      ENDLOOP.
    ELSE. "else adr6 has no record - this can happen if company address is not assigned to relationship contact person
      SELECT SINGLE * FROM cvi_cust_ct_link WHERE customer_cont EQ vbpa-parnr.
      IF sy-subrc = 0.
        "get business partner ID of contact person
        CALL FUNCTION 'BUPA_NUMBERS_GET'
          EXPORTING
            iv_partner_guid = cvi_cust_ct_link-person_guid
          IMPORTING
            ev_partner      = lv_ap_bp.
        SELECT SINGLE smtp_address INTO i1-eaddress1 FROM but051 WHERE partner1 = i1-kunnr AND partner2 = lv_ap_bp.
      ENDIF.
    ENDIF.
  ENDIF.
** 2012/8/8 Donald <BEGIN> - Get Keyin Person
  CLEAR vbpa.
  SELECT SINGLE * FROM vbpa
  WHERE vbeln =  i1-vbeln
  AND parvw = 'ZR'.

  i1-zrpernr = vbpa-pernr.
** 2012/8/8 Donald <END>
* chris 20140703

  CLEAR adrc.
  SELECT SINGLE * FROM adrc
         WHERE addrnumber = i1-adrnr
              AND date_from <= sy-datlo
  AND date_to >= sy-datlo.
  IF sy-subrc = 0.
    i1-endcustnm = adrc-name1.      "EM name
  ENDIF.

  CLEAR knb1.
  SELECT SINGLE * FROM knb1
  WHERE kunnr = i1-kunnr.
  i1-zekvbd = knb1-ekvbd.
*20180123 buffer order indicator
*1.AOL  : Sales Group : 315, 316,317,318,380
*2.Buffer AOL BUFFER /BUFFER
*( Order Type: ZOR9+ Sold-to party : UUAAESC )
  DATA : l_vapma LIKE vapma.
  IF NOT s_buff IS INITIAL.
    IF i1-vkgrp = '315' OR i1-vkgrp = '316'
    OR i1-vkgrp = '317' OR i1-vkgrp = '318'.
      SELECT SINGLE * INTO l_vapma
      FROM vapma
      WHERE auart = 'ZOR9'
        AND vkorg = i1-vkorg
        AND matnr = i1-matnr
      AND vkgrp = i1-vkgrp.
*        AND kunnr = 'UUAAESC'.
    ELSE.
      SELECT SINGLE * INTO l_vapma
      FROM vapma
      WHERE auart = 'ZOR9'
        AND vkorg = i1-vkorg
      AND matnr = i1-matnr.
    ENDIF.

    IF NOT l_vapma IS INITIAL..
      SELECT SINGLE * FROM vbap
        WHERE vbeln = l_vapma-vbeln AND posnr = l_vapma-posnr
      AND abgru = ''.
      IF sy-subrc = 0.
        i1-buff = 'V'.
      ENDIF.
    ENDIF.
  ENDIF.
***Add By Hermit 2005/11/17 for EU request
  PERFORM get_cust_name USING i1-kunnr i1-shipto i1-billto
                        CHANGING i1-soldtonm
                                 i1-shiptonm
                                 i1-billtonm.

** 2014/09/12 sunny Ship to Party Desc SOShip to
*20210413
  CLEAR vbpa.
  SELECT SINGLE * FROM vbpa
   WHERE vbeln =  i1-vbeln
     AND parvw = 'WE'
  AND posnr = '000000'.
*20210413
  CLEAR vbpa.
  SELECT SINGLE * FROM vbpa
   WHERE vbeln =  i1-vbeln
     AND parvw = 'WE'
  AND posnr = i1-posnr.

  CLEAR adrc.
  SELECT SINGLE * FROM adrc
         WHERE addrnumber = vbpa-adrnr
              AND date_from <= sy-datlo
              AND date_to >= sy-datlo
  AND nation = ''.
  IF sy-subrc = 0.
    i1-shiptonm = adrc-name1.      "EM name
  ENDIF.
** 2014/09/12 sunny


* get search term
  SELECT SINGLE * FROM kna1 WHERE kunnr = i1-kunnr.
  i1-sortl =  kna1-sortl.
  i1-brsch =  kna1-brsch.
  i1-katr4 = kna1-katr4.
  i1-land1 = kna1-land1.
  i1-regio = kna1-regio.

  PERFORM get_sales_name USING i1-pernr i1-sname.
  PERFORM get_sales_iname USING i1-ipernr i1-isname.        "090303

  PERFORM get_sales_name USING i1-z2pernr i1-z2name.
  PERFORM get_sales_name USING i1-z3pernr i1-z3name.
  PERFORM get_sales_name USING i1-zapernr i1-zaname.
  PERFORM get_sales_name USING i1-zbpernr i1-zbname.

  PERFORM get_sales_name USING i1-zrpernr i1-zrname.
  "Keyin Person  Donald 2012/8/8

  PERFORM get_sales_name USING i1-pernr_zv i1-zvname.

***Add By Hermit 2006/11/20
  PERFORM get_on_hand_qty.

***add by Hermit 2007/12/10 get P/T buffer day
  SELECT SINGLE * FROM ztpp_25 WHERE matnr = i1-matnr.
  IF sy-subrc = 0.
    i1-zbuffer = ztpp_25-zbuffer.
  ENDIF.

  CLEAR vbak.
  SELECT SINGLE * FROM vbak
  WHERE vbeln = i1-vbeln.

  i1-katr8 = vbak-zzkatr8.
  i1-katr9 = vbak-zzkatr9.      " Xuan.Kao 20160215 SO Head Attribute 9

**donald 201401030 Rep. Commission Rate
  IF i1-vkorg = 'US01'.
    DATA : v_reprate LIKE konv-kbetr.

    CLEAR v_reprate.
    SELECT SINGLE kbetr INTO v_reprate FROM v_konv_cds
      WHERE knumv = vbak-knumv
        AND kschl = 'ZCM2'
    AND kposn = '000000'.

    IF sy-subrc = 0.
      i1-reprate = v_reprate / 1000.
    ENDIF.

  ENDIF.

***add by Hermit 2008/01/10 get PI01 price
* IF i1-vkorg+0(2) <> i1-werks+0(2).
*** Xuan.Kao 20180802 Debug PI01-Start ***
  DATA: lw_bukrs LIKE tvko-bukrs.
  SELECT SINGLE tvko~bukrs INTO lw_bukrs
    FROM tvko INNER JOIN t001k ON ( tvko~bukrs = t001k~bukrs )
   WHERE tvko~vkorg = i1-vkorg
  AND t001k~bwkey = i1-werks.
  IF sy-subrc <> 0.
*** Xuan.Kao 20180802 Debug PI01-End ***
**Get Pricing Date
    CLEAR vbak.
    SELECT SINGLE * FROM vbak
    WHERE vbeln = i1-vbeln.
    CLEAR v_konv_cds.
    SELECT SINGLE * FROM v_konv_cds
      WHERE knumv = vbak-knumv
        AND kschl = 'PI01'
    AND kposn = i1-posnr.
    IF sy-subrc = 0.
      i1-zpi01 = v_konv_cds-kbetr.
    ENDIF.

  ENDIF.
* net price.
*  i1-netpr = i1-kzwi2 / i1-kwmeng.

  i1-netpr =  i1-netpr /  i1-kpein.

  i1-zpi01 = i1-zpi01 / v_konv_cds-kpein.
* convert amt
  IF p_waers <> space AND p_cur2 <> space.
    IF i1-waerk <> p_waers.

      PERFORM convert_amt USING
      i1-netpr
      i1-waerk
*      I1-STWAERS
                                p_waers
                                i1-vbeln
                                i1-posnr
                                 i1-auart
                                 i1-zpi01
                       CHANGING i1-netpr i1-opamt
                                i1-waerk
                                i1-zpi01.
*      i1-waerk = i1-waers.
    ENDIF.
  ENDIF.

* chris 20121030
  CLEAR p_factor.

  CALL FUNCTION 'CURRENCY_CONVERTING_FACTOR'
    EXPORTING
      currency = i1-waerk
    IMPORTING
      factor   = p_factor.

  IF sy-subrc <> 0.
    p_factor = 1.
  ENDIF.
  i1-netpr = i1-netpr * p_factor.
* chris 20121030

  i1-waers = i1-waerk.

* Order date = document date(VBKA-AUDAT)
  SELECT SINGLE erdat FROM vbak INTO vbak-erdat
  WHERE vbeln = i1-vbeln.
  IF sy-subrc = 0.
    i1-oedatu =  vbak-erdat.     " order date
  ENDIF.
* confirm date ,or request date,
  REFRESH it_vbep.
  SELECT * INTO CORRESPONDING FIELDS OF TABLE it_vbep
   FROM vbep
   WHERE vbeln = i1-vbeln
  AND   posnr = i1-posnr.

  CLEAR : cqty, uqty.
  LOOP AT it_vbep INTO wa_vbep.
    IF NOT wa_vbep-wmeng IS INITIAL.
      i1-redatu =  wa_vbep-edatu.     " request date
    ENDIF.
    IF NOT wa_vbep-bmeng IS INITIAL.
      i1-cedatu =  wa_vbep-edatu.     " confirmed date
    ENDIF.

*   i1-MBDAT = wa_vbep-MBDAT. "material available date
  ENDLOOP.


*assign customer po value to proper field.
  i1-ebeln = i1-bstnk.
  i1-ebelp = i1-posnv.

*set so type
  i1-otype = i1-auart.

**donald 20150330 <<BEGIN>> : add gp for US only
  IF i1-vkorg = 'US01'.
** Caculate GP
    CLEAR : m_gp.

    IF i1-netpr = 0.
      m_gp = 0.
    ELSE.
      IF i1-vkorg+0(2) <> i1-werks+0(2).
        m_gp = ( i1-netpr - i1-zpi01 ) / i1-netpr.
      ELSE.
        m_gp = ( i1-netpr - i1-stprs ) / i1-netpr.
      ENDIF.
      m_gp = m_gp * 100.
    ENDIF.
    MOVE m_gp TO i1-gp.

*** check permission
    AUTHORITY-CHECK OBJECT 'ZR1EINFWRK'
          ID 'WERKS' FIELD 'TWH1'
          ID 'ACTVT' FIELD '03'.
    IF sy-subrc <> 0.
      CLEAR : i1-zpi01, i1-gp.
    ENDIF.
  ENDIF.
**donald 20150330 <<END>>


*select all delivery notes by so, so item
  REFRESH ivbfa.
  CLEAR: vbfa, ivbfa.
  SELECT * FROM vbfa
*  APPENDING CORRESPONDING FIELDS OF TABLE ivbfa
  INTO CORRESPONDING FIELDS OF TABLE ivbfa
  WHERE vbelv = i1-vbeln
    AND posnv = i1-posnr
    AND vbtyp_n = c_j01     "Subs.doc.categ ='J' .
    AND plmin <> space
  ORDER BY vbeln.                                     " Xuan.Kao 20210617 Debug Delivery Note

  p_dnqty = 0.
  g_seq = g_seq + 1.
  g_cnt = g_seq.
  i1-seqno = g_seq.

  REFRESH :i2, i3, ivbep.
  CLEAR : i2, i3, ivbep.
  CLEAR: p_bqty, p_dnqty, p_tqty.
*loop delivery note

  LOOP AT ivbfa WHERE vbelv = i1-vbeln
                  AND posnv = i1-posnr.

    CLEAR: v_vbup_cds, i2.

* select each delivery notes in VBUP
    SELECT SINGLE * FROM v_vbup_cds
    WHERE vbeln = ivbfa-vbeln
    AND posnr = ivbfa-posnn.

*assign delivery status
    IF  sy-subrc = 0.
* Open item : billingitem,status 5 item
* 5 Billed: Billing status = C
* Item categorybilling
      IF v_vbup_cds-fksta = c_c01.
        i2-status = '5'.                                    "5. billed
      ENDIF.
* 5 Billed: billing status = ' ', Goods movement = 'C'.
*  Item categorybilling
      IF  v_vbup_cds-fksta = ' ' AND v_vbup_cds-wbsta = c_c01 .
        i2-status = '5'.
      ENDIF.
* 4 POST: billing status = 'A', Goods movement = 'C'.
      IF  v_vbup_cds-fksta = c_a01 AND v_vbup_cds-wbsta = c_c01 .

        i2-status = c_v04.                                  "4. Post
      ENDIF.
* 3  NOT YET POST: Picking status= C, Good Mov = A or B
      IF  v_vbup_cds-kosta = c_c01
       AND  v_vbup_cds-wbsta = c_a01 OR v_vbup_cds-wbsta = c_b01 .
*       AND  i2-status = space.
        i2-status = c_v03.       "3. Not yet post
      ENDIF.
* 2 Not yet Picked
*      IF  vbup-kosta = c_a01  AND i2-status = space.
*        i2-status = c_v02.       "2. Not yet picked
*      ENDIF.
      IF ( v_vbup_cds-kosta = c_a01  OR v_vbup_cds-kosta = space )
      AND i2-status = space.

        i2-status = c_v02.       "2. Not yet picked
      ENDIF.

    ENDIF.


    CLEAR: ztsd_revise, p_vstat, p_dvbeln, p_lfimg.
    SELECT SINGLE * FROM ztsd_revise
    WHERE vbeln = ivbfa-vbeln.
    IF sy-subrc = 0.
      i1-vstat = 'X'. "printed
    ENDIF.

    CLEAR lips.
*  delivery item quantity
    SELECT SINGLE * FROM lips
    WHERE vbeln = ivbfa-vbeln
    AND posnr = ivbfa-posnn.
    IF sy-subrc = 0.

      p_tqty = p_tqty + lips-lfimg.   " ALL dn qty.
      IF i2-status = '5'.
        p_bqty = p_bqty + lips-lfimg.   "BILLING QUANTITY
      ELSE.
        p_dnqty = p_dnqty + lips-lfimg. "DN QUANTITY(nonbilled)
      ENDIF.
    ENDIF.


    DATA: w_append TYPE c.
    IF i2-status <> '5'.
      CLEAR w_append.
      CASE i2-status.
        WHEN 4.
          IF p_sts4 <>  space.
            w_append = 'X'.
          ENDIF.
        WHEN 3.
          IF p_sts3 <> space .
            w_append = 'X'.
          ENDIF.
        WHEN 2.
          IF p_sts2 <> space.
            w_append = 'X'.
          ENDIF.
      ENDCASE.

      IF w_append = 'X'.

        g_seq     = g_seq + 1.
        i2-seqno  = g_seq.
        i2-vtweg  = i1-vtweg.
        i2-spart  = i1-spart.
        i2-vbeln  = i1-vbeln.
        i2-posnr  = i1-posnr.
        i3-uepos =  i1-uepos.
        i2-matnr  = i1-matnr.
        i2-kunnr  = i1-kunnr.
        i2-vkbur  = i1-vkbur.
        i2-vkgrp  = i1-vkgrp.
        i2-dvbeln = ivbfa-vbeln.
        i2-adnqty  = lips-lfimg.
        i2-vstat  = i1-vstat.
        i2-vrkme  = i1-vrkme.
        i2-adnamt =  i2-adnqty * i1-netpr.
        i2-uepos = i1-uepos.

        APPEND i2.

      ENDIF.
    ENDIF.
  ENDLOOP.

*set delivery no, qty, print status
  i1-lfimg = p_dnqty.

*set open quantity (SO - billed qty)
  i1-kbmeng = i1-kwmeng - p_bqty.

*set open amount
  i1-opamt = i1-kbmeng * i1-netpr.

* if  "Not yet DN qty exists.
  IF i1-kwmeng <> p_tqty.

    IF p_sts1 <>  space.  "show unDN
      i1-lfimg = i1-kwmeng - p_tqty.
      i1-status = c_v01.

    ELSE.
      READ TABLE i2 INDEX 1.
      IF sy-subrc = 0.
        CLEAR: i1-status, i1-lfimg.
        i1-dvbeln = i2-dvbeln.
        i1-lfimg  = i2-lfimg.
        i1-status = i2-status.
        i1-dnamt  = i2-dnamt.
        DELETE i2 INDEX 1.
        g_seq = g_seq - 1.
        g_cnt = g_seq.
      ELSE.
        w_del_item ='X'.
      ENDIF.
    ENDIF.
  ELSE.
    READ TABLE i2 INDEX 1.
    IF sy-subrc = 0.
      CLEAR: i1-status, i1-lfimg.
      i1-dvbeln = i2-dvbeln.
      i1-lfimg  = i2-lfimg.
      i1-status = i2-status.
      i1-dnamt  = i2-dnamt.

      DELETE i2 INDEX 1.
      g_seq = g_seq - 1.
      g_cnt = g_seq.
    ELSE.
      w_del_item ='X'.

    ENDIF.
  ENDIF.
* 20050509 Hans add start.
*set DN amount
  i1-dnamt = i1-lfimg * i1-netpr.
* 20050509 Hans add end.

*  MODIFY a1 INDEX g_cnt.
*  IF  W_DEL_ITEM = SPACE.
*    CLEAR A1.
**  creat first line item
*    MOVE-CORRESPONDING I1 TO A1.
*    APPEND A1.
*
*  ENDIF.

*  SELECT SINGLE dfrei INTO i1-dfrei FROM afpo
*      LEFT JOIN aufk ON aufk~aufnr = aufk~aufnr
*    WHERE kdauf = i1-vbeln
*    AND   kdpos = i1-posnr
*    AND   aufk~loekz <> 'X'. "no deletion flag

  DATA worel LIKE tj02t-txt04.
  DATA: lv_dfrei LIKE afpo-dfrei,
        lv_aufnr LIKE afpo-aufnr.

  IF it_soview-pstyv = 'ZTM5'. "WO Released Indicator
    SELECT aufnr dfrei INTO ( lv_aufnr, lv_dfrei ) FROM afpo WHERE kdauf = i1-vbeln AND kdpos = i1-posnr.
      SELECT SINGLE aufnr INTO lv_aufnr FROM aufk WHERE aufk~aufnr = lv_aufnr AND aufk~loekz <> 'X'.
      IF sy-subrc = 0.
        IF lv_dfrei = '1'.
          i1-wostatus = 'REL'.
        ELSE.
          i1-wostatus = 'Not REL'.
        ENDIF.
      ENDIF.
    ENDSELECT.
*    "20240424:SAP-EU: Bugfix - Switch Query because afpo-dfrei is not reversed when WO un-released
*    SELECT SINGLE txt04 INTO worel FROM aufk
*      INNER JOIN vjaufk ON vjaufk~aufnr = aufk~aufnr AND vjaufk~loekz <> 'X' AND vjaufk~inact <> 'X' "Find un-deleted WO
*      INNER JOIN tj02t ON tj02t~istat = vjaufk~stat AND tj02t~spras = 'E' AND tj02t~txt04 = 'CRTD'
*        WHERE aufk~kdauf = i1-vbeln AND aufk~kdpos = i1-posnr AND aufk~loekz <> 'X'.
*    IF sy-subrc <> 0.
*      i1-wostatus = 'REL'.
*    ELSE.
*      i1-wostatus = 'Not REL'.
*    ENDIF.
  ENDIF.

  IF w_del_item = space.
    SELECT * INTO CORRESPONDING FIELDS OF TABLE ivbep
     FROM vbep
     WHERE vbeln = i1-vbeln
    AND   posnr = i1-posnr.
*   AND ROMS1 = 0.
    IF sy-subrc = 0.
      SORT ivbep BY edatu.
      PERFORM process_so_schline USING p_tqty p_bqty.
    ENDIF.

    IF NOT i3[] IS INITIAL.
      LOOP AT i3.
        CLEAR a1.
        MOVE-CORRESPONDING i3 TO a1.
        APPEND a1.
      ENDLOOP.
    ENDIF.

    IF p_rado2 = ''.
      IF NOT i2[] IS INITIAL.
* a1: data table for ALV
        LOOP AT i2.
          CLEAR a1.
          MOVE-CORRESPONDING i2 TO a1.
          APPEND a1.
        ENDLOOP.
      ENDIF.
    ENDIF.

  ENDIF.



ENDFORM.                    " process_so_hans
***********************************

***************************
*
FORM get_on_hand_qty.
** MRP Table
  DATA: g_mt61d LIKE mt61d,
        g_mdkp  LIKE mdkp.
  DATA: i_mdez LIKE mdez OCCURS 20 WITH HEADER LINE,
        i_mdps LIKE mdps OCCURS 20 WITH HEADER LINE.
  DATA : porg LIKE vbak-vkorg.
  DATA : tberid LIKE mdma-berid.
*** Xuan.Kao 20201014 Debug Demand Plant on hand qty-Start ***
  IF i1-lgort IS NOT INITIAL.
    SELECT SINGLE labst INTO i1-labst
      FROM mard
     WHERE matnr = i1-matnr
       AND werks = i1-werks
    AND lgort = i1-lgort.
  ELSE.
    SELECT SINGLE labst INTO i1-labst
      FROM mard
     WHERE matnr = i1-matnr
       AND werks = i1-werks
    AND lgort = i1-slgort.
  ENDIF.
  IF sy-subrc = 0.
    i1-slabst = i1-labst.
  ENDIF.
*** Xuan.Kao 20201014 Debug Demand Plant on hand qty-End ***
*TBERID = I1-WERKS.
*
*IF P_RADO5 = 'X' AND I1-PSTYV <> 'ZTM5'.
*  PORG = 'TW01'.
*  TBERID = 'TWH1-BTO'.
*ENDIF.
*IF P_RADO6 = 'X'.
*   IF I1-LGORT = 'B000' AND I1-PSTYV <> 'ZTM5'.
*      TBERID = 'TWH1-BTO'.
*   ENDIF.
*ENDIF.
*IF I1-WERKS = 'CNH1' AND
*   ( I1-LGORT = '2000' OR I1-LGORT = '2500' )
*   AND I1-PSTYV <> 'ZTM5'.
*  TBERID = 'CNH1-BJ'.
*ENDIF.
*IF I1-WERKS = 'CNH1' AND I1-LGORT = '4000' AND
*  I1-PSTYV <> 'ZTM5'.
*  TBERID = 'CNH1-SZ'.
*ENDIF.
*
*IF I1-WERKS = 'CNH2' AND I1-LGORT = '4000' AND
*  I1-PSTYV <> 'ZTM5'.
*  TBERID = 'CNH2-SZ'.
*ENDIF.
*IF I1-PSTYV = 'ZTM5' OR I1-PSTYV = 'ZKM1'.
*  TBERID = I1-WERKS.
*ENDIF.
*      CALL FUNCTION 'MD_STOCK_REQUIREMENTS_LIST_API'
*      EXPORTING
*        MATNR                    = I1-MATNR
*        WERKS                    = I1-WERKS
*        BERID                    =  TBERID
*      IMPORTING
*        E_MT61D                  = G_MT61D
*        E_MDKP                   = G_MDKP
*      TABLES
*        MDPSX                    = I_MDPS
*        MDEZX                    = I_MDEZ
*      EXCEPTIONS
*        MATERIAL_PLANT_NOT_FOUND = 1
*        PLANT_NOT_FOUND          = 2
*        OTHERS                   = 3.
*  READ TABLE I_MDPS WITH KEY DELKZ = 'WB'.
* IF SY-SUBRC = 0.
*    I1-LABST = I_MDPS-MNG01.
* ENDIF.
ENDFORM.                    "GET_ON_HAND_QTY

*&---------------------------------------------------------------------*
*&      Form  GET_SUUPLY_ON_HAND_QTY
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM get_suuply_on_hand_qty.
** MRP Table
  DATA: g_mt61d LIKE mt61d,
        g_mdkp  LIKE mdkp.
  DATA: i_mdez LIKE mdez OCCURS 20 WITH HEADER LINE,
        i_mdps LIKE mdps OCCURS 20 WITH HEADER LINE.
  DATA : porg LIKE vbak-vkorg.
  DATA : tberid LIKE mdma-berid.
*** Xuan.Kao 20201014 Debug Supply Plant on hand qty-Start ***
  IF i1-slgort IS NOT INITIAL.
    SELECT SINGLE labst INTO i1-slabst
      FROM mard
     WHERE matnr = i1-matnr
       AND werks = i1-reswk
    AND lgort = i1-slgort.
  ENDIF.
*** Xuan.Kao 20201014 Debug Supply Plant on hand qty-End ***
ENDFORM.                    "GET_SUUPLY_ON_HAND_QTY

*********************************
* Add By Hermit 2006/11/20 for RMA request
*******************************
FORM get_po_item_text.
  DATA: objname(70) TYPE c.
  DATA: t_lines LIKE tline OCCURS 0 WITH HEADER LINE.
  DATA: ll_tdspras LIKE stxh-tdspras.
  CONCATENATE i1-ebeln i1-ebelp INTO objname.
*  WRITE I1-EBELN TO OBJNAME+0.
*  WRITE I1-EBELP TO OBJNAME+10.
*20220614 performance tuning
  CLEAR : i1-itemtxt,ll_tdspras.
  SELECT tdspras INTO ll_tdspras FROM stxh
  WHERE tdobject = 'EKPO'
  AND tdname = objname
  AND tdid = 'F01'.

    CLEAR t_lines.
    REFRESH t_lines.
    CALL FUNCTION 'READ_TEXT'
      EXPORTING
        id        = 'F01'
        language  = ll_tdspras "!!! ZH ZF
        name      = objname
        object    = 'EKPO'
      TABLES
        lines     = t_lines
      EXCEPTIONS
        not_found = 1.
    IF sy-subrc = '0'.
      READ TABLE t_lines INDEX 1.
      CONCATENATE i1-itemtxt t_lines-tdline INTO i1-itemtxt.
    ENDIF.
  ENDSELECT.
ENDFORM.                    "GET_PO_ITEM_TEXT
***************************
*
***************************

*** Xuan.Kao 20231220 STO Item Delivery text-Start ***
FORM get_sto_item_delivery_text.

  DATA: wt_tdname LIKE stxh-tdname.
  DATA: wt_tdspras LIKE stxh-tdspras.
  DATA: wt_tline LIKE tline OCCURS 0 WITH HEADER LINE.

  CLEAR: wt_tdname, wt_tdspras, i1-f04txt.
  CONCATENATE i1-ebeln i1-ebelp INTO wt_tdname.

  SELECT tdspras INTO wt_tdspras
    FROM stxh
   WHERE tdobject = 'EKPO'
     AND tdname = wt_tdname
     AND tdid = 'F04'.

    CLEAR: wt_tline, wt_tline[].
    CALL FUNCTION 'READ_TEXT'
      EXPORTING
        id        = 'F04'
        language  = wt_tdspras
        name      = wt_tdname
        object    = 'EKPO'
      TABLES
        lines     = wt_tline
      EXCEPTIONS
        not_found = 1.
    IF sy-subrc = 0.
      LOOP AT wt_tline.
        CONCATENATE i1-f04txt wt_tline-tdline INTO i1-f04txt SEPARATED BY space.
      ENDLOOP.
      CONDENSE i1-f04txt.
    ENDIF.
  ENDSELECT.

ENDFORM.
*** Xuan.Kao 20231220 STO Item Delivery text-End ***


FORM get_so_first_matdate.
*get material available date
  DATA : tabkey LIKE cdpos-tabkey,
         l_exit.
* 20220614 performance tuning
  DATA : l_changenr  LIKE cdhdr-changenr,
         l_value_old LIKE cdpos-value_old.

  CONCATENATE sy-mandt i1-vbeln i1-posnr '0001'
                 INTO tabkey.
  CLEAR :l_exit, so_fstmatdt,l_changenr,l_value_old.

  SELECT changenr INTO l_changenr FROM cdhdr
           WHERE objectclas = 'VERKBELEG'
             AND objectid   = i1-vbeln.
    SELECT value_old INTO l_value_old FROM cdpos
             WHERE objectclas = 'VERKBELEG'
               AND objectid   = i1-vbeln
               AND changenr  = l_changenr
               AND tabname = 'VBEP'
               AND tabkey = tabkey
               AND fname = 'MBDAT'
              AND chngind = 'U'.
      l_exit = 'X'.
      EXIT.
    ENDSELECT.
    IF l_exit = 'X'.
      EXIT.
    ENDIF.
  ENDSELECT.
  IF l_exit = 'X'.
    so_fstmatdt = l_value_old.
  ENDIF.

ENDFORM.                    "GET_SO_FIRST_MATDATE
****************************************************
* Get Ship-to, sold-to and bill-to name
*Add By Hermit 2005/11/17 for EU request
****************************************
FORM get_cust_name USING psold pship pbill
                   CHANGING VALUE(psoldnm)
                 VALUE(pshipnm)
                 VALUE(pbillnm).
  SELECT SINGLE name1 FROM kna1 INTO kna1-name1
  WHERE kunnr = psold.
  IF sy-subrc = 0.
    psoldnm = kna1-name1.
  ENDIF.
  SELECT SINGLE name1 FROM kna1 INTO kna1-name1
  WHERE kunnr = pship.
  IF sy-subrc = 0.
    pshipnm = kna1-name1.
  ENDIF.
  SELECT SINGLE name1 FROM kna1 INTO kna1-name1
  WHERE kunnr = pbill.
  IF sy-subrc = 0.
    pbillnm = kna1-name1.
  ENDIF.

ENDFORM.                    "GET_CUST_NAME


***********************************
* Add By hermit 2005/07/28
***********************************
FORM process_so_schline USING p_dnqty p_bqty.
* EDATU -> Schedule line Date
* BMENG -> confirm qty
* BDDAT -> Require Date
* MBDAT -> Material available date
* WMENG -> Order qty
  DATA : tmp_qty     LIKE vbep-wmeng,
         xxx_qty     LIKE vbep-wmeng,
         unit_price  LIKE ekpo-netpr,
         intcnt      TYPE i,
         diff_qty    LIKE vbep-wmeng,
         intline     TYPE i,
         cnf_qty     LIKE vbep-wmeng,
         rest_bqty   LIKE vbep-wmeng,
         topen_qty   LIKE vbep-wmeng,
         ord_qty     LIKE vbep-wmeng,
         ord_date    LIKE vbep-edatu,
         mat_date    LIKE vbep-edatu,
         nmat_date   LIKE vbep-edatu,
         rqt_date    LIKE vbep-edatu,
         firstdelv   LIKE vbep-edatu,
         ord_diffqty LIKE vbep-wmeng,
         tocnf_qty   LIKE vbep-wmeng,
         lncnf_qty   LIKE vbep-wmeng,
         intloop     TYPE i,
         diff_dnqty  LIKE vbep-wmeng.
  DESCRIBE TABLE ivbep LINES intcnt.
  rest_bqty = p_bqty. "Billing qty
  diff_dnqty = p_dnqty. "D/N qty
  intline = 1.
  intloop = 1.
***for filter those committed qty <> 0 and confirmed qty = 0
  LOOP AT ivbep.
    IF ivbep-roms1 <> 0 AND ivbep-bmeng = 0 AND intline <> 1
       AND ivbep-wmeng = 0.
      intcnt = intcnt - 1.
    ENDIF.
    intline = intline + 1.
  ENDLOOP.
  intline = 1.
  LOOP AT ivbep.
    i3-vtweg = i1-vtweg.
    i3-spart = i1-spart.
    i3-erdat = i1-erdat.  "Ord_Date
    i3-blatt = i1-blatt.
    i3-zz_zdatu = i1-zz_zdatu.
    i3-zz_cdatu = i1-zz_cdatu.
    i3-zz_sdatu = i1-zz_sdatu.
    i3-vsnmr_v = i1-vsnmr_v.
    i3-eaipd = i1-eaipd.
    i3-eaipg = i1-eaipg.
    i3-zrname = i1-zrname.
    i3-zrpernr = i1-zrpernr.
**add by rong 20181002,Require from Sylvia
    i3-country_ship = i1-country_ship.
    i3-city_ship    = i1-city_ship.
    i3-region_ship  = i1-region_ship.
    i3-post_ship    = i1-post_ship.
    i3-street_ship  = i1-street_ship.
**add end
    i3-wostatus  = i1-wostatus.
    "if sch = 0 and conf qty = 0 skip it
    IF ivbep-bmeng IS INITIAL AND
       ivbep-wmeng IS INITIAL.
      CONTINUE.
    ENDIF.
***add by Hermit 2005/11/03 for committed qty
    IF intloop <> 1 AND ivbep-roms1 <> 0
    AND ivbep-bmeng = 0 AND ivbep-wmeng = 0.
      CONTINUE.
    ENDIF.
    "if first line conf qty = 0, keep ord qty
    IF ivbep-bmeng IS INITIAL.
      ord_qty = ivbep-wmeng.
    ELSE.
      IF ivbep-wmeng <> 0.
        ord_qty = ivbep-wmeng.
      ENDIF.
    ENDIF.
    IF NOT ivbep-wmeng IS INITIAL.
      i3-redatu =  ivbep-edatu.     " request date
      rqt_date = ivbep-edatu.

    ENDIF.
    IF intloop = 1.
      IF so_fstmatdt IS INITIAL.
        mat_date = ivbep-mbdat.
      ELSE.
        mat_date = so_fstmatdt.
      ENDIF.
      nmat_date = ivbep-mbdat.
      firstdelv = ivbep-edatu.
    ENDIF.
*     I3-OEDATU = ORD_DATE.  "Order Date
    i3-lifsp = ivbep-lifsp.

    "keep total confirm qty
    tocnf_qty = tocnf_qty + ivbep-bmeng.
    IF ivbep-wmeng = 0.
      i3-bmeng = ivbep-bmeng. "conf qty
      IF intline = 1.
        i3-kwmeng = ord_qty. " IVBEP-WMENG. "ord qty
      ENDIF.
      IF diff_dnqty <> 0.
        IF ivbep-bmeng >= diff_dnqty.
** Revise By Hermit 2006/02/221
** for last schedule line has deliver qty
          IF i1-vkorg = 'US01'.
            i3-dnqty = diff_dnqty.
          ELSE.
            IF intloop = intcnt.
              i3-dnqty = diff_dnqty.
            ELSE.
              i3-dnqty = ivbep-bmeng. "Delivered qty
            ENDIF.
          ENDIF.
          lncnf_qty = ivbep-bmeng.
          i3-lfimg = ivbep-bmeng - diff_dnqty. "un DN
          diff_dnqty = 0.
        ELSE.
          IF intloop = intcnt.
            i3-lfimg = 0. "un dn
            lncnf_qty = diff_dnqty.
            i3-bmeng = diff_dnqty.
            tocnf_qty = tocnf_qty - ivbep-bmeng + diff_dnqty.
            i3-dnqty = diff_dnqty. "already DN qty
            diff_dnqty = 0.
          ELSE.
            lncnf_qty = ivbep-bmeng.
*                 I3-DNQTY = 0. "already DN qty
*                 I3-LFIMG = IVBEP-BMENG. "un dn
            i3-dnqty = ivbep-bmeng. "already DN qty
            i3-lfimg = 0. "un dn
            diff_dnqty = diff_dnqty - ivbep-bmeng.
          ENDIF.
        ENDIF.
      ELSE.
        i3-lfimg = ivbep-bmeng. "un dn qty
        lncnf_qty = ivbep-bmeng.
        i3-dnqty = 0. "delivered qty
      ENDIF.
      IF rest_bqty <> 0.
*           IF IVBEP-BMENG > REST_BQTY.
        IF lncnf_qty >= rest_bqty.
*              I3-KBMENG = IVBEP-BMENG - REST_BQTY.
*              REST_BQTY = IVBEP-BMENG - REST_BQTY.
          i3-kbmeng = lncnf_qty - rest_bqty.
          rest_bqty = lncnf_qty - rest_bqty.
          IF rest_bqty < 0.
            rest_bqty = 0.
          ENDIF.
        ELSE.
          i3-kbmeng = 0.
*             REST_BQTY = REST_BQTY - IVBEP-BMENG.
          rest_bqty = rest_bqty - lncnf_qty.
        ENDIF.
      ELSE.
*           I3-KBMENG = IVBEP-BMENG.
        i3-kbmeng = lncnf_qty.
      ENDIF.
      IF i3-lfimg = 0. "un dn qty
        "no undeliver dn,but need to check if billing qty
        IF i3-kbmeng <> 0.
          PERFORM move-i1-data USING 1.
******* add for i3-dvbeln by prince
          READ TABLE ivbfa
          WITH KEY vbelv = ivbep-vbeln
                   posnv = ivbep-posnr
                   rfmng = ivbep-bmeng.               " Xuan.Kao 20210617 Debug Delivery Note
          IF sy-subrc EQ 0.
            IF i3-dvbeln IS INITIAL.                  " Xuan.Kao 20210617 Debug Delivery Note
              i3-dvbeln = ivbfa-vbeln.
            ENDIF.
          ENDIF.

*** Xuan.Kao 20210617 Debug Delivery Note-Start ***
          IF i3-dvbeln IS INITIAL.
            LOOP AT ivbfa WHERE vbelv = ivbep-vbeln
                            AND posnv = ivbep-posnr.
              i3-dvbeln = ivbfa-vbeln.
            ENDLOOP.
          ENDIF.
*** Xuan.Kao 20210617 Debug Delivery Note-End ***

          i3-cedatu =  ivbep-edatu.     " confirmed date
*              I3-REDATU = IVBEP-EDATU.  "Request Date
          i3-redatu = rqt_date.  "Request Date
          i3-schline = intline.
          i3-unconfqty = 0.
          i3-uncnfamt = 0.
          IF intline = 1.
            i3-kwmeng = ord_qty. "IVBEP-WMENG. "ord qty
          ENDIF.
          i3-waerk =  i1-waers.
*              I3-SCHQTY = IVBEP-BMENG.
          i3-schqty = lncnf_qty.
          i3-lfimg = 0.  "unD/N qty
          i3-opamt = i3-kbmeng * i1-netpr. "open amt
*add by hermit
          i3-zpi01amt = i3-zpi01 * i3-kbmeng.
          i3-odnamt = i3-dnqty * i1-netpr. "SCH dn amt
          i3-dnamt = i3-lfimg * i1-netpr.  "open dn amt
          i3-otype =  i1-auart.   "po type
          i3-vbeln =  i1-vbeln.
          i3-posnr =  i1-posnr.
          i3-uepos =  i1-uepos.
          i3-vrkme =  i1-meins.  "unit of measure
          i3-splant = i1-splant.
          i3-slgort = i1-slgort.
          i3-slgpbe = i1-slgpbe.
          i3-labst = i1-labst.
          i3-mbdat = nmat_date.
          i3-ambdat = ivbep-mbdat.
*              I3-FIRSTDELV = FIRSTDELV.
          i3-firstmatv = mat_date.
          i3-zz_first = i1-zz_edatu.
          i3-zz_mbdat = i1-zz_edatu.
          i3-sosto = 'X'.
*              I3-STATUS = 4.
          i3-oedatu = i1-oedatu. "Ord date
          PERFORM get_backlog_date.
          IF p_rado2 = ''.
            IF intloop = intcnt.
              ord_diffqty = ord_qty - tocnf_qty.
              IF p_rado1 = 'X'.
                i3-unconfqty = ord_diffqty.
                i3-uncnfamt = i3-unconfqty * i1-netpr.
                "unconf dn amt
              ENDIF.
            ENDIF.
            APPEND i3.
            CLEAR i3.
            intline = intline + 1.
            IF p_rado3 = 'X'.
              IF intloop = intcnt.
                ord_diffqty = ord_qty - tocnf_qty.
                i3-firstmatv = mat_date.
                i3-zz_first = i1-zz_edatu .
                i3-zz_mbdat = i1-zz_edatu.

*                I3-FIRSTDELV = FIRSTDELV.
                IF ord_diffqty > 0.
                  PERFORM check_rest_qty USING ord_qty
                               ord_diffqty
                               CHANGING intline.
                ENDIF.
              ENDIF.
            ENDIF.
          ELSE.
            CLEAR i3.
            IF p_rado2 = 'X' OR p_rado3 = 'X'.
              IF intloop = intcnt.
                ord_diffqty = ord_qty - tocnf_qty.
                i3-firstmatv = mat_date.
                i3-zz_first = i1-zz_edatu.
                i3-zz_mbdat = i1-zz_edatu.

*                          I3-FIRSTDELV = FIRSTDELV.
                IF ord_diffqty > 0.
                  PERFORM check_rest_qty USING ord_qty
                                    ord_diffqty
                                   CHANGING intline.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDIF.
        ELSE.
          CLEAR i3.
          IF intloop = intcnt.
            ord_diffqty = ord_qty - tocnf_qty.
            i3-firstmatv = mat_date.
            i3-zz_first = i1-zz_edatu.
            i3-zz_mbdat = i1-zz_edatu.

*                    I3-FIRSTDELV = FIRSTDELV.
            IF ord_diffqty > 0.
              PERFORM check_rest_qty USING ord_qty
                                    ord_diffqty
                                    CHANGING intline.
            ENDIF.
          ENDIF.

        ENDIF.
      ELSE.
        PERFORM move-i1-data USING 1.
        i3-schline = intline.
        i3-unconfqty = 0.
        i3-uncnfamt = i3-unconfqty * i1-netpr.  "unconf dn amt
        i3-waerk =  i1-waers.
*           I3-SCHQTY = IVBEP-BMENG.
        i3-schqty = lncnf_qty.
        IF intline = 1.
          i3-kwmeng = ord_qty. "IVBEP-WMENG. "ord qty
        ENDIF.
        i3-odnamt = i3-dnqty * i1-netpr.
        i3-opamt = i3-kbmeng * i1-netpr.
        i3-zpi01amt = i3-zpi01 * i3-kbmeng.
        i3-dnamt = i3-lfimg * i1-netpr.
        i3-otype =  i1-auart.   "po type
        i3-vbeln =  i1-vbeln.
        i3-posnr =  i1-posnr.
        i3-uepos =  i1-uepos.
        i3-sosto = 'X'.
        i3-vrkme =  i1-meins.  "unit of measure
        i3-splant = i1-splant.
        i3-slgort = i1-slgort.
        i3-slgpbe = i1-slgpbe.
*           I3-STATUS = 1.
        i3-oedatu = i1-oedatu. "Ord date
        i3-cedatu =  ivbep-edatu.     " confirmed date
*           I3-REDATU = IVBEP-EDATU.  "Request Date
        i3-redatu = rqt_date.  "Request Date
        i3-labst = i1-labst.
        i3-mbdat = nmat_date.
        i3-ambdat = ivbep-mbdat.
        i3-firstmatv = mat_date.
        i3-zz_first = i1-zz_edatu.
        i3-zz_mbdat = i1-zz_edatu.
        i3-abtnr = i1-abtnr.                                "20250815

*           I3-FIRSTDELV = FIRSTDELV.
        PERFORM get_backlog_date.
        IF p_rado2 = ''.
          IF intloop = intcnt.
            ord_diffqty = ord_qty - tocnf_qty.
            IF p_rado1 = 'X'.
              i3-unconfqty = ord_diffqty.
              i3-uncnfamt = i3-unconfqty * i1-netpr.
              "unconf dn amt
            ENDIF.
          ENDIF.
          APPEND i3.
          CLEAR i3.
          intline = intline + 1.
          IF p_rado3 = 'X'.
            IF intloop = intcnt.
              ord_diffqty = ord_qty - tocnf_qty.
              i3-zz_first = i1-zz_edatu.
              i3-zz_mbdat = i1-zz_edatu.

*                    I3-FIRSTDELV = FIRSTDELV.
              i3-firstmatv = mat_date.
              IF ord_diffqty > 0.
                PERFORM check_rest_qty USING ord_qty
                                       ord_diffqty
                                       CHANGING intline.
              ENDIF.
            ENDIF.
          ENDIF.
        ELSE.
          CLEAR i3.
          IF intloop = intcnt.
            ord_diffqty = ord_qty - tocnf_qty.
            i3-zz_first = i1-zz_edatu.
            i3-zz_mbdat = i1-zz_edatu.

*                 I3-FIRSTDELV = FIRSTDELV.
            i3-firstmatv = mat_date.
            IF ord_diffqty > 0.
              PERFORM check_rest_qty USING ord_qty
                                         ord_diffqty
                                     CHANGING intline.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ELSE.
      " case 1 07/28 25 15
      " split to 15 15 15 0
      "          10 0  0  10
      " case 2 07/28 25 0
      " unconfirm 25
      " case 3 7/28 10 0
      "         8/2  0 5
      IF intline = 1.
        i3-kwmeng = ord_qty. "IVBEP-WMENG. "ord qty
      ENDIF.
      diff_qty = ivbep-wmeng - ivbep-bmeng.
      IF p_rado1 = 'X'.
        i3-unconfqty = diff_qty. "unconf qty
      ELSE.
        i3-unconfqty = 0.
      ENDIF.
      i3-uncnfamt = i3-unconfqty * i1-netpr.  "unconf dn amt

      IF diff_qty <> ivbep-wmeng.
        IF diff_dnqty <> 0.
          IF ivbep-bmeng >= diff_dnqty.
            lncnf_qty = ivbep-bmeng.
            i3-lfimg = ivbep-bmeng - diff_dnqty.
            IF intloop = intcnt.
              i3-dnqty = diff_dnqty. "already DN qty
            ENDIF.
            diff_dnqty = ivbep-bmeng - diff_dnqty.
            IF diff_dnqty < 0.
              diff_dnqty = 0.
            ENDIF.
          ELSE.
*                 I3-LFIMG = 0.
*                 DIFF_DNQTY = DIFF_DNQTY - IVBEP-BMENG.
            IF intloop = intcnt.
              IF intcnt = 1.
                IF p_rado1 = 'X'.
                  i3-lfimg = ivbep-wmeng - diff_dnqty.
                  "un dn
                ELSE.
                  i3-lfimg = 0.
                ENDIF.
                diff_qty = ivbep-wmeng - diff_dnqty.
              ELSE.
                i3-lfimg = 0.
                diff_qty = 0.
              ENDIF.
              lncnf_qty = diff_dnqty.
              i3-bmeng = diff_dnqty.
              tocnf_qty = tocnf_qty - ivbep-bmeng + diff_dnqty.
              i3-dnqty = diff_dnqty. "already DN qty
              diff_dnqty = 0.
            ELSE.
              i3-lfimg = 0.
              lncnf_qty = ivbep-bmeng.
              diff_dnqty = diff_dnqty - ivbep-bmeng.
            ENDIF.
          ENDIF.
        ELSE.
          i3-lfimg = ivbep-bmeng.
          lncnf_qty = ivbep-bmeng.
          diff_dnqty = 0.
        ENDIF.
        "Calculate the rest of billing qty
        IF rest_bqty <> 0.
*              IF IVBEP-BMENG > REST_BQTY.
          IF lncnf_qty >= rest_bqty.
*                 I3-KBMENG = IVBEP-BMENG - REST_BQTY.
*                 REST_BQTY = IVBEP-BMENG - REST_BQTY.
            i3-kbmeng = lncnf_qty - rest_bqty.
            rest_bqty = lncnf_qty - rest_bqty.
            IF rest_bqty < 0.
              rest_bqty = 0.
            ENDIF.
          ELSE.
            i3-kbmeng = 0.
*                 REST_BQTY = REST_BQTY - IVBEP-BMENG.
            rest_bqty = rest_bqty - lncnf_qty.
          ENDIF.
        ELSE.
*              I3-KBMENG = IVBEP-BMENG.
          i3-kbmeng = lncnf_qty.
        ENDIF.
        IF i3-kbmeng <> 0.
          PERFORM move-i1-data USING 1.
******* add for i3-dvbeln by prince
          READ TABLE ivbfa
          WITH KEY vbelv = ivbep-vbeln
                   posnv = ivbep-posnr.
          IF sy-subrc EQ 0.
            i3-dvbeln = ivbfa-vbeln.
          ENDIF.

          i3-cedatu =  ivbep-edatu. " confirmed date
*              I3-REDATU = IVBEP-EDATU.  "Request Date
          i3-redatu = rqt_date.  "Request Date
          i3-schline = intline.
          i3-waerk =  i1-waers.
          i3-uepos = i1-uepos.
          i3-labst = i1-labst.
*              I3-SCHQTY = IVBEP-BMENG.
*              I3-BMENG = IVBEP-BMENG. "conf qty
          i3-schqty = lncnf_qty.
          i3-bmeng = lncnf_qty. "conf qty
          IF intline = 1.
            i3-kwmeng = ord_qty. "IVBEP-WMENG. "ord qty
          ENDIF.
          i3-opamt = i3-kbmeng * i1-netpr.
          i3-zpi01amt = i3-zpi01 * i3-kbmeng.
          i3-odnamt = i3-dnqty * i1-netpr.
          i3-dnamt = i3-lfimg * i1-netpr.
          i3-sosto = 'X'.
          i3-otype =  i1-auart.   "order type
*              I3-STATUS = 1.
          i3-oedatu = i1-oedatu. "Ord date
          i3-mbdat = nmat_date.
          i3-ambdat = ivbep-mbdat.
          i3-firstmatv = mat_date.
          i3-zz_first = i1-zz_edatu.
          i3-zz_mbdat = i1-zz_edatu.

*              I3-FIRSTDELV = FIRSTDELV.
          PERFORM get_backlog_date.
          IF p_rado2 = ''.
            APPEND i3.
            CLEAR i3.
            intline = intline + 1.
          ELSE.
            CLEAR i3.
          ENDIF.
        ELSE.
          CLEAR i3.
        ENDIF.
        IF intcnt = 1.
          IF diff_qty <> 0.
            IF p_rado2 = 'X' OR p_rado3 = 'X'.
              IF diff_dnqty <> 0.
                IF ivbep-bmeng >= diff_dnqty.
                  lncnf_qty = ivbep-bmeng.
                  i3-lfimg = ivbep-bmeng - diff_dnqty.
                  diff_dnqty = ivbep-bmeng - diff_dnqty.
                  IF diff_dnqty < 0.
                    diff_dnqty = 0.
                  ENDIF.
                ELSE.
*                 I3-LFIMG = 0.
*                 DIFF_DNQTY = DIFF_DNQTY - IVBEP-BMENG.
                  IF intloop = intcnt.
                    i3-lfimg = 0. "un dn
                    lncnf_qty = diff_dnqty.
                    i3-bmeng = diff_dnqty.
                    tocnf_qty = tocnf_qty - ivbep-bmeng +
                                diff_dnqty.
                    i3-dnqty = diff_dnqty. "already DN qty
                    diff_dnqty = 0.
                  ELSE.
                    i3-lfimg = 0.
                    lncnf_qty = ivbep-bmeng.
                    diff_dnqty = diff_dnqty - ivbep-bmeng.
                  ENDIF.
                ENDIF.
              ELSE.
                i3-lfimg = ivbep-bmeng.
                lncnf_qty = ivbep-bmeng.
                diff_dnqty = 0.
              ENDIF.
              "Calculate the rest of billing qty
              IF rest_bqty <> 0.
*                      IF IVBEP-BMENG > REST_BQTY.
                IF lncnf_qty >= rest_bqty.
*                 I3-KBMENG = IVBEP-BMENG - REST_BQTY.
*                 REST_BQTY = IVBEP-BMENG - REST_BQTY.
                  i3-kbmeng = lncnf_qty - rest_bqty.
                  rest_bqty = lncnf_qty - rest_bqty.
                  IF rest_bqty < 0.
                    rest_bqty = 0.
                  ENDIF.
                ELSE.
                  i3-kbmeng = 0.
*                 REST_BQTY = REST_BQTY - IVBEP-BMENG.
                  rest_bqty = rest_bqty - lncnf_qty.
                ENDIF.
              ELSE.
*              I3-KBMENG = IVBEP-BMENG.
                IF lncnf_qty <> 0.
                  i3-kbmeng = lncnf_qty.
                ELSE.
                  i3-kbmeng = ivbep-wmeng.
                ENDIF.
              ENDIF.
              IF i3-kbmeng <> 0.
                PERFORM move-i1-data USING 1.
                i3-schline = intline.
                i3-kbmeng = diff_qty.  "open qty
                i3-unconfqty = diff_qty.
                i3-uncnfamt = i3-unconfqty * i1-netpr.
                "unconf dn amt
                i3-lfimg = diff_qty.  "un dn qty
*                      I3-STATUS = 1.
                i3-oedatu = i1-oedatu. "Ord date
*                       I3-REDATU = IVBEP-EDATU.  "Request Date
                i3-redatu = rqt_date.  "Request Date
                i3-dnqty = 0.  "Delivered D/N qty
                i3-odnamt = 0. "already D/N amt
                i3-otype =  i1-auart.   "po type
                i3-sosto = 'X'.
                i3-schqty = diff_qty. "sch qty
                i3-labst = i1-labst.
                IF intline = 1.
                  i3-kwmeng = ord_qty. "IVBEP-WMENG. "ord qty
                ENDIF.
                i3-bmeng = 0. "conf qty
                i3-opamt = i3-kbmeng * i1-netpr.
                i3-zpi01amt = i3-zpi01 * i3-kbmeng.
                i3-dnamt = i3-lfimg * i1-netpr.
                i3-mbdat = nmat_date.
                i3-ambdat = ivbep-mbdat.
                i3-firstmatv = mat_date.
                i3-zz_first = i1-zz_edatu.
                i3-zz_mbdat = i1-zz_edatu.

*                       I3-FIRSTDELV = FIRSTDELV.
                PERFORM get_backlog_date.
                IF lncnf_qty <> 0.
                  APPEND i3.
                  CLEAR i3.
                  intline = intline + 1.
                ENDIF.
              ELSE.
                CLEAR i3.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ELSE.
        IF intcnt = 1.
          IF p_rado2 = 'X' OR p_rado3 = 'X'.
            IF diff_dnqty <> 0.
              IF ivbep-bmeng >= diff_dnqty.
                lncnf_qty = ivbep-bmeng.
                i3-lfimg = ivbep-bmeng - diff_dnqty.
                diff_dnqty = ivbep-bmeng - diff_dnqty.
                IF diff_dnqty < 0.
                  diff_dnqty = 0.
                ENDIF.
              ELSE.
*                 I3-LFIMG = 0.
*                 DIFF_DNQTY = DIFF_DNQTY - IVBEP-BMENG.
                IF intloop = intcnt.
                  i3-lfimg = 0. "un dn
                  lncnf_qty = diff_dnqty.
                  i3-bmeng = diff_dnqty.
                  tocnf_qty = tocnf_qty - ivbep-bmeng +
                              diff_dnqty.
                  i3-dnqty = diff_dnqty. "already DN qty
                  diff_dnqty = 0.
                ELSE.
                  i3-lfimg = 0.
                  lncnf_qty = ivbep-bmeng.
                  diff_dnqty = diff_dnqty - ivbep-bmeng.
                ENDIF.
              ENDIF.
            ELSE.
*                    I3-LFIMG = IVBEP-BMENG.
*                    LNCNF_QTY = IVBEP-BMENG.
              i3-lfimg = diff_qty.
              lncnf_qty = 0.
              diff_dnqty = 0.
            ENDIF.
            "Calculate the rest of billing qty
            IF rest_bqty <> 0.
*                   IF IVBEP-BMENG > REST_BQTY.
              IF lncnf_qty >= rest_bqty.
*                 I3-KBMENG = IVBEP-BMENG - REST_BQTY.
*                 REST_BQTY = IVBEP-BMENG - REST_BQTY.
                i3-kbmeng = lncnf_qty - rest_bqty.
                rest_bqty = lncnf_qty - rest_bqty.
                IF rest_bqty < 0.
                  rest_bqty = 0.
                ENDIF.
              ELSE.
                i3-kbmeng = 0.
*                 REST_BQTY = REST_BQTY - IVBEP-BMENG.
                rest_bqty = rest_bqty - lncnf_qty.
              ENDIF.
            ELSE.
*              I3-KBMENG = IVBEP-BMENG.
              IF lncnf_qty <> 0.
                i3-kbmeng = lncnf_qty.
              ELSE.
                i3-kbmeng = ivbep-wmeng.
              ENDIF.
            ENDIF.
            IF i3-kbmeng <> 0.
              PERFORM move-i1-data USING 1.
              i3-schline = intline.
              i3-kbmeng = diff_qty.  "open qty
              i3-unconfqty = diff_qty.
              i3-uncnfamt = i3-unconfqty * i1-netpr.  "unconf dn amt
              i3-lfimg = diff_qty.  "un dn qty
*                 I3-STATUS = 1.
              i3-oedatu = i1-oedatu. "Ord date
*                 I3-REDATU = IVBEP-EDATU.  "Request Date
              i3-redatu = rqt_date.  "Request Date
              i3-dnqty = 0.  "Delivered D/N qty
              i3-odnamt = 0. "already D/N amt
              i3-otype =  i1-auart.   "po type
              i3-sosto = 'X'.
              i3-labst = i1-labst.
              i3-schqty = diff_qty. "sch qty
              IF intline = 1.
                i3-kwmeng = ord_qty. "IVBEP-WMENG. "ord qty
              ENDIF.
              i3-bmeng = 0. "conf qty
              i3-opamt = i3-kbmeng * i1-netpr.
              i3-zpi01amt = i3-zpi01 * i3-kbmeng.
              i3-dnamt = i3-lfimg * i1-netpr.
              i3-mbdat = nmat_date.
              i3-ambdat = ivbep-mbdat.
              i3-firstmatv = mat_date.
              i3-zz_first = i1-zz_edatu.
              i3-zz_mbdat = i1-zz_edatu.

*                 I3-FIRSTDELV = FIRSTDELV.
              PERFORM get_backlog_date.
              APPEND i3.
              CLEAR i3.
              intline = intline + 1.
            ELSE.
              CLEAR i3.
            ENDIF.
          ENDIF.
        ELSE.
          IF ivbep-bmeng <> 0.
            i3-bmeng = ivbep-bmeng. "conf qty
            IF diff_dnqty <> 0.
              IF ivbep-bmeng >= diff_dnqty.
                i3-dnqty = diff_dnqty. "Delivered qty
                lncnf_qty = ivbep-bmeng.
                i3-lfimg = ivbep-bmeng - diff_dnqty. "un DN
                diff_dnqty = ivbep-bmeng - diff_dnqty.
              ELSE.
                IF intloop = intcnt.
                  i3-lfimg = 0. "un dn
                  lncnf_qty = diff_dnqty.
                  i3-bmeng = diff_dnqty.
                  tocnf_qty = tocnf_qty - ivbep-bmeng +
                  diff_dnqty.
                  i3-dnqty = diff_dnqty. "already DN qty
                  diff_dnqty = 0.
                ELSE.
                  i3-lfimg = 0. "un dn
                  i3-bmeng = ivbep-bmeng.
                  lncnf_qty = ivbep-bmeng.
                  i3-dnqty = ivbep-bmeng. "already DN qty
                  diff_dnqty = diff_dnqty - ivbep-bmeng.
                ENDIF.
              ENDIF.
            ELSE.
              i3-lfimg = ivbep-bmeng. "un dn qty
              lncnf_qty = ivbep-bmeng.
              i3-dnqty = 0. "delivered qty
            ENDIF.
            IF rest_bqty <> 0.
*                    IF IVBEP-BMENG > REST_BQTY.
              IF lncnf_qty >= rest_bqty.
*                       I3-KBMENG = IVBEP-BMENG - REST_BQTY.
*                       REST_BQTY = IVBEP-BMENG - REST_BQTY.
                i3-kbmeng = lncnf_qty - rest_bqty.
                rest_bqty = lncnf_qty - rest_bqty.
                IF rest_bqty < 0.
                  rest_bqty = 0.
                ENDIF.
              ELSE.
                i3-kbmeng = 0.
*                       REST_BQTY = REST_BQTY - IVBEP-BMENG.
                rest_bqty = rest_bqty - lncnf_qty.
              ENDIF.
            ELSE.
*                    I3-KBMENG = IVBEP-BMENG.
              i3-kbmeng = lncnf_qty.
            ENDIF.
            IF i3-lfimg = 0. "un dn qty
              "no undeliver dn,but need to check if billing qty
              IF i3-kbmeng <> 0.
                PERFORM move-i1-data USING 1.
                i3-cedatu =  ivbep-edatu.     " confirmed date
*                       I3-REDATU = IVBEP-EDATU.  "Request Date
                i3-redatu = rqt_date.  "Request Date
                i3-schline = intline.
                i3-unconfqty = 0.
                i3-bmeng = ivbep-bmeng. "conf qty
                i3-uncnfamt = i3-unconfqty * i1-netpr.
                "unconf dn amt
                IF intline = 1.
                  i3-kwmeng = ord_qty. "IVBEP-WMENG. "ord qty
                ENDIF.
                i3-waerk =  i1-waers.
*                      I3-SCHQTY = IVBEP-BMENG.
                i3-schqty = lncnf_qty.
                i3-lfimg = 0.  "unD/N qty
                i3-opamt = i3-kbmeng * i1-netpr. "open amt
                i3-zpi01amt = i3-zpi01 * i3-kbmeng.
                i3-odnamt = i3-dnqty * i1-netpr. "already dn amt
                i3-dnamt = i3-lfimg * i1-netpr.  "open dn amt
                i3-otype =  i1-auart.   "po type
                i3-sosto = 'X'.
                i3-vbeln =  i1-vbeln.
                i3-posnr =  i1-posnr.
                i3-uepos =  i1-uepos.
                i3-vrkme =  i1-meins.  "unit of measure
                i3-splant = i1-splant.
                i3-slgort = i1-slgort.
                i3-slgpbe = i1-slgpbe.
                i3-mbdat = nmat_date.
                i3-ambdat = ivbep-mbdat.
                i3-firstmatv = mat_date.
                i3-zz_first = i1-zz_edatu.
                i3-zz_mbdat = i1-zz_edatu.

*                       I3-FIRSTDELV = FIRSTDELV.
*                       I3-STATUS = 4.
                i3-labst = i1-labst.
                i3-oedatu = i1-oedatu. "Ord date
                PERFORM get_backlog_date.
                IF p_rado2 = ''.
                  APPEND i3.
                  CLEAR i3.
                  intline = intline + 1.
                ELSE.
                  CLEAR i3.
                ENDIF.
              ELSE.
                CLEAR i3.
              ENDIF.
            ELSE.
              PERFORM move-i1-data USING 1.
              i3-schline = intline.
              i3-unconfqty = 0.
              i3-uncnfamt = i3-unconfqty * i1-netpr.
              "unconf dn amt
              i3-waerk =  i1-waers.
*                    I3-SCHQTY = IVBEP-BMENG.
              i3-schqty = lncnf_qty.
              IF intline = 1.
                i3-kwmeng = ord_qty. "IVBEP-WMENG. "ord qty
              ENDIF.
              i3-odnamt = i3-dnqty * i1-netpr.
              i3-opamt = i3-kbmeng * i1-netpr.
              i3-zpi01amt = i3-zpi01 * i3-kbmeng.
              i3-dnamt = i3-lfimg * i1-netpr.
              i3-otype =  i1-auart.   "po type
              i3-vbeln =  i1-vbeln.
              i3-posnr =  i1-posnr.
              i3-uepos =  i1-uepos.
              i3-vrkme =  i1-meins.  "unit of measure
              i3-splant = i1-splant.
              i3-slgort = i1-slgort.
              i3-slgpbe = i1-slgpbe.
              i3-sosto = 'X'.
*                    I3-STATUS = 1.
              i3-labst = i1-labst.
              i3-oedatu = i1-oedatu. "Ord date
              i3-cedatu =  ivbep-edatu.     " confirmed date
*                    I3-REDATU = IVBEP-EDATU.  "Request Date
              i3-redatu = rqt_date.  "Request Date
              i3-mbdat =  nmat_date.
              i3-ambdat = ivbep-mbdat.
              i3-firstmatv = mat_date.
              i3-zz_first = i1-zz_edatu.
              i3-zz_mbdat = i1-zz_edatu.

*                   I3-FIRSTDELV = FIRSTDELV.
              PERFORM get_backlog_date.
              IF p_rado2 = ''.
                APPEND i3.
                CLEAR i3.
                intline = intline + 1.
                IF diff_dnqty <> 0 AND sy-index = intcnt.
                  IF p_rado2 = 'X' OR p_rado3 = 'X'.
                    PERFORM move-i1-data USING 1.
                    i3-schline = intline.
                    i3-kbmeng = diff_dnqty.  "open qty
                    i3-unconfqty = diff_dnqty.
                    i3-uncnfamt = i3-unconfqty * i1-netpr.
                    "unconf dn amt
                    i3-lfimg = diff_dnqty.  "un dn qty
*                            I3-STATUS = 1.
                    i3-oedatu = i1-oedatu. "Ord date
                    i3-otype =  i1-auart.   "po type
*                            I3-REDATU = IVBEP-EDATU.  "Request Date
                    i3-redatu = rqt_date.  "Request Date
                    i3-dnqty = 0.  "Delivered D/N qty
                    i3-odnamt = 0. "already D/N amt
                    i3-schqty = diff_dnqty. "sch qty
                    i3-sosto = 'X'.
                    IF intline = 1.
                      i3-kwmeng = ord_qty.
                      "IVBEP-WMENG. "ord qty
                    ENDIF.
                    i3-bmeng = 0. "conf qty
                    i3-opamt = i3-kbmeng * i1-netpr.
                    i3-zpi01amt = i3-zpi01 * i3-kbmeng.
                    i3-dnamt = i3-lfimg * i1-netpr.
                    i3-labst = i1-labst.
                    i3-mbdat = nmat_date.
                    i3-ambdat = ivbep-mbdat.
                    i3-firstmatv = mat_date.
                    i3-zz_first = i1-zz_edatu.
                    i3-zz_mbdat = i1-zz_edatu.

*                            I3-FIRSTDELV = FIRSTDELV.
                    PERFORM get_backlog_date.
                    APPEND i3.
                    CLEAR i3.
                    intline = intline + 1.
                  ENDIF.
                ENDIF.
              ELSE.
                CLEAR i3.
              ENDIF.
            ENDIF.
**Add By Hermit if meet schedule confirm qty = 0 2007/08/06
** user split different sch line
** sche 1 10 10 0
** sche 2 5 5 0
** 20181104 ,rong, need display confirm qty = 0, reuqriement from Sylvia
*          ELSE.
*            IF ( P_RADO2 = 'X' OR P_RADO3 = 'X' ) AND i1-vkorg = 'US10'.
*               PERFORM MOVE-I1-DATA USING 1.
*              I3-KBMENG = IVBEP-WMENG.  "open qty
*              I3-UNCONFQTY = IVBEP-WMENG.
*              I3-UNCNFAMT = I3-UNCONFQTY * I1-NETPR.
*              "unconf dn amt
*              I3-LFIMG = IVBEP-WMENG.  "un dn qty
*              I3-OEDATU = I1-OEDATU. "Ord date
*              I3-OTYPE =  I1-AUART.   "po type
*              I3-REDATU = RQT_DATE.  "Request Date
*              I3-DNQTY = 0.  "Delivered D/N qty
*              I3-ODNAMT = 0. "already D/N amt
*              I3-SCHQTY = IVBEP-WMENG. "sch qty
*              I3-SOSTO = 'X'.
*              IF INTLINE = 1.
*                I3-KWMENG = ORD_QTY.
*                "IVBEP-WMENG. "ord qty
*              ENDIF.
*              I3-BMENG = 0. "conf qty
*              I3-OPAMT = I3-KBMENG * I1-NETPR.
*              I3-DNAMT = I3-LFIMG * I1-NETPR.
*              I3-LABST = I1-LABST.
*              I3-MBDAT = NMAT_DATE.
*              I3-AMBDAT = IVBEP-MBDAT.
*              I3-FIRSTMATV = MAT_DATE.
*              I3-ZZ_FIRST = I1-ZZ_EDATU.
*              I3-ZZ_MBDAT = I1-ZZ_EDATU.
*              PERFORM GET_BACKLOG_DATE.
*              APPEND I3.
*              CLEAR I3.
*              intline = intline + 1.
*            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
    intloop = intloop + 1.
  ENDLOOP.

ENDFORM.                    "PROCESS_SO_SCHLINE
**** End Add Hermit

***************
* Add By Hermit
* To check current record is the last one
* if yes, then check the ord_qty - total cnf_qty
* if this diff <> 0 then add for unconfirm qty
***************
FORM check_rest_qty USING ord_qty ord_diffqty
                          CHANGING VALUE(intline).
  IF ord_diffqty <> 0.
    IF p_rado2 = 'X' OR p_rado3 = 'X'.
      PERFORM move-i1-data USING 1.
      i3-schline = intline.
      i3-kbmeng = ord_diffqty.  "open qty
      i3-unconfqty = ord_diffqty.
      i3-uncnfamt = i3-unconfqty * i1-netpr.  "unconf dn amt
      i3-lfimg = ord_diffqty.  "un dn qty
*         I3-STATUS = 1.
      i3-oedatu = i1-oedatu. "Ord date
      i3-redatu = ivbep-edatu.  "Request Date
      i3-ambdat = ivbep-mbdat.
      i3-dnqty = 0.  "Delivered D/N qty
      i3-odnamt = 0. "already D/N amt
      i3-schqty = ord_diffqty. "sch qty
      i3-sosto = 'X'.
      IF intline = 1.
        i3-kwmeng = ord_qty.
        "IVBEP-WMENG. "ord qty
      ENDIF.
      i3-bmeng = 0. "conf qty
      i3-opamt = i3-kbmeng * i1-netpr.
      i3-zpi01amt = i3-zpi01 * i3-kbmeng.
      i3-dnamt = i3-lfimg * i1-netpr.
      PERFORM get_backlog_date.
      APPEND i3.
      CLEAR i3.
      intline = intline + 1.
    ENDIF.
  ENDIF.
ENDFORM.                    "CHECK_REST_QTY

*&---------------------------------------------------------------------*
*&      Form  GET_BACKLOG_DATE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM get_backlog_date.
  IF NOT i3-cedatu IS INITIAL.      "  confirm  Qty
    i3-blogdt = i3-cedatu.
  ELSEIF NOT i3-ondockdt IS INITIAL.
*         I3-BLOGDT = I3-ONDOCKDT.   2005/09/27 by Ted
    IF  i3-ondockdt > next_month .
      i3-blogdt = i3-ondockdt.
    ELSEIF  i3-ondockdt < last3_month.  " 
      i3-blogdt = i3-ondockdt.
    ELSE.
      i3-blogdt = next_month.   "  confirm 
    ENDIF.   " ,,
  ELSE.
*         I3-BLOGDT = I3-REDATU.     2005/09/27 by Ted
    IF  i3-redatu > next_month .
      i3-blogdt = i3-redatu.
    ELSEIF  i3-redatu < last3_month.  " 
      i3-blogdt = i3-redatu.
    ELSE.
      i3-blogdt = next_month.   "  confirm 
    ENDIF.   " ,,
  ENDIF.
ENDFORM.                    "GET_BACKLOG_DATE
*&---------------------------------------------------------------------*
*&      Form  process_sto_hans
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_P_DFLAG  text
*----------------------------------------------------------------------*
FORM process_sto_hans  CHANGING dflag.
  DATA: p_vstat  LIKE nast-vstat,
        p_lfimg  LIKE lips-lfimg,
        p_dvbeln LIKE lips-vbeln,
        p_dnqty  LIKE lips-lfimg,
        p_tqty   LIKE lips-lfimg,
        p_bqty   LIKE lips-lfimg,
        p_posnr  LIKE lips-posnr.
  DATA: w_del_item TYPE c.
  DATA: w_append TYPE c.
  DATA: wa_knvv LIKE knvv.
  DATA: wa_eket LIKE eket.
**add by hermit 2006/11/10
  DATA : tporg LIKE ekko-ekorg.
  DATA : tmp_qty    LIKE eket-glmng,
         xxx_qty    LIKE eket-glmng,
         unit_price LIKE ekpo-netpr,
         intcnt     TYPE i,
         diff_qty   LIKE eket-glmng,
         intline    TYPE i,
         cnf_qty    LIKE eket-glmng,
         rest_bqty  LIKE eket-glmng,
         topen_qty  LIKE eket-glmng,
         line_qty   LIKE eket-glmng.


*
*check shipping condition, sold-to party and ship-to party when STO
*"changed to selection criteria.
*  CLEAR ekpv.
*  SELECT SINGLE * FROM ekpv
*  WHERE ebeln = i1-ebeln "STO number
*    AND ebelp = i1-ebelp "STO item
*  AND vsbed IN s_vsbed "shipping condition
*  AND kunag IN s_kunag "Sold-to party
*  AND kunnr IN s_kunnr."ship-to party
*
*  IF sy-subrc <> 0.
*    dflag = 'X'. EXIT.
*  ENDIF.

*check sales office and sales group when sto
*  CLEAR knvv.
*  SELECT * FROM knvv
*  UP TO 1 ROWS
*  WHERE kunnr = ekpv-kunnr
*    AND vkgrp IN s_vkgrp
*    AND vkbur IN s_vkbur.
*  ENDSELECT.
*
*  IF sy-subrc <> 0.
*    dflag = 'X'. EXIT.
*  ENDIF.
***add by Hermit 2006/11/10
  SELECT SINGLE ekorg FROM t024w INTO t024w-ekorg
  WHERE werks = i1-reswk.
  tporg = t024w-ekorg.
*sales person and Z1,Z2,Z3, Z4
  IF  s_pernr IS INITIAL.

    CLEAR knvp.
    SELECT SINGLE * FROM knvp
    WHERE kunnr = i1-kunnr
          AND vkorg = tporg
*      AND VKORG = P_VKORG
*    AND vtweg = i1-vtweg
*    AND spart = i1-spart
    AND parvw =  c_ve.
*    AND pernr IN s_pernr.
    i1-pernr = knvp-pernr.  "set sales person id


* check sales group and office, infects sold to party.
    IF s_vkgrp[] IS INITIAL AND  s_vkbur[] IS INITIAL.
      CLEAR wa_knvv.
      SELECT SINGLE * FROM knvv
      INTO wa_knvv
       WHERE kunnr = i1-kunnr
*        AND  VKORG = P_VKORG.
      AND  vkorg = tporg.

      IF sy-subrc <> 0.
* 20180705 fix purchase org EU01 ,  sales org =  EU10 bug
*        dflag = 'X'. EXIT.
      ELSE.
        i1-vkgrp = wa_knvv-vkgrp.
        i1-vkbur = wa_knvv-vkbur.
        i1-zterm = wa_knvv-zterm.
      ENDIF.

    ELSE.
      CLEAR wa_knvv.
      LOOP AT  it_knvv INTO wa_knvv
       WHERE kunnr = i1-kunnr
*         AND VKORG = P_VKORG.
         AND vkorg = tporg.
        i1-vkgrp = wa_knvv-vkgrp.
        i1-vkbur = wa_knvv-vkbur.
        i1-zterm = wa_knvv-zterm.

      ENDLOOP.
    ENDIF.


  ELSE.  " IF  not s_pernr IS INITIAL.

*check sales person
    LOOP AT it_knvvvp
          WHERE kunnr = it_knvvvp-kunnr
            AND vkorg = it_knvvvp-vkorg
            AND parvw =  c_ve.

      IF sy-tabix = 1.
        i1-pernr = it_knvvvp-pernr.   "set sales person id
        i1-vkgrp = it_knvvvp-vkgrp.
        i1-vkbur = it_knvvvp-vkbur.
        i1-zterm = it_knvvvp-zterm. " payment term

      ENDIF.
    ENDLOOP.

  ENDIF.


*set sales person name
  CLEAR pa0002.
  SELECT SINGLE * FROM pa0002
  WHERE pernr = i1-pernr.

  CONCATENATE pa0002-vorna ' ' pa0002-nachn INTO i1-sname.


*get production hierachy  and old material number and material status
  CLEAR mvke.
  SELECT SINGLE * FROM mvke WHERE matnr = i1-matnr
                              AND vkorg = i1-vkorg
  AND vtweg = '00'.
  IF NOT mvke-vmsta IS INITIAL.
    i1-mstav = mvke-vmsta.
  ENDIF.
*20231130
  i1-mvgr2 = mvke-mvgr2.

*  IF i1-mstav is initial.
*    LOOP AT it_mara WHERE matnr = i1-matnr.
*      i1-mstav = it_mara-mstav. " material status
*    ENDLOOP.
*  ENDIF.

*get Special procurement type
*  CLEAR marc.
*  SELECT SINGLE * FROM marc WHERE matnr = i1-matnr
*                              AND werks = i1-werks.
*  i1-sobsl = marc-sobsl.
** plant delivery LT time
*  i1-plifz = marc-plifz .


*  CLEAR mara.
*  SELECT SINGLE * FROM mara WHERE matnr = i1-matnr.
*  i1-bismt = mara-bismt.
*  i1-prodh = mara-prdha.

*  IF i1-mstav = space.
*      i1-mstav = mara-mstav. " material status
*  ENDIF.

**set product hierarchy - level2 product group
*  i1-prodh2 = i1-prodh+5(5).
*
**set product hierarchy - level3 product line
*  i1-prodh3 = i1-prodh+10(8).
*

*set on hand quantity and check storage bin
*  CLEAR: ztsd_30, mard.
*  SELECT SINGLE * FROM ztsd_30
*  WHERE mtart = mara-mtart
*    AND werks = i1-reswk.
*
*  IF sy-subrc = 0.
*    CLEAR mard.
*    SELECT SINGLE * FROM mard
*    WHERE matnr = i1-matnr
*      AND werks = i1-reswk
*      AND lgort = ztsd_30-lgort.
*
*    IF sy-subrc = 0.
*      i1-labst = mard-labst.
*    ENDIF.
*  ENDIF.
* real unit price for PB00.
  IF i1-kpein1 NE 0.
    i1-kbetr  = i1-kbetr / i1-kpein1.
  ENDIF.

  CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
    EXPORTING
      currency    = i1-waerk
      sap_amount  = i1-kbetr
    IMPORTING
      idoc_amount = i1-kbetr.


* real unit price for single product.
  i1-netpr  = i1-netpr / i1-peinh.
  CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
    EXPORTING
      currency    = i1-waerk
      sap_amount  = i1-netpr
    IMPORTING
      idoc_amount = i1-netpr.

* , down , ,  data 
* 2005/6/1 by Ted

  IF i1-netpr > 98765432101 .
    i1-netpr = 98765432101 .
  ENDIF.
  i1-waerk = i1-waers.

*I1-NETPR = I1-NETWR.
*convert amt
  IF p_waers <> space AND p_cur2 <> space.
*    i1-waerk = i1-waers.
*    IF i1-waerk <> p_waers.
    IF i1-waers <> p_waers.

      PERFORM convert_amt USING i1-kbetr
*                           i1-waerk
                            i1-waers
                            p_waers
                            i1-ebeln i1-ebelp
                            i1-otype
                            i1-zpi01amt
                   CHANGING i1-kbetr i1-opamt
                            i1-waerk
                            i1-zpi01amt.


      PERFORM convert_amt USING i1-netpr
*      I1-STWAERS
*                                i1-waerk
                                i1-waers
                                p_waers
                                i1-ebeln i1-ebelp
                                i1-otype
                                i1-zpi01amt
* revise by Hermit 2006/03/01
*                                I1-VBELN   I1-POSNR
                       CHANGING i1-netpr i1-opamt
                                i1-waerk
                                i1-zpi01amt.
    ENDIF.
  ENDIF.
*set print flag
  CLEAR ztsd_revise.
  SELECT SINGLE * FROM ztsd_revise
  WHERE vbeln = i1-ebeln.

  IF sy-subrc = 0.
    i1-vstat = 'X'. "printed
  ENDIF.

* get customer ID
*  SELECT SINGLE * FROM t001w
*  WHERE werks = i1-werks.
*  i1-kunnr =  t001w-kunnr .
  i1-shipto = i1-kunnr.
*  i1-billto = i1-kunnr.
**add by rong 20181002,Require From Sylvia
  SELECT SINGLE adrc~country adrc~city1 adrc~region adrc~post_code1 adrc~street
          INTO (i1-country_ship,i1-city_ship,i1-region_ship,i1-post_ship,i1-street_ship)
          FROM adrc INNER JOIN ekpo ON ekpo~adrnr = adrc~addrnumber
          WHERE ekpo~ebeln = i1-ebeln
            AND ekpo~ebelp = i1-ebelp
            AND adrc~date_from <= sy-datlo
            AND adrc~date_to >= sy-datlo
  AND adrc~nation = '1'.
  IF sy-subrc <> 0.
    SELECT SINGLE adrc~country adrc~city1 adrc~region adrc~post_code1 adrc~street
        INTO (i1-country_ship,i1-city_ship,i1-region_ship,i1-post_ship,i1-street_ship)
        FROM adrc INNER JOIN ekpo ON ekpo~adrnr = adrc~addrnumber
        WHERE ekpo~ebeln = i1-ebeln
          AND ekpo~ebelp = i1-ebelp
          AND adrc~date_from <= sy-datlo
          AND adrc~date_to >= sy-datlo
    AND adrc~nation = ''.
  ENDIF.
**end rong
*******
* Add By Hermit 2005/08/04
* To get transit time
  SELECT SINGLE traztd INTO tvro-traztd
  FROM tvro WHERE route = i1-route.
  IF sy-subrc = 0.
    transit_day = tvro-traztd / 240000.
  ELSE.
    transit_day = 0.
  ENDIF.

***Add By Hermit 2006/11/20
  PERFORM get_on_hand_qty.
  PERFORM get_po_item_text.
  PERFORM get_sto_item_delivery_text.   " Xuan.Kao 20231220 STO Item Delivery text
***add by Hermit 2007/12/10 get P/T buffer day
  SELECT SINGLE * FROM ztpp_25 WHERE matnr = i1-matnr.
  IF sy-subrc = 0.
    i1-zbuffer = ztpp_25-zbuffer.
  ENDIF.


* get search term
  SELECT SINGLE * FROM kna1 WHERE kunnr = i1-kunnr.
  i1-sortl =  kna1-sortl.
  i1-brsch =  kna1-brsch.  "industry key
  i1-katr4 = kna1-katr4.
  i1-land1 = kna1-land1.
  i1-regio = kna1-regio.
  CLEAR wa_eket.
  SELECT SINGLE *
  INTO  CORRESPONDING FIELDS OF  wa_eket
  FROM  eket
  WHERE ebeln = i1-ebeln
  AND   ebelp = i1-ebelp.

  i1-slfdt = wa_eket-slfdt.
  i1-eindt = wa_eket-eindt.
  i1-dat01 = wa_eket-dat01.
  i1-wemng = wa_eket-wemng.
  "i1-wamng = wa_eket-wamng.  "double add on 2022
  i1-mbdat = wa_eket-mbdat. "Material availability date


* Order date = document date(EKKO-BEDAT)
  i1-oedatu =  i1-audat.     " Order date

*STOdelivery block & credit block
*set delivery date, currency, order quantity, po type
  IF NOT i1-slfdt IS INITIAL.  "Request date
    i1-redatu =  i1-slfdt.
  ELSE.
    i1-oedatu =  i1-eindt.
  ENDIF.

*****Add By Hermit 2005/07/11
* 1. Get supply plant from EKKO
* 2. Get Stor loc from EKPO
* 3. Get Stor bin from mard
  SELECT SINGLE lifnr FROM ekko INTO ekko-lifnr
  WHERE ebeln = i1-ebeln.
  IF sy-subrc = 0.
    i1-splant = ekko-lifnr.
    SELECT SINGLE reslo FROM ekpo INTO ekpo-reslo
        WHERE matnr = i1-matnr
          AND ebeln = i1-ebeln
    AND ebelp = i1-ebelp.
    IF sy-subrc = 0.
      IF NOT ekpo-reslo IS INITIAL.
        i1-slgort = ekpo-reslo.
        SELECT SINGLE lgpbe FROM mard INTO mard-lgpbe
            WHERE matnr = i1-matnr
              AND werks = ekko-lifnr
        AND lgort = ekpo-reslo.
        IF sy-subrc = 0.
          i1-slgpbe = mard-lgpbe.
        ENDIF.
      ELSE.
        "Get main stor condition
        SELECT SINGLE raube FROM mara INTO mara-raube
        WHERE matnr = i1-matnr.
        IF sy-subrc = 0.
          "Get stor loc from main storage condition
          SELECT SINGLE lgort FROM tvkol INTO tvkol-lgort
              WHERE vstel = i1-splant
                AND werks = i1-splant
          AND raube = mara-raube.
          IF sy-subrc = 0.
            SELECT SINGLE lgpbe FROM mard INTO mard-lgpbe
               WHERE matnr = i1-matnr
                 AND werks = i1-splant
            AND lgort = tvkol-lgort.
            IF sy-subrc = 0.
              i1-slgort = tvkol-lgort.
              i1-slgpbe = mard-lgpbe.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

  ENDIF.

  PERFORM get_suuply_on_hand_qty.

*** End Add By Hermit

*      SELECT SINGLE  * FROM MARD
*     INTO CORRESPONDING FIELDS OF WA_MARD
*     WHERE MATNR = I1-MATNR
*       AND WERKS = I1-SPLANT.
**       AND LGORT = I1-SLGPBE.
**       AND lgpbe IN s_lgpbe.
*
*      IF SY-SUBRC = 0.
*        I1-LABST = WA_MARD-LABST.
*      ELSE.
*     I1-LABST = 0.
*   ENDIF.

  i1-cedatu = i1-dat01.  " confirmed date = committed date
  i1-edatu =  i1-eindt.
* I1-WAERK =  I1-WAERS.
  i1-kwmeng = i1-menge.
  i1-otype =  i1-bsart.   "po type
  i1-vbeln =  i1-ebeln.
  i1-posnr =  i1-ebelp.
  i1-vrkme =  i1-meins.  "unit of measure


*get delivery no for STO
  REFRESH iekbe.
  CLEAR: ekbe, iekbe, a1, p_bqty, p_dnqty, p_tqty.

  IF i1-bsart = 'ISLD' OR i1-bsart = 'IPD'.
    SELECT * FROM ekbe
     APPENDING CORRESPONDING FIELDS OF TABLE iekbe
     WHERE ebeln = i1-ebeln
    AND ebelp = i1-ebelp.
  ELSE.
    SELECT * FROM ekbe
     APPENDING CORRESPONDING FIELDS OF TABLE iekbe
     WHERE ebeln = i1-ebeln
       AND ebelp = i1-ebelp
*    AND vgabe = c_v08.
    AND bewtp = c_vl.   " category = L. Cutty said.
  ENDIF.
  g_seq = g_seq + 1.
  g_cnt = g_seq.
  i1-seqno = g_seq.
* chris 20121011
  DATA : i_belnr LIKE iekbe-belnr.
  CLEAR : i_belnr.

  SELECT belnr INTO i_belnr
  FROM ekbe
  WHERE ebeln = i1-ebeln
    AND ebelp = i1-ebelp
    AND bewtp = c_vl   " category = L. Cutty said.
    AND menge = i1-wemng.
  ENDSELECT.

  i1-dvbeln = i_belnr.
* chris 20121011

  REFRESH i2.

  LOOP AT iekbe WHERE ebeln = i1-ebeln AND ebelp = i1-ebelp.


    CLEAR: v_vbup_cds, i2.
    SELECT SINGLE * FROM v_vbup_cds
    WHERE vbeln = iekbe-belnr
    AND posnr = iekbe-buzei.

*assign delivery status
    IF  sy-subrc = 0.
* Billed: Billing status = C ,
      IF v_vbup_cds-fkivp = c_c01.
        i2-status = '5'.                                    "5. billed
      ENDIF.
* 4 POST: billing status = 'A', Goods movement = 'C'.
      IF  v_vbup_cds-fkivp = c_a01 AND v_vbup_cds-wbsta = c_c01 .

        i2-status = c_v04.                                  "4. Post
      ENDIF.
* 3  NOT YET POST: Picking status= C, Good Mov = A or B
      IF  v_vbup_cds-kosta = c_c01
       AND  v_vbup_cds-wbsta = c_a01 OR v_vbup_cds-wbsta = c_b01 .
*       AND  i2-status = space.
        i2-status = c_v03.       "3. Not yet post
      ENDIF.
* 2 Not yet Picked
      IF  v_vbup_cds-kosta = c_a01 ." AND i2-status = space.
        i2-status = c_v02.       "2. Not yet picked
      ENDIF.

    ENDIF.


    CLEAR lips.
    SELECT SINGLE * FROM lips
    WHERE vbeln = iekbe-belnr
    AND posnr = iekbe-buzei.

    IF sy-subrc = 0.

      p_tqty = p_tqty + lips-lfimg. " ALL dn qty.


      IF i2-status = 5.
        p_bqty = p_bqty + lips-lfimg. "BILLING QUANTITY
      ELSE.
        p_dnqty = p_dnqty + lips-lfimg. "DN QUANTITY
      ENDIF.

    ENDIF.

    IF i1-bsart = 'ISLD' OR i1-bsart = 'IPD'.
      IF iekbe-bwart = '101'.
        p_bqty = p_bqty + iekbe-menge.
      ENDIF.
      IF iekbe-bwart = '102'.
        p_bqty = p_bqty - iekbe-menge.
      ENDIF.
    ENDIF.
*print flag
    CLEAR: ztsd_revise, p_vstat, p_dvbeln, p_lfimg.

    SELECT SINGLE * FROM ztsd_revise
    WHERE vbeln = iekbe-belnr.

    IF sy-subrc = 0.
      i1-vstat = 'X'. "printed
    ENDIF.


    IF i2-status <> '5'.
      CLEAR w_append.
      CASE i2-status.
        WHEN 4.
          IF p_sts4 <>  space.
            w_append = 'X'.
          ENDIF.
        WHEN 3.
          IF p_sts3 <> space .
            w_append = 'X'.
          ENDIF.
        WHEN 2.
          IF p_sts2 <> space.
            w_append = 'X'.
          ENDIF.
      ENDCASE.

      IF w_append = 'X'.

        g_seq     = g_seq + 1.
        i2-seqno  = g_seq.
        i2-dvbeln = iekbe-belnr.
*        I2-LFIMG  = LIPS-LFIMG.
        i2-adnqty = lips-lfimg.
        i2-vstat  = i1-vstat.
        i2-vrkme  = i1-vrkme.
        i2-adnamt =  i2-adnqty * i1-netpr.
        APPEND i2.

      ENDIF.
    ENDIF.
  ENDLOOP.

*set delivery qty
  i1-lfimg = p_dnqty.

*set open quantity
  i1-kbmeng = i1-menge - p_bqty.

*set open amount
  i1-opamt = i1-kbmeng * i1-netpr.



* if  "Not yet DN qty exists.
  IF i1-kwmeng <> p_tqty.

    IF p_sts1 <>  space.  "show unDN
      i1-lfimg = i1-kwmeng - p_tqty.
      i1-status = c_v01.
    ELSE.
      READ TABLE i2 INDEX 1.
      IF sy-subrc = 0.
        CLEAR: i1-status, i1-lfimg.
        i1-dvbeln = i2-dvbeln.
        i1-lfimg  = i2-lfimg.
        i1-status = i2-status.

        DELETE i2 INDEX 1.
        g_seq = g_seq - 1.
        g_cnt = g_seq.
      ELSE.
        w_del_item ='X'.
      ENDIF.
    ENDIF.
  ELSE.
    READ TABLE i2 INDEX 1.
    IF sy-subrc = 0.
      CLEAR: i1-status, i1-lfimg.
      i1-dvbeln = i2-dvbeln.
      i1-lfimg  = i2-lfimg.
      i1-status = i2-status.

      DELETE i2 INDEX 1.
      g_seq = g_seq - 1.
      g_cnt = g_seq.
    ELSE.
      w_del_item ='X'.

    ENDIF.
  ENDIF.

* 20050509 Hans add start.
*set DN amount
  i1-dnamt = i1-lfimg * i1-netpr.
* 20050509 Hans add end.

*****
* Add By hermit 2005/07/25
* MNG01 -> Committed qty
* DAT01 -> Committed date
* MENGE -> Scheduled quantity
* GLMNG -> Quantity delivered (stock transfer)
* EINDT -> delv date
* SLFDT -> Statistics-relevant delivery date
  IF w_del_item = space. "add by hermit
    REFRESH : i3,ieket.
    CLEAR : i3, ieket.
    SELECT * FROM eket
         APPENDING CORRESPONDING FIELDS OF TABLE ieket
           WHERE ebeln = i1-ebeln
    AND ebelp = i1-ebelp .

    IF sy-subrc = 0.
      SORT ieket BY eindt.
      PERFORM process_sto_schline USING p_tqty p_bqty i1-splant.
    ENDIF.

**Add By Hermit 2005/07/26
    IF intcnt > 1.
      diff_qty = i1-lfimg - tmp_qty.
    ELSE.
      diff_qty = 0.
    ENDIF.
    IF diff_qty = 0.
      w_del_item = 'X'.
    ELSE.
      i1-kbmeng = i1-kbmeng - tmp_qty.
      i1-lfimg = i1-lfimg - tmp_qty.
    ENDIF.
**End of Add

*  MODIFY a1 INDEX g_cnt.

*  IF W_DEL_ITEM = SPACE.
*     CLEAR A1.
**  creat first line item
*     MOVE-CORRESPONDING I1 TO A1.
*     APPEND A1.
*  ENDIF.

**Add By Hermit
    IF NOT i3[] IS INITIAL.
      LOOP AT i3.
        CLEAR a1.
        MOVE-CORRESPONDING i3 TO a1.
        APPEND a1.
      ENDLOOP.
    ENDIF.
**End of Hermit

    IF p_rado2 = ''.
      IF NOT i2[] IS INITIAL.
* a1: data table for ALV
        LOOP AT i2.
          CLEAR a1.
          MOVE-CORRESPONDING i2 TO a1.
          APPEND a1.
        ENDLOOP.
      ENDIF.
    ENDIF.
  ENDIF.  "add by hermit for checking w_del_item

ENDFORM.                    " process_sto_hans


**************************************
* Add By Hermit 2005/07/27
* To Process STO Schedule Line
* Original delv date = on dock date
* request date = material available date
**************************************
FORM process_sto_schline USING p_dnqty p_bqty p_splant.
  DATA :
    tmp_qty     LIKE eket-glmng,
    xxx_qty     LIKE eket-glmng,
    unit_price  LIKE ekpo-netpr,
    intcnt      TYPE i,
    diff_qty    LIKE eket-glmng,
    intline     TYPE i,
    cnf_qty     LIKE eket-glmng,
    rest_bqty   LIKE eket-glmng,
    topen_qty   LIKE eket-glmng,
    tadn_qty    LIKE eket-glmng,
    firstmatv   LIKE eket-eindt,
    ord_diffqty LIKE eket-glmng,
    intloop     TYPE i,
    lncnf_qty   LIKE eket-glmng,
    line_qty    LIKE eket-glmng.
  DESCRIBE TABLE ieket LINES intcnt.
  rest_bqty = p_bqty. "Billing qty
  line_qty = p_dnqty. "D/N qty
  intline = 1.
  intloop = 1.
  IF p_splant = 'TWH2'.
    LOOP AT ieket.
      ieket-dat01 = ieket-mbdat.
      ieket-mng02 = ieket-menge.
      MODIFY  ieket.
    ENDLOOP.
  ENDIF.
  LOOP AT ieket.
    cnf_qty = i3-bmeng + cnf_qty.
    i3-erdat = i1-aedat.
* chris 20120830
    i3-ekgrp = i1-ekgrp .
* chris 20121024
    i3-frgke = i1-frgke .
**add by rong 20181002,Require from Sylvia
    i3-country_ship = i1-country_ship.
    i3-city_ship    = i1-city_ship.
    i3-region_ship  = i1-region_ship.
    i3-post_ship    = i1-post_ship.
    i3-street_ship  = i1-street_ship.
**add end
    IF ieket-dat01 <> '99991231'.
*         MOVE-CORRESPONDING I1 TO I3.
      line_qty = line_qty - ieket-glmng.
      IF intloop = 1.
        po_date = ieket-slfdt. "- TRANSIT_DAY.
        firstmatv = ieket-licha. "first avai date
      ENDIF.
      "DN qty - line dn qty
      IF line_qty <> 0.
        IF line_qty < 0.
          line_qty = 0.
        ENDIF.
        PERFORM move-i1-data USING 1.
        diff_qty = ieket-menge - ieket-glmng. "UNDN QTY
        i3-cedatu = ieket-dat01.
        i3-oedatu =  i1-audat.     " Order date
        IF NOT ieket-slfdt IS INITIAL.  "Request date
          i3-ondockdt =  ieket-slfdt.
*               I3-REDATU =  IEKET-MBDAT.
          i3-redatu =  po_date.
        ELSE.
          i3-oedatu =  ieket-eindt.
        ENDIF.
        i3-firstdelv = i1-ean11.
        i3-schline = intline.
        i3-slfdt = ieket-slfdt.
        i3-eindt = ieket-eindt.
        i3-wemng = ieket-wemng.  "receive qty
        i3-wamng = ieket-wamng.  "DN ISSUE POSTING qty   "DOUBLE ADD ON 20230208
        i3-mbdat = ieket-mbdat.
        IF ieket-mng02 >= ieket-glmng.
          i3-bmeng = ieket-mng02.  "confirm qty
          lncnf_qty = ieket-mng02.
        ELSE.
          i3-bmeng = ieket-glmng.
          lncnf_qty = ieket-glmng.
        ENDIF.
        i3-unconfqty = ieket-menge - ieket-mng02.  "unconf qty
        i3-uncnfamt = i3-unconfqty * i1-netpr.  "unconf dn amt
        i3-edatu =  ieket-eindt.
*       I3-WAERK =  I1-WAERS.
        IF intline = 1.
          i3-kwmeng = i1-menge.  "Order Qty
        ENDIF.
        i3-schqty = ieket-menge.
        i3-lfimg = diff_qty.  "un D/N qty(=und/n qty)
        IF NOT ieket-glmng IS INITIAL.
          i3-dnqty =  ieket-glmng. "already DN
          i3-odnamt = i3-dnqty * i1-netpr.
        ELSE.
          i3-dnqty = 0. "already DN
          i3-odnamt = 0.
        ENDIF.
        IF rest_bqty <> 0.
*               IF IEKET-MNG02 >= REST_BQTY.
          IF lncnf_qty >= rest_bqty.
*                     I3-KBMENG = IEKET-MNG02 - REST_BQTY.  "open qty
*                     REST_BQTY = IEKET-MNG02 - REST_BQTY.
            i3-kbmeng = lncnf_qty - rest_bqty.  "open qty
            rest_bqty = lncnf_qty - rest_bqty.
          ELSE.
            i3-kbmeng = 0.
*                     REST_BQTY = REST_BQTY - IEKET-MNG02.
            rest_bqty = rest_bqty - lncnf_qty.
          ENDIF.
          "rest of bill qty
        ELSE.
          i3-kbmeng = ieket-mng02.
        ENDIF.
        i3-opamt = i3-kbmeng * i1-netpr.
        i3-dnamt = i3-lfimg * i1-netpr.
        i3-otype =  i1-bsart.   "po type
        i3-vbeln =  i1-ebeln.
        i3-posnr =  i1-ebelp.
        i3-uepos =  i1-uepos.
        i3-vrkme =  i1-meins.  "unit of measure
        i3-splant = i1-splant.
        i3-slgort = i1-slgort.
        i3-slgpbe = i1-slgpbe.
        i3-firstmatv = firstmatv.
        i3-zz_first = i1-zz_first .
        i3-zz_mbdat = i1-zz_mbdat.

        i3-erdat = i1-create_date.
        i3-erzet = i1-create_time.
        i3-commit_date = i1-commit_date.
        i3-kbetr  = i1-kbetr .
        PERFORM get_backlog_date.
        IF p_rado2 = ''.
          IF i3-kbmeng <> 0.
            IF intloop = intcnt.
*                     ORD_DIFFQTY = IEKET-MENGE - IEKET-MNG02.
              ord_diffqty = ieket-menge - lncnf_qty.
              IF ord_diffqty > 0 AND p_rado1 = 'X'.
                i3-unconfqty = ord_diffqty.
                i3-uncnfamt = i3-unconfqty * i1-netpr.
                "unconf dn amt
              ENDIF.
            ENDIF.
*                  I3-STATUS = 1.
            APPEND i3.
            CLEAR i3.
            intline = intline + 1.
            IF p_rado3 = 'X'.
              IF intloop = intcnt.
*                        ORD_DIFFQTY = IEKET-MENGE - IEKET-MNG02.
                ord_diffqty = ieket-menge - lncnf_qty.
                IF ord_diffqty > 0.
*** Add By Hermit 2006/02/15
                  i3-unconfqty = ord_diffqty.
                  i3-firstdelv = i1-ean11.
                  i3-uncnfamt = i3-unconfqty * i1-netpr.
                  i3-erdat = i1-create_date.
                  i3-erzet = i1-create_time.
                  i3-firstmatv = firstmatv.
                  i3-zz_first = i1-zz_first .
                  i3-zz_mbdat = i1-zz_mbdat.
                  i3-commit_date = i1-commit_date.
                  PERFORM check_rest_pqty USING ieket-menge
                                        ord_diffqty
                                        CHANGING intline.
                ENDIF.
              ENDIF.
            ENDIF.
          ELSE.
            CLEAR i3.
          ENDIF.
        ELSE.
          CLEAR i3.
          IF intloop = intcnt.
*                  ORD_DIFFQTY = IEKET-MENGE - IEKET-MNG02.
            ord_diffqty = ieket-menge - lncnf_qty.
            IF ord_diffqty > 0.
              i3-firstdelv = i1-ean11.
              i3-erdat = i1-create_date.
              i3-erzet = i1-create_time.
              i3-firstmatv = firstmatv.
              i3-zz_first = i1-zz_first .
              i3-zz_mbdat = i1-zz_mbdat.
              i3-commit_date = i1-commit_date.
              PERFORM check_rest_pqty USING ieket-menge
                                         ord_diffqty
                                         CHANGING  intline.
            ENDIF.
          ENDIF.
        ENDIF.
      ELSE. "LINE_QTY = 0
        IF intloop = 1.
          po_date = ieket-slfdt. "- TRANSIT_DAY.
          firstmatv = ieket-licha. "first avai date
        ENDIF.

        IF ieket-mng02 >= ieket-glmng.
          topen_qty = ieket-mng02 - rest_bqty.
*                    DIFF_QTY = IEKET-MNG02 - IEKET-GLMNG.
          lncnf_qty = ieket-mng02.
        ELSE.
          topen_qty = ieket-menge - rest_bqty.
*                   DIFF_QTY = IEKET-MENGE - IEKET-GLMNG.
          lncnf_qty = ieket-glmng.
        ENDIF.
        diff_qty = ieket-menge - lncnf_qty.
        IF topen_qty > 0.
          i3-firstdelv = i1-ean11.
          i3-commit_date = i1-commit_date.
          PERFORM move-i1-data USING 1.
          i3-cedatu = ieket-dat01.
          i3-oedatu =  i1-audat.     " Order date
          IF NOT ieket-slfdt IS INITIAL.  "Request date
            i3-ondockdt =  ieket-slfdt.
*                  I3-REDATU =  IEKET-MBDAT.
            i3-redatu =  po_date.
          ELSE.
            i3-oedatu =  ieket-eindt.
          ENDIF.
          i3-schline = intline.
          i3-slfdt = ieket-slfdt.
          i3-eindt = ieket-eindt.
*               I3-STATUS = 4.
          i3-wemng = ieket-wemng.  "receive qty
          i3-wamng = ieket-wamng.  "DN ISSUE POSTING qty   "DOUBLE ADD ON 20230208
          i3-mbdat = ieket-mbdat.
          i3-bmeng = lncnf_qty.  "confirm qty
          cnf_qty = i3-bmeng + cnf_qty.
*               I3-UNCONFQTY = IEKET-MENGE - IEKET-MNG02.  "unconf qty
          IF p_rado1 = 'X'.
            i3-unconfqty = ieket-menge - lncnf_qty.  "unconf qty
            i3-uncnfamt = i3-unconfqty * i1-netpr.  "unconf dn amt
          ENDIF.
*               I3-UNCONFQTY = IEKET-MENGE - LNCNF_QTY.  "unconf qty
*               I3-UNCNFAmt = I3-UNCONFQTY * I1-NETPR.  "unconf dn amt
          i3-edatu =  ieket-eindt.
*          I3-WAERK =  I1-WAERS.
          IF intline = 1.
            i3-kwmeng = i1-menge.  "Order Qty
          ENDIF.
          i3-schqty = ieket-menge.
          IF diff_qty <> 0.
            i3-cedatu = ieket-eindt.
*              I3-SCHQTY = IEKET-MNG02.  "sched qty
            i3-schqty = lncnf_qty.  "sched qty
          ENDIF.
          i3-lfimg = lncnf_qty - ieket-glmng.
*               I3-LFIMG = DIFF_QTY.  "Open D/N qty(=und/n qty)
          IF NOT ieket-glmng IS INITIAL.
            i3-dnqty =  ieket-glmng. "already DN
            i3-odnamt = i3-dnqty * i1-netpr.
          ELSE.
            i3-dnqty = 0. "already DN
            i3-odnamt = 0.
          ENDIF.

*               IF IEKET-MNG02 >= REST_BQTY.
          IF lncnf_qty >= rest_bqty.
*                  I3-KBMENG = IEKET-MNG02 - REST_BQTY.  "open qty
            i3-kbmeng = lncnf_qty - rest_bqty.  "open qty
            IF rest_bqty > 0.
*                     REST_BQTY = IEKET-MNG02 - REST_BQTY.
              rest_bqty = lncnf_qty - rest_bqty.
            ELSE.
              rest_bqty = 0.
            ENDIF.
          ELSE.
*                  I3-KBMENG = REST_BQTY - IEKET-MNG02.
*                  REST_BQTY = REST_BQTY - IEKET-MNG02.
            i3-kbmeng = rest_bqty - lncnf_qty.
            rest_bqty = rest_bqty - lncnf_qty.
            IF rest_bqty < 0.
              rest_bqty = 0.
            ENDIF.
          ENDIF.
          i3-opamt = i3-kbmeng * i1-netpr.
          i3-dnamt = i3-lfimg * i1-netpr.
          i3-otype =  i1-bsart.   "po type
          i3-vbeln =  i1-ebeln.
          i3-posnr =  i1-ebelp.
          i3-uepos =  i1-uepos.
          i3-vrkme =  i1-meins.  "unit of measure
          i3-splant = i1-splant.
          i3-slgort = i1-slgort.
          i3-slgpbe = i1-slgpbe.
          i3-firstdelv = i1-ean11.
          i3-erdat = i1-create_date.
          i3-erzet = i1-create_time.
          i3-firstmatv = firstmatv.
          i3-zz_first = i1-zz_first .
          i3-zz_mbdat = i1-zz_mbdat.
          i3-commit_date = i1-commit_date.
          i3-kbetr  = i1-kbetr .
          PERFORM get_backlog_date.
          IF p_rado2 = ''.
            IF intloop = intcnt.
*                     ORD_DIFFQTY = IEKET-MENGE - IEKET-MNG02.
              ord_diffqty = ieket-menge - lncnf_qty.
              IF ord_diffqty > 0 AND p_rado1 = 'X'.
                i3-unconfqty = ord_diffqty.
                i3-uncnfamt = i3-unconfqty * i1-netpr.
                "unconf dn amt
              ENDIF.
            ENDIF.
            APPEND i3.
            CLEAR i3.
            intline = intline + 1.
* Mark By Hermit 2006/02/14
*                  IF P_RADO3 = 'X'.
*                     IF INTLOOP = INTCNT.
**                        ORD_DIFFQTY = IEKET-MENGE - IEKET-MNG02.
*                        ORD_DIFFQTY = IEKET-MENGE - LNCNF_QTY.
*                        IF ORD_DIFFQTY > 0.
*                           I3-UNCONFQTY = ORD_DIFFQTY.  "unconf qty
*I3-UNCNFAmt = ORD_DIFFQTY * I1-NETPR.  "unconf dn amt
*                            PERFORM CHECK_REST_PQTY USING IEKET-MENGE
*                                                  ORD_DIFFQTY
*                                                  CHANGING INTLINE.
*                        ENDIF.
*                     ENDIF.
*                 ENDIF.
          ELSE.
            CLEAR i3.
          ENDIF.
          IF diff_qty <> 0 AND ( p_rado2 = 'X' OR p_rado3 = 'X').
            i3-firstdelv = i1-ean11.
            PERFORM move-i1-data USING 1.
            i3-unconfqty = diff_qty.  "unconf qty
            i3-uncnfamt = i3-unconfqty * i1-netpr.  "unconf dn amt
            IF intline = 1.
              i3-kwmeng = i1-menge.  "Order Qty
            ENDIF.
            i3-schqty = diff_qty.
            i3-kbmeng = diff_qty.  "Open Qty
            i3-lfimg = diff_qty.   "Open D/N qty
            i3-dnqty = 0.
            i3-odnamt = 0.
            i3-bmeng = 0.   "confirm qty
            i3-oedatu =  i1-audat.     " Order date
            IF NOT ieket-slfdt IS INITIAL.  "Request date
              i3-ondockdt =  ieket-slfdt.
*                 I3-REDATU =  IEKET-MBDAT.
              i3-redatu =  po_date.
            ELSE.
              i3-oedatu =  ieket-eindt.
            ENDIF.
            i3-opamt = diff_qty * i1-netpr.
            i3-dnamt = i3-lfimg * i1-netpr.
            i3-otype =  i1-bsart.   "po type
            i3-vbeln =  i1-ebeln.
            i3-posnr =  i1-ebelp.
            i3-schline = intline.
*              I3-STATUS = 1.
            i3-vrkme =  i1-meins.  "unit of measure
            i3-splant = i1-splant.
            i3-slgort = i1-slgort.
            i3-slgpbe = i1-slgpbe.
            i3-erdat = i1-create_date.
            i3-erzet = i1-create_time.
            i3-firstmatv = firstmatv.
            i3-zz_first = i1-zz_first .
            i3-zz_mbdat = i1-zz_mbdat.
            i3-commit_date = i1-commit_date.
            PERFORM get_backlog_date.
            APPEND i3.
            intline = intline + 1.
            CLEAR i3.
          ENDIF.
**mark by Hermit 2006/02/09
*                   IF INTLOOP = INTCNT.
**                      ORD_DIFFQTY = IEKET-MENGE - IEKET-MNG02.
*                      ORD_DIFFQTY = IEKET-MENGE - LNCNF_QTY.
*                      IF ORD_DIFFQTY > 0.
*                            PERFORM CHECK_REST_PQTY USING IEKET-MENGE
*                                                  ORD_DIFFQTY
*                                                  CHANGING INTLINE.
*                       ENDIF.
*                   ENDIF.
*               ENDIF.
        ELSE.  "TOOPEN_QTY = 0 or < 0
          rest_bqty = 0.
          IF intloop = 1.
            po_date = ieket-slfdt. " - TRANSIT_DAY.
            firstmatv = ieket-licha. "first avai date
          ENDIF.

          IF p_rado2 = 'X' OR p_rado3 = 'X'.
            IF intloop = intcnt.
* mark by Hermit 2006/02/15
*                      IF INTCNT = 1.
              i3-firstdelv = i1-ean11.
              i3-unconfqty = ieket-menge - lncnf_qty.  "unconf qty
              i3-uncnfamt = i3-unconfqty * i1-netpr.  "unconf dn amt
              i3-erdat = i1-create_date.
              i3-erzet = i1-create_time.
              i3-firstmatv = firstmatv.
*                      ENDIF.
              i3-zz_first = i1-zz_first .
              i3-zz_mbdat = i1-zz_mbdat.
              i3-commit_date = i1-commit_date.
              ord_diffqty = ieket-menge - lncnf_qty.
*                     ORD_DIFFQTY = IEKET-MENGE - IEKET-MNG02.
              IF ord_diffqty > 0.
                PERFORM check_rest_pqty USING ieket-menge
                                       ord_diffqty
                                       CHANGING intline.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ELSE.
      IF ieket-mng02 <> 0.
        i3-firstdelv = i1-ean11.
        i3-commit_date = i1-commit_date.
        PERFORM move-i1-data USING 1.

*           LINE_QTY = IEKET-MNG02 - IEKET-GLMNG.
        IF ieket-mng02 >= ieket-glmng.
          tadn_qty = ieket-mng02 - ieket-glmng.
          lncnf_qty = ieket-mng02.
        ELSE.
          tadn_qty = ieket-glmng - ieket-mng02.
          lncnf_qty = ieket-glmng.
        ENDIF.
        IF intloop = 1.
          po_date = ieket-slfdt. " - TRANSIT_DAY.
          firstmatv = ieket-licha. "first avai date
        ENDIF.

*        " Confirm qty - delivered qty
*           DIFF_QTY = IEKET-MENGE - IEKET-MNG02.
        diff_qty = ieket-menge - lncnf_qty.
*   scheduled qty - committed qty
        IF ieket-eindt IS NOT INITIAL.   " delivery date
          i3-cedatu = ieket-eindt. "confirm date
        ELSE.
          i3-cedatu = ieket-slfdt.         " Stat. del. date
        ENDIF.
        IF NOT ieket-slfdt IS INITIAL.  "Request date
          i3-ondockdt =  ieket-slfdt.
*              I3-REDATU =  IEKET-MBDAT.
          i3-redatu =  po_date.
        ELSE.
          i3-oedatu =  ieket-eindt.
        ENDIF.
        i3-firstdelv = i1-ean11.
        i3-oedatu =  i1-audat.     " Order date
        i3-slfdt = ieket-slfdt.
        i3-eindt = ieket-eindt.  "delv date
        i3-mbdat = ieket-mbdat.
*           I3-BMENG = IEKET-MNG02.  "confirm qty
        i3-bmeng = lncnf_qty.  "confirm qty
        cnf_qty = cnf_qty + i3-bmeng.
        IF p_rado1 = 'X'.
          i3-unconfqty = ieket-menge - lncnf_qty.  "unconf qty
*              I3-UNCONFQTY = IEKET-MENGE - IEKET-MNG02.  "unconf qty
        ENDIF.
        i3-edatu =  ieket-eindt.
*        I3-WAERK =  I1-WAERS.
        IF intline = 1.
          i3-kwmeng = i1-menge.  "Order Qty
        ENDIF.
        i3-schqty = ieket-menge.

        IF diff_qty <> 0.
          i3-cedatu = ieket-eindt.
*              I3-SCHQTY = IEKET-MNG02.  "sched qty
          i3-schqty = lncnf_qty.  "sched qty
        ENDIF.
        IF NOT ieket-glmng IS INITIAL.
          i3-dnqty =  ieket-glmng. "already DN
          i3-odnamt = i3-dnqty * i1-netpr.
        ELSE.
          i3-dnqty = 0. "already DN
          i3-odnamt = 0.
        ENDIF.

        IF line_qty > 0.
          IF NOT ieket-glmng IS INITIAL.
            i3-lfimg = ieket-menge - ieket-glmng.
            line_qty = line_qty - ieket-glmng.
          ELSE.
            i3-lfimg = line_qty - lncnf_qty.     "openD/N qty
            line_qty = line_qty - lncnf_qty.
          ENDIF.
*              I3-LFIMG = LINE_QTY - IEKET-MNG02.     "openD/N qty
*              LINE_QTY = LINE_QTY - IEKET-MNG02.
        ELSE.
*              I3-LFIMG = IEKET-MNG02 - IEKET-GLMNG.
          i3-lfimg = lncnf_qty - ieket-glmng.
        ENDIF.
*           IF IEKET-MNG02 >= REST_BQTY.
        IF lncnf_qty >= rest_bqty.
*              I3-KBMENG = IEKET-MNG02 - REST_BQTY.  "Open qty
          i3-kbmeng = lncnf_qty - rest_bqty.  "Open qty
          IF rest_bqty <> 0.
*                 REST_BQTY = IEKET-MNG02 - REST_BQTY.
            rest_bqty = lncnf_qty - rest_bqty.
          ELSE.
            rest_bqty = 0.
          ENDIF.
        ELSE.
*              I3-KBMENG = REST_BQTY - IEKET-MNG02.  "Open qty
*              REST_BQTY = REST_BQTY - IEKET-MNG02.
          i3-kbmeng = rest_bqty - lncnf_qty.  "Open qty
          rest_bqty = rest_bqty - lncnf_qty.
          IF rest_bqty < 0.
            rest_bqty = 0.
          ENDIF.
        ENDIF.
*set open amount
        i3-opamt = i3-kbmeng * i1-netpr.
        i3-dnamt = i3-lfimg * i1-netpr.
        i3-netpr = i1-netpr.
        i3-otype =  i1-bsart.   "po type
        i3-vbeln =  i1-ebeln.
        i3-posnr =  i1-ebelp.
        i3-uepos =  i1-uepos.
        i3-vrkme =  i1-meins.  "unit of measure
        i3-splant = i1-splant.
        i3-slgort = i1-slgort.
        i3-slgpbe = i1-slgpbe.
        i3-schline = intline.
        i3-firstdelv = i1-ean11.
        i3-erdat = i1-create_date.
        i3-erzet = i1-create_time.
        i3-firstmatv = firstmatv.
        i3-zz_first = i1-zz_first .
        i3-zz_mbdat = i1-zz_mbdat.
        i3-commit_date = i1-commit_date.
        i3-kbetr  = i1-kbetr .

        PERFORM get_backlog_date.
        IF p_rado2 = ''.
          IF i3-kbmeng <> 0.
*                 I3-STATUS = 1.
            APPEND i3.
            CLEAR i3.
            intline = intline + 1.
          ENDIF.
        ELSE.
          CLEAR i3.
        ENDIF.
        IF diff_qty <> 0 AND ( p_rado2 = 'X' OR p_rado3 = 'X').
          i3-firstdelv = i1-ean11.
          PERFORM move-i1-data USING 1.
          i3-unconfqty = diff_qty.  "unconf qty
          i3-uncnfamt = i3-unconfqty * i1-netpr.  "unconf dn amt
          IF intline = 1.
            i3-kwmeng = i1-menge.  "Order Qty
          ENDIF.
          i3-schqty = diff_qty.
          i3-kbmeng = diff_qty.  "Open Qty
          i3-lfimg = diff_qty.   "Open D/N qty
          i3-dnqty = 0.
          i3-odnamt = 0.
          i3-bmeng = 0.   "confirm qty
          i3-oedatu =  i1-audat.     " Order date
          IF NOT ieket-slfdt IS INITIAL.  "Request date
            i3-ondockdt =  ieket-slfdt.
*                 I3-REDATU =  IEKET-MBDAT.
            i3-redatu =  po_date.
          ELSE.
            i3-oedatu =  ieket-eindt.
          ENDIF.
          i3-opamt = diff_qty * i1-netpr.
          i3-dnamt = i3-lfimg * i1-netpr.
          i3-otype =  i1-bsart.   "po type
          i3-vbeln =  i1-ebeln.
          i3-posnr =  i1-ebelp.
          i3-schline = intline.
*              I3-STATUS = 1.
          i3-vrkme =  i1-meins.  "unit of measure
          i3-splant = i1-splant.
          i3-slgort = i1-slgort.
          i3-slgpbe = i1-slgpbe.
          i3-erdat = i1-create_date.
          i3-erzet = i1-create_time.
          i3-firstmatv = firstmatv.
          i3-zz_first = i1-zz_first .
          i3-zz_mbdat = i1-zz_mbdat.
          i3-commit_date = i1-commit_date.

          PERFORM get_backlog_date.
          APPEND i3.
          intline = intline + 1.
          CLEAR i3.
        ENDIF.
      ELSE.
* MNG02 = 0(confirm qty = 0)
        IF intloop = 1.
          po_date = ieket-slfdt. " - TRANSIT_DAY.
          firstmatv = ieket-licha. "first avai date
        ENDIF.
        IF ieket-glmng <> 0.
          diff_qty = ieket-menge - ieket-glmng.
          lncnf_qty = ieket-glmng.
        ELSE.
          diff_qty = 0.
          lncnf_qty = 0.
        ENDIF.
        IF lncnf_qty >= rest_bqty.
          i3-kbmeng = lncnf_qty - rest_bqty.  "Open qty
          IF rest_bqty <> 0.
            rest_bqty = lncnf_qty - rest_bqty.
          ELSE.
            rest_bqty = 0.
          ENDIF.
        ELSE.
          i3-kbmeng = rest_bqty - lncnf_qty.  "Open qty
          rest_bqty = rest_bqty - lncnf_qty.
          IF rest_bqty < 0.
            rest_bqty = 0.
          ENDIF.
        ENDIF.
        IF i3-kbmeng <> 0.
          i3-firstdelv = i1-ean11.
          PERFORM move-i1-data USING 1.
          IF intline = 1.
            i3-kwmeng = i1-menge.  "Order Qty
          ENDIF.
          i3-unconfqty = diff_qty.
          i3-uncnfamt = i3-unconfqty * i1-netpr.  "unconf dn amt
          i3-schqty = ieket-menge.
          i3-kbmeng = ieket-menge.  "Open Qty
          i3-lfimg = diff_qty.   "Open D/N qty
*              IF NOT IEKET-GLMNG IS INITIAL.
*                   I3-DNQTY =  IEKET-GLMNG. "already DN
*                   I3-ODNAMT = I3-DNQTY * I1-NETPR.
*             ELSE.
*                  I3-DNQTY = 0. "already DN
*                  I3-ODNAMT = 0.
*             ENDIF.
          i3-dnqty = lncnf_qty.
          i3-odnamt = i3-dnqty * i1-netpr.
          i3-bmeng = lncnf_qty.   "confirm qty
          i3-oedatu =  i1-audat.     " Order date
          IF NOT ieket-slfdt IS INITIAL.  "Request date
            i3-ondockdt =  ieket-slfdt.
*                 I3-REDATU =  IEKET-MBDAT.
            i3-redatu =  po_date.
          ELSE.
            i3-oedatu =  ieket-eindt.
          ENDIF.
          i3-opamt = ieket-menge * i1-netpr.
          i3-dnamt = i3-lfimg * i1-netpr.
          i3-otype =  i1-bsart.   "po type
          i3-vbeln =  i1-ebeln.
          i3-posnr =  i1-ebelp.
          i3-uepos =  i1-uepos.
          i3-schline = intline.
*              I3-STATUS = 1.
          i3-vrkme =  i1-meins.  "unit of measure
          i3-splant = i1-splant.
          i3-slgort = i1-slgort.
          i3-slgpbe = i1-slgpbe.
          i3-firstdelv = i1-ean11.
          i3-erdat = i1-create_date.
          i3-erzet = i1-create_time.
          i3-firstmatv = firstmatv.
          i3-zz_first = i1-zz_first .
          i3-zz_mbdat = i1-zz_mbdat.
          i3-commit_date = i1-commit_date.
          i3-kbetr  = i1-kbetr .

          PERFORM get_backlog_date.
          APPEND i3.
          intline = intline + 1.
          CLEAR i3.
          IF p_rado2 = 'X' OR p_rado3 = 'X'.
            IF intloop = intcnt.
              i3-firstdelv = i1-ean11.
              i3-erdat = i1-create_date.
              i3-erzet = i1-create_time.
              i3-firstmatv = firstmatv.
              i3-commit_date = i1-commit_date.
              ord_diffqty = ieket-menge - lncnf_qty.
*                     ORD_DIFFQTY = IEKET-MENGE - IEKET-MNG02.
              IF ord_diffqty > 0.
*mark by hermit 2006/02/09   I3-UNCONFQTY = DIFF_QTY.
                i3-unconfqty = ord_diffqty.
                i3-uncnfamt = i3-unconfqty * i1-netpr.
                "unconf dn amt
                PERFORM check_rest_pqty USING ieket-menge
                                       ord_diffqty
                                       CHANGING intline.
              ENDIF.
            ENDIF.
          ENDIF.
        ELSE.
          CLEAR i3.
          IF p_rado2 = 'X' OR p_rado3 = 'X'.
            IF intloop = intcnt.
              i3-firstdelv = i1-ean11.
              i3-erdat = i1-create_date.
              i3-erzet = i1-create_time.
              i3-firstmatv = firstmatv.
              i3-zz_first = i1-zz_first .
              i3-zz_mbdat = i1-zz_mbdat.
              i3-commit_date = i1-commit_date.
              ord_diffqty = ieket-menge - lncnf_qty.
*                     ORD_DIFFQTY = IEKET-MENGE - IEKET-MNG02.
              IF ord_diffqty > 0.
                i3-unconfqty = ord_diffqty.
                i3-uncnfamt = i3-unconfqty * i1-netpr.
                "unconf dn amt
                PERFORM check_rest_pqty USING ieket-menge
                                       ord_diffqty
                                       CHANGING intline.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
    intloop = intloop + 1.
  ENDLOOP.

ENDFORM.                    "PROCESS_STO_SCHLINE


*********************
* To check STO
*********************
FORM check_rest_pqty USING ord_qty diff_qty
                                             CHANGING intline.
  PERFORM move-i1-data USING 1.
*   I3-UNCONFQTY = DIFF_QTY.  "unconf qty
  IF intline = 1.
    i3-kwmeng = i1-menge.  "Order Qty
  ENDIF.
  i3-schqty = diff_qty.
  i3-mbdat = ieket-mbdat.
  i3-kbmeng = diff_qty.  "Open Qty
  i3-lfimg = diff_qty.   "Open D/N qty
  i3-dnqty = 0.
  i3-odnamt = 0.
  i3-bmeng = 0.   "confirm qty
  i3-oedatu =  i1-audat.     " Order date
  i3-zpi01 = i1-zpi01.
  i3-zpi01amt = i1-zpi01amt.
  IF NOT ieket-slfdt IS INITIAL.  "Request date
    i3-ondockdt =  ieket-slfdt.
*      I3-REDATU =  IEKET-MBDAT.
    i3-redatu =  po_date.
  ELSE.
    i3-oedatu =  ieket-eindt.
  ENDIF.
  i3-opamt = diff_qty * i1-netpr.
  i3-dnamt = i3-lfimg * i1-netpr.
  i3-otype =  i1-bsart.   "po type
  i3-vbeln =  i1-ebeln.
  i3-posnr =  i1-ebelp.
  i3-uepos =  i1-uepos.
  i3-schline = intline.
  i3-vrkme =  i1-meins.  "unit of measure
  i3-splant = i1-splant.
  i3-slgort = i1-slgort.
  i3-slgpbe = i1-slgpbe.
  i3-prdplant = i1-prdplant.
  i3-blatt = i1-blatt.
  i3-zz_zdatu = i1-zz_zdatu.
  i3-zz_cdatu = i1-zz_cdatu.
  i3-zz_sdatu = i1-zz_sdatu.
  i3-eaipd = i1-eaipd.
  i3-eaipg = i1-eaipg.
  i3-zrname = i1-zrname.
  i3-zrpernr = i1-zrpernr.
  i3-reprate = i1-reprate.
  i3-gp = i1-gp.

  PERFORM get_backlog_date.
  APPEND i3.
  intline = intline + 1.
  CLEAR i3.
ENDFORM.                    "CHECK_REST_PQTY

*****************************
* Add By Hermit 2005/07/27
* PTYPE = 1, STO
*****************************
FORM move-i1-data USING ptype.
  IF ptype = 1.
    i3-vbeln = i1-vbeln.
    i3-ebeln = i1-ebeln.
    i3-posnr = i1-posnr.
    i3-uepos = i1-uepos.
    i3-erdat = i1-erdat.
    i3-erzet = i1-erzet.
    i3-pstyv = i1-pstyv.
    i3-pstyp = i1-pstyp.
    i3-lifsk = i1-lifsk.
    i3-sortl = i1-sortl.
    i3-katr4 = i1-katr4.
    i3-matnr = i1-matnr.
    i3-otype = i1-otype.
    i3-mtart = i1-mtart.
    i3-mstav = i1-mstav.
    i3-sobsl = i1-sobsl.
    i3-plifz = i1-plifz.
    i3-ladgr = i1-ladgr.
    i3-auart = i1-auart.
    i3-werks = i1-werks.
    i3-lgort = i1-lgort.
    i3-vkorg = i1-vkorg.
    i3-vbtyp = i1-vbtyp.
    i3-kunnr = i1-kunnr.
    i3-shipto = i1-shipto.
    i3-billto = i1-billto.
    i3-vsbed = i1-vsbed.
    i3-ship_desc = i1-ship_desc.
    i3-vkbur = i1-vkbur.
    i3-vkgrp = i1-vkgrp.
    i3-prodh = i1-prodh.
    i3-route = i1-route.
    i3-prodh2 = i1-prodh2.
    i3-prodh3 = i1-prodh3.
    i3-bismt = i1-bismt.
    i3-brsch = i1-brsch.
    i3-cmgst = i1-cmgst.
    i3-dvbeln = i1-dvbeln.
    i3-lfsta = i1-lfsta.
    i3-fksta = i1-fksta.
    i3-absta = i1-absta.
    i3-wbsta = i1-wbsta.
    i3-kosta = i1-kosta.
    i3-dncmgst = i1-dncmgst.
    i3-sname = i1-sname.
    i3-pernr = i1-pernr.
    i3-pernr_zv = i1-pernr_zv.
    i3-zvname = i1-zvname.
    i3-eaddress1 = i1-eaddress1.
    i3-eaddress2 = i1-eaddress2.
    i3-eaddress3 = i1-eaddress3.
    i3-apparnr = i1-apparnr.
    i3-apname = i1-apname.

    i3-isname = i1-isname.                                  "090303
    i3-ipernr = i1-ipernr.                                  "090303

    i3-z2name = i1-z2name.
    i3-z2pernr = i1-z2pernr.
    i3-z3name = i1-z3name.
    i3-z3pernr = i1-z3pernr.
    i3-zaname = i1-zaname.
    i3-zapernr = i1-zapernr.
    i3-zbname = i1-zbname.
    i3-zbpernr = i1-zbpernr.
    i3-katr8 = i1-katr8.
    i3-katr9 = i1-katr9.        " Xuan.Kao 20160215 SO Head Attribute 9
    i3-ernam = i1-ernam.
    i3-sdabw = i1-sdabw.
    i3-zterm = i1-zterm.
    i3-inco1 = i1-inco1.
    i3-inco2 = i1-inco2.
    i3-stprs = i1-stprs.
    i3-stwaers = i1-stwaers.
    i3-bukrs = i1-bukrs.
    i3-reswk = i1-reswk.
    i3-bzirk = i1-bzirk.
    i3-ebeln = i1-ebeln.
    i3-ebelp = i1-ebelp.
    i3-bstyp = i1-bstyp.
    i3-bsart = i1-bsart.
    i3-lifnr = i1-lifnr.
    i3-waers = i1-waers.
    i3-meins = i1-meins.
    i3-peinh = i1-peinh.
    i3-elikz = i1-elikz.
    i3-wepos = i1-wepos.
    i3-erekz = i1-erekz.
    i3-netpr = i1-netpr.
    i3-waerk = i1-waerk.
    i3-labst = i1-labst.
    i3-bstnk = i1-bstnk.
    i3-bstdk = i1-bstdk.
    i3-abtnr = i1-abtnr.                                    "20250815
** Add By Hermit 2005/11/03 FOR EU request
    i3-empid = i1-empid.
    i3-vorna = i1-vorna.
    i3-nachn = i1-nachn.
*****Add By Hermit 2005/11/17 for EU request
    i3-soldtonm = i1-soldtonm.
    i3-shiptonm = i1-shiptonm.
    i3-billtonm = i1-billtonm.
    i3-endcust = i1-endcust.
    i3-endcustnm = i1-endcustnm.
    i3-labst = i1-labst.
    i3-slabst = i1-slabst.
    i3-ekorg = i1-ekorg.
    i3-smmsta = i1-smmsta.
    i3-vmsta = i1-vmsta.
*20231130
    i3-mvgr2 = i1-mvgr2.
    i3-odtxt = i1-odtxt.
    i3-maabc = i1-maabc.
    i3-eisbe = i1-eisbe.
    i3-itemtxt = i1-itemtxt.
    i3-f04txt = i1-f04txt.              " Xuan.Kao 20231220 STO Item Delivery text
** add by hermit 2007/03/30 reason code
    i3-zz_abgru = i1-zz_abgru.
    i3-zz_abgru_text = i1-zz_abgru_text.
    i3-zz_reason = i1-zz_reason.
    i3-zz_reason_text = i1-zz_reason_text.
    i3-afnam = i1-afnam.
**add by hermit 2007/12/11 add P/T buffers day.
    i3-zbuffer = i1-zbuffer.
    i3-zpi01 = i1-zpi01.
    i3-bstkd =  i1-bstkd.                                   "20081215
    i3-bstkd_e =  i1-bstkd_e.                               "20090819
    i3-ihrez_e =  i1-ihrez_e.                               "20090819
    i3-kdmat = i1-kdmat.                                    "20090819
    i3-prdplant = i1-prdplant.
    i3-blatt = i1-blatt.
    i3-zz_zdatu = i1-zz_zdatu.
    i3-zz_sdatu = i1-zz_sdatu.
    i3-zz_cdatu = i1-zz_cdatu.
    i3-vsnmr_v = i1-vsnmr_v.
    i3-eaipd = i1-eaipd.
    i3-eaipg = i1-eaipg.
    i3-zrname = i1-zrname.
    i3-zrpernr = i1-zrpernr.
    i3-zekvbd = i1-zekvbd.
    i3-reprate = i1-reprate.
    i3-gp = i1-gp.
    i3-sekgrp = i1-sekgrp.              " Xuan.Kao 20150212 Material's Purchasing Group on Sales
    i3-sekgrp_desc = i1-sekgrp_desc.    " Xuan.Kao 20150212 Material's Purchasing Group on Sales
    i3-dsnam = i1-dsnam.                 "double add on 20250306
    i3-psobsl = i1-psobsl.              " Xuan.Kao 20150506 Material's Special procurement in Demand Plant
    i3-zzcaps = i1-zzcaps.              " Xuan.Kao 20160329 Material CAPS indicator
    PERFORM get_sub-sector.             " Xuan.Kao 20160608 Sub-Sector
    i3-vgbel = i1-vgbel.                " Xuan.Kao 20160628 Reference doc.
    i3-erdat_qt = i1-erdat_qt.          " Xuan.Kao 20160628 Quotation Create Date
    PERFORM get_delivery-info.          " Xuan.Kao 20160628 Delivery-Info
    i3-salesnote = i1-salesnote.        " Xuan.Kao 20150720 SO Head Sales note from customer
    i3-shipinstr = i1-shipinstr.        " Timo.Rusnjak 20210414 SO Head Shipping Instruction
    i3-forwserv = i1-forwserv.          " Timo.Rusnjak 20210715 SO Head Forwarder Service
    i3-kondm = i1-kondm.                " Xuan.Kao 20161222 Material Pricing Group
    i3-sh_adrnr = i1-sh_adrnr.                    " Xuan.Kao 20211108 Ship to Party Address Code
    SHIFT i3-sh_adrnr LEFT DELETING LEADING '0'.  " Xuan.Kao 20211108 Ship to Party Address Code
    i3-buff = i1-buff.                  " 20180123 buffer order indicator
**add by rong 20181002,Require from Sylvia
    i3-country_ship = i1-country_ship.
    i3-city_ship    = i1-city_ship.
    i3-region_ship  = i1-region_ship.
    i3-post_ship    = i1-post_ship.
    i3-street_ship  = i1-street_ship.
    i3-prdnote      = i1-prdnote.
**add end
*20240819 rong
    i3-gpdate = i1-gpdate.
    i3-mingptxt = i1-mingptxt.
    i3-cost = i1-cost.
    i3-currentgptxt2 = i1-currentgptxt2.
**20240819 end
  ENDIF.
ENDFORM.                    "MOVE-I1-DATA
**End Add By Hermit

*&---------------------------------------------------------------------*
*&      Form  process_data_hans
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM process_data_hans .
  DATA: p_dflag.
  DATA : zplant LIKE marc-werks.
  DATA: g_index LIKE sy-tabix.
  DATA : mabc   LIKE marc-maabc,
         teisbe LIKE marc-eisbe.

  CLEAR: g_cnt, g_seq.
  g_cnt = 0.

***********************************************
*Process SO
***********************************************
  CLEAR:tbl_gp. REFRESH:tbl_gp.
  LOOP AT it_soview.
    g_index = sy-tabix.
    CLEAR: p_dflag, i1.
***Add By Hermit 2006/08/02
** to filter consign order
    IF it_soview-auart = 'KE' OR it_soview-auart = 'KA'.
      CONTINUE.
    ENDIF.
    SELECT SINGLE maabc eisbe ekgrp dispo FROM marc INTO          " Xuan.Kao 20150212 Material's Purchasing Group on Sales For ekgrp
    (marc-maabc, marc-eisbe, marc-ekgrp, marc-dispo)                    " Xuan.Kao 20150212 Material's Purchasing Group on Sales For marc-ekgrp
       WHERE matnr = it_soview-matnr
    AND werks = it_soview-werks.
    IF sy-subrc = 0.
      mabc = marc-maabc.
      teisbe = marc-eisbe.
      i1-sekgrp = marc-ekgrp.        " Xuan.Kao 20150212 Material's Purchasing Group on Sales
      " i1-DISPO = marc-DISPO.
      CHECK marc-maabc IN s_maabc.
    ENDIF.
*** Xuan.Kao 20160329 Get MARA Data-Start ***
    SELECT SINGLE zzcaps FROM mara INTO
    (i1-zzcaps)                                             " Xuan.Kao 20160329 Material CAPS indicator
    WHERE matnr = it_soview-matnr.
*** Xuan.Kao 20160329 Get MARA Data-End ***
*** Xuan.Kao 20160628 Reference doc.-Start ***
    SELECT SINGLE vgbel INTO i1-vgbel
      FROM vbap
     WHERE vbeln = it_soview-vbeln
    AND posnr = it_soview-posnr.
*** Xuan.Kao 20160628 Reference doc.-End ***
*** Xuan.Kao 20160628 Quotation Create Date-Start ***
    IF i1-vgbel IS NOT INITIAL.
      SELECT SINGLE erdat INTO i1-erdat_qt
        FROM vbak
       WHERE vbeln = i1-vgbel
      AND vbtyp = 'B'.
    ENDIF.
*** Xuan.Kao 20160628 Quotation Create Date-End ***
*** Xuan.Kao 20150720 SO Head Sales note from customer-Start ***
    IF s_note = 'X'.
      CALL FUNCTION 'SD_GET_TEXTNAME'
        EXPORTING
          fi_object = 'VBBK'
          fi_vbeln  = it_soview-vbeln
        IMPORTING
          fe_tdname = tmp_tdname.

      CLEAR:tmp_id,tmp_tline,tmp_tline[].
      tmp_id = '0001'.

      PERFORM get_text TABLES tmp_tline
                       USING  tmp_tdname
                              sy-langu
                              tmp_id.

      IF tmp_tline[] IS INITIAL.
        LOOP AT t002.
          PERFORM get_text TABLES tmp_tline
                           USING  tmp_tdname
                                  t002-spras
                                  tmp_id.
          IF tmp_tline[] IS NOT INITIAL.
            EXIT.
          ENDIF.
        ENDLOOP.
      ENDIF.

      IF tmp_tline[] IS NOT INITIAL.
        LOOP AT tmp_tline.
          CONCATENATE i1-salesnote tmp_tline-tdline INTO i1-salesnote.
        ENDLOOP.
      ENDIF.
    ENDIF.
*** Xuan.Kao 20150720 SO Head Sales note from customer-End ***
*** Timo.Rusnjak 20210414 SO Head Shipping Instruction-Start ***
*** Timo.Rusnjak 20210715 SO Head Forwarding Service Updated ***
    IF s_instr = 'X'.
      "Shipping Instruction (SO Header Text)
      CALL FUNCTION 'SD_GET_TEXTNAME'
        EXPORTING
          fi_object = 'VBBK'
          fi_vbeln  = it_soview-vbeln
        IMPORTING
          fe_tdname = tmp_tdname.

      CLEAR:tmp_id,tmp_tline,tmp_tline[].
      tmp_id = 'ZSHP'.

      PERFORM get_text TABLES tmp_tline
                       USING  tmp_tdname
                              sy-langu
                              tmp_id.

      IF tmp_tline[] IS INITIAL.
        LOOP AT t002.
          PERFORM get_text TABLES tmp_tline
                           USING  tmp_tdname
                                  t002-spras
                                  tmp_id.
          IF tmp_tline[] IS NOT INITIAL.
            EXIT.
          ENDIF.
        ENDLOOP.
      ENDIF.

      IF tmp_tline[] IS NOT INITIAL.
        LOOP AT tmp_tline.
          CONCATENATE i1-shipinstr tmp_tline-tdline
                 INTO i1-shipinstr SEPARATED BY space.
        ENDLOOP.
      ENDIF.

      "Forwarding Service (SO Header Text)
      CALL FUNCTION 'SD_GET_TEXTNAME'
        EXPORTING
          fi_object = 'VBBK'
          fi_vbeln  = it_soview-vbeln
        IMPORTING
          fe_tdname = tmp_tdname.

      CLEAR:tmp_id,tmp_tline,tmp_tline[].
      tmp_id = 'ZFDS'.

      PERFORM get_text TABLES tmp_tline
                       USING  tmp_tdname
                              sy-langu
                              tmp_id.

      IF tmp_tline[] IS INITIAL.
        LOOP AT t002.
          PERFORM get_text TABLES tmp_tline
                           USING  tmp_tdname
                                  t002-spras
                                  tmp_id.
          IF tmp_tline[] IS NOT INITIAL.
            EXIT.
          ENDIF.
        ENDLOOP.
      ENDIF.

      IF tmp_tline[] IS NOT INITIAL.
        LOOP AT tmp_tline.
          CONCATENATE i1-forwserv tmp_tline-tdline
                 INTO i1-forwserv SEPARATED BY space.
        ENDLOOP.
      ENDIF.
    ENDIF.
*** Timo.Rusnjak 20210414 SO Head Shipping Instruction-End ***
*20200225
    IF it_soview-vkorg(2) = 'JP'.
      CALL FUNCTION 'SD_GET_TEXTNAME'
        EXPORTING
          fi_object = 'VBBK'
          fi_vbeln  = it_soview-vbeln
        IMPORTING
          fe_tdname = tmp_tdname.

      CLEAR:tmp_id,tmp_tline,tmp_tline[].
      tmp_id = 'ZPRD'.

      PERFORM get_text TABLES tmp_tline
                       USING  tmp_tdname
                              sy-langu
                              tmp_id.

      IF tmp_tline[] IS INITIAL.
        LOOP AT t002.
          PERFORM get_text TABLES tmp_tline
                           USING  tmp_tdname
                                  t002-spras
                                  tmp_id.
          IF tmp_tline[] IS NOT INITIAL.
            EXIT.
          ENDIF.
        ENDLOOP.
      ENDIF.

      IF tmp_tline[] IS NOT INITIAL.
        LOOP AT tmp_tline.
          CONCATENATE i1-prdnote tmp_tline-tdline
                 INTO i1-prdnote SEPARATED BY space.
        ENDLOOP.
      ENDIF.
    ENDIF.

*** Xuan.Kao 20161222 Material Pricing Group-Start ***
    SELECT SINGLE kondm INTO i1-kondm
      FROM vbap
     WHERE vbeln = it_soview-vbeln
    AND posnr = it_soview-posnr.
    CHECK i1-kondm IN s_kondm.
*** Xuan.Kao 20161222 Material Pricing Group-End ***

*** Xuan.Kao 20211108 Ship to Party Address Code-Start ***
    SELECT SINGLE adrnr INTO i1-sh_adrnr
      FROM vbpa
     WHERE vbeln = it_soview-vbeln
       AND posnr = it_soview-posnr
       AND parvw = 'WE'.
    IF sy-subrc <> 0.
      SELECT SINGLE adrnr INTO i1-sh_adrnr
        FROM vbpa
       WHERE vbeln = it_soview-vbeln
         AND posnr = ''
         AND parvw = 'WE'.
    ENDIF.
*** Xuan.Kao 20211108 Ship to Party Address Code-End ***

    IF p_rado4 = 'X'.  "Hub SO only
      IF it_soview-lgort = 'B000'.
*      IF NOT it_soview-uepos IS INITIAL OR
*     it_soview-pstyv = 'ZTM5'.
*      SELECT SINGLE KDAUF FROM CAUFV
*          INTO CAUFV-KDAUF
*          WHERE KDAUF = IT_SOVIEW-VBELN
*              AND KDPOS = IT_SOVIEW-POSNR.
*      IF SY-SUBRC = 0.
        CONTINUE.
*      ENDIF.
      ENDIF.
    ELSEIF p_rado5 = 'X' .  "BTOS SO only
      IF it_soview-lgort <> 'B000'.
*      IF it_soview-uepos IS INITIAL.
*      SELECT SINGLE KDAUF FROM CAUFV
*         INTO CAUFV-KDAUF
*         WHERE KDAUF = IT_SOVIEW-VBELN
*             AND KDPOS = IT_SOVIEW-POSNR.
*      IF SY-SUBRC <> 0.
        CONTINUE.
      ENDIF.
    ENDIF.
    CLEAR zplant.
    CALL FUNCTION 'ZGET_PRODUCTION_PLANT'
      EXPORTING
*       PWERKS = it_soview-werks
        pwerks = 'TWH1'
        pmatnr = it_soview-matnr
      IMPORTING
        zwerks = zplant.

    IF NOT zplant IN s_prod.
      CONTINUE.
    ENDIF.

    MOVE-CORRESPONDING it_soview TO i1.
    SELECT SINGLE bstkd bstdk INTO (i1-bstnk, i1-bstdk)         " Xuan.Kao 20190910 Customer PO Date
      FROM vbkd
     WHERE vbeln = i1-vbeln
    AND posnr = ''.
    MOVE zplant TO i1-prdplant.
    MOVE mabc TO i1-maabc.
    MOVE teisbe TO i1-eisbe.
    i1-sosto = 'X'.
**add by rong 20201218
    CLEAR itab_vbak.
    READ TABLE itab_vbak WITH KEY vbeln = i1-vbeln.
    IF sy-subrc = 0.
      i1-vtweg = itab_vbak-vtweg.
      i1-spart = itab_vbak-spart.
    ENDIF.
**add end
**add GP Information Rong 20240819
    IF p_gp = 'X' AND l_display_gp = 'X'.
      READ TABLE tbl_gp WITH KEY vbeln = it_soview-vbeln posnr = it_soview-posnr.
      IF sy-subrc <> 0.
        CLEAR: tmp_tbl_gp, tmp_tbl_gp[].
        CALL FUNCTION 'Z_SD_CHECK_GP'
          EXPORTING
            pi_vbeln = it_soview-vbeln
            pi_date  = sy-datlo
          TABLES
            tbl_gp   = tmp_tbl_gp.
        APPEND LINES OF tmp_tbl_gp TO tbl_gp.
      ENDIF.
      READ TABLE tbl_gp WITH KEY vbeln = it_soview-vbeln posnr = it_soview-posnr.
      IF sy-subrc = 0.
        CLEAR: gp_factor,gp_vkorg.
        CALL FUNCTION 'CURRENCY_CONVERTING_FACTOR'
          EXPORTING
            currency          = tbl_gp-waerk
          IMPORTING
            factor            = gp_factor
          EXCEPTIONS
            too_many_decimals = 1
            OTHERS            = 2.
        tbl_gp-cost = tbl_gp-cost * gp_factor.
        i1-cost = tbl_gp-cost.
        i1-gpdate = sy-datlo.
        i1-mingptxt = tbl_gp-mingptxt.
        IF tbl_gp-currentgptxt IS NOT INITIAL.
          SPLIT tbl_gp-currentgptxt AT '%' INTO i1-currentgptxt2 gp_vkorg.
          IF ( gp_vkorg IS INITIAL ) AND ( strlen( i1-currentgptxt2 ) = 1 ).
            CONCATENATE '+' i1-currentgptxt2 INTO i1-currentgptxt2.
          ENDIF.
          CONCATENATE gp_vkorg i1-currentgptxt2 '%' INTO i1-currentgptxt2.
        ENDIF.
      ENDIF..
    ENDIF.
**20240819 end
    PERFORM process_so_hans CHANGING p_dflag.
  ENDLOOP.
***20250828 rong not display ZTM0 after shipped
  DATA: wa_a1       LIKE a1,
        l_open(1),
        w_loop_ztm0 LIKE sy-tabix.
  LOOP AT a1 WHERE pstyv = 'ZTM0'.
    w_loop_ztm0  = sy-tabix.
    l_open = ''.
    LOOP AT it_soview WHERE vbeln = a1-vbeln AND uepos = a1-posnr."
      READ TABLE a1 WITH KEY vbeln = it_soview-vbeln posnr = it_soview-posnr INTO wa_a1.
      IF sy-subrc = 0.
        l_open = 'X'.  "Open, 
        EXIT.
      ENDIF.
    ENDLOOP.
    IF l_open = ''.
      DELETE a1 INDEX w_loop_ztm0.
    ENDIF.
  ENDLOOP.
***end 20250828
  REFRESH it_soview.


***********************************************
*Process STO
***********************************************
** Add By Hermit for default check
  DATA : torg LIKE ekko-ekorg.
  torg = 'TW01'.
  LOOP AT it_stoview.
    g_index = sy-tabix.
    CLEAR: p_dflag, i1.
    CLEAR : mabc, teisbe.
***modify by Hermit
** for release STO only
*    IF IT_STOVIEW-FRGKE <> 'Y' AND IT_STOVIEW-BUKRS = 'US01'.
*     CONTINUE.
*  ENDIF.
*   IF TORG NOT IN S_ORG AND
*    IT_STOVIEW-EKORG NOT IN S_ORG.
*    CONTINUE.
* ENDIF.
    IF it_stoview-reswk = 'TWH1'.
      IF p_rado4 = 'X'.  "Hub SO only
        IF it_stoview-reslo = 'B000'.
          CONTINUE.
        ENDIF.
      ELSEIF p_rado5 = 'X'.
        IF it_stoview-reslo <> 'B000'.
          CONTINUE.
        ENDIF.
      ENDIF.
    ENDIF.
    SELECT SINGLE maabc eisbe mmsta ekgrp dispo FROM marc INTO    " Xuan.Kao 20150212 Material's Purchasing Group on Sales For ekgrp
    (marc-maabc, marc-eisbe, marc-mmsta, marc-ekgrp ,marc-dispo)        " Xuan.Kao 20150212 Material's Purchasing Group on Sales For marc-ekgrp
       WHERE matnr = it_stoview-matnr
    AND werks = it_stoview-reswk.
    IF sy-subrc = 0.
      i1-smmsta = marc-mmsta.
      mabc = marc-maabc.
      teisbe = marc-eisbe.
      i1-sekgrp = marc-ekgrp.                               " Xuan.Kao 20150212 Material's Purchasing Group on Sales
      "i1-dispo = marc-dispo.                               " Xuan.Kao 20150212 Material's Purchasing Group on Sales
      CHECK marc-maabc IN s_maabc.
    ENDIF.
*** Xuan.Kao 20150506 Material's Special procurement in Demand Plant-Start
    SELECT SINGLE sobsl FROM marc INTO (marc-sobsl)
           WHERE matnr = it_stoview-matnr
    AND werks = it_stoview-werks.
    IF sy-subrc = 0.
      i1-psobsl = marc-sobsl.
    ENDIF.
*** Xuan.Kao 20150506 Material's Special procurement in Demand Plant-End
*** Xuan.Kao 20160329 Get MARA Data-Start ***
    SELECT SINGLE zzcaps FROM mara INTO
    (i1-zzcaps)                                             " Xuan.Kao 20160329 Material CAPS indicator
    WHERE matnr = it_stoview-matnr.
*** Xuan.Kao 20160329 Get MARA Data-End ***
*** Xuan.Kao 20161222 Material Pricing Group-Start ***
    SELECT SINGLE kondm INTO i1-kondm
      FROM mvke
     WHERE matnr = it_stoview-matnr
    AND vkorg = it_stoview-vkorg.
    CHECK i1-kondm IN s_kondm.
*** Xuan.Kao 20161222 Material Pricing Group-End ***
*** Xuan.Kao 20211108 Ship to Party Address Code-Start ***
    SELECT SINGLE adrn2 INTO i1-sh_adrnr
      FROM ekpo
     WHERE ebeln = it_stoview-ebeln
       AND ebelp = it_stoview-ebelp.
*** Xuan.Kao 20211108 Ship to Party Address Code-End ***

    CLEAR zplant.
    CALL FUNCTION 'ZGET_PRODUCTION_PLANT'
      EXPORTING
*       PWERKS = it_stoview-werks
        pwerks = 'TWH1'
        pmatnr = it_stoview-matnr
      IMPORTING
        zwerks = zplant.
    IF NOT zplant IN s_prod.
      CONTINUE.
    ENDIF.

    MOVE-CORRESPONDING it_stoview TO i1.
    MOVE zplant TO i1-prdplant.
    MOVE mabc TO i1-maabc.
    MOVE teisbe TO i1-eisbe.
    MOVE it_stoview-commit_date1 TO i1-zz_sdatu.
    i1-sosto = ''.
    PERFORM process_sto_hans  CHANGING p_dflag.
  ENDLOOP.
  REFRESH it_stoview.


***********************************************
*  DN Credit block
***********************************************
  RANGES: s_bukrs FOR ekko-bukrs.
  RANGES: s_dn FOR  likp-vbeln.
  DATA: BEGIN OF itab_vbup OCCURS 0,
          vbeln LIKE vbuk-vbeln, " Sales and Distribution Document Number
          cmgst LIKE vbuk-cmgst, " Overall status of credit checks
        END OF itab_vbup .

  DATA: it_vsbed LIKE isa_shipping_cond OCCURS 0
  WITH HEADER LINE.


  PERFORM get_shipping_desc TABLES it_vsbed.

  IF a1[] IS NOT INITIAL.   " 2009/10/29 , Ted.Tsao
    SELECT * FROM v_vbuk_cds
    INTO CORRESPONDING FIELDS OF TABLE itab_vbup
    FOR ALL ENTRIES IN a1
    WHERE vbeln = a1-dvbeln.
  ENDIF.

** change by chris 20111213
  DATA: BEGIN OF itab_makt OCCURS 0,
          matnr LIKE makt-matnr, " Material Number
*           SPRAS LIKE MAKT-SPRAS, " language key
          maktx LIKE makt-maktx, " material desc
        END OF itab_makt .
  IF NOT a1[] IS INITIAL.
    SELECT * FROM makt
      INTO CORRESPONDING FIELDS OF TABLE itab_makt
      FOR ALL ENTRIES IN a1
      WHERE matnr = a1-matnr
    AND spras = 'E'.
  ENDIF.
** change by chris 20111213



  LOOP AT a1.
* TOM 2010/11/29
*    if a1-VKORG eq 'CN01'.
*SELECT SINGLE LABST INTO A1-G_LABST FROM MARD WHERE MATNR = A1-MATNR
*AND LGORT = '0000'.
*      IF SY-SUBRC = 0.
*        A1-G_CYKC = A1-G_LABST - A1-SCHQTY.
*      ENDIF.
*    ENDIF.
    g_index = sy-tabix.

** change by chris 20111213
    READ TABLE itab_makt WITH KEY matnr = a1-matnr.
    IF sy-subrc = 0.
      a1-arktx = itab_makt-maktx.
    ENDIF.
** change by chris 20111213

*** Xuan.Kao 20191115 TW19 SO Item Description-Start ***
    IF ( a1-vkorg = 'TW19' ) AND ( a1-vbtyp = 'C' ).
      IF ( a1-uepos IS NOT INITIAL ) AND ( a1-posnr+4(2) = '01' ).
        SELECT SINGLE arktx INTO a1-arktx
          FROM vbap
         WHERE vbeln = a1-vbeln
        AND posnr = a1-uepos.
      ENDIF.
      IF ( a1-uepos IS INITIAL ) AND ( a1-pstyv(3) <> 'ZTM' ).
        SELECT SINGLE arktx INTO a1-arktx
          FROM vbap
         WHERE vbeln = a1-vbeln
        AND posnr = a1-posnr.
      ENDIF.
    ENDIF.
*** Xuan.Kao 20191115 TW19 SO Item Description-End ***

*** Xuan.Kao 20211118 TW19 Sales Order Purchasing Group-Start ***
    IF ( a1-vkorg = 'TW19' ) AND ( a1-vbtyp = 'C' ) AND ( a1-kunnr = 'ADVACL' ).
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = a1-ebeln
        IMPORTING
          output = a1-ebeln.

      SELECT SINGLE ekgrp INTO a1-ekgrp
        FROM ekko
       WHERE ebeln = a1-ebeln
         AND ekorg = 'TW01'
         AND bsart = 'PO'
         AND lifnr = 'ADVCERMATE'.

      IF a1-ekgrp IN s_ekgrp.
      ELSE.
        DELETE a1.
        CONTINUE.
      ENDIF.
    ENDIF.
*** Xuan.Kao 20211118 TW19 Sales Order Purchasing Group-End ***
*20220913
    IF  a1-vkorg = 'JP02' .
      SELECT SINGLE arktx INTO a1-arktx
              FROM vbap
             WHERE vbeln = a1-vbeln
            AND posnr = a1-posnr.
    ENDIF.
*** Xuan.Kao 20211118 Purchasing Group Name For STO-Start ***
    SELECT SINGLE eknam INTO a1-ekgrp_desc
      FROM t024
     WHERE ekgrp = a1-ekgrp.
*** Xuan.Kao 20211118 Purchasing Group Name For STO-End ***
*** DOUBLE ADD 20250306 MRP NAME FOR SUPPLY PLANT
    CLEAR: a1-dsnam.
    SELECT SINGLE dsnam INTO a1-dsnam
    FROM marc
    INNER JOIN t024d ON marc~werks = t024d~werks AND marc~dispo = t024d~dispo
    WHERE marc~werks = a1-splant
    AND marc~matnr = a1-matnr.

* * assign DN block
    LOOP AT itab_vbup WHERE vbeln =  a1-dvbeln.
      a1-dncmgst = itab_vbup-cmgst.
    ENDLOOP.
    IF sy-subrc <> 0.
      CLEAR a1-dncmgst.
    ENDIF.

* give shipping desc
    LOOP AT it_vsbed WHERE vsbed = a1-vsbed.
      a1-ship_desc =  it_vsbed-vtext.
    ENDLOOP.

* clear DN amount when status = 1, not yet dn.
*    IF a1-status = 1.
*      CLEAR a1-dnamt.
**     clear a1-dnqty.
*    ENDIF.
* Chris 2011/02/01 Add sold-to EMAIL
    CLEAR : kna1, adr6.
    SELECT SINGLE * FROM kna1 WHERE kunnr = a1-kunnr.
    IF sy-subrc = 0.
      SELECT SINGLE * FROM adr6 WHERE addrnumber = kna1-adrnr
      AND  flgdefault = 'X'.
      a1-smtp_addr = adr6-smtp_addr.
    ENDIF.
* Chris 2011/06/14
    CLEAR : vbak.
    SELECT SINGLE * FROM vbak WHERE vbeln = a1-vbeln.
    IF sy-subrc = 0.
      a1-vdatu = vbak-vdatu.
      a1-zzkatr11 = vbak-zzkatr11.
* Chris 2015/04/30
      a1-autlf = vbak-autlf.
      "---20251118 HW Add Parcel Shipment Info
      a1-zzcarr      = vbak-zzcarr.
      a1-zzcarr_type = vbak-zzcarr_type.
      a1-zzcoll      = vbak-zzcoll.
      a1-zzpayer     = vbak-zzpayer.
      a1-zzcharge    = vbak-zzcharge.
      a1-zzinsurance = vbak-zzinsurance.
      a1-zzpdetail   = vbak-zzpdetail.
      a1-zzcolshpact = vbak-zzcolshpact.
    ENDIF.
* Chris 20120821
    CLEAR : ztmm_127.
    SELECT SINGLE * FROM ztmm_127 WHERE matnr = a1-matnr
    AND zreg = 'ADS'.
    IF sy-subrc = 0.
      a1-matnr_old = ztmm_127-matnr_old.
    ENDIF.
* Chris 20130206
*** Xuan.Kao 20160308 Delivery Plant For Country of origin,Material Description(Chinese),Brand,MPN.-Start ***
    CLEAR: dlvplant.
    IF a1-vbtyp = 'C'.
      dlvplant = a1-werks.
    ELSE.
      dlvplant = a1-splant.
    ENDIF.
*** Xuan.Kao 20160308 Delivery Plant For Country of origin,Material Description(Chinese),Brand,MPN.-End ***

*** Xuan.Kao 20151217 Country of origin-Start ***
    CLEAR :ztmm_44.
    SELECT SINGLE zprdplc INTO a1-zprdplc
      FROM ztmm_44
     WHERE matnr = a1-matnr
       AND werks = dlvplant                           " Xuan.Kao 20160308 Delivery Plant
    AND zprdplc <> ''.

    IF sy-subrc <> 0.
      SELECT SINGLE zprdplc INTO a1-zprdplc
        FROM ztmm_44
       WHERE matnr = a1-matnr
      AND werks = ''.
    ENDIF.
*** Xuan.Kao 20151217 Country of origin-End ***

*** Xuan.Kao 20151217 Material Description(Chinese)-Start ***
    CLEAR :ztmm_44.
    SELECT SINGLE maktx INTO a1-zmaktx
      FROM ztmm_44
     WHERE matnr = a1-matnr
       AND werks = dlvplant                           " Xuan.Kao 20160308 Delivery Plant
    AND maktx <> ''.

    IF sy-subrc <> 0.
      SELECT SINGLE maktx INTO a1-zmaktx
        FROM ztmm_44
       WHERE matnr = a1-matnr
      AND werks = ''.
    ENDIF.
*** Xuan.Kao 20151217 Material Description(Chinese)-End ***

*** Xuan.Kao 20151217 Brand-Start ***
    CLEAR :ztmm_44.
    SELECT SINGLE ztrademark INTO a1-ztrademark
      FROM ztmm_44
     WHERE matnr = a1-matnr
       AND werks = dlvplant                           " Xuan.Kao 20160308 Delivery Plant
    AND ztrademark <> ''.

    IF sy-subrc <> 0.
      SELECT SINGLE ztrademark INTO a1-ztrademark
        FROM ztmm_44
       WHERE matnr = a1-matnr
      AND werks = ''.
    ENDIF.
*** Xuan.Kao 20151217 Brand-End ***

*** Xuan.Kao 20151217 MPN-Start ***
    CLEAR :ztmm_46.
    SELECT SINGLE ematn INTO a1-ematn
      FROM ztmm_46
     WHERE bmatn = a1-matnr
       AND werks = dlvplant                           " Xuan.Kao 20160308 Delivery Plant
    AND activ = 'X'.

    IF sy-subrc <> 0.
      CLEAR :ztmm_45.
      SELECT SINGLE ematn INTO a1-ematn
        FROM ztmm_45
       WHERE bmatn = a1-matnr
         AND datuv <= sy-datum
      AND datub >= sy-datum.
      IF sy-subrc <> 0.
        SELECT SINGLE ematn INTO a1-ematn
          FROM ztmm_45
         WHERE bmatn = a1-matnr
           AND datuv = '00000000'
        AND datub = '00000000'.
      ENDIF.
    ENDIF.
*** Xuan.Kao 20151217 MPN-End ***

*** Xuan.Kao 20150212 Material's Purchasing Group on Sales-Start
    CLEAR : t024.
    SELECT SINGLE * FROM t024 WHERE ekgrp = a1-sekgrp.
    IF sy-subrc = 0.
      a1-sekgrp_desc = t024-eknam.
    ENDIF.
*** Xuan.Kao 20150212 Material's Purchasing Group on Sales-End

*    CLEAR :a1-dsnam.  "20250306 double add
*    SELECT SINGLE dsnam into a1-dsnam FROM t024d WHERE dispo = a1-dispo.



**rong 20181113 get delivry block decripiton
    SELECT SINGLE vtext INTO a1-vtext FROM tvlst WHERE spras = sy-langu
    AND lifsp = a1-lifsk.
    IF a1-dncmgst = 'B' OR a1-dncmgst = 'C'.
      a1-od_block = 'credit block'.
    ENDIF.
    SELECT SINGLE ddtext INTO a1-ddtext FROM dd07t WHERE domname = 'ZZ_ABGRU'
                                  AND ddlanguage = sy-langu
    AND domvalue_l = a1-zz_reason.

    SELECT SINGLE ddtext INTO a1-abgrux_text FROM dd07t WHERE domname = 'ZZ_ABGRUX'
                                  AND ddlanguage = sy-langu
    AND domvalue_l = a1-zz_abgru.
    IF alv_def = '/B+B LINE' OR  alv_def = '/B+B SH LINE' .
      SELECT SINGLE audat INTO a1-oedatu FROM vbak WHERE vbeln = a1-vbeln.
    ENDIF.
**end
**rong 20190404 add field from zrsd1440
    SELECT SINGLE action_by zreason zcomm_id zhold datab FROM ztsd_tracking_01
      INTO (a1-action_by,a1-zreason,a1-zcomm_id,a1-zhold,a1-datab)
      WHERE vbeln = a1-vbeln
    AND posnr = a1-posnr.
    IF a1-zhold = 'X'.
      a1-zhold = 'Y'.
    ELSE.
      a1-zhold = 'N'.
    ENDIF.
    SELECT SINGLE ename INTO a1-name_action FROM pa0001 WHERE pernr = a1-action_by.
    SELECT SINGLE zreason_text INTO a1-zreason_text FROM ztsd_tracking_02 WHERE zreason = a1-zreason.
    SELECT SINGLE zcomm_text INTO a1-zcomm_text FROM ztsd_tracking_03 WHERE zcomm_id = a1-zcomm_id.
**end
**rong 20190814 add field 'Reference Date'
    a1-d_audat = a1-audat.
    SELECT SINGLE audat INTO a1-d_audat FROM vbak WHERE vbeln = a1-vbeln.
    IF a1-zbuffer <> 0.
      a1-d_audat = a1-d_audat + a1-zbuffer.
    ELSE.
      SELECT SINGLE * FROM ztpp_05 WHERE maabc = a1-maabc.
      IF sy-subrc = 0.
        a1-d_audat = a1-d_audat + ztpp_05-zday.
      ENDIF.
    ENDIF.
**end
    MODIFY a1 INDEX g_index
    TRANSPORTING dncmgst ship_desc dnamt smtp_addr vdatu zzkatr11
                 arktx matnr_old zprdplc
                 zmaktx ztrademark ematn        " Xuan.Kao 20151217 Material Description(Chinese), Brand, MPN.
                 sekgrp_desc autlf              " Xuan.Kao 20150212 Material's Purchasing Group on Sales For sekgrp_desc
                 ekgrp ekgrp_desc               " Xuan.Kao 20211118 Purchasing Group Name For STO
                 vtext od_block ddtext oedatu abgrux_text  "rong 20181113 delivry block descprition
                 action_by name_action zreason zreason_text zcomm_id zcomm_text zhold datab d_audat dsnam "rong 20190404
                 zzcarr zzcarr_type zzcoll zzpayer zzcharge zzinsurance zzpdetail zzcolshpact. "20251118 HW
  ENDLOOP.

  DELETE a1 WHERE NOT dncmgst IN s_dncmg.

* industry key
  DELETE a1 WHERE NOT brsch IN s_brsch.

* Chris 2011/06/14 only released Virtual SO
  DELETE a1 WHERE auart = 'ZOR9' AND zzkatr11 = '100'.

*** Xuan.Kao 20181219 SO GP view-Start ***
  CLEAR: username.

  CALL METHOD cl_gui_frontend_services=>get_user_name
    CHANGING
      user_name            = username
    EXCEPTIONS
      cntl_error           = 1
      error_no_gui         = 2
      not_supported_by_gui = 3
      OTHERS               = 4.

  CALL METHOD cl_gui_cfw=>flush
    EXCEPTIONS
      cntl_system_error = 1
      cntl_error        = 2
      OTHERS            = 3.

  IF username IS INITIAL.
    CALL METHOD cl_gui_frontend_services=>registry_get_value
      EXPORTING
        root                 = cl_gui_frontend_services=>hkey_current_user
        key                  = 'Software\Microsoft\Windows\CurrentVersion\Explorer'
        value                = 'Logon User Name'
      IMPORTING
        reg_value            = username
      EXCEPTIONS
        get_regvalue_failed  = 1
        cntl_error           = 2
        error_no_gui         = 3
        not_supported_by_gui = 4
        OTHERS               = 5.

    CALL METHOD cl_gui_cfw=>flush
      EXCEPTIONS
        cntl_system_error = 1
        cntl_error        = 2
        OTHERS            = 3.
  ENDIF.

  TRANSLATE username TO UPPER CASE.

  IF username IS NOT INITIAL.
    CLEAR: gp_vkorg, gp_view.
    SELECT SINGLE zmalgp INTO gp_vkorg
      FROM ztmm_15
     WHERE zmalgp LIKE 'ZRSD28B_%'
    AND smtp_addr = username.
    IF sy-subrc = 0.
      LOOP AT a1 WHERE vbtyp = 'C'.
        g_index = sy-tabix.

        CLEAR: gp_vkorg.
        CONCATENATE 'ZRSD28B_' a1-vkorg INTO gp_vkorg.
        SELECT SINGLE zmalgp INTO gp_vkorg
          FROM ztmm_15
         WHERE zmalgp = gp_vkorg
        AND smtp_addr = username.
        IF sy-subrc = 0.
          gp_view = 'X'.

          CLEAR: tbl_gp, tbl_gp[].
          CALL FUNCTION 'Z_SD_CHECK_GP'
            EXPORTING
              pi_vbeln = a1-vbeln
            TABLES
              tbl_gp   = tbl_gp.

          READ TABLE tbl_gp WITH KEY posnr = a1-posnr.
          IF sy-subrc = 0.
            CLEAR: gp_factor, gp_vkorg.
            CALL FUNCTION 'CURRENCY_CONVERTING_FACTOR'
              EXPORTING
                currency          = tbl_gp-waerk
              IMPORTING
                factor            = gp_factor
              EXCEPTIONS
                too_many_decimals = 1
                OTHERS            = 2.

            tbl_gp-cost = tbl_gp-cost * gp_factor.
            IF tbl_gp-perunit IS INITIAL.
              IF tbl_gp-kwmeng IS NOT INITIAL.
                a1-verpr = tbl_gp-cost / tbl_gp-kwmeng.
              ENDIF.
            ELSE.
              a1-verpr = tbl_gp-cost / tbl_gp-perunit.
            ENDIF.

            IF tbl_gp-currentgptxt IS NOT INITIAL.
              SPLIT tbl_gp-currentgptxt AT '%' INTO a1-currentgptxt gp_vkorg.
              IF ( gp_vkorg IS INITIAL ) AND ( strlen( a1-currentgptxt ) = 1 ).
                CONCATENATE '+' a1-currentgptxt INTO a1-currentgptxt.
              ENDIF.
              CONCATENATE gp_vkorg a1-currentgptxt '%' INTO a1-currentgptxt.
            ENDIF.

            MODIFY a1 INDEX g_index TRANSPORTING verpr currentgptxt.
          ENDIF.
        ENDIF.
      ENDLOOP.
    ENDIF.
  ENDIF.
*** Xuan.Kao 20181219 SO GP view-End ***

ENDFORM.                    " process_data_hans
*&---------------------------------------------------------------------*
*&      Form  get_sales_order_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_sales_order_data .

  DATA: w_not_found LIKE sy-subrc.
  CLEAR w_not_found.
  RANGES: ss_vbeln FOR vbak-vbeln.
  RANGES: s_so_bukrs FOR ekko-bukrs.
**add by rong, 20201218
  CLEAR:s_vtweg,s_spart.
  REFRESH: s_vtweg,s_spart.
  IF p_vtweg <> ''.
    MOVE: 'I' TO s_vtweg-sign,
          'EQ' TO s_vtweg-option,
          p_vtweg TO s_vtweg-low.
    APPEND s_vtweg.
  ENDIF.
  IF p_spart <> ''.
    MOVE: 'I' TO s_spart-sign,
          'EQ' TO s_spart-option,
          p_spart TO s_spart-low.
    APPEND s_spart.
  ENDIF.
**add end,20201218
* if s_kunnr or s_pernr has vaule.
*  IF s_vbeln IS INITIAL AND
*   s_kunnr[] IS INITIAL AND
*   s_pernr[] IS INITIAL.
**    do nothing.
*  ELSE.
*    REFRESH s_parvw.
*    give_range_value 'VE' s_parvw. " ship to party
*    give_range_value 'WE' s_parvw. " sales person
*    give_range_value 'VE' s_parvw. "partner func for sales person
*    SELECT  * FROM vbpa AS a
*    INTO CORRESPONDING FIELDS OF wa_vbpa
*    WHERE vbeln IN s_vbeln
*    AND kunnr   IN s_kunnr
*    AND pernr   IN s_pernr
*    AND parvw   IN s_parvw
*    AND EXISTS ( SELECT * FROM zsoview
*                WHERE vbeln = a~vbeln
*                 AND vkorg = p_vkorg    "sales org
*                 AND bstnk IN s_bstnk   "PO number
*                 AND auart IN s_auart   "order type
*                 AND pstyv IN s_pstyv   " item category
*                 AND ernam IN s_ernam   "user id
*                 AND kunnr IN s_kunag   "sold to party
*               AND vsbed IN s_vsbed   "Shipping condition
*               AND vkbur IN s_vkbur   "sales office
*               AND vkgrp IN s_vkgrp   "sales group
*               AND werks IN s_werks   "plant
*               AND lgort IN s_lgort   "storage location
*               AND matnr IN s_matnr   "material
*               AND cmgst IN s_cmgst   "So credit block
*               AND  route  IN s_route   " route
*          ).
**      give_range_value wa_vbpa-vbeln ss_vbeln.
*      APPEND wa_vbpa TO it_vbpa.
*    ENDSELECT.
*
*    IF sy-subrc <> 0.
*      IF s_vbeln IS INITIAL.
*        MESSAGE e000 WITH 'Ship to Party or Personal Number not found!'
*.
*      ENDIF.
*    ENDIF.
*
**    SORT ss_vbeln BY sign option low high .
**    DELETE ADJACENT DUPLICATES FROM  ss_vbeln
**    COMPARING ALL FIELDS .
*
*    SORT it_vbpa BY vbeln posnr parvw kunnr pernr.
*    DELETE ADJACENT DUPLICATES FROM  it_vbpa
*    COMPARING vbeln.
*
*
*  ENDIF.

  DATA: so_line TYPE i.
  DATA: w_check .
  DESCRIBE TABLE it_vbpa LINES so_line.

  IF w_check = 'X'.
    REFRESH it_vbpa.
  ENDIF.


*  IF  p_sts5 IS INITIAL.
*    PERFORM select_so_all USING w_not_found.
*  ELSE.
*    PERFORM select_so_confirm USING w_not_found.
*  ENDIF.

*** Change Request By Hermit 2005/07/09
* IF p_rado2 = 'X'.  " un_confirm
*   PERFORM select_so_unconfirm USING w_not_found.
* ELSE.                  " all or confirm
  PERFORM select_so_all USING w_not_found.
* ENDIF.
** End of modification

  REFRESH it_vbpa.

  IF w_not_found <> 0.
    IF p_type2 IS INITIAL.
      MESSAGE i208 WITH TEXT-m05.
      SUBMIT zrsd0028b VIA SELECTION-SCREEN.
    ELSE.
      EXIT.
    ENDIF.
  ENDIF.

  DESCRIBE TABLE it_soview LINES so_line.
  IF so_line = 0.
    IF p_type2 IS INITIAL.
      MESSAGE i208 WITH TEXT-m05.
      LEAVE TO TRANSACTION sy-tcode.
    ELSE.
      EXIT.

    ENDIF.
  ENDIF.
**********************************************
  PERFORM so_mara_marc_mard_tvko.
**********************************************
************************************************
* selction criteria condition: Storage bin
************************************************

  IF NOT s_lgpbe IS INITIAL.
    DELETE it_soview WHERE NOT  lgpbe  IN s_lgpbe .

    DESCRIBE TABLE it_soview LINES so_line.
    IF so_line = 0.
      IF p_type2 IS INITIAL.
        MESSAGE i208 WITH TEXT-m05.
        LEAVE TO TRANSACTION sy-tcode.
      ELSE.
        EXIT.

      ENDIF.
    ENDIF.
  ENDIF.


************************************************
*** Process  prodh2 prodh3.
************************************************
*  LOOP AT it_soview.
**set product hierarchy - level2 product group
*    it_soview-prodh2 = it_soview-prodh+5(5).
*    REPLACE '-' WITH space INTO it_soview-prodh2.
**set product hierarchy - level3 product line
*    it_soview-prodh3 = it_soview-prodh+10(8).
*    MODIFY it_soview INDEX sy-tabix
*       TRANSPORTING prodh2 prodh3.
*  ENDLOOP.

* check s_prodh2 s_prodh3 .
  IF s_prodh2 IS INITIAL AND s_prodh3 IS INITIAL.
  ELSE.

    DELETE it_soview
    WHERE  NOT ( prodh2  IN s_prodh2
             AND prodh3  IN s_prodh3 ).

  ENDIF.
* chris 20120504
  IF s_blatt IS NOT INITIAL .
    DELETE it_soview
    WHERE  NOT blatt IN s_blatt.
  ENDIF.

  IF s_eaipd IS INITIAL AND s_eaipg IS INITIAL.
  ELSE.

    DELETE it_soview
    WHERE  NOT ( eaipd  IN s_eaipd
             AND eaipg  IN s_eaipg ).

  ENDIF.


  DESCRIBE TABLE it_soview LINES so_line.
  IF so_line = 0.
    IF p_type2 IS INITIAL.
      MESSAGE i208 WITH TEXT-m05.
      LEAVE TO TRANSACTION sy-tcode.
    ELSE.
      EXIT.
    ENDIF.
  ENDIF.
*20151014 exclude sales BOM ZAP
  IF it_soview IS NOT INITIAL .
    DELETE it_soview WHERE pstyv = 'ZAP'.
  ENDIF.

******************************************************
  PERFORM search_so_incoterm .
******************************************************

******************************************************
*******for cost currency key*
*****************************************************
*  RANGES: s_so_matnr FOR ekpo-matnr.

  DATA: BEGIN OF itab_t001 OCCURS 0,
          bukrs LIKE t001-bukrs, " Company Code
          waers LIKE t001-waers, " Currency Key
          spras LIKE t001-spras, " Language Key
        END OF itab_t001 .

  DATA: BEGIN OF itab_mbew OCCURS 0,
          matnr LIKE mbew-matnr, " Material Number
          bwkey LIKE mbew-bwkey, " Valuation area
          stprs LIKE mbew-stprs, " Standard Price
          peinh LIKE mbew-peinh, " Price Unit
        END OF itab_mbew .
  DATA: wa_mbew  LIKE  itab_mbew .
  DATA: g_factor TYPE p DECIMALS 3.
  DATA: i_zgetcost LIKE zgetcost2.

*  LOOP AT it_soview.
**    give_range_value it_soview-bukrs  s_so_bukrs.
**    give_range_value it_soview-matnr  s_so_matnr.
*    give_range_value it_soview-werks  s_so_werks.
*
*  ENDLOOP.

*  SORT s_so_matnr BY sign option low high.
*  SORT s_so_werks BY sign option low high.
*  SORT s_so_bukrs BY sign option low high.

*  DELETE ADJACENT DUPLICATES FROM   s_so_matnr
*  COMPARING ALL FIELDS .
*  DELETE ADJACENT DUPLICATES FROM   s_so_werks
*  COMPARING ALL FIELDS .
*  DELETE ADJACENT DUPLICATES FROM   s_so_bukrs
*  COMPARING ALL FIELDS .


  SELECT * FROM t001
  INTO CORRESPONDING FIELDS OF TABLE itab_t001
  WHERE bukrs IN s_so_bukrs.



*  SELECT * FROM mbew
*  INTO CORRESPONDING FIELDS OF TABLE itab_mbew
*  WHERE matnr IN s_so_matnr
*  AND bwkey   IN s_so_werks.

*   20170329 replace cost
*  SELECT * FROM mbew
*  INTO CORRESPONDING FIELDS OF TABLE itab_mbew
*  FOR ALL ENTRIES IN it_soview
*        WHERE  matnr = it_soview-matnr
*        AND bwkey    = it_soview-werks.

  SORT itab_mbew BY matnr bwkey.
  LOOP AT it_soview.
    so_index = sy-tabix .
    SELECT SINGLE land1 INTO t001w-land1 FROM t001w
    WHERE vkorg = it_soview-vkorg.
    SELECT SINGLE waers FROM t001 INTO t001-waers
    WHERE land1 = t001w-land1.
    IF sy-subrc = 0.
      it_soview-stwaers = t001-waers.
    ENDIF.
*   20170329 replace cost

    CALL FUNCTION 'Z_GET_TARGET_COST'
      EXPORTING
        pi_werks         = it_soview-werks
        pi_matnr         = it_soview-matnr
        pi_convert       = ''
        pi_price_convert = ''
      IMPORTING
        pe_zgetcost      = i_zgetcost
      EXCEPTIONS
        no_found         = 1
        OTHERS           = 2.

    it_soview-stprs   = i_zgetcost-stprs.
    it_soview-stpeinh = i_zgetcost-peinh.
    it_soview-stprs  =  it_soview-stprs / it_soview-stpeinh.

*    READ TABLE itab_mbew WITH KEY matnr = it_soview-matnr
*                                  bwkey = it_soview-werks.
*    IF sy-subrc = 0.
*      it_soview-stprs   =  itab_mbew-stprs .
*      it_soview-stpeinh =  itab_mbew-peinh.
*
*      PERFORM get_curr_factor USING it_soview-stwaers g_factor.
*      it_soview-stprs  =  it_soview-stprs / it_soview-stpeinh.
*
*    ENDIF.
    MODIFY it_soview INDEX so_index
    TRANSPORTING stwaers stprs stpeinh.

  ENDLOOP.


**change request 20050511 Hans added end.


ENDFORM.                    " get_sales_order_data
*&---------------------------------------------------------------------*
*&      Form  get_STO_order_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_sto_order_data .
*******************************************************************
* check sales person id
* check sales group and office, infects sold to party.

  RANGES: s2_kunnr FOR knvv-kunnr.
  DATA: w_not_found TYPE sy-subrc.
  IF  s_pernr[] IS INITIAL.
    IF s_vkgrp[] IS INITIAL AND  s_vkbur[] IS INITIAL.
* do nothing.
    ELSE.
      SELECT * FROM knvv
*      WHERE  VKORG = P_VKORG
     WHERE kunnr IN s_kunnr
        AND vkgrp IN s_vkgrp
        AND vkbur IN s_vkbur.
        give_range_value knvv-kunnr s2_kunnr.
        APPEND knvv TO it_knvv.
      ENDSELECT.
*    sold to party = ship to party.
    ENDIF.

  ELSE.   "NOT s_pernr IS INITIAL.

    SELECT *
    INTO CORRESPONDING FIELDS OF  it_knvvvp
    FROM knvv AS m
    INNER JOIN knvp AS n
          ON   m~kunnr = n~kunnr
          AND  m~vkorg = n~vkorg
    WHERE m~kunnr IN s_kunnr
*      AND M~VKORG =  P_VKORG
      AND m~vkgrp IN  s_vkgrp
      AND m~vkbur IN  s_vkbur
      AND n~parvw =   c_ve
      AND n~pernr IN s_pernr.

      give_range_value it_knvvvp-kunnr s2_kunnr.

      APPEND it_knvvvp.
    ENDSELECT.

    IF sy-subrc <> 0.
      IF p_type1 IS INITIAL.
        MESSAGE e000 WITH 'Personal Number not found!'.
        LEAVE TO TRANSACTION sy-tcode.
      ELSE.
        EXIT.
      ENDIF.
    ENDIF.
    SORT s2_kunnr BY sign option low high.
    DELETE ADJACENT DUPLICATES FROM   s2_kunnr
    COMPARING ALL FIELDS .

  ENDIF.

  IF NOT s2_kunnr[] IS INITIAL.
    REFRESH s_kunnr.
    s_kunnr[] = s2_kunnr[].
  ENDIF.

* Mark By Hermit 2005/07/26
*  IF  P_STS5 IS INITIAL.
*    PERFORM SELECT_STO_ALL USING W_NOT_FOUND.
*  ELSE.
*    PERFORM SELECT_STO_CONFIRM USING W_NOT_FOUND.
*  ENDIF.


*** Change Request By Hermit 2005/07/11
  IF p_rado1 = 'X'.
    PERFORM select_sto_confirm USING w_not_found.
  ELSEIF p_rado2 = 'X'.
    PERFORM select_sto_unconfirm USING w_not_found.
  ELSE.
    PERFORM select_sto_all USING w_not_found.
  ENDIF.
** End of modification

  IF w_not_found <> 0.
    IF p_type1 IS INITIAL.
      MESSAGE i208 WITH TEXT-m06.
*    SUBMIT sy-repid VIA SELECTION-SCREEN.
      SUBMIT zrsd0028b VIA SELECTION-SCREEN.
    ELSE.
      EXIT.
    ENDIF.
  ENDIF.


  DATA: sto_index LIKE sy-tabix.
  DATA: sto_line TYPE i.

*  RANGES: s_sto_matnr FOR mara-matnr.
*  LOOP AT it_stoview.
*    give_range_value it_stoview-matnr s_sto_matnr.
*  ENDLOOP.
*
*  SORT s_sto_matnr BY sign option low high.
*
*  DELETE ADJACENT DUPLICATES FROM   s_sto_matnr
*  COMPARING ALL FIELDS .
*

  REFRESH it_marc.
  SELECT  * FROM marc
   INTO CORRESPONDING FIELDS OF TABLE it_marc
   FOR ALL ENTRIES IN it_stoview
        WHERE matnr = it_stoview-matnr
  AND    werks = it_stoview-reswk.

*add by thomas 04.15     TO GET PB00 price FOR ADMU
  REFRESH: it_ekko.
  SELECT * FROM ekko
  INTO CORRESPONDING FIELDS OF TABLE it_ekko
  FOR ALL ENTRIES IN it_stoview
  WHERE ebeln = it_stoview-ebeln .

*the end

*   WHERE matnr  IN s_sto_matnr
*   AND   werks  IN s_werks.
  SORT it_marc BY matnr werks.
  LOOP AT it_stoview.
    sto_index = sy-tabix.
*add by thomas 04.15
    READ TABLE it_ekko WITH KEY ebeln =  it_stoview-ebeln .
    IF sy-subrc EQ 0.

      CLEAR : it_konv.

      IF it_stoview-lifnr = 'CKH2' OR it_stoview-lifnr = 'CKH1'.
*       Add by jane for STOZBP1>>Start

*        SELECT * FROM konv
*        INTO CORRESPONDING FIELDS OF  it_konv
*        WHERE knumv = it_ekko-knumv
*        AND   kposn = it_stoview-ebelp
*        AND   kschl = 'PB00'.
*        ENDSELECT.
*
*        IF sy-subrc NE 0.
*          SELECT * FROM konv
*          INTO CORRESPONDING FIELDS OF  it_konv
*          WHERE knumv = it_ekko-knumv
*          AND   kposn = it_stoview-ebelp
*          AND   kschl = 'ZBP1'.
*          ENDSELECT.
*        ENDIF.
*
*        IF sy-subrc EQ 0.
*          it_stoview-waers = it_konv-waers. "ZBP1 Currency
*        ELSE.
*          SELECT * FROM konv
*          INTO CORRESPONDING FIELDS OF  it_konv
*          WHERE knumv = it_ekko-knumv
*          AND   kposn = it_stoview-ebelp
*          AND   kschl = 'PBXX'.
*          ENDSELECT.
*        ENDIF.

        DATA: v_flag TYPE c.
        CLEAR v_flag.

        SELECT * FROM v_konv_cds
        INTO CORRESPONDING FIELDS OF  it_konv
        WHERE knumv = it_ekko-knumv
        AND   kposn = it_stoview-ebelp
        AND   kschl = 'ZBP1'.
        ENDSELECT.

        IF sy-subrc EQ 0.
          IF it_konv-kbetr = 0.
            v_flag = 'Y'.
          ENDIF.
        ELSE.
          v_flag = 'Y'.
        ENDIF.

        IF v_flag = 'Y'.
          SELECT * FROM v_konv_cds
          INTO CORRESPONDING FIELDS OF  it_konv
          WHERE knumv = it_ekko-knumv
          AND   kposn = it_stoview-ebelp
          AND   kschl = 'PB00'.
          ENDSELECT.

          IF sy-subrc NE 0.
            SELECT * FROM v_konv_cds
            INTO CORRESPONDING FIELDS OF  it_konv
            WHERE knumv = it_ekko-knumv
            AND   kposn = it_stoview-ebelp
            AND   kschl = 'PBXX'.
            ENDSELECT.
          ENDIF.
        ENDIF.

        IF it_konv IS NOT INITIAL.
          it_stoview-waers = it_konv-waers. "Currency Key
        ENDIF.
*      <<End

      ELSE.
        SELECT * FROM v_konv_cds
        INTO CORRESPONDING FIELDS OF  it_konv
        WHERE knumv = it_ekko-knumv
        AND   kposn = it_stoview-ebelp
        AND   kschl = 'PB00'.
        ENDSELECT.

        IF sy-subrc NE 0.
          SELECT * FROM v_konv_cds
          INTO CORRESPONDING FIELDS OF  it_konv
          WHERE knumv = it_ekko-knumv
          AND   kposn = it_stoview-ebelp
          AND   kschl = 'PBXX'.
          ENDSELECT.
        ENDIF.

      ENDIF.

      IF sy-subrc EQ 0 .
        it_stoview-kbetr = it_konv-kbetr .
        it_stoview-kpein1 = it_konv-kpein .

        it_stoview-kschl = it_konv-kschl."Condition Type
      ENDIF.

    ENDIF.
*end
*    LOOP AT it_marc WHERE matnr = it_stoview-matnr
*                     AND  werks = it_stoview-reswk.
*      it_stoview-sobsl = it_marc-sobsl.
*      it_stoview-plifz = it_marc-plifz.
*      it_stoview-ladgr = it_marc-ladgr.
*    ENDLOOP.
*mark by johnson and change code 12/13/2006
    READ TABLE it_marc WITH KEY matnr = it_stoview-matnr
                                werks = it_stoview-reswk.
    IF sy-subrc = 0.
      it_stoview-sobsl = it_marc-sobsl.
      it_stoview-plifz = it_marc-plifz.
      it_stoview-ladgr = it_marc-ladgr.
    ENDIF.
    MODIFY it_stoview INDEX sto_index
      TRANSPORTING sobsl plifz  ladgr kbetr kpein1 waers kschl.
  ENDLOOP.

  IF NOT s_ladgr[] IS INITIAL.
    DELETE it_stoview WHERE NOT ladgr  IN s_ladgr.
  ENDIF.

*add 20050623 by vivian
  IF NOT s_sobsl[] IS INITIAL.
    "DOUBLE ADD ON 20220407 FOR DX DATA AS STO,IP Be excluded by SP KEY
    REFRESH: itab_wrk2.
    SELECT wrk02 INTO TABLE itab_wrk2 FROM t460a WHERE sobsl IN s_sobsl.
    LOOP AT itab_wrk2.
      MOVE: 'I' TO s_wrk02-sign,
        'EQ' TO s_wrk02-option,
        itab_wrk2-wrk02 TO s_wrk02-low.
      APPEND s_wrk02.
      CLEAR s_wrk02.
    ENDLOOP.
    REFRESH:it_stoview_bak.
    LOOP AT it_stoview WHERE lifnr IN s_wrk02 AND sobsl NOT IN s_sobsl.
      MOVE-CORRESPONDING it_stoview TO it_stoview_bak.
      APPEND it_stoview_bak.
      CLEAR it_stoview_bak.
    ENDLOOP.
    DELETE it_stoview WHERE NOT sobsl  IN s_sobsl.
    "vendor  SP KEYSTO,IPSTO
    LOOP AT it_stoview_bak.
      MOVE-CORRESPONDING it_stoview_bak TO it_stoview.
      APPEND it_stoview.
      CLEAR it_stoview.
    ENDLOOP.
  ENDIF.


  DESCRIBE TABLE it_stoview LINES sto_line.
  IF sto_line = 0.
    IF p_type1 IS INITIAL.
      MESSAGE i208 WITH TEXT-m06.
*    SUBMIT zrsd0028v VIA SELECTION-SCREEN.
      LEAVE TO TRANSACTION sy-tcode.
    ELSE.
      EXIT.
    ENDIF.
  ENDIF.



*** process prodh2 prodh3.
*  SELECT  * FROM mara
*  APPENDING CORRESPONDING FIELDS OF TABLE it_mara
*  WHERE matnr IN s_sto_matnr.

  SELECT  * FROM mara
  APPENDING CORRESPONDING FIELDS OF TABLE it_mara
  FOR ALL ENTRIES IN it_stoview
  WHERE matnr = it_stoview-matnr.

*  SELECT  * FROM ZTPP_45
*  APPENDING CORRESPONDING FIELDS OF TABLE it_ZTPP_45
*  FOR ALL ENTRIES IN it_stoview
*               WHERE PRDLN+0(8) = it_stoview-prodh3.


  CLEAR sto_index .
  SORT it_mara BY matnr.
  LOOP AT it_stoview.
    sto_index = sy-tabix.
*    LOOP AT it_mara WHERE matnr = it_stoview-matnr.
*      it_stoview-bismt = it_mara-bismt.
*      it_stoview-prodh = it_mara-prdha.
*      it_stoview-mtart = it_mara-mtart.
*      it_stoview-mstav = it_mara-mstav. " material status
*    ENDLOOP.
    READ TABLE it_mara WITH KEY matnr = it_stoview-matnr.
    IF sy-subrc = 0.
      it_stoview-bismt = it_mara-bismt.
      it_stoview-prodh = it_mara-prdha.
      it_stoview-mtart = it_mara-mtart.
      it_stoview-mstav = it_mara-mstav. " material status
* chris 20120504
      it_stoview-blatt = it_mara-blatt. " GIP code

    ENDIF.
*set product hierarchy - level2 product group
    it_stoview-prodh2 = it_stoview-prodh+5(5).
    REPLACE '-' WITH space INTO it_stoview-prodh2.
*set product hierarchy - level3 product line
    it_stoview-prodh3 = it_stoview-prodh+10(8).
* chris 20120504
    CLEAR ztpp_45.
    SELECT SINGLE * FROM ztpp_45
    WHERE prdln = it_stoview-prodh3.
    IF sy-subrc = 0.
      it_stoview-eaipd = ztpp_45-eaipd.
      it_stoview-eaipg = ztpp_45-eaipg.
    ENDIF.

    MODIFY it_stoview INDEX sto_index
   TRANSPORTING prodh prodh2 prodh3
                bismt mtart mstav eaipd eaipg.

  ENDLOOP.

* selction criteria condition: product group
*            product line,s_prodh2 s_prodh3 .
  IF s_prodh2 IS INITIAL AND s_prodh3 IS INITIAL.
  ELSE.
    DELETE it_stoview
    WHERE  NOT ( prodh2  IN s_prodh2
             AND prodh3 IN s_prodh3 ).
  ENDIF.
* chris 20120504
  IF s_blatt IS NOT INITIAL .
    DELETE it_soview
    WHERE  NOT blatt IN s_blatt.
  ENDIF.

  IF s_eaipd IS INITIAL AND s_eaipg IS INITIAL.
  ELSE.

    DELETE it_soview
    WHERE  NOT ( eaipd  IN s_eaipd
             AND eaipg  IN s_eaipg ).

  ENDIF.

  DESCRIBE TABLE it_stoview LINES sto_line.
  IF sto_line = 0.
    IF p_type1 IS INITIAL.
      MESSAGE i208 WITH TEXT-m06.
*    SUBMIT zrsd0028v VIA SELECTION-SCREEN.
      LEAVE TO TRANSACTION sy-tcode.
    ELSE.
      EXIT.
    ENDIF.
  ENDIF.



* check storage bin, Valuated stock with unrestricted use


*  IF
**    s_matnr[] IS INITIAL AND
*     s_reswk[] IS INITIAL AND
*     s_lgort[]  IS INITIAL AND
*     s_lgpbe[] IS INITIAL .
*    " do nothing.
*  ELSE.
** check storage bin, Valuated stock with unrestricted use
*    REFRESH it_mard.
*    SELECT * FROM mard
*    APPENDING CORRESPONDING FIELDS OF TABLE it_mard
*    FOR ALL ENTRIES IN it_stoview
*         WHERE matnr = it_stoview-matnr
**    WHERE matnr IN s_matnr
*      AND werks IN s_reswk     "supply plant
*      AND lgort  IN s_lgort
*      AND lgpbe IN s_lgpbe.
*
*  ENDIF.

  LOOP AT it_stoview.
    sto_index = sy-tabix.


*    IF
**    s_matnr[] IS INITIAL AND
*    s_reswk[] IS INITIAL AND
*    s_lgort[] IS INITIAL AND
*    s_lgpbe[] IS INITIAL .

*      SELECT SINGLE  * FROM mard
*       INTO CORRESPONDING FIELDS OF wa_mard
*       WHERE matnr = it_stoview-matnr
*         AND werks =  it_stoview-reswk
*         AND lgort =   it_stoview-lgort.
*
*      IF sy-subrc = 0.
*        it_stoview-lgpbe = wa_mard-lgpbe.
*        it_stoview-labst = wa_mard-labst.
*
*      ELSE.
    CLEAR: wa_mard, ztsd_30.
    SELECT SINGLE * FROM ztsd_30
     WHERE mtart =  it_stoview-mtart
    AND  werks =  it_stoview-reswk.   "supply  plant

    IF sy-subrc = 0.
      SELECT SINGLE * FROM mard
      INTO CORRESPONDING FIELDS OF wa_mard
      WHERE matnr = it_stoview-matnr
      AND werks =   it_stoview-reswk   "supply plant
      AND lgort =   ztsd_30-lgort.
*          AND lgpbe IN  s_lgpbe.
      IF sy-subrc = 0.
        it_stoview-lgpbe = wa_mard-lgpbe.
        it_stoview-labst = wa_mard-labst.
      ELSE.
        it_stoview-lgpbe = ''.
        it_stoview-labst = 0.
      ENDIF.
    ELSE.
      it_stoview-lgpbe = ''.
      it_stoview-labst = 0.
    ENDIF.
*      ENDIF.


*    ELSE.
*
*      LOOP AT it_mard
*        WHERE matnr = it_stoview-matnr
*        AND werks =   it_stoview-reswk     "supply plant
*        AND lgort =   it_stoview-lgort.
*        IF sy-subrc = 0.
*          it_stoview-lgpbe = it_mard-lgpbe.
*          it_stoview-labst = it_mard-labst.
*        ELSE.
*          CLEAR: wa_mard, ztsd_30.
*          SELECT SINGLE * FROM ztsd_30
*           WHERE mtart = it_stoview-mtart
*            AND  werks =  it_stoview-reswk.   "supply plant
*
*          IF sy-subrc = 0.
*            SELECT SINGLE * FROM mard
*            INTO CORRESPONDING FIELDS OF wa_mard
*            WHERE matnr = it_stoview-matnr
*            AND werks =   it_stoview-reswk   "suply plant
*            AND lgort =   ztsd_30-lgort
*            AND lgpbe IN  s_lgpbe.
*            IF sy-subrc = 0.
*              it_stoview-lgpbe = wa_mard-lgpbe.
*              it_stoview-labst = wa_mard-labst.
*            ELSE.
*              it_stoview-lgpbe = ''.
*              it_stoview-labst = 0.
*            ENDIF.
*          ENDIF.
*        ENDIF.

*      ENDLOOP.
    MODIFY it_stoview INDEX sto_index
            TRANSPORTING lgpbe labst.
*    ENDIF.
  ENDLOOP.

* selction criteria condition: Storage bin
  IF NOT s_lgpbe IS INITIAL.
    DELETE it_stoview WHERE NOT  lgpbe  IN s_lgpbe .
  ENDIF.

  DESCRIBE TABLE it_stoview LINES sto_line.
  IF sto_line = 0.
    IF p_type1 IS INITIAL.

      MESSAGE i208 WITH TEXT-m06.
*    SUBMIT zrsd0028v VIA SELECTION-SCREEN.
      LEAVE TO TRANSACTION sy-tcode.
    ELSE.
      EXIT.

    ENDIF.
  ENDIF.


******************************************************
*******for cost currency key*
******* cost of item
*****************************************************
  RANGES: s_sto_bukrs FOR ekko-bukrs.
  RANGES: s_sto_werks FOR ekpo-werks.

  DATA: BEGIN OF itab_t001 OCCURS 0,
          bukrs LIKE t001-bukrs,  " Company Code
          waers LIKE t001-waers,  " Currency Key
          spras LIKE t001-spras,   " Language Key
        END OF itab_t001 .

  DATA: BEGIN OF itab_mbew OCCURS 0,
          matnr LIKE mbew-matnr, " Material Number
          bwkey LIKE mbew-bwkey, " Valuation area
          stprs LIKE mbew-stprs, " Standard Price
          peinh LIKE mbew-peinh, " Price Unit
        END OF itab_mbew .
  DATA: g_factor TYPE p DECIMALS 3.
  DATA: i_zgetcost LIKE zgetcost2.

  LOOP AT it_stoview.
    give_range_value it_stoview-bukrs  s_sto_bukrs.
*    give_range_value it_stoview-matnr  s_mara_matnr.
    give_range_value it_stoview-werks  s_sto_werks.

  ENDLOOP.

*  SORT s_mara_matnr BY sign option low high.
  SORT s_sto_werks BY sign option low high.
  SORT s_sto_bukrs BY sign option low high.


*  DELETE ADJACENT DUPLICATES FROM   s_mara_matnr
*  COMPARING ALL FIELDS .
  DELETE ADJACENT DUPLICATES FROM   s_sto_werks
  COMPARING ALL FIELDS .
  DELETE ADJACENT DUPLICATES FROM   s_sto_bukrs
  COMPARING ALL FIELDS .


  SELECT * FROM t001
  INTO CORRESPONDING FIELDS OF TABLE itab_t001
  WHERE bukrs IN s_sto_bukrs.


  REFRESH itab_mbew.
*  SELECT * FROM mbew
*  INTO CORRESPONDING FIELDS OF TABLE itab_mbew
*  WHERE matnr IN  s_mara_matnr
*  AND bwkey   IN  s_sto_werks.

*  20170329 replace cost
*  SELECT * FROM mbew
* INTO CORRESPONDING FIELDS OF TABLE itab_mbew
* FOR ALL ENTRIES IN it_stoview
* WHERE matnr = it_stoview-matnr
* AND   bwkey = it_stoview-reswk.


  SORT itab_mbew BY matnr bwkey.
  LOOP AT it_stoview.
    sto_index = sy-tabix .
    SELECT SINGLE land1 INTO t001w-land1 FROM t001w
    WHERE werks = it_stoview-reswk.
    SELECT SINGLE waers FROM t001 INTO t001-waers
    WHERE land1 = t001w-land1.
    IF sy-subrc = 0.
      it_stoview-stwaers = t001-waers.
    ENDIF.
*   20170329 replace cost
    CALL FUNCTION 'Z_GET_TARGET_COST'
      EXPORTING
        pi_werks         = it_stoview-werks
        pi_matnr         = it_stoview-matnr
        pi_convert       = ''
        pi_price_convert = ''
      IMPORTING
        pe_zgetcost      = i_zgetcost
      EXCEPTIONS
        no_found         = 1
        OTHERS           = 2.

    it_stoview-stprs   = i_zgetcost-stprs.
    it_stoview-stpeinh = i_zgetcost-peinh.
    it_stoview-stprs  =  it_stoview-stprs / it_stoview-stpeinh.
*    READ TABLE itab_mbew WITH KEY matnr = it_stoview-matnr
*                                  bwkey = it_stoview-reswk.
*    IF sy-subrc = 0.
*      it_stoview-stprs   = itab_mbew-stprs .
*      it_stoview-stpeinh =  itab_mbew-peinh.
*
*      it_stoview-stprs  =  it_stoview-stprs / it_stoview-stpeinh.
*
*    ENDIF.
*    document date to i1 field.
    it_stoview-audat = it_stoview-bedat.
    MODIFY it_stoview INDEX sto_index
      TRANSPORTING stwaers stprs stpeinh audat.

  ENDLOOP.





ENDFORM.                    " get_STO_order_data
*&---------------------------------------------------------------------*
*&      Form  get_curr_factor
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_IT_SOVIEW_STWAERS  text
*      -->P_G_FACTOR  text
*----------------------------------------------------------------------*
FORM get_curr_factor  USING    p_view_stwaers
                               p_g_factor.

  CLEAR p_g_factor.

  CALL FUNCTION 'CURRENCY_CONVERTING_FACTOR'
    EXPORTING
      currency = p_view_stwaers
    IMPORTING
      factor   = p_g_factor.

  IF sy-subrc <> 0.
    p_g_factor = 1.
  ENDIF.

ENDFORM.                    " get_curr_factor


*---------------------------------------------------------------------*
*       FORM USER_COMMAND                                             *
*---------------------------------------------------------------------*
FORM user_command USING r_ucomm LIKE sy-ucomm
                  rs_selfield TYPE slis_selfield.
*  DATA: L_TA TYPE SY-TCODE VALUE 'SLIS_DUMMY'.
*  DATA: L_TA TYPE SY-TCODE VALUE 'SLIS_DUMMY'.
*
*
  CASE r_ucomm.
*    WHEN  'WAHL'.                      "menubutton
*      READ TABLE GT_OUTTAB INDEX RS_SELFIELD-TABINDEX. "cursorposit.
*      IF SY-SUBRC = 0.
*        SUBMIT SLIS_DUMMY WITH P_CARRID EQ GT_OUTTAB-CARRID
*                          WITH P_CONNID EQ GT_OUTTAB-CONNID.
*      ENDIF.
*      CLEAR R_UCOMM.
    WHEN '&IC1'.                       "doubleclick
      READ TABLE a1 INTO a1 INDEX rs_selfield-tabindex.
      IF sy-subrc = 0.

        IF  a1-sosto IS INITIAL.   "STO
*        IF  A1-OTYPE IS INITIAL.   "STO
          CALL FUNCTION 'MEPO_CALL'
            EXPORTING
              im_ebeln                 = a1-vbeln
              im_ebelp                 = a1-ebelp
              im_trtyp                 = 'A'
*             IM_DATABLADE             =
            EXCEPTIONS
              invalid_transaction_type = 1
              invalid_call             = 2
              no_authority             = 3
              OTHERS                   = 4.
          IF sy-subrc <> 0.
            MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                    WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
          ENDIF.


        ELSE.


          CALL FUNCTION 'SD_SALESDOCUMENT_DISPLAY'
            EXPORTING
              i_vbeln = a1-vbeln
*             I_POSNR =
*             I_VBTYP =
*       EXCEPTIONS
*             NO_AUTHORITY       = 1
*             OTHERS  = 2
            .
          IF sy-subrc <> 0.
            MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                    WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
          ENDIF.
        ENDIF.
      ENDIF.

      CLEAR r_ucomm.
  ENDCASE.
ENDFORM.                    "USER_COMMAND
*&---------------------------------------------------------------------*
*&      Form  event_init
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_G_EVENTS[]  text
*----------------------------------------------------------------------*
FORM event_init  USING    rt_events TYPE slis_t_event.

  DATA: ls_event TYPE slis_alv_event.

  CALL FUNCTION 'REUSE_ALV_EVENTS_GET'
    EXPORTING
      i_list_type = 0
    IMPORTING
      et_events   = rt_events.

  READ TABLE rt_events WITH KEY name = slis_ev_top_of_page
                           INTO ls_event.
  IF sy-subrc = 0.
*    MOVE 'TOP_OF_PAGE' TO ls_event-form.
    MOVE 'WRITE_TITLE' TO ls_event-form.


    MODIFY rt_events FROM ls_event INDEX sy-tabix.
  ENDIF.
ENDFORM.                    " event_init
*&---------------------------------------------------------------------*
*&      Form  get_shipping_desc
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_IT_VSBED  text
*----------------------------------------------------------------------*
FORM get_shipping_desc  TABLES   t_vsbed. "STRUCTURE
* <isa_shipping_cond>.  "Insert correct name for <...>.


  SELECT vsbed vtext
  FROM tvsbt
  INTO CORRESPONDING FIELDS OF TABLE t_vsbed
  WHERE spras = 'EN'.

ENDFORM.                    " get_shipping_desc
*&---------------------------------------------------------------------*
*&      Form  search_incoterm
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM search_so_incoterm .
  DATA: BEGIN OF it_vbkd OCCURS 0,
          vbeln   LIKE vbkd-vbeln, " Sales and D Document Number
          posnr   LIKE vbkd-posnr, " Item number of the SD document
          bzirk   LIKE vbkd-bzirk, " Sales district
          inco1   LIKE vbkd-inco1, " Incoterms (part 1)
          inco2   LIKE vbkd-inco2, " Incoterms (part 2)
          zterm   LIKE vbkd-zterm, " Terms of payment key
          sdabw   LIKE vbkd-sdabw, "Special processing indicator
          bstkd   LIKE vbkd-bstkd, " Item PO number  2081215
          bstkd_e LIKE vbkd-bstkd_e,                        "20090819
          ihrez_e LIKE vbkd-ihrez_e,                        "20090819
          abtnr   LIKE vbkd-abtnr,                          "20250815
        END OF it_vbkd .

  DATA: inco_index TYPE i.
  RANGES: ss_vbeln FOR vbkd-vbeln.
  DATA: s_line TYPE i.

*  LOOP AT it_soview.
*    give_range_value it_soview-vbeln ss_vbeln.
*  ENDLOOP.
*
*  SORT ss_vbeln BY sign option low high.
*  DELETE ADJACENT DUPLICATES FROM  ss_vbeln
*  COMPARING ALL FIELDS .

  IF it_soview[] IS NOT INITIAL.
    SELECT * FROM vbkd
    INTO CORRESPONDING FIELDS OF TABLE it_vbkd
    FOR ALL ENTRIES IN it_soview
    WHERE vbeln = it_soview-vbeln.
    SORT it_vbkd BY vbeln posnr.
    LOOP AT it_soview.
      inco_index = sy-tabix.
*      CLEAR it_vbkd.
*      LOOP AT it_vbkd WHERE  vbeln =  it_soview-vbeln
*                         AND  posnr = it_soview-posnr.
*        it_soview-bzirk = it_vbkd-bzirk. " Sales district
*        it_soview-inco1 = it_vbkd-inco1. " Incoterms (part 1)
*        it_soview-inco2 = it_vbkd-inco2. " Incoterms (part 2)
*        it_soview-zterm = it_vbkd-zterm. " Terms of payment key
*        it_soview-sdabw = it_vbkd-sdabw.
*
*      ENDLOOP.
      CLEAR it_vbkd.
      READ TABLE it_vbkd WITH KEY vbeln = it_soview-vbeln
                                  posnr = it_soview-posnr.
      IF sy-subrc = 0.
        it_soview-bzirk = it_vbkd-bzirk. " Sales district
        it_soview-inco1 = it_vbkd-inco1. " Incoterms (part 1)
        it_soview-inco2 = it_vbkd-inco2. " Incoterms (part 2)
        it_soview-zterm = it_vbkd-zterm. " Terms of payment key
        it_soview-sdabw = it_vbkd-sdabw.
        it_soview-bstkd = it_vbkd-bstkd.                    "20081215
        it_soview-bstkd_e = it_vbkd-bstkd_e.                "20090819
        it_soview-ihrez_e = it_vbkd-ihrez_e.                "20090819
        it_soview-abtnr   = it_vbkd-abtnr.                  "20250815
      ELSE.
        CLEAR it_vbkd.
        READ TABLE it_vbkd WITH KEY vbeln = it_soview-vbeln
                                    posnr = ''.
        it_soview-bzirk = it_vbkd-bzirk. " Sales district
        it_soview-inco1 = it_vbkd-inco1. " Incoterms (part 1)
        it_soview-inco2 = it_vbkd-inco2. " Incoterms (part 2)
        it_soview-zterm = it_vbkd-zterm. " Terms of payment key
        it_soview-sdabw = it_vbkd-sdabw.
        it_soview-bstkd = it_vbkd-bstkd.                    "20081215
        it_soview-bstkd_e = it_vbkd-bstkd_e.                "20090819
        it_soview-ihrez_e = it_vbkd-ihrez_e.                "20090819
        it_soview-abtnr   = it_vbkd-abtnr.                  "20250815

      ENDIF.

      MODIFY it_soview INDEX inco_index
         TRANSPORTING bzirk inco1  inco2 zterm sdabw bstkd bstkd_e
         ihrez_e abtnr.
      "20081215 add bstkd
      "20090819 add bstkd_e ihrez_e.

    ENDLOOP.
  ENDIF.
*  ELSE.
*
*    LOOP AT it_soview.
*      SELECT * FROM vbkd
*      INTO corresponding fields of wa_vbkd
*      WHERE vbeln = it_soview-vbeln
*      AND   posnr = it_soview-posnr.
*
*        IF sy-subrc <> 0.
*          READ TABLE it_vbkd  WITH KEY vbeln = it_soview-vbeln.
*          it_soview-bzirk = wa_vbkd-bzirk. " Sales district
*          it_soview-inco1 = wa_vbkd-inco1. " Incoterms (part 1)
*          it_soview-inco2 = wa_vbkd-inco2. " Incoterms (part 2)
*          it_soview-zterm = wa_vbkd-zterm. " Terms of payment key
*          it_soview-sdabw = wa_vbkd-sdabw.
*        ENDIF.
*
*        MODIFY it_soview INDEX inco_index
*            TRANSPORTING bzirk inco1  inco2 zterm sdabw.
*
*      ENDLOOP.
*    ENDIF.
*

ENDFORM.                    " search_incoterm
*&---------------------------------------------------------------------*
*&      Form  select_so_all
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM select_so_all USING p_not_found.

  DATA:l_mail LIKE pa0105-usrid_long.
  DATA:l_smtp_addr2 LIKE zuser01-smtp_addr2.
*  check confirm date
*  confirm date against un-confirm dn status.
  DATA: z_fksaa TYPE vbup-fksaa.
  CLEAR itab_vbak.
  REFRESH itab_vbak.

  PERFORM upload_from_server.

*  the first order date  so 
*  so  /usr/sap/trans/interface/SD/out/exceptso.txt
*  EAI 
*20230412
  SELECT vbeln INTO r_soso-low FROM vbbe WHERE auart IN ('ZKB','KB','KE').
    r_soso-sign = 'I'.
    r_soso-option = 'EQ'.
    APPEND r_soso.
    CLEAR  r_soso.
  ENDSELECT.

  IF should1 >= 'X'.

    SELECT vbeln vkorg vtweg spart
      INTO CORRESPONDING FIELDS OF TABLE itab_vbak
             FROM vbak
             WHERE audat  < p_1st     "  1
               AND vbeln IN r_soso    "  2
               AND vbeln IN s_vbeln
               AND vkorg IN s_org
               AND vtweg IN s_vtweg   " add by rong 20201218
               AND spart IN s_spart   " add by rong 20201218
               AND auart <> 'QT'      " order type
               AND auart IN s_auart   " order type
               AND ernam IN s_ernam   " user id
               AND kunnr IN s_kunag   " sold to party
               AND vkbur IN s_vkbur   " sales office
               AND vkgrp IN s_vkgrp   " sales group
               AND bstnk IN s_bstnk   " PO number
               AND lifsk IN s_lifsk   " Delivery block (header) VBAK~
    AND vsbed IN s_vsbed.  " Shipping condition
  ENDIF.

*  the first order date  so 
  SELECT vbeln vkorg vtweg spart
     APPENDING CORRESPONDING FIELDS OF TABLE itab_vbak
               FROM vbak
               WHERE audat >= p_1st     " add by Ted.Tsao 2008/11/27
                 AND vbeln IN s_vbeln
                 AND vkorg IN s_org
                 AND vtweg IN s_vtweg   " add by rong 20201218
                 AND spart IN s_spart   " add by rong 20201218
                 AND auart <> 'QT'      " order type
                 AND auart IN s_auart   " order type
                 AND ernam IN s_ernam   " user id
                 AND kunnr IN s_kunag   " sold to party
                 AND vkbur IN s_vkbur   " sales office
                 AND vkgrp IN s_vkgrp   " sales group
                 AND bstnk IN s_bstnk   " PO number
                 AND lifsk IN s_lifsk   " Delivery block (header) VBAK~
  AND vsbed IN s_vsbed.  " Shipping condition

  IF it_vbpa[] IS INITIAL.
    IF itab_vbak[] IS NOT INITIAL.
      REFRESH datetmp.
      IF p_rado2 = 'X'.      " un_confirm  request date
        datetmp = s_datu .
      ELSE.                  "  confirmed date
        datetmp = s_edatu.
      ENDIF.                 "  dateTmp ,,

      SELECT *
             FROM zsoview AS s
                 INTO CORRESPONDING FIELDS OF TABLE  it_soview
                 FOR ALL ENTRIES IN itab_vbak
                   WHERE s~vbeln = itab_vbak-vbeln
                    AND s~posnr IN s_posnr   " Sales order item
                AND s~vkorg IN s_org     " sales org          VBAK~VKORG
                AND s~bstnk IN s_bstnk   " PO number          VBAK~BSTNK
                AND s~auart IN s_auart   " order type         VBAK~AUART
                AND s~pstyv IN s_pstyv   " item category,     VBAP~PSTYV
                AND s~uepos IN s_uepos   "Higher-lev.item
                AND s~ernam IN s_ernam   " user id,           VBAK~ERNAM
                AND s~kunnr IN s_kunag   " sold to party      VBAK~KUNNR
                AND s~vsbed IN s_vsbed   "Shipping condition  VBAK~VSBED
                AND s~vkbur IN s_vkbur   "sales office        VBAK~VKBUR
                AND s~vkgrp IN s_vkgrp   "sales group         VBAK~VKGRP
                AND s~werks IN s_werks   "plant               VBAP~WERKS
                AND s~werks IN so_werks
                "delivery plant      VBAP~WERKS chris20121030
                AND s~lgort IN s_lgort   "storage location    VBAP~LGORT
                AND s~matnr IN s_matnr   "material            VBAP~MATNR
                AND s~cmgst IN s_cmgst   "So credit block     VBUK~CMGST
                AND s~route IN s_route   " route              VBAP~ROUTE
                AND s~erdat IN s_cdat    "create date         VBAP~ERDAT
                 AND s~lifsk IN s_lifsk   "Delivery block (header) VBAK~
                AND EXISTS ( SELECT *  FROM marc
                              WHERE  matnr =  s~matnr
                              AND    werks =  s~werks
                              AND    ladgr IN s_ladgr
*                        vivian add from 20050623
                              AND  sobsl IN  s_sobsl )
                 AND EXISTS (  SELECT  * FROM vbpa   ""20250605 rong check bill to party
                             WHERE vbeln = s~vbeln
                                AND kunnr   IN s_billto
                                AND parvw   = 'RE') "20250605 rong end
                AND EXISTS (  SELECT  * FROM vbpa
                             WHERE vbeln = s~vbeln
                                AND kunnr   IN s_kunnr
                                AND pernr   IN s_pernr
**                        Add  By Hermit 2005/11/03 FOR EU request
                                AND pernr   IN s_pernr1
      AND parvw   IN s_parvw ).
    ENDIF.
*    "rong 20250605 check bill to party
*    IF NOT s_billto[] IS INITIAL.
*      LOOP AT it_soview.
*        SELECT SINGLE * FROm vbpa WHERE vbeln = it_soview-vbeln AND parvw = 'RE' AND kunnr IN s_billto.
*        IF sy-subrc <> 0 .
*          DELETE it_soview.
*        ENDIF.
*      ENDLOOP.
*    ENDIF.
*    "20250605 end

** 20181227 exclude TAD
    LOOP AT it_soview WHERE pstyv = 'TAD' .
      CLEAR z_fksaa.
      SELECT SINGLE fksaa INTO z_fksaa FROM v_vbup_cds
      WHERE vbeln = it_soview-vbeln
      AND posnr = it_soview-posnr.
      IF z_fksaa = 'C'.
        DELETE it_soview.
      ENDIF.
    ENDLOOP.

    IF s_org-low = 'CN10' AND sy-uname(6) = 'ACN.IS' AND sy-uname <> 'ACN.IS1' . "Double add on  20250707 for  gu.li,IS1 is power user"20251119
      LOOP AT it_soview. "KEYIN
        CLEAR:l_mail.
        SELECT SINGLE usrid_long INTO l_mail FROM pa0105
         WHERE pernr IN ( SELECT pernr FROM vbpa
        WHERE vbeln =  it_soview-vbeln
        AND parvw = 'ZR').

        TRANSLATE l_mail TO UPPER CASE.

        CLEAR:l_smtp_addr2.
        SELECT SINGLE  smtp_addr2 INTO l_smtp_addr2 FROM zuser01
          WHERE bname = sy-uname AND smtp_addr2 = l_mail.
        IF sy-subrc <> 0 .
          IF l_mail NS '.COM.CN'.
            CONCATENATE l_mail  '.CN' INTO l_mail.
            SELECT SINGLE  smtp_addr2 INTO l_smtp_addr2 FROM zuser01
             WHERE bname = sy-uname AND smtp_addr2 = l_mail.
          ENDIF.
          IF sy-subrc <> 0 .  "20251023 FOR PA30 NOT INCLUCE .CN
            DELETE it_soview.
          ENDIF.
        ENDIF.
      ENDLOOP.
    ENDIF.




*    :  unconfirmed ,  bmeng <> 0, ,
*          confirm ,
*         : client 236, SO 1000851, Line 300

    IF it_soview[] IS NOT INITIAL.
      REFRESH tvbep.
      j3 = 0.
      IF NOT s_edatu IS INITIAL AND p_rado3  = 'X' OR
                                    p_rado1  = 'X'.
*           confirmed date  "ALL" 
*                  confirmed 
*           confirm , bmeng <> 0 
        SELECT vbeln posnr bmeng FROM vbep
              INTO TABLE  tvbep
              FOR ALL ENTRIES IN it_soview
                  WHERE vbep~vbeln = it_soview-vbeln
                    AND vbep~posnr = it_soview-posnr
                    AND edatu IN s_edatu
        AND vbep~bmeng  <> 0.
        j3 = 1.
      ENDIF.

      IF NOT s_datu IS INITIAL AND p_rado2 = 'X'.
*           request date  "unconfirmed" 
*          ,confirm 
        SELECT vbeln posnr bmeng FROM vbep
              INTO TABLE  tvbep
              FOR ALL ENTRIES IN it_soview
                  WHERE vbep~vbeln = it_soview-vbeln
                    AND vbep~posnr = it_soview-posnr
        AND vbep~edatu IN s_datu.
        j3 = 2.
      ENDIF.

      IF j3 > 0.
        SORT tvbep BY vbeln posnr.

        index1 = 1.
        READ TABLE tvbep       INDEX index1.
        IF sy-subrc <> 0.
          eof1 = 'True'.
        ELSE.
          eof1 = 'False'.
        ENDIF.

        SORT it_soview BY vbeln posnr.
        LOOP AT it_soview.
          first_rec = sy-tabix .
*             AT new, it_soview-matnr*******,
*             end at 

          WHILE eof1 = 'False' AND
             (  tvbep-vbeln < it_soview-vbeln   OR
                tvbep-vbeln = it_soview-vbeln        AND
                tvbep-posnr < it_soview-posnr               ) .
            index1 = index1 + 1.
            READ TABLE tvbep   INDEX index1.
            IF sy-subrc <> 0.
              eof1 = 'True'.
            ENDIF.
          ENDWHILE.

          IF it_soview-vbeln < tvbep-vbeln OR
             it_soview-posnr < tvbep-posnr OR
             eof1 = 'True'.    " , EOF
            DELETE it_soview. "
            CONTINUE.         "
          ENDIF.
        ENDLOOP.

      ENDIF.  " IF NOT s_edatu IS INITIAL.   "for confirmed date
    ENDIF.  " IF it_soview[] IS not INITIAL.
  ELSE.
*           it_vbpa[]  INITIAL 
*           logic,  run , 2009/11/17 , by Ted Tsao
    j1 = 0.
    j2 = 3.
    j3 = j2 / j1.  "   0, ,  run 
  ENDIF.

  p_not_found = sy-subrc.
  IF it_soview[] IS INITIAL.  " add by Ted, 2008/12/05
    p_not_found = 4.
  ELSE.
    p_not_found = 0.
  ENDIF.

*  IF sy-subrc <> 0.
*    MESSAGE s208 WITH text-m02.
**    SUBMIT sy-repid VIA SELECTION-SCREEN.
*    SUBMIT zrsd0028v VIA SELECTION-SCREEN.
*
*  ENDIF.

ENDFORM.                    " select_so_all

*********************************
* Add by Hermit
*Get STO unconfirm Items
*Get unconfirm item date
*********************************
FORM select_sto_unconfirm  USING    p_not_found.

  SELECT *
   FROM zstoview AS v
   INTO CORRESPONDING FIELDS OF TABLE it_stoview
   WHERE ( v~ebeln IN s_ebeln AND
         v~ebeln IN s_ebelnn )
*      AND a~bstyp = 'F' "Purchasing document category
*      AND a~loekz = space    "deletion indicator
* mark by Hermit 2006/06/09
**     AND V~VKORG =  P_VKORG     "sales org
     AND v~bsart IN s_bsart
     AND v~ernam IN s_ernam    "user id
     AND v~reswk IN s_reswk    "supply plant
     AND v~werks IN s_werks    "plant
     AND v~lgort IN s_lgort    "storage location
     AND v~matnr IN s_matnr    "material
*      AND b~loekz =  space       "deletion indicator
     AND v~route IN s_route    "route
     AND v~vsbed IN s_vsbed    "Shipping condition
     AND ( v~kunnr IN s_kunnr   "ship to party
     AND  v~kunnr IN s_kunag )   " sold to party.
     AND v~zz_kunnr IN s_zkunnr
     AND v~aedat IN s_cdat  "create date
     AND v~reslo IN s_reslo
     AND v~elikz = ''           " 2012/06/19 Ethan add
     AND v~ekgrp IN s_ekgrp
*change request2 hans 0527 "Material availability date
     AND EXISTS ( SELECT *  FROM eket
                     WHERE  ebeln =  v~ebeln
                     AND    ebelp =  v~ebelp
                     AND    mbdat IN s_mbdat
  AND    eindt IN s_datu ).



  p_not_found = sy-subrc.
  IF it_stoview[] IS INITIAL.  " add by Ted, 2008/12/05
    p_not_found = 4.
  ELSE.
    p_not_found = 0.
  ENDIF.

*  IF sy-subrc <> 0.
*    MESSAGE i208 WITH text-m02.
**    SUBMIT sy-repid VIA SELECTION-SCREEN.
*    SUBMIT zrsd0028v VIA SELECTION-SCREEN.
*
*  ENDIF.

ENDFORM.                    " select_sto_unconfirml
****End of Add By Hermit


*&---------------------------------------------------------------------*
*&      Form  select_sto_all
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_W_NOT_FOUND  text
*----------------------------------------------------------------------*
FORM select_sto_all  USING    p_not_found.

  IF  s_edatu IS INITIAL.
    SELECT *
     FROM zstoview AS v
     INTO CORRESPONDING FIELDS OF TABLE it_stoview
     WHERE ( v~ebeln IN s_ebeln AND
           v~ebeln IN s_ebelnn )
*      AND a~bstyp = 'F' "Purchasing document category
*      AND a~loekz = space    "deletion indicator
** Mark by Hermit 2006/06/09
**       AND V~VKORG =  P_VKORG     "sales org
       AND v~bsart IN s_bsart
       AND v~ernam IN s_ernam    "user id
       AND v~reswk IN s_reswk    "supply plant
       AND v~werks IN s_werks    "plant
       AND v~lgort IN s_lgort    "storage location
       AND v~matnr IN s_matnr    "material
*      AND b~loekz =  space       "deletion indicator
       AND v~route IN s_route    "route
       AND v~vsbed IN s_vsbed    "Shipping condition
       AND ( v~kunnr IN s_kunnr   "ship to party
       AND  v~kunnr IN s_kunag )   " sold to party.
       AND v~zz_kunnr IN s_zkunnr
       AND v~aedat IN s_cdat "create date
       AND v~reslo IN s_reslo
       AND v~elikz = ''           " 2012/06/19 Ethan add
       AND v~ekgrp IN s_ekgrp
*change request2 hans 0527 "Material availability date
       AND EXISTS ( SELECT *  FROM eket
                       WHERE  ebeln =  v~ebeln
                       AND    ebelp =  v~ebelp
                       AND    mbdat IN s_mbdat
    AND eindt IN s_datu ).


  ELSE.

    SELECT *
        FROM zstoview AS v
        INTO CORRESPONDING FIELDS OF TABLE it_stoview
        WHERE ( v~ebeln IN s_ebeln OR
              v~ebeln IN s_ebelnn )
** mark org by Hermit 2006/06/09
*          AND V~VKORG =  P_VKORG     "sales org
          AND v~bsart IN s_bsart
          AND v~ernam IN s_ernam    "user id
          AND v~reswk IN s_reswk    "supply plant
          AND v~werks IN s_werks    "plant
          AND v~lgort IN s_lgort    "storage location
          AND v~matnr IN s_matnr    "material
          AND v~route IN s_route    "route
          AND v~vsbed IN s_vsbed    "Shipping condition
          AND ( v~kunnr IN s_kunnr    "ship to party
           AND  v~kunnr IN s_kunag )   " sold to party.
           AND v~zz_kunnr IN s_zkunnr
           AND v~aedat IN s_cdat "create date
           AND v~reslo IN s_reslo
           AND v~elikz = ''           " 2012/06/19 Ethan add
           AND v~ekgrp IN s_ekgrp
          AND EXISTS ( SELECT *  FROM eket   " Confirmed date
                       WHERE  ebeln =  v~ebeln
                       AND    ebelp =  v~ebelp
                       AND    dat01 IN s_edatu
                       AND    mbdat IN s_mbdat
    AND eindt IN s_datu ).

  ENDIF.

  p_not_found = sy-subrc.
  IF it_stoview[] IS INITIAL.  " add by Ted, 2008/12/05
    p_not_found = 4.
  ELSE.
    p_not_found = 0.
  ENDIF.

*  IF sy-subrc <> 0.
*    MESSAGE i208 WITH text-m02.
**    SUBMIT sy-repid VIA SELECTION-SCREEN.
*    SUBMIT zrsd0028v VIA SELECTION-SCREEN.
*
*  ENDIF.

ENDFORM.                    " select_sto_all

*&---------------------------------------------------------------------*
*&      Form  select_sto_confirm
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_W_NOT_FOUND  text
* Add Check Delv Date condition
* EINDT IN S_DATU   By Hermit 2005/07/13
*----------------------------------------------------------------------*
FORM select_sto_confirm  USING    p_not_found.
  IF  s_edatu IS INITIAL.
    SELECT *
     FROM zstoview AS v
     INTO CORRESPONDING FIELDS OF TABLE it_stoview
     WHERE ( v~ebeln IN s_ebeln AND
           v~ebeln IN s_ebelnn )
*      AND a~bstyp = 'F' "Purchasing document category
*      AND a~loekz = space    "deletion indicator
** mark org by Hermit 2006/06/09
*       AND V~VKORG =  P_VKORG     "sales org
       AND v~bsart IN s_bsart
       AND v~ernam IN s_ernam    "user id
       AND v~reswk IN s_reswk    "supply plant
       AND v~werks IN s_werks    "plant
       AND v~lgort IN s_lgort    "storage location
       AND v~matnr IN s_matnr    "material
*      AND b~loekz =  space       "deletion indicator
       AND v~route IN s_route    "route
       AND v~vsbed IN s_vsbed    "Shipping condition
       AND ( v~kunnr IN s_kunnr    "ship to party
       AND  v~kunnr IN s_kunag )  " sold to party.
       AND v~zz_kunnr IN s_zkunnr
       AND v~aedat IN s_cdat "create date
       AND v~reslo IN s_reslo
       AND v~elikz = ''           " 2012/06/19 Ethan add
       AND v~ekgrp IN s_ekgrp
       AND EXISTS ( SELECT *  FROM eket
                       WHERE  ebeln =  v~ebeln
                       AND    ebelp =  v~ebelp
                       AND    mbdat IN s_mbdat
    AND  eindt IN s_datu ).
  ELSE.

    SELECT *
        FROM zstoview AS v
        INTO CORRESPONDING FIELDS OF TABLE it_stoview
        WHERE ( v~ebeln IN s_ebeln OR
              v~ebeln IN s_ebelnn )
**Mark org by Hermit 2006/06/09
*          AND V~VKORG =  P_VKORG     "sales org
          AND v~bsart IN s_bsart
          AND v~ernam IN s_ernam    "user id
          AND v~reswk IN s_reswk    "supply plant
          AND v~werks IN s_werks    "plant
          AND v~lgort IN s_lgort    "storage location
          AND v~matnr IN s_matnr    "material
          AND v~route IN s_route    "route
          AND v~vsbed IN s_vsbed    "Shipping condition
          AND ( v~kunnr IN s_kunnr    "ship to party
          AND  v~kunnr IN s_kunag )   " sold to party.
          AND v~zz_kunnr IN s_zkunnr
          AND v~aedat IN s_cdat "create date
          AND v~reslo IN s_reslo
          AND v~elikz = ''           " 2012/06/19 Ethan add
          AND v~ekgrp IN s_ekgrp
          AND EXISTS ( SELECT *  FROM eket   " Confirmed date
                       WHERE  ebeln =  v~ebeln
                       AND    ebelp =  v~ebelp
                       AND    dat01 IN s_edatu
                       AND    mbdat IN s_mbdat
    AND  eindt IN s_datu ).

  ENDIF.

  p_not_found = sy-subrc.
  IF it_stoview[] IS INITIAL.  " add by Ted, 2008/12/05
    p_not_found = 4.
  ELSE.
    p_not_found = 0.
  ENDIF.


ENDFORM.                    " select_sto_confirm
*&---------------------------------------------------------------------*
*&      Form  so_mara_marc_mard_tvko
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM so_mara_marc_mard_tvko .
*****************************************************
****SO: assign company code *************************
*****************************************************

  DATA: BEGIN OF itab_tvko OCCURS 0,
          vkorg LIKE tvko-vkorg, " Sales Organization
          waers LIKE tvko-waers, " Statistics currency
          bukrs LIKE tvko-bukrs, " Company code of the sales organization
        END OF itab_tvko .

  SELECT * FROM tvko
  INTO CORRESPONDING FIELDS OF TABLE itab_tvko
*  WHERE VKORG = P_VKORG.
  WHERE vkorg = i1-vkorg.

** MARA. MARC, MARD
*  LOOP AT it_soview.
*    give_range_value it_soview-matnr s_mara_matnr.
*  ENDLOOP.
*
*  SORT s_mara_matnr BY sign option low high.
*  DELETE ADJACENT DUPLICATES FROM  s_mara_matnr
*  COMPARING ALL FIELDS .
*******************************************************
****Assign: Special procurement  **********************
***         delivery time        **********************
*******     Loading group        **********************
*******************************************************

  SELECT  * FROM marc
   INTO CORRESPONDING FIELDS OF TABLE it_marc
   FOR ALL ENTRIES IN it_soview
           WHERE  matnr = it_soview-matnr
  AND   werks  = it_soview-werks.
  SORT it_marc BY matnr werks.
  LOOP AT it_soview.
    so_index = sy-tabix.
*mark by johnson and change code 12/13/2006
*    LOOP AT it_marc WHERE matnr = it_soview-matnr
*                     AND  werks = it_soview-werks.
*      it_soview-sobsl = it_marc-sobsl. "Special procurement
*      it_soview-plifz = it_marc-plifz. "delivery time
*      it_soview-ladgr = it_marc-ladgr. "Loading group
*
*    ENDLOOP.
    READ TABLE it_marc WITH KEY matnr = it_soview-matnr
                                werks = it_soview-werks.
    IF sy-subrc = 0.
      it_soview-sobsl = it_marc-sobsl. "Special procurement
      it_soview-plifz = it_marc-plifz. "delivery time
      it_soview-ladgr = it_marc-ladgr. "Loading group
    ENDIF.
    LOOP AT itab_tvko WHERE  vkorg = it_soview-vkorg.
      it_soview-bukrs   = itab_tvko-bukrs.
    ENDLOOP.
*change by johnson and change code 12/13/2006
*set product hierarchy - level2 product group
    it_soview-prodh2 = it_soview-prodh+5(5).
    REPLACE '-' WITH space INTO it_soview-prodh2.
*set product hierarchy - level3 product line
    it_soview-prodh3 = it_soview-prodh+10(8).
*    give_range_value it_soview-werks  s_so_werks.

* chris 20120504
    CLEAR ztpp_45.
    SELECT SINGLE * FROM ztpp_45
    WHERE prdln = it_soview-prodh3.
    IF sy-subrc = 0.
      it_soview-eaipd = ztpp_45-eaipd.
      it_soview-eaipg = ztpp_45-eaipg.
    ENDIF.

    MODIFY it_soview INDEX so_index
      TRANSPORTING sobsl plifz  ladgr bukrs prodh2 prodh3
                   eaipd eaipg.

  ENDLOOP.



**MARD
*********************************************************
* Check: storage bin,
*        Valuated stock with unrestricted use
*        Old material number
*         Material Type
*         material status
*********************************************************


*  SELECT  * FROM mara
*  INTO CORRESPONDING FIELDS OF TABLE it_mara
*  WHERE matnr IN s_mara_matnr.
  SELECT  * FROM mara
    INTO CORRESPONDING FIELDS OF TABLE it_mara
    FOR ALL ENTRIES IN it_soview
  WHERE  matnr = it_soview-matnr.

  IF
*     s_matnr[] IS INITIAL AND
     s_werks[] IS INITIAL AND
     s_lgort[] IS INITIAL AND
     s_lgpbe[] IS INITIAL .
    "do nothing.
  ELSE.
*    SELECT * FROM mard
*    INTO CORRESPONDING FIELDS OF TABLE it_mard
*    WHERE matnr IN s_matnr
*      AND werks IN s_werks
*      AND lgort IN s_lgort
*      AND lgpbe IN s_lgpbe.
    SELECT * FROM mard
       INTO CORRESPONDING FIELDS OF TABLE it_mard
       FOR ALL ENTRIES IN it_soview
       WHERE  matnr = it_soview-matnr
         AND werks IN s_werks
         AND lgort IN s_lgort
    AND lgpbe IN s_lgpbe.

  ENDIF.

  SORT it_mara BY matnr.
  SORT it_mard BY matnr werks lgort.
  LOOP AT it_soview.
    so_index = sy-tabix.
*mark by johnson and change code 12/13/2006
*    LOOP AT it_mara WHERE matnr = it_soview-matnr.
*      it_soview-bismt = it_mara-bismt. "Old material number
*      it_soview-mtart = it_mara-mtart. " Material Type
*      it_soview-mstav = it_mara-mstav. " material status
*    ENDLOOP.
    READ TABLE it_mara WITH KEY matnr = it_soview-matnr.
    IF sy-subrc = 0.
      it_soview-bismt = it_mara-bismt. " Old material number
      it_soview-mtart = it_mara-mtart. " Material Type
      it_soview-mstav = it_mara-mstav. " material status
* chris 20120504
      it_soview-blatt = it_mara-blatt. " GIP code
    ENDIF.
    IF
*     s_matnr[] IS INITIAL AND
     s_werks[] IS INITIAL AND
     s_lgort[] IS INITIAL AND
     s_lgpbe[] IS INITIAL .

      SELECT SINGLE  * FROM mard
     INTO CORRESPONDING FIELDS OF wa_mard
     WHERE matnr = it_soview-matnr
       AND werks = it_soview-werks
      AND lgort = it_soview-lgort.
*       AND lgpbe IN s_lgpbe.

      IF sy-subrc = 0.
        it_soview-lgpbe = wa_mard-lgpbe.
        it_soview-labst = wa_mard-labst.

      ELSE.
        CLEAR: wa_mard, ztsd_30.
        SELECT SINGLE * FROM ztsd_30
         WHERE mtart =  it_soview-mtart
        AND  werks =  it_soview-werks.   " plant

        IF sy-subrc = 0.
          SELECT SINGLE * FROM mard
          INTO CORRESPONDING FIELDS OF wa_mard
          WHERE matnr = it_soview-matnr
          AND werks =   it_soview-werks   " plant
          AND lgort =   ztsd_30-lgort
          AND lgpbe IN  s_lgpbe.
          IF sy-subrc = 0.
            it_soview-lgpbe = wa_mard-lgpbe.
            it_soview-labst = wa_mard-labst.
          ELSE.
            it_soview-lgpbe = ''.
            it_soview-labst = 0.
          ENDIF.
        ENDIF.
      ENDIF.

    ELSE.
*mark by johnson and change code 12/13/2006
*      LOOP AT it_mard
*        WHERE matnr = it_soview-matnr
*        AND werks   = it_soview-werks
*        AND lgort   = it_soview-lgort.
      READ TABLE it_mard WITH KEY matnr = it_soview-matnr
                                  werks = it_soview-werks
                                  lgort = it_soview-lgort.
      IF sy-subrc = 0.
        it_soview-lgpbe = it_mard-lgpbe.
        it_soview-labst = it_mard-labst.

      ELSE.
        CLEAR: wa_mard, ztsd_30.
        SELECT SINGLE * FROM ztsd_30
         WHERE mtart = it_soview-mtart
        AND  werks =  it_soview-werks.   " plant

        IF sy-subrc = 0.
          SELECT SINGLE * FROM mard
          INTO CORRESPONDING FIELDS OF wa_mard
          WHERE matnr = it_soview-matnr
          AND werks =   it_soview-werks   " plant
          AND lgort =   ztsd_30-lgort
          AND lgpbe IN  s_lgpbe.
          IF sy-subrc = 0.
            it_soview-lgpbe = wa_mard-lgpbe.
            it_soview-labst = wa_mard-labst.
          ELSE.
            it_soview-lgpbe = ''.
            it_soview-labst = 0.
          ENDIF.
        ENDIF.
      ENDIF.
*    ENDLOOP.
    ENDIF.
    MODIFY it_soview INDEX so_index
* chris 20120405
      TRANSPORTING bismt mtart  mstav lgpbe labst blatt.
*       TRANSPORTING bismt mtart  mstav lgpbe labst.

  ENDLOOP.

ENDFORM.                    " so_mara_marc_mard_tvko
*&---------------------------------------------------------------------*
*&      Form  get_sales_name
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_I1_PERNR  text
*      -->P_W_NAME  text
*----------------------------------------------------------------------*
FORM get_sales_name  USING    p_pernr
                              p_name.

  DATA: a_name(80).
  CLEAR pa0002.
  SELECT SINGLE * FROM pa0002
  WHERE pernr = p_pernr.

  CONCATENATE pa0002-vorna ' ' pa0002-nachn INTO  a_name.
  MOVE a_name(40) TO  p_name.

ENDFORM.                    " get_sales_name


*&------------------------------------------------------------------
* form get_sales_iname  *090303
*$------------------------------------------------------------------

FORM get_sales_iname  USING    p_ipernr
                              p_iname.

  DATA: a_iname(80).
  CLEAR pa0002.
  SELECT SINGLE * FROM pa0002
  WHERE pernr = p_ipernr.

  CONCATENATE pa0002-vorna ' ' pa0002-nachn INTO  a_iname.
  MOVE a_iname(40) TO  p_iname.

ENDFORM.                    " get_sales_iname


*&---------------------------------------------------------------------
*&      Form  CONVERT_AMOUNT_TO_IDOC
*&---------------------------------------------------------------------
FORM convert_amount_to_idoc USING    u_curr
                                     u_sapamt
                                     u_pi01
                            CHANGING u_idocamt
                                     u_idocamt2.
  DATA: idoc_amount(30).
  DATA : idoc_amount2(30).
  CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
    EXPORTING
      currency    = u_curr
      sap_amount  = u_sapamt
    IMPORTING
      idoc_amount = idoc_amount.
  CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
    EXPORTING
      currency    = u_curr
      sap_amount  = u_pi01
    IMPORTING
      idoc_amount = idoc_amount2.

* , down , ,  data 
* 2005/6/1 by Ted

  IF idoc_amount > 98765432101 .
    idoc_amount = 98765432101 .
    idoc_amount2 = 98765432101.
  ENDIF.
  u_idocamt = idoc_amount .
  u_idocamt2 = idoc_amount2 .

ENDFORM.                    " CONVERT_AMOUNT_TO_IDOC

*&---------------------------------------------------------------------*
*&      Form  READ_EXCHANGE_RATE
*&---------------------------------------------------------------------*
*       READ EXCHANGE RATE
*----------------------------------------------------------------------*
FORM read_exchange_rate USING u_fcurr
                              u_lcurr
                              u_date
                     CHANGING c_rate.
  DATA: l_ffactor TYPE i,
        l_lfactor TYPE i.

  CALL FUNCTION 'READ_EXCHANGE_RATE'
    EXPORTING
*     CLIENT           = SY-MANDT
      date             = u_date
      foreign_currency = u_fcurr
      local_currency   = u_lcurr
*     TYPE_OF_RATE     = 'M'
*     EXACT_DATE       = ' '
    IMPORTING
      exchange_rate    = c_rate
      foreign_factor   = l_ffactor
      local_factor     = l_lfactor
*     VALID_FROM_DATE  =
*     DERIVED_RATE_TYPE =
*     FIXED_RATE       =
*     OLDEST_RATE_FROM =
    EXCEPTIONS
      no_rate_found    = 1
      no_factors_found = 2
      no_spread_found  = 3
      derived_2_times  = 4
      overflow         = 5
      zero_rate        = 6
      OTHERS           = 7.

  IF sy-subrc <> 0.
    c_rate = 0 .
  ELSE .
    IF c_rate < 0 .
      c_rate = 1 / ( c_rate * -1 ) .
    ENDIF .
    c_rate = c_rate * l_lfactor / l_ffactor .
  ENDIF.

ENDFORM.                    " get_rate

**********  add by Ted.Tsao begin, 2008/11/26 ****************
FORM printtime.
  IF tmpf3  = 'Print'.
    qtime-xdesc = 'All Done '.
    qtime-xdate = sy-uname.
    qtime-xtime = sy-uzeit.
    APPEND qtime.

    LOOP AT s_edatu .
      IF s_edatu-low IS NOT INITIAL.
        qtime-xdesc = 'Confirm Date'.
        qtime-xdate = s_edatu-low.
        qtime-xtime = ' '.
        APPEND qtime.
      ENDIF.
    ENDLOOP.

    LOOP AT s_mbdat .
      IF s_mbdat-low IS NOT INITIAL.
        qtime-xdesc = 'Available Date'.
        qtime-xdate = s_mbdat-low.
        qtime-xtime = ' '.
        APPEND qtime.
      ENDIF.
    ENDLOOP.


    LOOP AT s_cdat .
      IF s_cdat-low IS NOT INITIAL.
        qtime-xdesc = 'Create Date'.
        qtime-xdate = s_cdat-low.
        qtime-xtime = ' '.
        APPEND qtime.
      ENDIF.
    ENDLOOP.


    LOOP AT s_datu .
      IF s_datu-low IS NOT INITIAL.
        qtime-xdesc = 'Request Date'.
        qtime-xdate = s_datu-low.
        qtime-xtime = ' '.
        APPEND qtime.
      ENDIF.
    ENDLOOP.


    CONCATENATE
    '/usr/sap/trans/interface/SD/out/sd28b_'
    sy-datum+4(4)
    '_'
    sy-timlo(4)
    '.txt' INTO u_file.
    OPEN DATASET u_file FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
    IF sy-subrc NE 0.
      MESSAGE a894 WITH u_file.
    ENDIF.
    LOOP AT qtime.
      TRANSFER qtime      TO u_file.
    ENDLOOP.
    CLOSE DATASET u_file.
  ENDIF.
ENDFORM.                    "PrintTime

*&---------------------------------------------------------------------*
*&      Form  UPLOAD_FROM_Server
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM upload_from_server.
  DATA: pt_line LIKE zsoli OCCURS 0 WITH HEADER LINE,
        pi_name LIKE rlgrap-filename.

  FIELD-SYMBOLS <fs> TYPE any.
  DATA: skey(1) TYPE c.

  DATA: v_line TYPE i VALUE 0.

  skey = ','.    "CSV

  IF sy-sysid = 'RDV'.  " 
    pi_name =
'/usr/sap/trans/interface/SD/out/exceptso220.txt' .
  ELSEIF sy-sysid = 'RDQ'.
    pi_name =
'/usr/sap/trans/interface/SD/out/exceptsoRDQ.txt' .
  ELSE.
    pi_name =
'/usr/sap/trans/interface/SD/out/exceptso.txt' .
  ENDIF.

  CLEAR   r_soso.
  REFRESH r_soso.

  r_soso-option = 'EQ'.
  r_soso-sign = 'I'.

  OPEN DATASET pi_name
          FOR INPUT IN TEXT MODE ENCODING UTF-8.
  IF sy-subrc = 0.
    DO.
      READ DATASET pi_name INTO pt_line.
      IF sy-subrc NE 0.
        EXIT.
      ENDIF.
      APPEND pt_line.
    ENDDO.
    CLOSE DATASET pi_name.
  ENDIF.

  v_line = 0.
  CLEAR p_1st.
  LOOP AT pt_line.
    DO.
*  , ,DATA,, 2007/03/22
      ASSIGN COMPONENT sy-index OF STRUCTURE exceptso TO <fs>.
      IF sy-subrc NE 0.
        EXIT.
      ENDIF.
      SPLIT pt_line-line AT skey INTO <fs> pt_line-line.
    ENDDO.

    IF v_line = 0 AND p_1st IS INITIAL.
      p_1st = exceptso-vbeln.  "  the 1st order date
    ELSE.
      APPEND exceptso.
      IF   r_soso-low <> exceptso-vbeln.
        r_soso-low = exceptso-vbeln.
        APPEND r_soso.
        v_line = v_line + 1.
      ENDIF.
    ENDIF.
    CLEAR exceptso.
  ENDLOOP.

  should1  = 'X'.
  LOOP AT s_vbeln.
    IF s_vbeln-low IN r_soso.
      should1  = 'Y'.
      EXIT.
    ELSE.
*      should1  = 'N'.
* chris 20130403
      should1  = 'X'.
    ENDIF.
  ENDLOOP.

** add by rong ,20210118
  IF s_org-low = 'US01' AND p_vtweg = '10' AND p_spart = '30'.
    CLEAR: p_1st, should1.
  ENDIF.
**end
ENDFORM.        "UPLOAD_FROM_PC
*&---------------------------------------------------------------------*
*&      Form  fill_zsotext
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM fill_zsotext .
*  FIELD-SYMBOLS: <fs_a1> LIKE LINE OF a1.
*  CHECK s_org-low EQ 'EU10'.
*  LOOP AT a1 ASSIGNING <fs_a1>.
*    CHECK <fs_a1>-vbeln IS NOT INITIAL.
***CHECK vbrp-aubel IS NOT INITIAL.
*
*    DATA: lt_lines TYPE TABLE OF tline,
*          lw_lines TYPE tline,
*          lf_id    TYPE thead-tdid,
*          lf_name  TYPE thead-tdname,
*          lf_lan   TYPE thead-tdspras,
*          lf_obj   TYPE thead-tdobject.

***read the FM to get the quot text

*    lf_id   = 'ZQUO'.
*    lf_lan  = 'EN'.
*    lf_name = <fs_a1>-vbeln.
*    lf_obj  = 'VBBK'.
*
*    CLEAR: lt_lines, lw_lines.
*
*    CALL FUNCTION 'READ_TEXT'
*      EXPORTING
*        client                  = sy-mandt
*        id                      = lf_id
*        language                = lf_lan
*        name                    = lf_name
*        object                  = lf_obj
*      TABLES
*        lines                   = lt_lines
*      EXCEPTIONS
*        id                      = 1
*        language                = 2
*        name                    = 3
*        not_found               = 4
*        object                  = 5
*        reference_check         = 6
*        wrong_access_to_archive = 7
*        OTHERS                  = 8.
*
*    IF sy-subrc = 0.
*      LOOP AT lt_lines INTO lw_lines.
*CONCATENATE <fs_a1>-zso_text lw_lines-tdline INTO <fs_a1>-zso_text
*        SEPARATED BY space.
*        CONDENSE <fs_a1>-zso_text.
*      ENDLOOP.
*    ENDIF.
*    UNASSIGN <fs_a1>.
*  ENDLOOP.

ENDFORM.                    " fill_zsotext
*&---------------------------------------------------------------------*
*&      Form  GET_EXTERNAL_NOTE
*&---------------------------------------------------------------------*
FORM get_external_note.

  TYPES:
    BEGIN OF lst_ext_note,
      vbeln          TYPE vbeln,
      zexternal_note LIKE zssd_dn-z_note,             " Xuan.Kao 20220830 Debug External Note Length
    END OF lst_ext_note,
    ztt_ext_note TYPE HASHED TABLE OF lst_ext_note WITH UNIQUE KEY vbeln.

  DATA:
    lt_ext_note TYPE ztt_ext_note,
    lt_lines    TYPE STANDARD TABLE OF tline,
    lv_name     TYPE thead-tdname,
    lv_spras    TYPE stxh-tdspras,                    " Xuan.Kao 20220830 Debug External Note Language
    ls_ext_note TYPE lst_ext_note.


  FIELD-SYMBOLS:
    <ls_vbak>     LIKE LINE OF itab_vbak,
    <ls_line>     TYPE tline,
    <ls_ext_note> TYPE lst_ext_note,
    <ls_a1>       LIKE i1.

  "LOOP AT itab_vbak ASSIGNING <ls_vbak>. 20250605 A1
  LOOP AT a1 ASSIGNING <ls_a1>.
    lv_name = <ls_a1>-vbeln." <ls_vbak>-vbeln.

*** Xuan.Kao 20220830 Debug External Note Language-Start ***
    lv_spras = sy-langu.

    SELECT SINGLE tdspras INTO lv_spras
      FROM stxh
     WHERE tdobject = 'VBBK'
       AND tdname = lv_name
       AND tdid = '0002'
       AND tdspras = lv_spras.
    IF sy-subrc <> 0.
      SELECT SINGLE tdspras INTO lv_spras
        FROM stxh
       WHERE tdobject = 'VBBK'
         AND tdname = lv_name
         AND tdid = '0002'.
    ENDIF.
*** Xuan.Kao 20220830 Debug External Note Language-End ***

    CALL FUNCTION 'READ_TEXT'
      EXPORTING
        client                  = sy-mandt
        id                      = '0002'
        language                = lv_spras            " Xuan.Kao 20220830 Debug External Note Language
        name                    = lv_name
        object                  = 'VBBK'
      TABLES
        lines                   = lt_lines
      EXCEPTIONS
        id                      = 1
        language                = 2
        name                    = 3
        not_found               = 4
        object                  = 5
        reference_check         = 6
        wrong_access_to_archive = 7
        OTHERS                  = 8.
    IF sy-subrc NE 0.
      CONTINUE.
    ENDIF.
*** Xuan.Kao 20220830 Debug External Note Length-Start ***
    CLEAR: ls_ext_note.
    LOOP AT lt_lines ASSIGNING <ls_line>.
      CONCATENATE ls_ext_note-zexternal_note <ls_line>-tdline INTO ls_ext_note-zexternal_note.
    ENDLOOP.
    IF ls_ext_note-zexternal_note IS NOT INITIAL.
      ls_ext_note-vbeln = <ls_a1>-vbeln." <ls_vbak>-vbeln.
      INSERT ls_ext_note INTO TABLE lt_ext_note.
    ENDIF.
*** Xuan.Kao 20220830 Debug External Note Length-End ***
  ENDLOOP.
  CHECK lt_ext_note IS NOT INITIAL.

  LOOP AT a1 ASSIGNING <ls_a1>.
    READ TABLE lt_ext_note ASSIGNING <ls_ext_note>
      WITH TABLE KEY vbeln = <ls_a1>-vbeln.
    IF sy-subrc EQ 0.
      <ls_a1>-zexternal_note = <ls_ext_note>-zexternal_note.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " GET_EXTERNAL_NOTE
*&---------------------------------------------------------------------*
*&      Form  GET_TEXT
*&---------------------------------------------------------------------*
*** Xuan.Kao 20150720 SO Head Sales note from customer ***
*&---------------------------------------------------------------------*
FORM get_text TABLES t_tline STRUCTURE tline
              USING  t_tdname
                     t_lang
                     t_id.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id                      = t_id
      language                = t_lang
      name                    = t_tdname
      object                  = 'VBBK'
    TABLES
      lines                   = t_tline
    EXCEPTIONS
      id                      = 1
      language                = 2
      name                    = 3
      not_found               = 4
      object                  = 5
      reference_check         = 6
      wrong_access_to_archive = 7
      OTHERS                  = 8.
ENDFORM.                    " GET_TEXT
*&---------------------------------------------------------------------*
*&      Form  Get_Sub-Sector
*&---------------------------------------------------------------------*
*** Xuan.Kao 20160608 Sub-Sector ***
*&---------------------------------------------------------------------*
FORM get_sub-sector.
  CALL FUNCTION 'Z_SD_SECTOR'
    EXPORTING
      pi_pernr     = i1-pernr
      pi_kunnr     = i1-kunnr
    IMPORTING
      po_subsector = i3-subsector.
ENDFORM.                    " Get_Sub-Sector
*&---------------------------------------------------------------------*
*&      Form  Get_Delivery-Info
*&---------------------------------------------------------------------*
*** Xuan.Kao 20160628 Delivery-Info ***
*&---------------------------------------------------------------------*
FORM get_delivery-info.
  IF i1-dvbeln IS NOT INITIAL.
    SELECT SINGLE kodat wadat wadat_ist INTO (i3-kodat, i3-wadat, i3-wadat_ist)
      FROM likp
    WHERE vbeln = i1-dvbeln.
  ENDIF.
ENDFORM.                    " Get_Delivery-Info
*&---------------------------------------------------------------------*
*&      Form  DOWNLOAD_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM download_data  USING p_file.
** DOWNLOAD TO SERVER
  FIELD-SYMBOLS: <f> TYPE any.
  DATA: w_temp(20)   TYPE c,
        w_line(2048) TYPE c.
  DATA: ls_field_type(1)   TYPE c.
  CONSTANTS:  con_tab TYPE c VALUE cl_abap_char_utilities=>horizontal_tab.
  OPEN DATASET p_file FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  IF sy-subrc = 0.
    LOOP AT d1.
      DO.
        ASSIGN COMPONENT sy-index OF STRUCTURE d1 TO <f>.
        IF sy-subrc <> 0.
          EXIT.
        ELSE.
          DESCRIBE FIELD <f> TYPE ls_field_type.
          IF ls_field_type = 'I' OR          " Integer
              ls_field_type = 'P' OR          " Packed
              ls_field_type = 'F' OR          " Floating Point
              ls_field_type = 'S' OR          " 1 byte integer
              ls_field_type = 'B'.            " 2 byte integer

            MOVE  <f> TO w_temp.
            CONCATENATE  w_line w_temp con_tab
                 INTO   w_line.

          ELSE.
            CONCATENATE  w_line <f> con_tab
                  INTO   w_line.
          ENDIF.
          CLEAR w_temp.
        ENDIF.
      ENDDO.
      TRANSFER w_line TO p_file.
      CLEAR w_line.
    ENDLOOP.
    CLOSE DATASET p_file.
  ENDIF.
ENDFORM.                    " DOWNLOAD_DATA
FORM download_data_a  USING p_file.
** DOWNLOAD TO SERVER
  FIELD-SYMBOLS: <f> TYPE any.
  DATA: w_temp(20)   TYPE c,
        w_line(2048) TYPE c.
  DATA: ls_field_type(1)   TYPE c.
  CONSTANTS:  con_tab TYPE c VALUE cl_abap_char_utilities=>horizontal_tab.
  OPEN DATASET p_file FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  IF sy-subrc = 0.
    LOOP AT d9.
      DO.
        ASSIGN COMPONENT sy-index OF STRUCTURE d9 TO <f>.
        IF sy-subrc <> 0.
          EXIT.
        ELSE.
          DESCRIBE FIELD <f> TYPE ls_field_type.
          IF ls_field_type = 'I' OR          " Integer
              ls_field_type = 'P' OR          " Packed
              ls_field_type = 'F' OR          " Floating Point
              ls_field_type = 'S' OR          " 1 byte integer
              ls_field_type = 'B'.            " 2 byte integer

            MOVE  <f> TO w_temp.
            CONCATENATE  w_line w_temp con_tab
                 INTO   w_line.

          ELSE.
            CONCATENATE  w_line <f> con_tab
                  INTO   w_line.
          ENDIF.
          CLEAR w_temp.
        ENDIF.
      ENDDO.
      TRANSFER w_line TO p_file.
      CLEAR w_line.
    ENDLOOP.
    CLOSE DATASET p_file.
  ENDIF.
ENDFORM.                    " DOWNLOAD_DATA


***************************************************************
*&    Add by Jane on 2018/07/31
*&    TXT
*&    
***************************************************************
DATA: BEGIN OF tbldown OCCURS 20,
        text(4000), "2048),
      END OF tbldown.

DATA: BEGIN OF tblover OCCURS 0,
        curdate   LIKE sy-datum,    "Current Date
        vbeln     LIKE vbak-vbeln,  "sales order
        posnr     LIKE vbap-posnr,  "Sales Document Item
        matnr     LIKE vbap-matnr,  "Material
        opamt     LIKE vbap-netwr,  "Unbilling Amount
        waerk     LIKE vbap-waerk,  "SD document currency
        blogdt    LIKE vbep-edatu,  "backlog date
        werks     LIKE vbap-werks,  "Plant
        dispo     LIKE marc-dispo,    " MRP Controller
        dsnam     LIKE  t024d-dsnam,  " MRP Controller Name
        blatt     LIKE mara-blatt,   "GIP Code
        eknam     LIKE t024-eknam,   "SCM Name
        kbmeng    LIKE vbap-kbmeng, "Unbilling Qty
        smtp_addr LIKE t024-smtp_addr, "SCM E-Mail Address
        ernam     LIKE vbak-ernam, "User ID
        exp_days  TYPE i, "
      END OF tblover.

*&---------------------------------------------------------------------*
*&      Form  download-overdue-data.
*&---------------------------------------------------------------------*
FORM download-overdue-data USING p_file.

  PERFORM get-overdue-data TABLES tblover.
  IF tblover[] IS NOT INITIAL.
    PERFORM prepare-download-data TABLES tblover tbldown.
    PERFORM download-to-server TABLES tbldown USING p_file.
  ENDIF.

ENDFORM.          "download-overdue-data.

*&---------------------------------------------------------------------*
*&      Form  get-overdue-data.
*&---------------------------------------------------------------------*
FORM get-overdue-data TABLES tbldata LIKE tblover[].
  DATA: i_days TYPE i VALUE 0.
  DATA: iekbe LIKE ekbe OCCURS 0 WITH HEADER LINE.
  DATA: ivbfa LIKE vbfa OCCURS 0 WITH HEADER LINE.
  DATA: s_status(1) TYPE c.

  CLEAR tbldata.
  REFRESH tbldata.

  LOOP AT a1.
    IF a1-blogdt IS INITIAL OR a1-blogdt >= sy-datum.
      CONTINUE.
    ENDIF.

*    CALL FUNCTION 'FIMA_DAYS_AND_MONTHS_AND_YEARS'
*               EXPORTING
*                 I_DATE_FROM          = a1-blogdt
**                I_KEY_DAY_FROM       =
*                 I_DATE_TO            = sy-datum
**                I_KEY_DAY_TO         =
*                 I_FLG_SEPARATE       = ' '
*               IMPORTING
*                 E_DAYS               = I_DAYS
**                E_MONTHS             =
**                E_YEARS              =
*                       .

    PERFORM f_get_days USING a1-blogdt sy-datum CHANGING i_days.
    IF i_days <= 2.  "2
      CONTINUE.
    ENDIF.

*   DN
*    IF a1-dnqty = a1-kbmeng.  "'Sch.Already DN qty' = 'Unbilling Qty'
*      CONTINUE.
*    ENDIF.

*   DN
    IF a1-dnqty = a1-schqty.  "'Sch.Already DN qty' = 'Sched.Line Qty'
      CONTINUE.
*      IF I_DAYS <= 3. "3
*        CONTINUE.
*      ENDIF.
    ENDIF.

    MOVE-CORRESPONDING a1 TO tbldata.
    tbldata-werks = a1-splant.   "Delv/Supply Plant
    tbldata-exp_days = i_days. "

*   MRP Controller
    SELECT SINGLE dispo INTO tbldata-dispo FROM marc WHERE werks = tbldata-werks
    AND matnr = tbldata-matnr.
    SELECT SINGLE dsnam INTO tbldata-dsnam FROM t024d WHERE werks = tbldata-werks
    AND dispo = tbldata-dispo.

*   SCM
    SELECT SINGLE blatt FROM mara INTO tbldata-blatt WHERE matnr = tbldata-matnr.
    SELECT SINGLE eknam smtp_addr INTO (tbldata-eknam,tbldata-smtp_addr)
      FROM t024
    WHERE ekgrp = tbldata-blatt.

    tbldata-curdate = sy-datum.

    APPEND tbldata.
    CLEAR tbldata.
  ENDLOOP.
ENDFORM.        "get-overdue-data


*&---------------------------------------------------------------------*
*&      Form  prepare-download-data
*&---------------------------------------------------------------------*
FORM  prepare-download-data TABLES tbldata LIKE tblover[]
                                   tbldown LIKE tbldown[].
  DATA: BEGIN OF tblpredown OCCURS 0,
          curdate LIKE sy-datum,    "Current Date
          vbeln   LIKE vbak-vbeln,  "sales order
          posnr   LIKE vbap-posnr,  "Sales Document Item
          matnr   LIKE vbap-matnr,  "Material
          opamt   LIKE vbap-netwr,  "Unbilling Amount
          waerk   LIKE vbap-waerk,  "SD document currency
          blogdt  LIKE vbep-edatu,  "backlog date
          werks   LIKE vbap-werks,  "Plant
          dispo   LIKE marc-dispo,    " MRP Controller
          dsnam   LIKE  t024d-dsnam,  " MRP Controller Name
          blatt   LIKE mara-blatt,   "GIP Code
          eknam   LIKE t024-eknam,   "SCM Name
          kbmeng  LIKE vbap-kbmeng, "Unbilling Qty
          ernam   LIKE vbak-ernam, "User ID
        END OF tblpredown.

  LOOP AT tbldata.
    MOVE-CORRESPONDING tbldata TO tblpredown.
    APPEND tblpredown.
    CLEAR tblpredown.
  ENDLOOP.

  DATA:cl_descr TYPE REF TO cl_abap_structdescr.
  FIELD-SYMBOLS: <fs_comp> TYPE abap_compdescr.
  FIELD-SYMBOLS: <fs>.
  DATA: s_tmp(150) TYPE c.
  CONSTANTS:  con_tab TYPE c VALUE cl_abap_char_utilities=>horizontal_tab.

  CLEAR tbldown.
  REFRESH tbldown.

* Internal table column name
  cl_descr ?= cl_abap_typedescr=>describe_by_data( tblpredown ).
  LOOP AT cl_descr->components ASSIGNING <fs_comp>.
    IF sy-tabix = 1.
      tbldown-text = <fs_comp>-name.
    ELSE.
      CONCATENATE tbldown-text con_tab  <fs_comp>-name INTO tbldown-text.
    ENDIF.
  ENDLOOP.
  APPEND tbldown.
  CLEAR tbldown.

* Internal table value
  IF tblpredown[] IS NOT INITIAL.
    LOOP AT tblpredown.
      DO.
        ASSIGN COMPONENT sy-index OF STRUCTURE tblpredown TO <fs>.
        IF sy-subrc <> 0.
          EXIT.
        ENDIF.
        IF sy-index = 1.
          tbldown-text = <fs>.
          CONDENSE tbldown-text.
        ELSE.
          MOVE <fs> TO s_tmp.
          CONDENSE s_tmp.
          CONCATENATE tbldown-text con_tab s_tmp INTO tbldown-text.
        ENDIF.
      ENDDO.
      APPEND tbldown.
      CLEAR tbldown.
    ENDLOOP.
  ENDIF.

ENDFORM.            "prepare-download-data

*&---------------------------------------------------------------------*
*&     FORM download-to-server
*&---------------------------------------------------------------------*
FORM download-to-server TABLES tbltxt LIKE tbldown[]
                        USING file.

  OPEN DATASET file FOR OUTPUT IN TEXT MODE ENCODING UTF-8.

  LOOP AT tbltxt.
    TRANSFER tbltxt TO file.
  ENDLOOP.

  CLOSE DATASET file.
ENDFORM.          "download-to-server


*&---------------------------------------------------------------------*
*&      Form  send-mail-overdue
*&---------------------------------------------------------------------*
*       Send Mail For 
*----------------------------------------------------------------------*
FORM send-mail-overdue.

  LOOP AT s_sobsl.
    IF s_sobsl-low IS NOT INITIAL.
*      IF s_sobsl-low = 'M3'.
*        PERFORM send-mail-overdue-m3.
*      ELSEIF s_sobsl-low = 'M4'.
*        PERFORM send-mail-overdue-m4.
*      ENDIF.

      PERFORM send-mail-overdue-common.

      EXIT. "
    ENDIF.
  ENDLOOP.

ENDFORM.          "send-mail-overdue

*&---------------------------------------------------------------------*
*&      Form  send-mail-overdue-m4
*&---------------------------------------------------------------------*
*       Send Mail For  
*----------------------------------------------------------------------*
FORM send-mail-overdue-m4.

  DATA: tbldata LIKE TABLE OF tblover WITH HEADER LINE.
  PERFORM get-overdue-data TABLES tbldata.

  IF tbldata[] IS INITIAL.
    WRITE 'Not send email,no data!'.
  ELSE.
**   SCM
*    DATA:TBLADDR LIKE TBLOVER OCCURS 0 WITH HEADER LINE.
*    LOOP AT TBLDATA.
*      IF TBLDATA-SMTP_ADDR IS NOT INITIAL.
*        MOVE TBLDATA-SMTP_ADDR TO TBLADDR-SMTP_ADDR.
*        COLLECT TBLADDR.
*        CLEAR TBLADDR.
*      ENDIF.
*    ENDLOOP.

*   User ID,
    DATA:BEGIN OF tbladdr OCCURS 0,
           email TYPE string,
         END OF tbladdr.

    LOOP AT tbldata.
      IF tbldata-smtp_addr IS NOT INITIAL.
        MOVE tbldata-ernam TO tbladdr-email.
        CONCATENATE tbladdr-email '@ADVANTECH.COM.TW' INTO tbladdr-email.
        COLLECT tbladdr.
        CLEAR tbladdr.
      ENDIF.
    ENDLOOP.

*  
    DATA: lt_mailrecipients  TYPE STANDARD TABLE OF somlreci1 WITH HEADER LINE.
    DATA: x_mailgp           LIKE ztmm_15-zmalgp.
    DATA: x_mailgp_bcc           LIKE ztmm_15-zmalgp.

    MOVE 'ZRSD0028B-M4' TO x_mailgp.
    MOVE 'ZRSD0028B-M4-BCC' TO x_mailgp_bcc.

*   
    SELECT smtp_addr INTO lt_mailrecipients-receiver FROM ztmm_15 WHERE zmalgp = x_mailgp.
      lt_mailrecipients-rec_type = 'U'.
      APPEND lt_mailrecipients.
      CLEAR lt_mailrecipients.
    ENDSELECT.

*   BCC
    SELECT smtp_addr INTO lt_mailrecipients-receiver FROM ztmm_15 WHERE zmalgp = x_mailgp_bcc.
      lt_mailrecipients-blind_copy = 'X'.
      APPEND lt_mailrecipients.
      CLEAR lt_mailrecipients.
    ENDSELECT.

    LOOP AT tbladdr.
      lt_mailrecipients-receiver = tbladdr-email.
      lt_mailrecipients-rec_type = 'U'.
      APPEND lt_mailrecipients.
      CLEAR lt_mailrecipients.
    ENDLOOP.

*  
    DATA: c_title TYPE string.
    DATA: c_str   TYPE string.

    CONCATENATE '' '-()'  INTO c_title SEPARATED BY space.
    CONCATENATE '' c_title '' INTO c_str SEPARATED BY space.

*  
    DATA: BEGIN OF lt_mail OCCURS 0,
            ernam(40),
            eknam(40),
            matnr(20),
            kbmeng(20),
            vbeln(20),
            posnr(20),
            blogdt(20),
            opamt(30),
            werks(20),
            exp_days(20),
          END OF lt_mail.

    lt_mail-ernam = 'Owner'.
    lt_mail-eknam = 'SCM'.
    lt_mail-matnr = 'Material'.
    lt_mail-kbmeng = 'Unbilling Qty'.
    lt_mail-vbeln = 'Sales Document'.
    lt_mail-posnr = 'Sales Document Item'.
    lt_mail-blogdt = 'Backlog Date'.
    lt_mail-opamt = 'Unbilling Amount'.
    lt_mail-werks = 'Supply Plant'.
    lt_mail-exp_days = 'Expired days'.

    APPEND lt_mail.
    CLEAR lt_mail.

    SORT tbldata BY blogdt.
    LOOP AT tbldata.
      MOVE-CORRESPONDING tbldata TO lt_mail.

      PERFORM remove_post_zero
          CHANGING lt_mail-kbmeng.

      APPEND lt_mail.
      CLEAR lt_mail.
    ENDLOOP.

    DATA:to_mail LIKE zstext1024 OCCURS 0 WITH HEADER LINE.
    LOOP AT lt_mail.
      CONCATENATE lt_mail-ernam   '|'
                  lt_mail-eknam   '|'
                  lt_mail-matnr   '|'
                  lt_mail-kbmeng '|'
                  lt_mail-vbeln   '|'
                  lt_mail-posnr   '|'
                  lt_mail-blogdt   '|'
                  lt_mail-opamt   '|'
                  lt_mail-werks   '|'
                  lt_mail-exp_days
      INTO to_mail-line.
      APPEND to_mail.
    ENDLOOP.

*  FUNCTIONHTML
    CALL FUNCTION 'Z_SEND_MAIL_HTML'
      EXPORTING
        pi_title         = c_title
        pi_dear          = 'Dear All'
        pi_content1      = c_str
        pi_content2      = ''
      TABLES
        pt_text          = to_mail
        pt_mail_receiver = lt_mailrecipients
*     EXCEPTIONS
*       SENDING_FAILED   = 1
*       OTHERS           = 2
      .

    IF sy-subrc <> 0.
      WRITE 'Send Email Error!'.
    ELSE.
      WRITE 'Send Email Success!'.
    ENDIF.

  ENDIF.

ENDFORM.          "send-mail-overdue-m4

*&---------------------------------------------------------------------*
*&      Form  send-mail-overdue-m3
*&---------------------------------------------------------------------*
*       Send Mail For  
*----------------------------------------------------------------------*
FORM send-mail-overdue-m3.

  DATA: tbldata LIKE TABLE OF tblover WITH HEADER LINE.
  PERFORM get-overdue-data TABLES tbldata.

  IF tbldata[] IS INITIAL.
    WRITE 'Not send email,no data!'.
  ELSE.
**   SCM
*    DATA:TBLADDR LIKE TBLOVER OCCURS 0 WITH HEADER LINE.
*    LOOP AT TBLDATA.
*      IF TBLDATA-SMTP_ADDR IS NOT INITIAL.
*        MOVE TBLDATA-SMTP_ADDR TO TBLADDR-SMTP_ADDR.
*        COLLECT TBLADDR.
*        CLEAR TBLADDR.
*      ENDIF.
*    ENDLOOP.

*   User ID,
    DATA:BEGIN OF tbladdr OCCURS 0,
           email TYPE string,
         END OF tbladdr.

    LOOP AT tbldata.
      IF tbldata-smtp_addr IS NOT INITIAL.
        MOVE tbldata-ernam TO tbladdr-email.
        CONCATENATE tbladdr-email '@ADVANTECH.COM.TW' INTO tbladdr-email.
        COLLECT tbladdr.
        CLEAR tbladdr.
      ENDIF.
    ENDLOOP.

*  
    DATA: lt_mailrecipients  TYPE STANDARD TABLE OF somlreci1 WITH HEADER LINE.
    DATA: x_mailgp           LIKE ztmm_15-zmalgp.
    DATA: x_mailgp_bcc           LIKE ztmm_15-zmalgp.

    MOVE 'ZRSD0028B-M3' TO x_mailgp.
    MOVE 'ZRSD0028B-M3-BCC' TO x_mailgp_bcc.

*   
    SELECT smtp_addr INTO lt_mailrecipients-receiver FROM ztmm_15 WHERE zmalgp = x_mailgp.
      lt_mailrecipients-rec_type = 'U'.
      APPEND lt_mailrecipients.
      CLEAR lt_mailrecipients.
    ENDSELECT.

*   BCC
    SELECT smtp_addr INTO lt_mailrecipients-receiver FROM ztmm_15 WHERE zmalgp = x_mailgp_bcc.
      lt_mailrecipients-blind_copy = 'X'.
      APPEND lt_mailrecipients.
      CLEAR lt_mailrecipients.
    ENDSELECT.

    LOOP AT tbladdr.
      lt_mailrecipients-receiver = tbladdr-email.
      lt_mailrecipients-rec_type = 'U'.
      APPEND lt_mailrecipients.
      CLEAR lt_mailrecipients.
    ENDLOOP.

*  
    DATA: c_title TYPE string.
    DATA: c_str   TYPE string.

    CONCATENATE '' '-()'  INTO c_title SEPARATED BY space.
    CONCATENATE '' c_title '' INTO c_str SEPARATED BY space.

*  
    DATA: BEGIN OF lt_mail OCCURS 0,
            ernam(40),
            eknam(40),
            matnr(20),
            kbmeng(20),
            vbeln(20),
            posnr(20),
            blogdt(20),
            werks(20),
            exp_days(20),
          END OF lt_mail.

    lt_mail-ernam = 'Owner'.
    lt_mail-eknam = 'SCM'.
    lt_mail-matnr = 'Material'.
    lt_mail-kbmeng = 'Unbilling Qty'.
    lt_mail-vbeln = 'Sales Document'.
    lt_mail-posnr = 'Sales Document Item'.
    lt_mail-blogdt = 'Backlog Date'.
    lt_mail-werks = 'Supply Plant'.
    lt_mail-exp_days = 'Expired days'.

    APPEND lt_mail.
    CLEAR lt_mail.

    SORT tbldata BY blogdt.
    LOOP AT tbldata.
      MOVE-CORRESPONDING tbldata TO lt_mail.

      PERFORM remove_post_zero
          CHANGING lt_mail-kbmeng.

      APPEND lt_mail.
      CLEAR lt_mail.
    ENDLOOP.

    DATA:to_mail LIKE zstext1024 OCCURS 0 WITH HEADER LINE.
    LOOP AT lt_mail.
      CONCATENATE lt_mail-ernam   '|'
                  lt_mail-eknam   '|'
                  lt_mail-matnr   '|'
                  lt_mail-kbmeng '|'
                  lt_mail-vbeln   '|'
                  lt_mail-posnr   '|'
                  lt_mail-blogdt   '|'
                  lt_mail-werks   '|'
                  lt_mail-exp_days
      INTO to_mail-line.
      APPEND to_mail.
    ENDLOOP.

*  FUNCTIONHTML
    CALL FUNCTION 'Z_SEND_MAIL_HTML'
      EXPORTING
        pi_title         = c_title
        pi_dear          = 'Dear All'
        pi_content1      = c_str
        pi_content2      = ''
      TABLES
        pt_text          = to_mail
        pt_mail_receiver = lt_mailrecipients
*     EXCEPTIONS
*       SENDING_FAILED   = 1
*       OTHERS           = 2
      .

    IF sy-subrc <> 0.
      WRITE 'Send Email Error!'.
    ELSE.
      WRITE 'Send Email Success!'.
    ENDIF.

  ENDIF.

ENDFORM.


*&---------------------------------------------------------------------*
*&      Form  send-mail-overdue
*&---------------------------------------------------------------------*
*       Send Mail For  
*----------------------------------------------------------------------*
FORM send-mail-overdue-common.

  DATA: tbldata LIKE TABLE OF tblover WITH HEADER LINE.
  PERFORM get-overdue-data TABLES tbldata.

  IF tbldata[] IS INITIAL.
    WRITE 'Not send email,no data!'.
  ELSE.
**   SCM
*    DATA:TBLADDR LIKE TBLOVER OCCURS 0 WITH HEADER LINE.
*    LOOP AT TBLDATA.
*      IF TBLDATA-SMTP_ADDR IS NOT INITIAL.
*        MOVE TBLDATA-SMTP_ADDR TO TBLADDR-SMTP_ADDR.
*        COLLECT TBLADDR.
*        CLEAR TBLADDR.
*      ENDIF.
*    ENDLOOP.

*   User ID,
    DATA:BEGIN OF tbladdr OCCURS 0,
           email TYPE string,
         END OF tbladdr.

    LOOP AT tbldata.
      IF tbldata-smtp_addr IS NOT INITIAL.
        MOVE tbldata-ernam TO tbladdr-email.
        CONCATENATE tbladdr-email '@ADVANTECH.COM.TW' INTO tbladdr-email.
        COLLECT tbladdr.
        CLEAR tbladdr.
      ENDIF.
    ENDLOOP.

*  
    DATA: lt_mailrecipients  TYPE STANDARD TABLE OF somlreci1 WITH HEADER LINE.
    DATA: x_mailgp           LIKE ztmm_15-zmalgp.
    DATA: x_mailgp_bcc           LIKE ztmm_15-zmalgp.
    DATA: plant(20)   TYPE c.


    IF s_sobsl-low = 'M3'.
      MOVE 'ZRSD0028B-M3' TO x_mailgp.
      MOVE 'ZRSD0028B-M3-BCC' TO x_mailgp_bcc.
      plant = ''.
    ELSEIF s_sobsl-low = 'M4'.
      MOVE 'ZRSD0028B-M4' TO x_mailgp.
      MOVE 'ZRSD0028B-M4-BCC' TO x_mailgp_bcc.
      plant = ''.
    ELSEIF s_sobsl-low = 'M8'.
      MOVE 'ZRSD0028B-M8' TO x_mailgp.
      MOVE 'ZRSD0028B-M8-BCC' TO x_mailgp_bcc.
      plant = ''.
    ENDIF.

*   
    SELECT smtp_addr INTO lt_mailrecipients-receiver FROM ztmm_15 WHERE zmalgp = x_mailgp.
      lt_mailrecipients-rec_type = 'U'.
      APPEND lt_mailrecipients.
      CLEAR lt_mailrecipients.
    ENDSELECT.

*   BCC
    SELECT smtp_addr INTO lt_mailrecipients-receiver FROM ztmm_15 WHERE zmalgp = x_mailgp_bcc.
      lt_mailrecipients-blind_copy = 'X'.
      APPEND lt_mailrecipients.
      CLEAR lt_mailrecipients.
    ENDSELECT.

    LOOP AT tbladdr.
      lt_mailrecipients-receiver = tbladdr-email.
      lt_mailrecipients-rec_type = 'U'.
      APPEND lt_mailrecipients.
      CLEAR lt_mailrecipients.
    ENDLOOP.

*  
    DATA: c_title TYPE string.
    DATA: c_str   TYPE string.

    CONCATENATE '-' '(' plant ')' INTO c_title SEPARATED BY space.
    CONCATENATE '' c_title '' INTO c_str SEPARATED BY space.

*  
    DATA: BEGIN OF lt_mail OCCURS 0,
            ernam(40),
            eknam(40),
            matnr(20),
            kbmeng(20),
            vbeln(20),
            posnr(20),
            blogdt(20),
            werks(20),
            exp_days(20),
          END OF lt_mail.

    lt_mail-ernam = 'Owner'.
    lt_mail-eknam = 'SCM'.
    lt_mail-matnr = 'Material'.
    lt_mail-kbmeng = 'Unbilling Qty'.
    lt_mail-vbeln = 'Sales Document'.
    lt_mail-posnr = 'Sales Document Item'.
    lt_mail-blogdt = 'Backlog Date'.
    lt_mail-werks = 'Supply Plant'.
    lt_mail-exp_days = 'Expired days'.

    APPEND lt_mail.
    CLEAR lt_mail.

    SORT tbldata BY blogdt.
    LOOP AT tbldata.
      MOVE-CORRESPONDING tbldata TO lt_mail.

      PERFORM remove_post_zero
          CHANGING lt_mail-kbmeng.

      APPEND lt_mail.
      CLEAR lt_mail.
    ENDLOOP.

    DATA:to_mail LIKE zstext1024 OCCURS 0 WITH HEADER LINE.
    LOOP AT lt_mail.
      CONCATENATE lt_mail-ernam   '|'
                  lt_mail-eknam   '|'
                  lt_mail-matnr   '|'
                  lt_mail-kbmeng '|'
                  lt_mail-vbeln   '|'
                  lt_mail-posnr   '|'
                  lt_mail-blogdt   '|'
                  lt_mail-werks   '|'
                  lt_mail-exp_days
      INTO to_mail-line.
      APPEND to_mail.
    ENDLOOP.

*  FUNCTIONHTML
    CALL FUNCTION 'Z_SEND_MAIL_HTML'
      EXPORTING
        pi_title         = c_title
        pi_dear          = 'Dear All'
        pi_content1      = c_str
        pi_content2      = ''
      TABLES
        pt_text          = to_mail
        pt_mail_receiver = lt_mailrecipients
*     EXCEPTIONS
*       SENDING_FAILED   = 1
*       OTHERS           = 2
      .

    IF sy-subrc <> 0.
      WRITE 'Send Email Error!'.
    ELSE.
      WRITE 'Send Email Success!'.
    ENDIF.

  ENDIF.

ENDFORM.          "send-mail-overdue-m3

*&---------------------------------------------------------------------*
*&      Form  REMOVE_POST_ZERO
*&---------------------------------------------------------------------*
*&      
*----------------------------------------------------------------------*
FORM remove_post_zero CHANGING p_str.
  DATA: l_str1 TYPE string, l_str2 TYPE string, l_str TYPE string.
  CONDENSE p_str NO-GAPS.
  SPLIT p_str AT '.' INTO l_str1 l_str2.
  SHIFT l_str2 RIGHT DELETING TRAILING '0'.
  CONDENSE l_str2.
  CONCATENATE l_str1 '.' l_str2 INTO l_str.
  SHIFT l_str RIGHT DELETING TRAILING '.'.
  p_str = l_str.
ENDFORM.              "REMOVE_POST_ZERO

*&---------------------------------------------------------------------*
*&      FORM  F_GET_DAYS
*&---------------------------------------------------------------------*
*       
*----------------------------------------------------------------------*
*      -->I_FROM  TEXT
*      -->I_FROM  TEXT
*      <--O_DAYS  TEXT
*----------------------------------------------------------------------*
FORM f_get_days  USING    i_from TYPE sy-datum
                          i_to   TYPE sy-datum
                 CHANGING o_days TYPE i.

  DATA: it_tab TYPE STANDARD TABLE OF casdayattr WITH  HEADER  LINE .
  DATA: holiday TYPE c.
  DATA: attributes TYPE STANDARD TABLE OF thol.

  CALL FUNCTION 'DAY_ATTRIBUTES_GET'
    EXPORTING
*     FACTORY_CALENDAR           = ' '
*     HOLIDAY_CALENDAR           = ' '
      date_from                  = i_from
      date_to                    = i_to
      language                   = sy-langu
*     NON_ISO                    = ' '
*   IMPORTING
*     YEAR_OF_VALID_FROM         =
*     YEAR_OF_VALID_TO           =
*     RETURNCODE                 =
    TABLES
      day_attributes             = it_tab
    EXCEPTIONS
      factory_calendar_not_found = 1
      holiday_calendar_not_found = 2
      date_has_invalid_format    = 3
      date_inconsistency         = 4
      OTHERS                     = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  DELETE it_tab WHERE weekday = 6 OR weekday = 7.

  LOOP AT it_tab.
    CALL FUNCTION 'HOLIDAY_CHECK_AND_GET_INFO'
      EXPORTING
        date                         = it_tab-date  ":
        holiday_calendar_id          = 'CN'        " ID
        with_holiday_attributes      = ' '         "
      IMPORTING
        holiday_found                = holiday
      TABLES
        holiday_attributes           = attributes
        "
      EXCEPTIONS
        calendar_buffer_not_loadable = 1
        date_after_range             = 2
        date_before_range            = 3
        date_invalid                 = 4
        holiday_calendar_id_missing  = 5
        holiday_calendar_not_found   = 6
        OTHERS                       = 7.
    IF holiday = 'X'.
      DELETE it_tab.
    ENDIF.
  ENDLOOP.

  DESCRIBE TABLE it_tab LINES o_days.

ENDFORM.                    " F_GET_DAYS

***************************
*insert add-on table
***************************
FORM process-addontable-data.
  DATA: l_str_menge1(16) TYPE c.
  DATA: l_str_menge2(16) TYPE c.
  DATA: l_pwerk LIKE afpo-pwerk.
  DATA: l_werks LIKE marc-werks.
  DATA: l_posnr LIKE ekpo-ebelp.
  DATA: i_zgetcost TYPE  zgetcost2.
  DATA: l_string(6) TYPE c.
  DATA: BEGIN OF itab_plant OCCURS 0 ,

          werks LIKE marc-werks,
        END OF itab_plant.

  REFRESH: output_itab2_addon,output_itab2_addon_base.

  LOOP AT d2.
    IF d2-vbeln IS INITIAL.
      CONTINUE.
    ENDIF.
    MOVE-CORRESPONDING d2 TO output_itab2_addon.

    CLEAR l_werks.
    IF output_itab2_addon-splant IS NOT INITIAL.
      l_werks = output_itab2_addon-splant.
    ELSE.
      l_werks = output_itab2_addon-werks.
    ENDIF.

    CALL FUNCTION 'Z_GET_TARGET_COST'
      EXPORTING
        pi_werks         = l_werks
        pi_matnr         = output_itab2_addon-matnr
        pi_convert       = 'X'
        pi_price_convert = 'X'
      IMPORTING
        pe_zgetcost      = i_zgetcost
      EXCEPTIONS
        no_found         = 1
        OTHERS           = 2.
    IF  i_zgetcost-stprs IS INITIAL.
      i_zgetcost-stprs = 0.
    ENDIF.
    IF  i_zgetcost-pvprs IS INITIAL.
      i_zgetcost-pvprs = 0.
    ENDIF.
    IF  i_zgetcost-pvprs = 0.    "Double add on 20220825 AS i_zgetcost-g_pvprs NO VALUE
      i_zgetcost-pvprs = i_zgetcost-stprs.
    ENDIF.

    IF  i_zgetcost-g_stprs IS INITIAL.
      i_zgetcost-g_stprs = 0.
    ENDIF.
    IF  i_zgetcost-g_pvprs IS INITIAL.
      i_zgetcost-g_pvprs = 0.
    ENDIF.
    IF  i_zgetcost-g_pvprs = 0.  "Double add on 20220825 AS i_zgetcost-g_pvprs NO VALUE
      i_zgetcost-g_pvprs = i_zgetcost-g_stprs.
    ENDIF.

    "   l_itab-uprice = i_zgetcost-stprs.
    output_itab2_addon-amount = i_zgetcost-stprs * output_itab2_addon-bmeng.
    "Double add on 20211206 for fuudy report
    output_itab2_addon-zstdcst = i_zgetcost-stprs * output_itab2_addon-bmeng.
    output_itab2_addon-zactcst = i_zgetcost-pvprs * output_itab2_addon-bmeng.
    output_itab2_addon-zstdcst_usd = i_zgetcost-g_stprs * output_itab2_addon-bmeng.
    output_itab2_addon-zactcst_usd = i_zgetcost-g_pvprs * output_itab2_addon-bmeng.

    output_itab2_addon-zstdcst2 = i_zgetcost-stprs.
    output_itab2_addon-zactcst2 = i_zgetcost-pvprs.
    output_itab2_addon-zstdcst_usd2 = i_zgetcost-g_stprs.
    output_itab2_addon-zactcst_usd2 = i_zgetcost-g_pvprs.

    CLEAR l_posnr.
    l_posnr = output_itab2_addon-posnr+1(5).
    SELECT SINGLE loekz INTO output_itab2_addon-loekz FROM ekpo WHERE ebeln = output_itab2_addon-vbeln AND ebelp = l_posnr.
    "Double add on 20211206 for fuudy

    IF r_dn2tbg = 'X'. "ctos  20241025
      CLEAR:l_string.
      l_string = output_itab2_addon-posnr.
      IF l_string+4(2) = '00' AND output_itab2_addon-vbeln(2) = 'KN'.
        SELECT SINGLE wemng INTO output_itab2_addon-wamng  FROM afpo WHERE kdauf = output_itab2_addon-vbeln AND kdpos = output_itab2_addon-posnr.
      ENDIF.
    ENDIF.

    output_itab2_addon-erdat = sy-datum.  "create date for data
    output_itab2_addon-create_date = sy-datum.   "create owner for data
    output_itab2_addon-create_by = sy-uname.   "create owner for data
    output_itab2_addon-create_time = sy-uzeit.   "create TIME for data
    "DOUBLE ADD ON 20230309 BEGIN
    IF s_prod-low = 'TWM8' OR s_reswk-low = 'TWM8'.
      output_itab2_addon-change_by = 'TWM8'.   "create owner for data
    ENDIF.
    "DOUBLE ADD END

    APPEND output_itab2_addon.
    MOVE-CORRESPONDING output_itab2_addon TO output_itab2_addon_base.  "20231024 FOR CFTNO CKB8

    SELECT SINGLE zzcftno INTO output_itab2_addon_base-zzcftno FROM v_marc_md
      WHERE werks = output_itab2_addon_base-prdplant AND matnr = output_itab2_addon_base-matnr.

    "20240521 EOA:1026945
    IF output_itab2_addon_base-prdplant = 'CKM8'.
      CLEAR:output_itab2_addon_base-zzcftno.
      SELECT SINGLE zzcftno INTO output_itab2_addon_base-zzcftno FROM v_marc_md
      WHERE werks = 'CKB8' AND matnr = output_itab2_addon_base-matnr.
    ENDIF.


    output_itab2_addon_base-sobsl = d2-sobsl.  "20250530  FOR TW INTO LAKE
    output_itab2_addon_base-route = d2-route.  "20250530  FOR TW INTO LAKE
    output_itab2_addon_base-redatu = d2-redatu. "20250530  FOR TW INTO LAKE
    output_itab2_addon_base-commit_date = d2-commit_date. "20250530  FOR TW INTO LAKE
    output_itab2_addon_base-zz_zdatu = d2-zz_zdatu.  "20250530  FOR TW INTO LAKE


    APPEND output_itab2_addon_base.

    MOVE-CORRESPONDING output_itab2_addon TO output_itab2_addon_cn10.  "20250429 add for miniSGA on 20250429
    output_itab2_addon_cn10-custname = d2-endcustnm. "20250429 add for miniSGA on 20250429

    output_itab2_addon_cn10-pernr = d2-pernr.     "20250618 add for miniSGA on 20250618
    output_itab2_addon_cn10-zrpernr = d2-zrpernr. "20250618 add for miniSGA on 20250618

    IF output_itab2_addon_cn10-matnr CS 'BTO'.
      SELECT SINGLE aufnr INTO output_itab2_addon_cn10-aufnr FROM afpo WHERE kdauf = d2-vbeln AND kdpos = d2-posnr.  "20250429 add for miniSGA on 20250429
    ENDIF.

    APPEND output_itab2_addon_cn10.
    CLEAR  output_itab2_addon_cn10.

    CLEAR  output_itab2_addon.



  ENDLOOP.



  IF output_itab2_addon[] IS NOT INITIAL.
    "LOOP AT itab_plant.  "Double update on 20181119
    "    DELETE FROM ztsd_zrsd28b WHERE werks IN S_WERKS AND ERDAT = sy-datum.
    " ENDLOOP.
*    IF sy-subrc <> 0.
*      MESSAGE w000(zmm) WITH 'DELETE FAILED!'.
*    ENDIF.
    IF  r_dn2tbr = 'X' .  "CKB3 RAW 20230317
      MODIFY ztsd_zrsd28b_raw FROM TABLE output_itab2_addon.
      "INSERT  ztpp_zrpp76 FROM TABLE itab_comp_addon.
      IF sy-subrc <> 0.
        MESSAGE w000(zmm) WITH 'INSERT ADD-ON TABLE ztsd_zrsd28b_raw FAILED!'.
      ELSE.
        MESSAGE  'INSERT ADD-ON TABLE ztsd_zrsd28b_raw Success!'  TYPE 'I'.
      ENDIF.
      IF output_itab2_addon[] IS NOT INITIAL.
        PERFORM download_file_ckbx_raw. "20251014 FOR CKB3/CKB8 RAW STO
      ENDIF.


    ELSEIF r_dn2tbg = 'X' . "for globle RBU ON 20230801
      DELETE FROM ztsd_zrsd28b_rbu.                         "20240326
      MODIFY ztsd_zrsd28b_rbu FROM TABLE output_itab2_addon_cn10.

      IF sy-subrc <> 0.
        MESSAGE w000(zmm) WITH 'INSERT ADD-ON TABLE ztsd_zrsd28b_rbu FAILED!'.
      ELSE.
        MESSAGE  'INSERT ADD-ON TABLE ztsd_zrsd28b_rbu Success!'  TYPE 'I'.
      ENDIF.
    ELSEIF r_dn2cus = 'X' . "for cust map material zrsd1239 request
      DELETE FROM ztsd_zrsd28b_cus.                         "20240326
      MODIFY ztsd_zrsd28b_cus FROM TABLE output_itab2_addon.

      IF sy-subrc <> 0.
        MESSAGE w000(zmm) WITH 'INSERT ADD-ON TABLE ztsd_zrsd28b_cus FAILED!'.
      ELSE.
        MESSAGE  'INSERT ADD-ON TABLE ztsd_zrsd28b_cus Success!'  TYPE 'I'.
      ENDIF.
    ELSE.
      MODIFY ztsd_zrsd28b FROM TABLE output_itab2_addon_base.
      "INSERT  ztpp_zrpp76 FROM TABLE itab_comp_addon.
      IF sy-subrc <> 0.
        MESSAGE w000(zmm) WITH 'INSERT ADD-ON TABLE ztsd_zrsd28b FAILED!'.
      ELSE.
        MESSAGE  'INSERT ADD-ON TABLE ztsd_zrsd28b Success!'  TYPE 'I'.
      ENDIF.
    ENDIF.

  ENDIF.

ENDFORM.                    "PREPARE-DATA



***************************
*insert add-on table FOR CKB8
***************************
FORM process-addontable-data-b8.
  DATA: l_str_menge1(16) TYPE c.
  DATA: l_str_menge2(16) TYPE c.
  DATA: l_pwerk LIKE afpo-pwerk.
  DATA: l_werks LIKE marc-werks.
  DATA: l_posnr LIKE ekpo-ebelp.
  DATA: i_zgetcost TYPE  zgetcost2.
  DATA: BEGIN OF itab_plant OCCURS 0 ,
          werks LIKE marc-werks,
        END OF itab_plant.

  REFRESH output_itab8_addon.

  LOOP AT d3.
    IF d3-vbeln IS INITIAL.
      CONTINUE.
    ENDIF.
    MOVE-CORRESPONDING d3 TO output_itab8_addon.

    output_itab8_addon-erdat = sy-datum.  "create date for data
    output_itab8_addon-create_date = sy-datum.   "create owner for data
    output_itab8_addon-create_by = sy-uname.   "create owner for data
    output_itab8_addon-create_time = sy-uzeit.   "create TIME for data

    output_itab8_addon-create_on = sy-datum.  "create date for data

    APPEND output_itab8_addon.
    CLEAR  output_itab8_addon.

  ENDLOOP.



  IF output_itab8_addon[] IS NOT INITIAL.
    "LOOP AT itab_plant.  "Double update on 20181119
    "    DELETE FROM ztsd_zrsd28b WHERE werks IN S_WERKS AND ERDAT = sy-datum.
    " ENDLOOP.
*    IF sy-subrc <> 0.
*      MESSAGE w000(zmm) WITH 'DELETE FAILED!'.
*    ENDIF.
    MODIFY ztsd_zrsd28b_b8 FROM TABLE output_itab8_addon.
    "INSERT  ztpp_zrpp76 FROM TABLE itab_comp_addon.
    IF sy-subrc <> 0.
      MESSAGE w000(zmm) WITH 'INSERT ADD-ON TABLE ztsd_zrsd28b_B8 FAILED!'.
    ELSE.
      MESSAGE  'INSERT ADD-ON TABLE ztsd_zrsd28b_B8 Success!'  TYPE 'I'.
    ENDIF.

  ENDIF.


ENDFORM.                    "PREPARE-DATA

FORM send_mail_to_dn.
  DATA: tbldata LIKE TABLE OF tblover WITH HEADER LINE.
  PERFORM get-overdue-data TABLES tbldata.

  IF a1[] IS INITIAL.
    WRITE 'Not send email,no data!'.
  ELSE.
**   SCM
*    DATA:TBLADDR LIKE TBLOVER OCCURS 0 WITH HEADER LINE.
*    LOOP AT TBLDATA.
*      IF TBLDATA-SMTP_ADDR IS NOT INITIAL.
*        MOVE TBLDATA-SMTP_ADDR TO TBLADDR-SMTP_ADDR.
*        COLLECT TBLADDR.
*        CLEAR TBLADDR.
*      ENDIF.
*    ENDLOOP.

*   User ID,
    DATA:BEGIN OF tbladdr OCCURS 0,
           email TYPE string,
         END OF tbladdr.

    LOOP AT tbldata.
      IF tbldata-smtp_addr IS NOT INITIAL.
        MOVE tbldata-ernam TO tbladdr-email.
        CONCATENATE tbladdr-email '@advantech.com.tw' INTO tbladdr-email.
        COLLECT tbladdr.
        CLEAR tbladdr.
      ENDIF.
    ENDLOOP.

*  
    DATA: lt_mailrecipients  TYPE STANDARD TABLE OF somlreci1 WITH HEADER LINE.
    DATA: x_mailgp           LIKE ztmm_15-zmalgp.
    DATA: x_mailgp_bcc           LIKE ztmm_15-zmalgp.

    MOVE 'ZRSD0028B-DN' TO x_mailgp.


*   
    SELECT smtp_addr INTO lt_mailrecipients-receiver FROM ztmm_15 WHERE zmalgp = x_mailgp.
      lt_mailrecipients-rec_type = 'U'.
      APPEND lt_mailrecipients.
      CLEAR lt_mailrecipients.
    ENDSELECT.

*   BCC

*  
    DATA: c_title TYPE string.
    DATA: c_str   TYPE string.

    CONCATENATE 'DN'  c_title INTO c_title SEPARATED BY space.
    CONCATENATE '' c_title '' INTO c_str SEPARATED BY space.

*  
    DATA: BEGIN OF lt_mail OCCURS 0,
            zrname(40),
            soldtonm(40),
            vbeln(20),
            matnr(20),
            kwmeng(20),
            redatu(20),
            cedatu(20),

          END OF lt_mail.

    lt_mail-zrname = 'Sales Person'.
    lt_mail-soldtonm = 'Sold to Party Desc'.
    lt_mail-vbeln = 'Sales Doc'.
    lt_mail-matnr = 'Material'.
    lt_mail-kwmeng = 'Order Qty'.
    lt_mail-redatu = 'Request Date'.
    lt_mail-cedatu = 'Confirm Date'.


    APPEND lt_mail.
    CLEAR lt_mail.

    LOOP AT a1.
      IF a1-redatu = a1-cedatu AND a1-matnr CS 'BTO' .
        MOVE-CORRESPONDING a1 TO lt_mail.
        APPEND lt_mail.
        CLEAR lt_mail.
      ELSE.
        CONTINUE.
      ENDIF.
    ENDLOOP.

    DATA:to_mail LIKE zstext1024 OCCURS 0 WITH HEADER LINE.
    LOOP AT lt_mail.
      CONCATENATE  lt_mail-zrname  '|'
                  lt_mail-soldtonm  '|'
                  lt_mail-vbeln   '|'
                  lt_mail-matnr '|'
                  lt_mail-kwmeng   '|'
                  lt_mail-redatu   '|'
                  lt_mail-cedatu   '|'

      INTO to_mail-line.
      APPEND to_mail.
    ENDLOOP.

*  FUNCTIONHTML
    CALL FUNCTION 'Z_SEND_MAIL_HTML'
      EXPORTING
        pi_title         = c_title
        pi_dear          = 'Dear All'
        pi_content1      = c_str
        pi_content2      = ''
      TABLES
        pt_text          = to_mail
        pt_mail_receiver = lt_mailrecipients
*     EXCEPTIONS
*       SENDING_FAILED   = 1
*       OTHERS           = 2
      .

    IF sy-subrc <> 0.
      WRITE 'Send Email Error!'.
    ELSE.
      WRITE 'Send Email Success!'.
    ENDIF.

  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*& Form download_aeu_backlog
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> P_FILE4
*&---------------------------------------------------------------------*
FORM download_aeu_backlog  USING    p_file4.

  DATA: lv_subrc   TYPE sysubrc,
        t_data     LIKE TABLE OF i1,
        t_fieldcat TYPE lvc_t_fcat.
  PERFORM assign_alv_title.
  MOVE-CORRESPONDING g_fieldcat TO t_fieldcat.

  REPLACE ALL OCCURRENCES OF '--date--' IN p_file4 WITH sy-datum.

***** prince add for removing zero items.
  DELETE a1
  WHERE werks EQ space
  AND   kbmeng = 0
  AND   opamt = 0.
  t_data = a1[].
  GET REFERENCE OF t_data INTO DATA(ref_data).
  CALL METHOD zcl_aeu_create_xls=>create_xls
    EXPORTING
      i_layout           = alv_def
      i_tcode            = 'ZRSD28B'
      i_destination_type = '2'
      i_file_path        = p_file4
      i_data_format      = p_dtfrt
      t_fieldcatalog     = g_fieldcat
*     t_recepients       =
      ref_data           = ref_data
*     i_sender           =
*     i_email_body       =
*     i_subject          =
    IMPORTING
      e_subrc            = lv_subrc.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form dropdown_fill
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM dropdown_fill .
  DATA: t_values TYPE vrm_values.

  CALL METHOD zcl_aeu_create_xls=>get_dataformat_options
    IMPORTING
      t_values = t_values.

  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id              = 'P_DTFRT'
      values          = t_values
    EXCEPTIONS
      id_illegal_name = 1
      OTHERS          = 2.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.

ENDFORM.

FORM down_material_gp.
  DATA: plant LIKE marc-werks.
  DATA: i_zgetcost TYPE  zgetcost2.
  DATA:l_ukurs LIKE tcurr-ukurs.
  DATA: exrate_gdatu  LIKE tcurr-gdatu.
  DATA: exrate_gdatutw  LIKE tcurr-gdatu.
  DATA:l_month_first LIKE sy-datum.
  DATA:l_datetw  LIKE sy-datum.
  DATA:ldate_workdate LIKE sy-datum.
  DATA:ldate_yesterday LIKE sy-datum.

  CLEAR it_gp.
  REFRESH it_gp.

  LOOP AT a1 WHERE cedatu IS NOT INITIAL.
    MOVE-CORRESPONDING a1 TO it_gp.

    "
    IF a1-sosto = 'X'. "SO
      it_gp-curr = a1-waerk.
    ELSE."STO
      it_gp-curr = a1-waers.
    ENDIF.

    "Supply Plant
    CLEAR plant.
    IF a1-sosto = 'X'. "or  s_org-low = 'TW01'. "SO  "DOUBLE ADD ON 20241125 FOR TW GP MAIL ,CNY  "20250225 TWD ACT COST TURNTO CNY
      plant = a1-werks.
    ELSE."STO
      plant = a1-splant.
    ENDIF.

    it_gp-splant = plant.

    IF plant IS NOT INITIAL.
      "MRP Controller
      SELECT SINGLE t024d~dispo t024d~dsnam INTO ( it_gp-dispo,it_gp-dsnam )
        FROM marc
        INNER JOIN t024d ON marc~werks = t024d~werks AND marc~dispo = t024d~dispo
        WHERE marc~werks = plant
        AND marc~matnr = a1-matnr.

      "
      CALL FUNCTION 'Z_GET_TARGET_COST'
        EXPORTING
          pi_werks         = plant
          pi_matnr         = a1-matnr
          pi_convert       = 'X'
          pi_price_convert = 'X'
        IMPORTING
          pe_zgetcost      = i_zgetcost
        EXCEPTIONS
          no_found         = 1
          OTHERS           = 2.

      IF it_gp-curr = 'CNY'.
        IF i_zgetcost-peinh IS INITIAL OR i_zgetcost-peinh = 0.
          it_gp-actcost = 0.
        ELSE.
          it_gp-actcost = i_zgetcost-pvprs / i_zgetcost-peinh.
          "0
          IF it_gp-actcost IS INITIAL OR it_gp-actcost = 0.
            it_gp-actcost = i_zgetcost-stprs / i_zgetcost-peinh.
          ENDIF.
        ENDIF.
        "ADD ON 20250225 FOR TWGP =>TWD COST TO CNY
        IF s_org-low = 'TW01'.
          l_datetw = sy-datum.
          DO 31 TIMES.
            CLEAR:exrate_gdatutw.
            CONVERT DATE l_datetw INTO INVERTED-DATE exrate_gdatutw.
            CLEAR:l_ukurs.
            SELECT SINGLE ukurs INTO l_ukurs FROM tcurr
                 WHERE kurst = 'M' AND fcurr = 'CNY' AND tcurr = 'TWD' AND gdatu = exrate_gdatutw.

            IF l_ukurs <> 0 AND l_ukurs IS NOT INITIAL.
              it_gp-actcost = it_gp-actcost / l_ukurs. "TWD2CNY
              EXIT.
            ELSE.
              l_datetw = l_datetw - 1.
              CONTINUE.
            ENDIF.
          ENDDO.
        ENDIF.


      ELSE.
        IF i_zgetcost-g_peinh IS INITIAL OR i_zgetcost-g_peinh = 0.
          it_gp-actcost = 0.
        ELSE.
          it_gp-actcost = i_zgetcost-g_pvprs / i_zgetcost-g_peinh.
          "0
          IF it_gp-actcost IS INITIAL OR it_gp-actcost = 0.
            it_gp-actcost = i_zgetcost-g_stprs / i_zgetcost-g_peinh.
          ENDIF.
        ENDIF.
        "double add on 20221202
        IF it_gp-curr <> 'USD'.
          ldate_yesterday = sy-datum - 1.
          DO 10 TIMES.
            CLEAR: ldate_workdate.     "DOUBLE ADD ON 20210729 FOR CKM6 8/158/13
            CALL FUNCTION 'DATE_CONVERT_TO_FACTORYDATE'
              EXPORTING
                correct_option      = '-'
                date                = ldate_yesterday
                factory_calendar_id = 'TW'
              IMPORTING
                date                = ldate_workdate.


            CLEAR:l_month_first,exrate_gdatu.
            "  CONCATENATE sy-datum(6) '01' INTO l_month_first.
            l_month_first = ldate_workdate.
            CONVERT DATE l_month_first INTO INVERTED-DATE exrate_gdatu.
            CLEAR:l_ukurs.
            IF it_gp-curr = 'EUR'.
              SELECT SINGLE ukurs INTO l_ukurs FROM tcurr
               WHERE kurst = 'T' AND fcurr = 'EUR' AND tcurr = 'USD' AND  gdatu = exrate_gdatu.

              IF l_ukurs <> 0 AND l_ukurs IS NOT INITIAL.
                it_gp-actcost = it_gp-actcost * l_ukurs.
                EXIT.
              ELSE.
                ldate_yesterday = ldate_yesterday - 1.
                CONTINUE.
              ENDIF.
            ENDIF.
          ENDDO.
        ENDIF.

      ENDIF.

    ENDIF.

    "GP
    it_gp-unitgp = it_gp-netpr - it_gp-actcost .

    "Total GP
    it_gp-totalgp = it_gp-unitgp  * it_gp-kbmeng.

    APPEND it_gp.
    CLEAR it_gp.

  ENDLOOP.

  PERFORM download_csv_to_ftp.

ENDFORM.

FORM download_csv_to_ftp .
*  DATA: BEGIN OF it_gp_down OCCURS 0,
*          splant(4), "Delv/Supply Plant
*          vbeln(20),  "SO/STO Order
*          posnr(10),  "Order Item
*          matnr(50),  "Material
*          mtart(10),  "Material Type
*          kbmeng(30),  "Unbilling Qty
*          oedatu(15), "Order Date
*          cedatu(15), "Confirm Date
*          netpr(30),  "Unit Price
*          opamt(30),  "Unbilling Amount
*          curr(10), "Currency
*          actcost(30),  "Actual Cost
*          unitgp(30), "Unit GP
*          totalgp(30),  "Total GP
*          werks(4),  "Plant
*          otype(4), "Order Type
*          dispo(10), "MRP Controller
*          dsnam(40), "MRP Controller Name
*          ernam(40) "User ID (Created By)
*          .
*  DATA: END OF it_gp_down.

  DATA: lt_text TYPE truxs_t_text_data.
  DATA: lt_text2 TYPE truxs_t_text_data.
  DATA: wa_line LIKE LINE OF lt_text2.

  DATA : lt_out     LIKE zstext1024 OCCURS 0 WITH HEADER LINE,
         lt_return  LIKE bapiret2 OCCURS 0 WITH HEADER LINE,
         l_filename TYPE localfile.
  REFRESH:it_gp_down.
  LOOP AT it_gp.
    MOVE-CORRESPONDING it_gp TO it_gp_down.

    "
    CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
      CHANGING
        value = it_gp_down-unitgp.

    CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
      CHANGING
        value = it_gp_down-totalgp.

    APPEND it_gp_down.
    CLEAR it_gp_down.
  ENDLOOP.

  IF p_mailgp = 'X'.
    IF s_org-low = 'CN01'.
      PERFORM send_mail_gp.   "DOUBLE ADD ON 20221109
    ELSEIF s_org-low = 'TW01' .
      PERFORM send_mail_gp_tw.   "DOUBLE ADD ON 20240715
    ENDIF.
  ELSE.
    CALL FUNCTION 'SAP_CONVERT_TO_CSV_FORMAT'
      EXPORTING
        i_field_seperator    = ';'
      TABLES
        i_tab_sap_data       = it_gp_down
      CHANGING
        i_tab_converted_data = lt_text
      EXCEPTIONS
        conversion_failed    = 1
        OTHERS               = 2.

    "add title
    CLEAR wa_line.

    CONCATENATE 'Delv/Supply Plant'
    'SO/STO Number'
    'Order Item'
    'Material'
    'Material Type'
    'Unbilling Qty'
    'Order Date'
    'Confirm Date'
    'Unit Price'
    'Unbilling Amount'
    'Currency'
    'Actual Cost'
    'Unit GP'
    'Total GP'
    'Plant'
    'Order Type'
    'MC'
    'MC Name'
    'User ID'
    INTO  wa_line SEPARATED BY ','.
    APPEND wa_line TO  lt_text2.

    LOOP AT lt_text INTO wa_line .
      TRANSLATE wa_line USING ';,'.
      APPEND wa_line TO lt_text2 .
    ENDLOOP.

    LOOP AT lt_text2 INTO wa_line.
      MOVE wa_line TO lt_out-line.
      APPEND lt_out.
      CLEAR lt_out.
    ENDLOOP.

    CLEAR l_filename.
    SEARCH p_file6 FOR '.csv'.
    IF sy-subrc <> 0.
      SEARCH p_file6 FOR '.CSV'.
      IF sy-subrc <> 0.
        CONCATENATE p_file6 'MaterialGP_' sy-datum '.csv' INTO l_filename.
      ENDIF.
    ENDIF.

    IF l_filename IS INITIAL.
      MOVE p_file6 TO l_filename.
    ENDIF.

    CALL FUNCTION 'Z_FTP_FUNCTION'
      EXPORTING
        pi_prog     = 'ZRSD0028B'
        pi_werks    = ''
        pi_filename = l_filename
      TABLES
        pt_out      = lt_out
        pt_return   = lt_return.

    CLEAR lt_return.
    READ TABLE lt_return WITH KEY type = 'E'.
    IF sy-subrc = 0.
      MESSAGE lt_return-message TYPE 'I'.
    ELSE.
      MESSAGE 'Downlad File To FTP Success!' TYPE 'S' .
    ENDIF.
  ENDIF.

ENDFORM.                    " DOWNLOAD_CSV_TO_FTP


*&---------------------------------------------------------------------*
*&      Form  send_mail
*&---------------------------------------------------------------------*
*       text:attached file XLS
*----------------------------------------------------------------------*
FORM send_mail_gp.   "double add on 20170316 FOR CKB6
  DATA: lt_mailrecipients TYPE STANDARD TABLE OF somlrec90 WITH HEADER LINE,
        lt_mailtxt        TYPE STANDARD TABLE OF soli      WITH HEADER LINE,
        lt_attachment     TYPE STANDARD TABLE OF solisti1  WITH HEADER LINE,
        lt_mailsubject    TYPE sodocchgi1,
        lt_packing_list   TYPE STANDARD TABLE OF sopcklsti1 WITH HEADER LINE,
        gv_cnt            TYPE i,
        l_flag(1)         TYPE c,
        l_n               TYPE i,
        l_date            LIKE eket-eindt,
        l_date2           LIKE eket-eindt,
        tmp_org           TYPE string.

  DATA:l_zmalgp LIKE  ztmm_15-zmalgp.
  DATA: BEGIN OF i_mail OCCURS 0,
          splant(4), "Delv/Supply Plant
          vbeln(20),  "SO/STO Order
          posnr(10),  "Order Item
          matnr(50),  "Material
          mtart(10),  "Material Type
          kbmeng(30),  "Unbilling Qty
          oedatu(15), "Order Date
          cedatu(15), "Confirm Date
          netpr(30),  "Unit Price
          opamt(30),  "Unbilling Amount
          curr(10), "Currency
          actcost(30),  "Actual Cost
          unitgp(30), "Unit GP
          totalgp(30),  "Total GP
          werks(4),  "Plant
          otype(4), "Order Type
          dispo(10), "MRP Controller
          dsnam(40), "MRP Controller Name
          ernam(40), "User ID (Created By)
          gp_perc(20), "GP% = GP/(UNBILLING AMOUNT)
          totalgp_cny(30),  "IF totalgp IS NOT CNY Total GP TO  CNY
          supplypo(15),
          supplyitem(10),
          supplypo_up(30),
          curr2(10), "Currency
          totalgp2(30).

  DATA: END OF i_mail.

  DATA:g_ceh(1) TYPE c.
  DATA:l_date_gp LIKE sy-datum.
  DATA:l_lastmon_date LIKE sy-datum.
  DATA:l_gp_perc LIKE mard-labst.
  DATA:l_year LIKE mbewh-lfgja.
  DATA:l_month LIKE mbewh-lfmon.
  DATA:l_lbkum LIKE mbewh-lbkum.
  DATA t_berid LIKE mdlv-berid .
  DATA:t_werks LIKE marc-werks.
  DATA:t_matnr LIKE marc-matnr.
  DATA:l_ukurs LIKE tcurr-ukurs.
  DATA:l_ukurs3 LIKE tcurr-ukurs.
  DATA:l_ukurs2 LIKE tcurr-ukurs.
  DATA:l_netpr LIKE ekpo-netpr.
  DATA:l_peinh LIKE ekpo-peinh.
  DATA:l_waers LIKE ekko-waers.
  DATA:l_ebeln LIKE ekpo-ebeln.
  DATA:l_ebelp LIKE ekpo-ebelp.
  DATA: exrate_gdatu  LIKE tcurr-gdatu.
  DATA:l_month_first LIKE sy-datum.
  DATA: i_mdez  LIKE mdps OCCURS 20 WITH HEADER LINE.
  DATA: l_bdate LIKE sy-datum.
  DATA: l_strdate(10) TYPE c.
  DATA:l_sum_menge LIKE ekbe-menge.
  DATA:l_sum_dmbtr LIKE ekbe-dmbtr.
  DATA:l_newactcost  TYPE p DECIMALS 5.  "Actual Cost

  DATA:l_newactcost8  TYPE p DECIMALS 5.  "Actual Cost
  DATA:l_totalgp8  LIKE it_gp_down-totalgp.  "Actual Cost
  DATA:l_unitgp8   LIKE it_gp_down-unitgp.  "Actual Cost



  DATA:l_netwr LIKE ekpo-netwr.
  DATA:l_menge LIKE ekpo-menge.
  DATA:l_sum_netwr LIKE ekpo-netwr.
  DATA:l_sum_mdmenge LIKE ekpo-menge.
  DATA:l_lbkum_menge LIKE ekpo-menge.
  DATA:l_beskz LIKE marc-beskz.
  DATA:l_stprs_s LIKE ztco_zbco551-stprs_s.
  DATA:l_peinh551 LIKE ztco_zbco551-peinh.
  DATA ldate_workdate LIKE eket-eindt.
  DATA: l_count TYPE i.
  DATA:l_eknam LIKE t024-eknam.
  DATA: l_103 LIKE mard-labst.
  DATA: l_13 LIKE mard-labst.
  DATA:l_bukrs LIKE t001-bukrs.
  DATA: l_zhscode LIKE ziebtmpwl-zhscode.
  DATA: l_zgstax1 LIKE ziebtaxper-zgstax1.
  DATA: l_ztstax1 LIKE ziebtaxper-ztstax1.
  DATA: i_zgetcost TYPE  zgetcost2 .
  DATA: l_flag_iebtax(1) TYPE c.
  DATA: i_daigou(1) TYPE c.
  DATA: xmatnr LIKE mara-matnr.
  DATA:l_mtart LIKE mara-mtart.
  DATA:i_mblnr LIKE mkpf-mblnr.
  DATA:l_matnr LIKE marc-matnr.




  "  i_mail-matnr = 'Material Number'.
  "  i_mail-werks = 'Plant'.
  "  i_mail-lgort = 'Storage'.
  "  i_mail-lgpbe = 'Storage BIN'.
  "  i_mail-menge = 'QTY'.

  DATA: l_object(15) TYPE c.

  CLEAR l_object.

  l_object = 'GP-LIST'.
*
*  CLEAR l_zmalgp.
*  CONCATENATE  s_werks-low  'STO_DEL' INTO l_zmalgp.

  SELECT smtp_addr
   INTO lt_mailrecipients-receiver
   FROM ztmm_15
     WHERE zmalgp = 'ZRSD28B-GP' .

    lt_mailrecipients-rec_type = 'U'.
    lt_mailrecipients-com_type = 'INT'.
    lt_mailrecipients-notif_del = 'X'.
    lt_mailrecipients-notif_ndel = 'X'.
    APPEND lt_mailrecipients.
    CLEAR lt_mailrecipients.
  ENDSELECT.

  lt_mailtxt = 'Dear All:'.
  APPEND lt_mailtxt. CLEAR lt_mailtxt.
  lt_mailtxt = ' '.
  APPEND lt_mailtxt. CLEAR lt_mailtxt.

  lt_mailtxt = 'GPrule: '.
  APPEND lt_mailtxt. CLEAR lt_mailtxt.
  lt_mailtxt = ' '.
  APPEND lt_mailtxt. CLEAR lt_mailtxt.

  lt_mailtxt = 'Confirm Date1096)'.
  APPEND lt_mailtxt. CLEAR lt_mailtxt.
  lt_mailtxt = 'CNY GP>500GP%>5%(GP%>5%),CNY GP<-500'.
  APPEND lt_mailtxt. CLEAR lt_mailtxt.

  i_mail-splant = 'Delv/Supply Plant'.
  i_mail-vbeln = 'SO/STO Number'.
  i_mail-posnr = 'Order Item'.
  i_mail-matnr = 'Material'.
  i_mail-mtart = 'Material Type'.
  i_mail-kbmeng = 'Unbilling Qty'.
  i_mail-oedatu = 'Order Date'.
  i_mail-cedatu = 'Confirm Date'.
  i_mail-netpr = 'Unit Price'.
  i_mail-opamt = 'Unbilling Amount'.
  i_mail-curr = 'Currency'.
  i_mail-actcost = 'Actual Cost'.
  i_mail-unitgp = 'Unit GP'.
  i_mail-totalgp = 'Total GP'.
  i_mail-werks = 'Plant'.
  i_mail-otype = 'Order Type'.
  i_mail-dispo = 'MC'.
  i_mail-dsnam = 'MC Name'.
  i_mail-ernam = 'User ID'.
  i_mail-gp_perc = 'GP%'.
  i_mail-totalgp_cny = 'Total GP(CNY)'.
  i_mail-supplypo = 'Supply PO'.
  i_mail-supplyitem = 'Supply Item'.
  i_mail-supplypo_up = 'Unit Price(SupplyPO)'.
  i_mail-curr2 = 'Currency(SupplyPO)'.
  i_mail-totalgp2 = 'Total GP(SupplyPO)'.


  APPEND i_mail.
  CLEAR i_mail.

  " l_date_gp = sy-datum + 10.
  CLEAR: ldate_workdate,l_count.     "it_gp_down-cedatu10
  l_date_gp = sy-datum.
  DO  30 TIMES.
    CALL FUNCTION 'DATE_CONVERT_TO_FACTORYDATE'
      EXPORTING
        correct_option      = '+'
        date                = l_date_gp
        factory_calendar_id = 'CN'
      IMPORTING
        date                = ldate_workdate.

    IF l_date_gp = ldate_workdate. "
      l_date_gp = l_date_gp + 1.
      l_count = l_count + 1.
    ELSE.
      l_date_gp = ldate_workdate.
    ENDIF.
    IF l_count > 10.
      EXIT.
    ENDIF.
  ENDDO.


  CLEAR:l_lastmon_date.
  "MBEWH
  CALL FUNCTION 'CCM_GO_BACK_MONTHS'
    EXPORTING
      currdate   = sy-datum
      backmonths = 1
    IMPORTING
      newdate    = l_lastmon_date.

  l_year = l_lastmon_date(4).
  l_month = l_lastmon_date+4(2).
  CLEAR:g_ceh.
  DATA:l_ebeln2 LIKE ekpo-ebeln.
  DATA:l_ebelp2 LIKE ekpo-ebelp.
  DATA:l_reslo LIKE ekpo-reslo.
  LOOP AT it_gp_down.

    IF it_gp_down-cedatu > l_date_gp. "3.7AKMCcomfirm Date10
      CONTINUE.
    ENDIF.
    "CKH1/CKH2ZFINZOEM,ZSEM98*/CM-98*SQR-*&SQF-
    IF  it_gp_down-matnr(3) = 'SQR-' OR it_gp_down-matnr(3) = 'SQF-'.
    ELSE.
      IF it_gp_down-splant(3) = 'CKH'.
        IF it_gp_down-mtart = 'ZFIN' OR it_gp_down-mtart = 'ZOEM'.
          CONTINUE.
        ENDIF.
        IF it_gp_down-mtart = 'ZSEM'.
          IF  it_gp_down-matnr(2) = '98' OR it_gp_down-matnr(10) = '0000000098' OR  it_gp_down-matnr(4) = 'CM-98'.
            CONTINUE.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
*    IF it_gp_down-splant(3) = 'CKH1'. "20221230 mark for Jenny
*      CLEAR:l_ebeln2,l_ebelp2.
*      l_ebeln2 = it_gp_down-vbeln.
*      l_ebelp2 = it_gp_down-posnr.
*
**      CALL FUNCTION 'CONVERSION_EXIT_alpha_INPUT'
**        EXPORTING
**          input  = l_ebeln2
**        IMPORTING
**          output = l_ebeln2.
**
**      CALL FUNCTION 'CONVERSION_EXIT_alpha_INPUT'
**        EXPORTING
**          input  = l_ebelp2
**        IMPORTING
**          output = l_ebelp2.
*      CLEAR:l_reslo.
*      SELECT SINGLE reslo INTO l_reslo FROM ekpo  WHERE ebeln = l_ebeln2 AND ebelp = l_ebelp2.
*      IF l_reslo(1) = 'R'.
*        CONTINUE.
*      ENDIF.
*    ENDIF.

    CLEAR: i_mail,l_netpr,l_peinh,l_waers,l_ebeln,l_ebelp,l_ukurs2,l_beskz,l_newactcost,l_stprs_s,l_peinh551,l_flag_iebtax,l_matnr.
    CLEAR:i_zgetcost.


    MOVE-CORRESPONDING it_gp_down TO i_mail.


    "BEGIN 20250929 ADD NEW LOGIC FOR JENNY
    "1.PlanUSH*/EUH*,B2/B3/B4 STD
    "2.DelvCKH1B2/B3/B4=B1B2B3*1+5%
    "3.DelvCKH1,B2/B3/B4B2B3B4*(1.03+)+ (B2B3B4*(1.03+)*(13%-))/(1-13%+)
    IF it_gp_down-werks(3) = 'USH' OR it_gp_down-werks(3) = 'EUH'.
      l_matnr = it_gp_down-matnr.

      CALL FUNCTION 'Z_GET_TARGET_COST'
        EXPORTING
          pi_werks         = it_gp_down-splant
          pi_matnr         = l_matnr
          pi_convert       = 'X'
          pi_price_convert = 'X'
        IMPORTING
          pe_zgetcost      = i_zgetcost
        EXCEPTIONS
          no_found         = 1
          OTHERS           = 2.


      IF  i_zgetcost IS INITIAL.
        i_zgetcost-stprs = 0.
      ENDIF.

      l_flag_iebtax = 'U'. "US OR EU

*      IF i_zgetcost-stprs <= 100 .
*        it_gp_down-actcost = it_gp_down-actcost * '1.50'.
*      ENDIF.
*
*      IF i_zgetcost-stprs > 100  AND i_zgetcost-stprs <= 400.
*        it_gp_down-actcost = it_gp_down-actcost * '1.35'.
*      ENDIF.
*
*      IF i_zgetcost-stprs > 400  AND i_zgetcost-stprs <= 3000.
*        it_gp_down-actcost = it_gp_down-actcost * '1.25'.
*      ENDIF.
*
*      IF i_zgetcost-stprs > 3000 .
*        it_gp_down-actcost = it_gp_down-actcost * '1.15'.
*      ENDIF.
    ELSE.
      IF it_gp_down-splant = 'CKH1'.
        " it_gp_down-actcost = it_gp_down-actcost * '1.05'.
        l_flag_iebtax = 'C'. "CKH1
      ELSE.
        CLEAR:l_bukrs,l_zhscode,l_zgstax1,l_ztstax1.

        l_103 = 103 / 100.
        l_13 = 13 / 100.
        l_flag_iebtax = 'X'.

        SELECT SINGLE bukrs zhscode INTO ( l_bukrs,l_zhscode )
         FROM ziebtmpwl   "
        WHERE matnr = it_gp_down-matnr.
        IF l_zhscode IS INITIAL.
          SELECT SINGLE bukrs zhscode INTO ( l_bukrs,l_zhscode )
            FROM ziebtbswl   "
           WHERE matnr = it_gp_down-matnr.
        ENDIF.

        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
          EXPORTING
            input  = l_zhscode
          IMPORTING
            output = l_zhscode.

        SELECT SINGLE zgstax1 ztstax1 INTO ( l_zgstax1,l_ztstax1 )
          FROM ziebtaxper
         WHERE bukrs = l_bukrs AND zhscode = l_zhscode.

        IF l_zgstax1 >= 1. "20251114 
          l_zgstax1 = l_zgstax1 / 100.
        ENDIF.

        IF l_ztstax1 >= 1.
          l_ztstax1 = l_ztstax1 / 100.
        ENDIF.

*        IF sy-subrc = 0.
*          l_103 = 103 / 100.
*          l_13 = 13 / 100.
*          l_flag_iebtax = 'X'.
*          "it_gp_down-actcost = it_gp_down-actcost * ( l_103 + l_zgstax1 ) + ( it_gp_down-actcost * ( l_103 + l_zgstax1 ) * ( l_13 - l_ztstax1 ) ) / ( 1 - l_13 + l_ztstax1  ).
*        ENDIF.

        IF it_gp_down-werks = 'TW*'. "TWLINBO ELSE. "eoa1117710 for  
          CLEAR:i_daigou,xmatnr,l_mtart,i_mblnr.
          xmatnr = it_gp_down-matnr.
          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
            EXPORTING
              input  = xmatnr
            IMPORTING
              output = xmatnr.

          SELECT SINGLE mtart INTO l_mtart FROM mara WHERE matnr = it_gp_down-matnr.

          IF  ( l_mtart = 'ZRAW' OR l_mtart = 'ZSEM' OR l_mtart = 'ZPER' ) AND xmatnr+0(2) <> '98' AND
             ( it_gp_down-splant+(2) = 'CK' OR it_gp_down-splant = 'ACK1' ).
            SELECT SINGLE mblnr INTO i_mblnr FROM mseg
             WHERE matnr = it_gp_down-matnr AND ( werks LIKE 'CK%' OR werks = 'ACK1' ) AND bwart = '101' AND aufnr <> '' AND budat_mkpf < sy-datum.
            IF sy-subrc <> 0.
              SELECT SINGLE mblnr INTO i_mblnr FROM mseg
               WHERE matnr = it_gp_down-matnr AND ( werks LIKE 'CK%' OR werks = 'ACK1' ) AND bwart = '261' AND budat_mkpf < sy-datum.
              IF sy-subrc <> 0. "TW ->0
                l_ztstax1 = 0.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.

      ENDIF.
    ENDIF.

    "END20250929




    IF it_gp_down-otype = 'STO' AND i_mail-ernam(3) = 'B2B'.  "DOUBLE ADD ON 20250926 REPLACE USERID
      CLEAR:l_eknam.
      SELECT SINGLE eknam INTO l_eknam FROM t024 WHERE ekgrp = ( SELECT  ekgrp FROM ekko WHERE ebeln = it_gp_down-vbeln ).
      IF l_eknam IS NOT INITIAL .
        i_mail-ernam = l_eknam.
      ENDIF.
    ENDIF.


*    CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'
*      EXPORTING
*        input  = it_gp_down-matnr
*      IMPORTING
*        output = it_gp_down-matnr.


    "it_gp_down-totalgp CNYCNY
    CLEAR:l_month_first,exrate_gdatu.
*    if it_gp_down-cedatu is initial or it_gp_down-cedatu = '00000000' or it_gp_down-cedatu = '' .
*      it_gp_down-cedatu = sy-datum.
*    endif.
    it_gp_down-cedatu = sy-datum.
    CONCATENATE it_gp_down-cedatu(6) '01' INTO l_month_first.
    CONVERT DATE l_month_first INTO INVERTED-DATE exrate_gdatu.
    CLEAR:l_ukurs,l_ukurs3.
    IF it_gp_down-curr = 'EUR'.
      SELECT SINGLE ukurs INTO l_ukurs FROM tcurr
    WHERE kurst = 'EURX' AND fcurr = it_gp_down-curr AND tcurr = 'CNY' AND  gdatu = exrate_gdatu.
    ELSE.
      SELECT SINGLE ukurs INTO l_ukurs FROM tcurr
       WHERE kurst = 'M' AND fcurr = it_gp_down-curr AND tcurr = 'CNY' AND  gdatu = exrate_gdatu.
    ENDIF.

*    SELECT SINGLE ukurs INTO l_ukurs3 FROM tcurr
*     WHERE kurst = 'M' AND fcurr = 'CNY' AND tcurr = it_gp_down-curr AND  gdatu = exrate_gdatu.
*    IF l_ukurs3 < 0.
*      l_ukurs3 = l_ukurs3 * ( -1 ).
*    ENDIF.
    IF l_ukurs < 0.
      l_ukurs = l_ukurs * ( -1 ).
      i_mail-totalgp_cny = it_gp_down-totalgp / l_ukurs.

    ELSE.
      IF it_gp_down-curr = 'CNY'.
        i_mail-totalgp_cny = it_gp_down-totalgp.
      ELSE."CNYCNY
        i_mail-totalgp_cny = it_gp_down-totalgp * l_ukurs.
      ENDIF.
    ENDIF.

    "CKB6 ZRAWSPK2Ejane
    CLEAR:l_beskz.
    IF it_gp_down-splant = 'CKB6' AND it_gp_down-mtart = 'ZRAW'. "MAKE BY ADVANTECH.
      SELECT SINGLE beskz INTO l_beskz FROM marc WHERE matnr = it_gp_down-matnr AND werks = it_gp_down-splant.
    ENDIF.

    "MBEWH
    CLEAR l_lbkum."BALANCE STOCK
    SELECT SINGLE lbkum INTO l_lbkum FROM mbewh
            WHERE matnr = it_gp_down-matnr
              AND bwkey = it_gp_down-splant
              AND lfgja = l_year
              AND lfmon = l_month
              AND vprsv = 'V'.
    "BEGINMD04SHIPPING NOTICE
    IF ( it_gp_down-kbmeng - l_lbkum ) > 0  AND  l_beskz <> 'E'. "A1>A2ACTUAL PRICEshipping notice NETPR
      "CK*ZSEMshipping noticeZRAWZBCO55
      CLEAR:l_beskz,l_newactcost,l_stprs_s,l_peinh551.
      SELECT SINGLE beskz INTO l_beskz FROM marc WHERE matnr = it_gp_down-matnr AND werks = it_gp_down-splant.

      IF it_gp_down-splant(2) = 'CK' AND it_gp_down-mtart = 'ZSEM' AND  l_beskz = 'E'. "MAKE BY ADVANTECH.
*        CLEAR:l_beskz.
*        SELECT SINGLE beskz INTO l_beskz FROM marc WHERE matnr = it_gp_down-matnr AND werks = it_gp_down-splant.
*        IF l_beskz = 'E'. "MAKE BY ADVANTECH
        CLEAR:l_stprs_s,l_peinh551.
        SELECT SINGLE stprs_s peinh INTO ( l_stprs_s,l_peinh551 ) FROM ztco_zbco551
          WHERE matnr = it_gp_down-matnr AND werks = it_gp_down-splant AND budat = sy-datum.
        IF l_peinh551 = 0.
          l_peinh551 = 1.
        ENDIF.
        l_newactcost = l_stprs_s / l_peinh551.
        IF it_gp_down-curr <> 'CNY'.
          l_newactcost = l_newactcost / l_ukurs.
        ENDIF.
        IF l_newactcost = 0.
          i_mail-supplypo_up = it_gp_down-actcost.
        ELSE.
          i_mail-supplypo_up = l_newactcost.
        ENDIF.

        IF l_flag_iebtax = 'X'.  "20251009 for ieb tax
          i_mail-supplypo_up = i_mail-supplypo_up * ( l_103 + l_zgstax1 ) + ( i_mail-supplypo_up * ( l_103 + l_zgstax1 ) * ( l_13 - l_ztstax1 ) ) / ( 1 - l_13 + l_ztstax1  ).
          " ELSEIF l_flag_iebtax = 'T'. "IEB TAX = 0

        ELSEIF l_flag_iebtax = 'C'.
          i_mail-supplypo_up = i_mail-supplypo_up * '1.05'.

        ELSEIF l_flag_iebtax = 'U'.
          IF i_zgetcost-stprs <= 100 .
            i_mail-supplypo_up = i_mail-supplypo_up * '1.50'.
          ENDIF.

          IF i_zgetcost-stprs > 100  AND i_zgetcost-stprs <= 400.
            i_mail-supplypo_up = i_mail-supplypo_up * '1.35'.
          ENDIF.

          IF i_zgetcost-stprs > 400  AND i_zgetcost-stprs <= 3000.
            i_mail-supplypo_up = i_mail-supplypo_up * '1.25'.
          ENDIF.

          IF i_zgetcost-stprs > 3000 .
            i_mail-supplypo_up = i_mail-supplypo_up * '1.15'.
          ENDIF.
        ENDIF.


        i_mail-totalgp2 = ( it_gp_down-netpr -  i_mail-supplypo_up ) * i_mail-kbmeng. "act costtotalgp
        IF it_gp_down-curr = 'CNY'.
          i_mail-totalgp_cny = i_mail-totalgp2.
        ELSE.
          i_mail-totalgp_cny = i_mail-totalgp2 * l_ukurs.
        ENDIF.

        IF ( it_gp_down-opamt - 0 ) <> 0.
          i_mail-gp_perc =  ( i_mail-totalgp2 * 100 ) / it_gp_down-opamt.
          " concatenate i_mail-gp_perc '%' into i_mail-gp_perc.
        ELSE.
          i_mail-gp_perc = 0.
        ENDIF.
        "  ENDIF.
      ELSE.


        ""A1>A2A1<(A2+A3)"  A3:GR SUM(QTY)
        CLEAR:l_strdate,l_bdate.
        CONCATENATE sy-datum(6) '01' INTO l_strdate.
        l_bdate = l_strdate.

        CLEAR:l_sum_menge,l_sum_dmbtr,l_newactcost.


        "CNY,CNY,USD
        SELECT SUM( menge ) SUM( dmbtr ) INTO ( l_sum_menge,l_sum_dmbtr ) FROM ekbe  "CNY.AMT,ORIGIN.AMT,CUT
        WHERE matnr = it_gp_down-matnr AND werks = it_gp_down-splant  AND vgabe = '1' AND shkzg = 'S' AND wrbtr > 0 AND budat BETWEEN l_bdate AND sy-datum.






        " i_mail-supplypo_up = (A2*B2+A3*B3)/(A2+A3)
        "l_newactcost = ( l_lbkum * it_gp_down-actcost + l_SUM_dmbtr ) / ( L_SUM_menge + l_lbkum ).
        IF it_gp_down-curr = 'CNY'.   ""A1>A2A1<(A2+A3)"  A3:GR SUM(QTY)
          l_newactcost = ( l_lbkum * it_gp_down-actcost + l_sum_dmbtr ) / ( l_sum_menge + l_lbkum ).
          IF l_flag_iebtax = 'X'.  "20251009 for ieb tax
            l_newactcost = l_newactcost * ( l_103 + l_zgstax1 ) + ( l_newactcost * ( l_103 + l_zgstax1 ) * ( l_13 - l_ztstax1 ) ) / ( 1 - l_13 + l_ztstax1  ).
            "ELSEIF l_flag_iebtax = 'T'. "IEB TAX = 0

          ELSEIF l_flag_iebtax = 'C'.
            l_newactcost = l_newactcost * '1.05'.

          ELSEIF l_flag_iebtax = 'U'.
            IF i_zgetcost-stprs <= 100 .
              l_newactcost = l_newactcost * '1.50'.
            ENDIF.

            IF i_zgetcost-stprs > 100  AND i_zgetcost-stprs <= 400.
              l_newactcost = l_newactcost * '1.35'.
            ENDIF.

            IF i_zgetcost-stprs > 400  AND i_zgetcost-stprs <= 3000.
              l_newactcost = l_newactcost * '1.25'.
            ENDIF.

            IF i_zgetcost-stprs > 3000 .
              l_newactcost = l_newactcost * '1.15'.
            ENDIF.

          ENDIF.
          i_mail-supplypo_up = l_newactcost.
        ELSE. "cny*
          IF l_ukurs = 0.
            BREAK-POINT.
          ENDIF.
          l_sum_dmbtr = l_sum_dmbtr / l_ukurs.
          l_newactcost = ( l_lbkum * it_gp_down-actcost + l_sum_dmbtr ) / ( l_sum_menge + l_lbkum ).
          IF l_flag_iebtax = 'X'.  "20251009 for ieb tax
            l_newactcost = l_newactcost * ( l_103 + l_zgstax1 ) + ( l_newactcost * ( l_103 + l_zgstax1 ) * ( l_13 - l_ztstax1 ) ) / ( 1 - l_13 + l_ztstax1  ).
            "ELSEIF l_flag_iebtax = 'T'."IEB TAX = 0

          ELSEIF l_flag_iebtax = 'C'.
            l_newactcost = l_newactcost * '1.05'.

          ELSEIF l_flag_iebtax = 'U'.
            IF i_zgetcost-stprs <= 100 .
              l_newactcost = l_newactcost * '1.50'.
            ENDIF.

            IF i_zgetcost-stprs > 100  AND i_zgetcost-stprs <= 400.
              l_newactcost = l_newactcost * '1.35'.
            ENDIF.

            IF i_zgetcost-stprs > 400  AND i_zgetcost-stprs <= 3000.
              l_newactcost = l_newactcost * '1.25'.
            ENDIF.

            IF i_zgetcost-stprs > 3000 .
              l_newactcost = l_newactcost * '1.15'.
            ENDIF.
          ENDIF.
          i_mail-supplypo_up = l_newactcost.
        ENDIF.
        CLEAR:l_lbkum_menge.
        l_lbkum_menge = ( l_lbkum + l_sum_menge ).  "= + 

        IF ( it_gp_down-kbmeng - l_lbkum_menge ) <= 0.
          IF ( i_mail-supplypo_up - 0 ) = 0.
            i_mail-supplypo_up = i_mail-actcost.
          ENDIF.
          i_mail-totalgp2 = ( it_gp_down-netpr -  i_mail-supplypo_up ) * i_mail-kbmeng. "act costtotalgp
          "i_mail-totalgp_CNY,l_ukurs
          IF it_gp_down-curr = 'CNY'.
            i_mail-totalgp_cny = i_mail-totalgp2.
          ELSE.
            i_mail-totalgp_cny = i_mail-totalgp2 * l_ukurs.
          ENDIF.
          IF ( it_gp_down-opamt - 0 ) <> 0.
            i_mail-gp_perc =  ( i_mail-totalgp2 * 100 ) / it_gp_down-opamt.
            " concatenate i_mail-gp_perc '%' into i_mail-gp_perc.
          ELSE.
            i_mail-gp_perc = 0.
          ENDIF.
        ELSE. "MD04 SHIPPING NOTICE
          CLEAR: i_mdez,t_berid.
          REFRESH: i_mdez.
          t_berid = it_gp_down-splant.
          t_matnr = it_gp_down-matnr.
          t_werks = it_gp_down-splant.
          CALL FUNCTION 'MD_STOCK_REQUIREMENTS_LIST_API'
            EXPORTING
              matnr                    = t_matnr
              werks                    = t_werks
              berid                    = t_berid
            TABLES
              mdpsx                    = i_mdez
            EXCEPTIONS
              material_plant_not_found = 1
              plant_not_found          = 2
              OTHERS                   = 3.

          SORT i_mdez BY dat00.
          CLEAR:l_ebeln,l_ebelp,l_sum_netwr,l_sum_mdmenge.
          LOOP AT i_mdez WHERE  delkz = 'LA'.
            l_ebeln = i_mdez-delnr.   "ebeln
            l_ebelp = i_mdez-delps.    "ebelp

            CLEAR: l_netwr,l_menge,l_waers,l_netpr,l_peinh.
            SELECT SINGLE waers INTO l_waers FROM ekko WHERE ebeln = l_ebeln.
            SELECT SINGLE netpr peinh  INTO ( l_netpr,l_peinh )   FROM ekpo WHERE ebeln = l_ebeln AND ebelp = l_ebelp.

            IF l_peinh IS INITIAL OR l_peinh = 0.
              l_peinh = 1.
            ENDIF.
            l_netwr = ( l_netpr / l_peinh ) * i_mdez-mng01. "MD04 QTY MAY BE DIFF WITH PO QTY,SO REDO IT FOR SUM AMOUNT OF MD04 .
            IF it_gp_down-curr = l_waers. "CURRENCY SAME,
              l_sum_netwr = l_sum_netwr + l_netwr.

            ELSE.  "CURRENCY different,",POit_gp_down
              CLEAR:l_ukurs2.
              IF ( l_waers = 'CNY' AND it_gp_down-curr = 'EUR' ) OR ( l_waers = 'EUR' AND it_gp_down-curr = 'CNY').
                SELECT SINGLE ukurs INTO l_ukurs2 FROM tcurr
               WHERE kurst = 'EURX' AND fcurr = l_waers  AND tcurr = it_gp_down-curr AND  gdatu = exrate_gdatu.
              ELSE.
                SELECT SINGLE ukurs INTO l_ukurs2 FROM tcurr
                  WHERE kurst = 'M' AND fcurr = l_waers  AND tcurr = it_gp_down-curr AND  gdatu = exrate_gdatu.
                IF sy-subrc <> 0.
                  SELECT SINGLE ukurs INTO l_ukurs2 FROM tcurr
                   WHERE  fcurr = l_waers  AND tcurr = it_gp_down-curr AND  gdatu = exrate_gdatu.
                ENDIF.
              ENDIF.
              IF l_ukurs2 < 0.  "
                l_ukurs2 = l_ukurs2 * ( -1 ).
                l_sum_netwr = l_sum_netwr + ( l_netwr / l_ukurs2 ).
              ELSE.
                l_sum_netwr = l_sum_netwr + l_netwr * l_ukurs2.
              ENDIF.
            ENDIF.
            l_sum_mdmenge = l_sum_mdmenge + i_mdez-mng01.
            "
            CLEAR:l_lbkum_menge.
            l_lbkum_menge = ( l_sum_menge + l_lbkum + l_sum_mdmenge ).  "= + 
            IF ( l_lbkum_menge - it_gp_down-kbmeng ) >= 0.
              EXIT.
            ENDIF.
          ENDLOOP.

          "(A2*B2+A3*B3+A4*B4)/(A2+A3+A4)
          CLEAR:l_newactcost.
          l_newactcost = ( l_lbkum * it_gp_down-actcost + l_sum_dmbtr + l_sum_netwr ) / ( l_sum_menge + l_lbkum + l_sum_mdmenge ).

          IF l_flag_iebtax = 'X'.  "20251009 for ieb tax
            l_newactcost = l_newactcost * ( l_103 + l_zgstax1 ) + ( l_newactcost * ( l_103 + l_zgstax1 ) * ( l_13 - l_ztstax1 ) ) / ( 1 - l_13 + l_ztstax1  ).
            "ELSEIF l_flag_iebtax = 'T'. "IEB TAX = 0

          ELSEIF l_flag_iebtax = 'C'.
            l_newactcost = l_newactcost * '1.05'.

          ELSEIF l_flag_iebtax = 'U'.
            IF i_zgetcost-stprs <= 100 .
              l_newactcost = l_newactcost * '1.50'.
            ENDIF.

            IF i_zgetcost-stprs > 100  AND i_zgetcost-stprs <= 400.
              l_newactcost = l_newactcost * '1.35'.
            ENDIF.

            IF i_zgetcost-stprs > 400  AND i_zgetcost-stprs <= 3000.
              l_newactcost = l_newactcost * '1.25'.
            ENDIF.

            IF i_zgetcost-stprs > 3000 .
              l_newactcost = l_newactcost * '1.15'.
            ENDIF.
          ENDIF.

          i_mail-supplypo_up = l_newactcost.

          IF ( i_mail-supplypo_up - 0 )  = 0. "MD04,,"20221201
            i_mail-totalgp2 = i_mail-totalgp.
          ELSE.
            i_mail-totalgp2 = ( it_gp_down-netpr - i_mail-supplypo_up ) * i_mail-kbmeng. "act costtotalgp
          ENDIF.
          "i_mail-totalgp_CNY,l_ukurs
          IF it_gp_down-curr = 'CNY'.
            i_mail-totalgp_cny = i_mail-totalgp2.
          ELSE.
            i_mail-totalgp_cny = i_mail-totalgp2 * l_ukurs.
          ENDIF.


          IF ( it_gp_down-opamt - 0 ) <> 0.
            i_mail-gp_perc =  ( i_mail-totalgp2 * 100 ) / it_gp_down-opamt.
          ELSE.
            i_mail-gp_perc = 0.
          ENDIF.
        ENDIF.



*      CLEAR: i_mdez,t_berid.
*      REFRESH: i_mdez.
*      t_berid = it_gp_down-splant.
*      t_matnr = it_gp_down-matnr.
*      t_werks = it_gp_down-splant.
*      CALL FUNCTION 'MD_STOCK_REQUIREMENTS_LIST_API'
*        EXPORTING
*          matnr                    = t_matnr
*          werks                    = t_werks
*          berid                    = t_berid
*        TABLES
*          mdezx                    = i_mdez
*        EXCEPTIONS
*          material_plant_not_found = 1
*          plant_not_found          = 2
*          OTHERS                   = 3.
*
*      SORT i_mdez BY sort0.
*      CLEAR:L_ebeln,L_ebelp.
*      LOOP AT i_mdez WHERE  delkz = 'LA'.
*        L_ebeln = i_mdez-extra(10).  "ebeln
*        L_ebelp = i_mdez-extra+11(5). "ebelp
*        EXIT.
*      ENDLOOP.
*      "shipping notice run jobGR
*      IF L_ebeln IS INITIAL.
*        CLEAR:l_strdate,l_bdate.
*        CONCATENATE sy-datum(6) '01' INTO l_strdate.
*        l_bdate = l_strdate.
*        SELECT ebeln ebelp INTO ( L_ebeln,L_ebelp ) FROM ekbe
*          WHERE matnr = it_gp_down-matnr AND vgabe = '1' AND shkzg = 'S' AND wrbtr > 0 AND budat BETWEEN l_bdate AND sy-datum
*          ORDER BY budat.
*          EXIT.
*        ENDSELECT.
*      ENDIF.
*
*
*      CLEAR: l_NETPR,l_PEINH,l_waers.
*      SELECT SINGLE waers INTO l_waers FROM ekko WHERE ebeln = L_ebeln.
*      SELECT SINGLE netpr peinh  INTO ( l_NETPR,l_PEINH )  FROM ekpo WHERE ebeln = L_ebeln AND ebelp = L_ebelp.
*      i_mail-curr2 = l_waers.
*
*
*      IF l_NETPR = 0. "PO up is zero totalgp
*        " 2.GP%----GP%=GP/
*        IF it_gp_down-opamt <> 0.
*          i_mail-gp_perc =  ( it_gp_down-totalgp * 100 ) / it_gp_down-opamt.
*          " concatenate i_mail-gp_perc '%' into i_mail-gp_perc.
*        ELSE.
*          i_mail-gp_perc = 0.
*        ENDIF.
*      ELSE.
*        IF it_gp_down-curr = l_waers. "CURRENCY SAME
*          IF l_PEINH <> 0.
*            i_mail-supplypo_up = l_NETPR / l_PEINH.
*          ENDIF.
*          " it_gp_down-totalgp = ( netpr -  actcost ) * Unbilling Qty.  "JANE
*          i_mail-totalgp2 = ( it_gp_down-netpr -  i_mail-supplypo_up ) * i_mail-kbmeng. "act costtotalgp
*          IF it_gp_down-opamt <> 0.
*            i_mail-gp_perc =  ( i_mail-totalgp2 * 100 ) / it_gp_down-opamt.
*            " concatenate i_mail-gp_perc '%' into i_mail-gp_perc.
*          ELSE.
*            i_mail-gp_perc = 0.
*          ENDIF.
*        ELSE.  "CURRENCY different,
*          IF l_PEINH <> 0.
*            i_mail-supplypo_up = l_NETPR / l_PEINH.
*          ENDIF.
*          ",POit_gp_down
*          CLEAR:l_ukurs2.
*
*          SELECT SINGLE ukurs INTO l_ukurs2 FROM tcurr
*            WHERE kurst = 'M' AND fcurr = l_waers  AND tcurr = it_gp_down-curr AND  gdatu = exrate_gdatu.
*          i_mail-supplypo_up = i_mail-supplypo_up *  l_ukurs2.
*
*
*          "it_gp_down
*          i_mail-totalgp2 = ( it_gp_down-netpr -  i_mail-supplypo_up ) * i_mail-kbmeng. "act costtotalgp
*
*          IF it_gp_down-opamt <> 0.
*            i_mail-gp_perc =  ( i_mail-totalgp2 * 100 ) / it_gp_down-opamt.
*            " concatenate i_mail-gp_perc '%' into i_mail-gp_perc.
*          ELSE.
*            i_mail-gp_perc = 0.
*          ENDIF.
*          "i_mail-totalgp_CNY,l_ukurs
*          IF it_gp_down-curr = 'CNY'.
*            i_mail-totalgp_cny = i_mail-totalgp2.
*          ELSE.
*            i_mail-totalgp_cny = i_mail-totalgp2 * l_ukurs.
*          ENDIF.
*        ENDIF.
*      ENDIF.
*      i_mail-supplypo   = L_ebeln.
*      i_mail-supplyitem = L_ebelp.
      ENDIF.
    ELSE.

      CLEAR:l_totalgp8,l_newactcost8,l_unitgp8.

      " 2.GP%----GP%=GP/
      IF ( it_gp_down-opamt - 0 ) <> 0.
        "i_mail-gp_perc =  ( it_gp_down-totalgp * 100 ) / it_gp_down-opamt.
        "GP

        IF l_flag_iebtax = 'X'.  "20251009 for ieb tax
          l_newactcost8 = it_gp_down-actcost * ( l_103 + l_zgstax1 ) + ( it_gp_down-actcost * ( l_103 + l_zgstax1 ) * ( l_13 - l_ztstax1 ) ) / ( 1 - l_13 + l_ztstax1  ).
          " ELSEIF l_flag_iebtax = 'T'. "IEB TAX = 0
        ELSEIF l_flag_iebtax = 'C'.
          l_newactcost8 = it_gp_down-actcost * '1.05'.

        ELSEIF l_flag_iebtax = 'U'.
          IF i_zgetcost-stprs <= 100 .
            l_newactcost8 = it_gp_down-actcost * '1.50'.
          ENDIF.

          IF i_zgetcost-stprs > 100  AND i_zgetcost-stprs <= 400.
            l_newactcost8 = it_gp_down-actcost * '1.35'.
          ENDIF.

          IF i_zgetcost-stprs > 400  AND i_zgetcost-stprs <= 3000.
            l_newactcost8 = it_gp_down-actcost * '1.25'.
          ENDIF.

          IF i_zgetcost-stprs > 3000 .
            l_newactcost8 = it_gp_down-actcost * '1.15'.
          ENDIF.
        ENDIF.


        l_unitgp8 = it_gp_down-netpr - l_newactcost8 .  "actcost-> B2

        "Total GP
        l_totalgp8 = l_unitgp8  * it_gp_down-kbmeng.
        " concatenate i_mail-gp_perc '%' into i_mail-gp_perc.


        "i_mail-totalgp_CNY,l_ukurs "20251117
        IF it_gp_down-curr = 'CNY'.
          i_mail-totalgp_cny = l_totalgp8.
        ELSE.
          i_mail-totalgp_cny = l_totalgp8 * l_ukurs.
        ENDIF.



        i_mail-gp_perc =  ( l_totalgp8 * 100 ) / it_gp_down-opamt.

      ELSE.
        i_mail-gp_perc = 0.
      ENDIF.

    ENDIF.
    "ENDMD04SHIPPING NOTICE

    " 4.total GP>500GP%>5%(GP%>5%),GP<-500
    " clear l_gp_perc.
    " l_gp_perc = i_mail-gp_perc.  "
    IF ( ( i_mail-totalgp_cny - 0 ) > 500 AND ( i_mail-gp_perc - 0 ) > 5 ) OR ( i_mail-totalgp_cny - 0 ) < -500.
    ELSE.
      CLEAR: i_mail,l_netpr,l_peinh,l_waers,l_ebeln,l_ebelp,l_ukurs2,l_ukurs,l_ebeln2,l_ebelp2.
      CONTINUE.
    ENDIF.

    CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
      CHANGING
        value = i_mail-totalgp_cny.
    CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
      CHANGING
        value = i_mail-gp_perc.

    CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
      CHANGING
        value = i_mail-supplypo_up.

    CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
      CHANGING
        value = i_mail-totalgp2.
    IF i_mail-werks(3) = 'CEH'.
      g_ceh = 'X'.
    ENDIF.
    IF i_mail-matnr CS 'E-'.
      CONCATENATE '/' i_mail-matnr INTO i_mail-matnr.
    ENDIF.
    APPEND i_mail.
    CLEAR: i_mail,l_netpr,l_peinh,l_waers,l_ebeln,l_ebelp,l_ukurs2,l_ukurs.
  ENDLOOP.

  IF g_ceh = 'X'.  "CERMATE PM Fendi
    " lt_mailrecipients-receiver = 'Fendi.Fan@advantech.com.cn'.
    lt_mailrecipients-receiver = 'Daisy.Cai@advantech.com.cn'.
    lt_mailrecipients-rec_type = 'U'.
    lt_mailrecipients-com_type = 'INT'.
    lt_mailrecipients-notif_del = 'X'.
    lt_mailrecipients-notif_ndel = 'X'.
    APPEND lt_mailrecipients.
    CLEAR lt_mailrecipients.
  ENDIF.


  CLASS cl_abap_char_utilities DEFINITION LOAD.
  CLEAR lt_attachment.
  REFRESH lt_attachment.

  DATA: i_record  LIKE solisti1 OCCURS 0 WITH HEADER LINE.
  DATA filelen TYPE i.
  DATA: tmpstr TYPE string .
  CLEAR: tmpstr.
  PERFORM itabtostr TABLES i_mail USING tmpstr.
  PERFORM strtorecord TABLES i_record USING tmpstr filelen.
  APPEND LINES OF i_record TO lt_attachment.


  CLEAR lt_packing_list.
  REFRESH lt_packing_list.
  lt_packing_list-transf_bin  = space.
  lt_packing_list-head_start  = 1.
  lt_packing_list-head_num    = 0.
  lt_packing_list-body_start  = 1.
  lt_packing_list-body_num    = lines( lt_mailtxt ).
  lt_packing_list-doc_type    = 'RAW'.
  APPEND lt_packing_list.
  CLEAR lt_packing_list.
  lt_packing_list-transf_bin  = 'X'.
  lt_packing_list-head_start  = 1.
  lt_packing_list-head_num    = 1.
  lt_packing_list-body_start  = 1.
  lt_packing_list-body_num    = lines( lt_attachment ).
  lt_packing_list-doc_type    = 'XLS'.
  lt_packing_list-obj_name    = l_object.
  lt_packing_list-obj_descr   = l_object.
  lt_packing_list-doc_size    = lt_packing_list-body_num * 255.
  APPEND lt_packing_list.
  CLEAR lt_packing_list.
  lt_mailsubject-obj_name     = 'GPZRSD28B'.
  lt_mailsubject-obj_langu    = sy-langu.
  lt_mailsubject-obj_descr    = 'GPZRSD28B'.
  lt_mailsubject-sensitivty   = 'F'.
  gv_cnt = lines( lt_attachment ).
  lt_mailsubject-doc_size     = ( gv_cnt - 1 ) * 255 + strlen(
   lt_attachment ).
  CALL FUNCTION 'SO_NEW_DOCUMENT_ATT_SEND_API1'
    EXPORTING
      document_data              = lt_mailsubject
      put_in_outbox              = 'X'
      commit_work                = 'X'
    TABLES
      packing_list               = lt_packing_list
      contents_bin               = lt_attachment
      contents_txt               = lt_mailtxt
      receivers                  = lt_mailrecipients
    EXCEPTIONS
      too_many_receivers         = 1
      document_not_sent          = 2
      document_type_not_exist    = 3
      operation_no_authorization = 4
      parameter_error            = 5
      x_error                    = 6
      enqueue_error              = 7
      OTHERS                     = 8.
ENDFORM.                    "send_mail FOR CKB6

*&---------------------------------------------------------------------*
*&      Form  strtorecord
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->RECORD     text
*      -->STR        text
*      -->LEN        text
*----------------------------------------------------------------------*
FORM strtorecord TABLES record USING str len.
  DATA:tmpbuffer TYPE xstring.
  CALL FUNCTION 'SCMS_STRING_TO_XSTRING'
    EXPORTING
      text     = str
      mimetype = '"text/html; charset=GB2312"'
      encoding = '8400'
    IMPORTING
      buffer   = tmpbuffer
    EXCEPTIONS
      failed   = 1
      OTHERS   = 2.
  CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
    EXPORTING
      buffer          = tmpbuffer
      append_to_table = ''
    IMPORTING
      output_length   = len
    TABLES
      binary_tab      = record.
ENDFORM.                    "strtorecord

*&---------------------------------------------------------------------*
*&      Form  itabtostr
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->INTAB      text
*      -->OUTSTR     text
*----------------------------------------------------------------------*
FORM itabtostr TABLES intab
                USING outstr TYPE string.
  DATA: tab      TYPE c VALUE cl_abap_char_utilities=>horizontal_tab,
        enter(2) TYPE c VALUE cl_abap_char_utilities=>cr_lf,
        n        TYPE i.
  DATA: BEGIN OF headtab OCCURS 0 ,
          length    TYPE i,
          decimals  TYPE i,
          type_kind TYPE c,
          name(30)  TYPE c,
        END OF headtab.
  DATA descr_ref TYPE REF TO cl_abap_structdescr.
  FIELD-SYMBOLS: <comp_wa> TYPE abap_compdescr,
                 <f_field> ,
                 <f_intab> TYPE any.
  DATA:str   TYPE string,
       str2  TYPE string,
       text1 TYPE c.
  descr_ref ?= cl_abap_typedescr=>describe_by_data( intab ).
  LOOP AT descr_ref->components ASSIGNING <comp_wa>.
    MOVE-CORRESPONDING <comp_wa> TO headtab.
    APPEND headtab.
  ENDLOOP.
  DESCRIBE TABLE headtab LINES n.
  LOOP AT intab ASSIGNING <f_intab>.
    DO n TIMES.
      ASSIGN COMPONENT sy-index OF STRUCTURE <f_intab> TO <f_field>.
      str = <f_field>.
      READ TABLE headtab INDEX sy-index.
      IF headtab-type_kind = 'I' OR headtab-type_kind = 'P'
                                 OR headtab-type_kind = 'F'.
        SEARCH str FOR '-'.
        IF sy-subrc = 0 AND sy-fdpos <> 0.
          SPLIT str AT '-' INTO str text1.
          CONDENSE str.
          CONCATENATE '-' str INTO str.
        ELSE.
          CONDENSE str.
        ENDIF.
      ELSE.
*        SHIFT str LEFT DELETING LEADING '0' .
      ENDIF.
      CONCATENATE str2 tab str INTO str2.
    ENDDO.
    SHIFT str2.
    CONCATENATE outstr str2 enter INTO outstr.
    CLEAR str2.
  ENDLOOP.
ENDFORM.                    "itabtostr


*&---------------------------------------------------------------------*
*&      Form  send_mail_general
*&---------------------------------------------------------------------*
FORM send_mail_general TABLES p_table p_reclist USING p_key p_filename.
  DATA: objpack   LIKE sopcklsti1 OCCURS 0 WITH HEADER LINE.
  DATA: objhead   LIKE solisti1 OCCURS 0 WITH HEADER LINE.
  DATA: objbin    LIKE solisti1 OCCURS 0 WITH HEADER LINE.
  DATA: objtxt    LIKE solisti1 OCCURS 0 WITH HEADER LINE.
  DATA: reclist   LIKE somlreci1 OCCURS 0 WITH HEADER LINE.
  DATA: doc_chng  LIKE sodocchgi1.
  DATA: tab_lines LIKE sy-tabix.

  CLEAR: objpack, objpack[].
  CLEAR: objhead, objhead[].
  CLEAR: objbin, objbin[].
  CLEAR: objtxt, objtxt[].
  CLEAR: reclist, reclist[].
  CLEAR: doc_chng, tab_lines.

  reclist[] = p_reclist[].

  IF p_key = 'P000'.
    doc_chng-obj_descr = 'Sales Order [P000] Backlog'.
    objtxt = 'Attachment files are the Sales Order [P000] Backlog in the SAP.'.
    APPEND objtxt. CLEAR objtxt.
    APPEND objtxt. CLEAR objtxt.
  ENDIF.

  objtxt = '***** Auto-generated email, please do not reply. *****'.
  APPEND objtxt. CLEAR objtxt.
  APPEND objtxt. CLEAR objtxt.
  CONCATENATE 'Job Date:' sy-datum(4) '/'  sy-datum+4(2) '/' sy-datum+6(2) '_' sy-uzeit(2) ':' sy-uzeit+2(2) ':' sy-uzeit+4(2) INTO objtxt.
  APPEND objtxt. CLEAR objtxt.
  APPEND objtxt. CLEAR objtxt.
  objtxt = 'Tcode:ZRSD28B'.
  APPEND objtxt. CLEAR objtxt.
  APPEND objtxt. CLEAR objtxt.

  DESCRIBE TABLE objtxt LINES tab_lines.
  CLEAR objtxt.
  READ TABLE objtxt INDEX tab_lines.
  IF sy-subrc = 0.
    doc_chng-doc_size = ( tab_lines - 1 ) * 255 + strlen( objtxt ).
  ENDIF.

  CLEAR objpack-transf_bin.
  objpack-head_start = 1.
  objpack-head_num   = 0.
  objpack-body_start = 1.
  objpack-body_num   = tab_lines.
  objpack-doc_type   = 'RAW'.
  APPEND objpack.

  PERFORM get_mail_attfile TABLES p_table objbin objpack USING p_key p_filename.

  IF reclist[] IS NOT INITIAL.
    CALL FUNCTION 'SO_NEW_DOCUMENT_ATT_SEND_API1'
      EXPORTING
        document_data              = doc_chng
        put_in_outbox              = 'X'
        commit_work                = 'X'
      TABLES
        packing_list               = objpack
        object_header              = objhead
        contents_txt               = objtxt
        contents_bin               = objbin
        receivers                  = reclist
      EXCEPTIONS
        too_many_receivers         = 1
        document_not_sent          = 2
        operation_no_authorization = 4
        OTHERS                     = 99.

    IF sy-subrc EQ 0.
      MESSAGE 'Mail send Success !' TYPE 'S'.
    ENDIF.
  ENDIF.

ENDFORM.


*&---------------------------------------------------------------------*
*&      Form  get_mail_attfile
*&---------------------------------------------------------------------*
FORM get_mail_attfile TABLES p_table
                             i_objbin STRUCTURE solisti1
                             i_objpack STRUCTURE sopcklsti1
                       USING p_key p_filename.
  DATA: i_record LIKE solisti1 OCCURS 0 WITH HEADER LINE.
  DATA: filelen TYPE i.
  DATA: v_lines_bin TYPE i.
  DATA: v_lines_bin_all TYPE i.
  DATA: tmpstr TYPE string.
  DATA: tmpbuffer TYPE xstring.

  CLEAR: i_record, i_record[].
  CLEAR: filelen.
  CLEAR: v_lines_bin.
  CLEAR: v_lines_bin_all.
  CLEAR: tmpstr.
  CLEAR: tmpbuffer.

  CLEAR: i_objbin, i_objbin[].

  DATA: tab TYPE c VALUE cl_abap_char_utilities=>horizontal_tab.
  DATA: enter(2) TYPE c VALUE cl_abap_char_utilities=>cr_lf.
  DATA: n TYPE i.
  DATA: BEGIN OF headtab OCCURS 0,
          length    TYPE i,
          decimals  TYPE i,
          type_kind TYPE c,
          name(30)  TYPE c,
        END OF headtab.
  DATA descr_ref TYPE REF TO cl_abap_structdescr.
  FIELD-SYMBOLS: <comp_wa> TYPE abap_compdescr,
                 <f_field>,
                 <f_intab> TYPE any.
  DATA: str TYPE string.
  DATA: str2 TYPE string.
  DATA: text1 TYPE c.
  DATA: l_dd(10).

  CLEAR: headtab, headtab[].
  CLEAR: n, str, str2, text1.

  IF p_table[] IS NOT INITIAL.
    descr_ref ?= cl_abap_typedescr=>describe_by_data( p_table ).
    LOOP AT descr_ref->components ASSIGNING <comp_wa>.
      MOVE-CORRESPONDING <comp_wa> TO headtab.
      APPEND headtab.
    ENDLOOP.
    DESCRIBE TABLE headtab LINES n.

    IF p_key = 'P000'.
      CONCATENATE 'Sold to Party'
                  'Sold to Party Desc.'
                  'Sales Document'
                  'Sales Document Item'
                  'Material'
                  'Order Qty'
                  'Unbilling Qty'
                  'Created on'
                  'Request Date'
                  'Confirm Date'
                  'Unbilling Amount'
                  'Supply plant on hand qty'
                  'Delay Reason Code'
                  'ABC Indicator'
                  'Sales Person ID'
                  'Sales Person Name'
                  'Employee ID'
                  'Employee Name'
                  'SO notify person ID'
                  'SO notify person Name'
                  'GIP code'
                  'MRP Controller'
      INTO tmpstr SEPARATED BY tab.
    ENDIF.
    CONCATENATE tmpstr enter INTO tmpstr.

    LOOP AT p_table ASSIGNING <f_intab>.
      DO n TIMES.
        CHECK sy-index > 0.
        ASSIGN COMPONENT sy-index OF STRUCTURE <f_intab> TO <f_field>.
        str = <f_field>.
        READ TABLE headtab INDEX sy-index.
        IF headtab-type_kind = 'I' OR headtab-type_kind = 'P'
                                   OR headtab-type_kind = 'F'.
          SEARCH str FOR '-'.
          IF sy-subrc = 0 AND sy-fdpos <> 0.
            SPLIT str AT '-' INTO str text1.
            CONDENSE str.
            CONCATENATE '-' str INTO str.
          ELSE.
            CONDENSE str.
          ENDIF.
        ELSEIF headtab-type_kind = 'D'.
          CONDENSE str.
          IF str = '00000000'.
            str = ''.
          ELSE.
            CONCATENATE str+4(2) '/' str+6(2) '/' str(4) INTO l_dd.
            str = l_dd.
          ENDIF.
        ENDIF.
        CONCATENATE str2 tab str INTO str2.
      ENDDO.
      SHIFT str2.
      CONCATENATE tmpstr str2 enter INTO tmpstr.
      CLEAR str2.
    ENDLOOP.

    CALL FUNCTION 'SCMS_STRING_TO_XSTRING'
      EXPORTING
        text     = tmpstr
        mimetype = '"text/html; charset=Unicode; charset=big5"'
      IMPORTING
        buffer   = tmpbuffer
      EXCEPTIONS
        failed   = 1
        OTHERS   = 2.

    CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
      EXPORTING
        buffer          = tmpbuffer
        append_to_table = ''
      IMPORTING
        output_length   = filelen
      TABLES
        binary_tab      = i_record.

    IF i_record[] IS NOT INITIAL.
      APPEND LINES OF i_record TO i_objbin.
      DESCRIBE TABLE i_record LINES v_lines_bin.
      DESCRIBE TABLE i_objbin LINES v_lines_bin_all.
      i_objpack-transf_bin = 'X'.
      i_objpack-body_start = v_lines_bin_all - v_lines_bin + 1 .
      i_objpack-body_num = v_lines_bin.
      i_objpack-doc_type = 'XLS'.
      i_objpack-obj_name = 'text'.
      i_objpack-doc_size = v_lines_bin * 255.
      i_objpack-obj_descr = p_filename.
      APPEND i_objpack. CLEAR: i_objpack.
    ENDIF.
  ENDIF.

ENDFORM.




*&---------------------------------------------------------------------*
*&      Form  send_mail
*&---------------------------------------------------------------------*
*       text:attached file XLS
*----------------------------------------------------------------------*
FORM send_mail_gp_tw.   "double add on 20170316 FOR CKB*
  DATA: lt_mailrecipients TYPE STANDARD TABLE OF somlrec90 WITH HEADER LINE,
        lt_mailtxt        TYPE STANDARD TABLE OF soli      WITH HEADER LINE,
        lt_attachment     TYPE STANDARD TABLE OF solisti1  WITH HEADER LINE,
        lt_mailsubject    TYPE sodocchgi1,
        lt_packing_list   TYPE STANDARD TABLE OF sopcklsti1 WITH HEADER LINE,
        gv_cnt            TYPE i,
        l_flag(1)         TYPE c,
        l_n               TYPE i,
        l_date            LIKE eket-eindt,
        l_date2           LIKE eket-eindt,
        tmp_org           TYPE string.

  DATA:l_zmalgp LIKE  ztmm_15-zmalgp.
  DATA: BEGIN OF i_mail OCCURS 0,
          splant(4), "Delv/Supply Plant
          vbeln(20),  "SO/STO Order
          posnr(10),  "Order Item
          matnr(50),  "Material
          mtart(10),  "Material Type
          kbmeng(30),  "Unbilling Qty
          oedatu(15), "Order Date
          cedatu(15), "Confirm Date
          netpr(30),  "Unit Price
          opamt(30),  "Unbilling Amount
          curr(10), "Currency
          actcost(30),  "Actual Cost
          unitgp(30), "Unit GP
          totalgp(30),  "Total GP
          werks(4),  "Plant
          otype(4), "Order Type
          dispo(10), "MRP Controller
          dsnam(40), "MRP Controller Name
          ernam(40), "User ID (Created By)
          gp_perc(20), "GP% = GP/(UNBILLING AMOUNT)
          totalgp_cny(30),  "IF totalgp IS NOT CNY Total GP TO  CNY
          supplypo(15),
          supplyitem(10),
          supplypo_up(30),
          curr2(10), "Currency
          totalgp2(30).

  DATA: END OF i_mail.

  DATA:g_ceh(1) TYPE c.
  DATA:l_date_gp LIKE sy-datum.
  DATA:l_lastmon_date LIKE sy-datum.
  DATA:l_gp_perc LIKE mard-labst.
  DATA:l_year LIKE mbewh-lfgja.
  DATA:l_month LIKE mbewh-lfmon.
  DATA:l_lbkum LIKE mbewh-lbkum.
  DATA t_berid LIKE mdlv-berid .
  DATA:t_werks LIKE marc-werks.
  DATA:t_matnr LIKE marc-matnr.
  DATA:l_ukurs LIKE tcurr-ukurs.
  DATA:l_ukurs3 LIKE tcurr-ukurs.
  DATA:l_ukurs2 LIKE tcurr-ukurs.
  DATA:l_netpr LIKE ekpo-netpr.
  DATA:l_peinh LIKE ekpo-peinh.
  DATA:l_waers LIKE ekko-waers.
  DATA:l_ebeln LIKE ekpo-ebeln.
  DATA:l_ebelp LIKE ekpo-ebelp.
  DATA: exrate_gdatu  LIKE tcurr-gdatu.
  DATA:l_month_first LIKE sy-datum.
  DATA: i_mdez  LIKE mdps OCCURS 20 WITH HEADER LINE.
  DATA: l_bdate LIKE sy-datum.
  DATA: l_strdate(10) TYPE c.
  DATA:l_sum_menge LIKE ekbe-menge.
  DATA:l_sum_dmbtr LIKE ekbe-dmbtr.
  DATA:l_newactcost  TYPE p DECIMALS 5.  "Actual Cost

  DATA:l_netwr LIKE ekpo-netwr.
  DATA:l_menge LIKE ekpo-menge.
  DATA:l_sum_netwr LIKE ekpo-netwr.
  DATA:l_sum_mdmenge LIKE ekpo-menge.
  DATA:l_lbkum_menge LIKE ekpo-menge.
  DATA:l_beskz LIKE marc-beskz.
  DATA:g_flag(1) TYPE c.
  DATA:l_stprs_s LIKE ztco_zbco551-stprs_s.
  DATA:l_peinh551 LIKE ztco_zbco551-peinh.
  DATA ldate_workdate LIKE eket-eindt.
  DATA: l_count TYPE i.
  DATA:l_errorstr TYPE string.


  "  i_mail-matnr = 'Material Number'.
  "  i_mail-werks = 'Plant'.
  "  i_mail-lgort = 'Storage'.
  "  i_mail-lgpbe = 'Storage BIN'.
  "  i_mail-menge = 'QTY'.

  DATA: l_object(15) TYPE c.

  CLEAR l_object.

  l_object = 'GP-LIST'.
*
*  CLEAR l_zmalgp.
*  CONCATENATE  s_werks-low  'STO_DEL' INTO l_zmalgp.

  SELECT smtp_addr
   INTO lt_mailrecipients-receiver
   FROM ztmm_15
     WHERE zmalgp = 'ZRSD28B-GP-TW' .

    lt_mailrecipients-rec_type = 'U'.
    lt_mailrecipients-com_type = 'INT'.
    lt_mailrecipients-notif_del = 'X'.
    lt_mailrecipients-notif_ndel = 'X'.
    APPEND lt_mailrecipients.
    CLEAR lt_mailrecipients.
  ENDSELECT.

  lt_mailtxt = 'Dear All:'.
  APPEND lt_mailtxt. CLEAR lt_mailtxt.
  lt_mailtxt = ' '.
  APPEND lt_mailtxt. CLEAR lt_mailtxt.

  lt_mailtxt = 'GPrule: '.
  APPEND lt_mailtxt. CLEAR lt_mailtxt.
  lt_mailtxt = ' '.
  APPEND lt_mailtxt. CLEAR lt_mailtxt.

  lt_mailtxt = 'Confirm Date1096)'.
  APPEND lt_mailtxt. CLEAR lt_mailtxt.
  lt_mailtxt = ' GP>2500(TWD)GP%>6%(GP%>6%),CNY GP<-2500(TWD)'.  "5->6 20250428
  APPEND lt_mailtxt. CLEAR lt_mailtxt.

  i_mail-splant = 'Delv/Supply Plant'.
  i_mail-vbeln = 'SO/STO Number'.
  i_mail-posnr = 'Order Item'.
  i_mail-matnr = 'Material'.
  i_mail-mtart = 'Material Type'.
  i_mail-kbmeng = 'Unbilling Qty'.
  i_mail-oedatu = 'Order Date'.
  i_mail-cedatu = 'Confirm Date'.
  i_mail-netpr = 'Unit Price'.
  i_mail-opamt = 'Unbilling Amount'.
  i_mail-curr = 'Currency'.
  i_mail-actcost = 'Actual Cost'.
  i_mail-unitgp = 'Unit GP'.
  i_mail-totalgp = 'Total GP'.
  i_mail-werks = 'Plant'.
  i_mail-otype = 'Order Type'.
  i_mail-dispo = 'MC'.
  i_mail-dsnam = 'MC Name'.
  i_mail-ernam = 'User ID'.
  i_mail-gp_perc = 'GP%'.
  i_mail-totalgp_cny = 'Total GP(TWD)'.
  i_mail-supplypo = 'Supply PO'.
  i_mail-supplyitem = 'Supply Item'.
  i_mail-supplypo_up = 'Unit Price(SupplyPO)'.
  i_mail-curr2 = 'Currency(SupplyPO)'.
  i_mail-totalgp2 = 'Total GP(SupplyPO)'.


  APPEND i_mail.
  CLEAR i_mail.

  " l_date_gp = sy-datum + 10.
  CLEAR: ldate_workdate,l_count.     "it_gp_down-cedatu10
  l_date_gp = sy-datum.
  DO  30 TIMES.
    CALL FUNCTION 'DATE_CONVERT_TO_FACTORYDATE'
      EXPORTING
        correct_option      = '+'
        date                = l_date_gp
        factory_calendar_id = 'CN'
      IMPORTING
        date                = ldate_workdate.

    IF l_date_gp = ldate_workdate. "
      l_date_gp = l_date_gp + 1.
      l_count = l_count + 1.
    ELSE.
      l_date_gp = ldate_workdate.
    ENDIF.
    IF l_count > 10.
      EXIT.
    ENDIF.
  ENDDO.


  CLEAR:l_lastmon_date.
  "MBEWH
  CALL FUNCTION 'CCM_GO_BACK_MONTHS'
    EXPORTING
      currdate   = sy-datum
      backmonths = 1
    IMPORTING
      newdate    = l_lastmon_date.

  l_year = l_lastmon_date(4).
  l_month = l_lastmon_date+4(2).
  CLEAR:g_ceh.
  DATA:l_ebeln2 LIKE ekpo-ebeln.
  DATA:l_ebelp2 LIKE ekpo-ebelp.
  DATA:l_reslo LIKE ekpo-reslo.
  LOOP AT it_gp_down.

    IF it_gp_down-cedatu > l_date_gp. "3.7AKMCcomfirm Date10
      CONTINUE.
    ENDIF.
    "CKH1/CKH2ZFINZOEM,ZSEM98*/CM-98*SQR-*&SQF-
    IF  it_gp_down-matnr(3) = 'SQR-' OR it_gp_down-matnr(3) = 'SQF-'.
    ELSE.
      IF it_gp_down-splant(3) = 'TWH'.
*        IF it_gp_down-mtart = 'ZFIN' OR it_gp_down-mtart = 'ZOEM'.
*          CONTINUE.
*        ENDIF.
        IF it_gp_down-mtart = 'ZSEM'.
          IF  it_gp_down-matnr(2) = '98' OR it_gp_down-matnr(10) = '0000000098' OR  it_gp_down-matnr(4) = 'CM-98'.
            CONTINUE.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
*    IF it_gp_down-splant(3) = 'CKH1'. "20221230 mark for Jenny
*      CLEAR:l_ebeln2,l_ebelp2.
*      l_ebeln2 = it_gp_down-vbeln.
*      l_ebelp2 = it_gp_down-posnr.
*
**      CALL FUNCTION 'CONVERSION_EXIT_alpha_INPUT'
**        EXPORTING
**          input  = l_ebeln2
**        IMPORTING
**          output = l_ebeln2.
**
**      CALL FUNCTION 'CONVERSION_EXIT_alpha_INPUT'
**        EXPORTING
**          input  = l_ebelp2
**        IMPORTING
**          output = l_ebelp2.
*      CLEAR:l_reslo.
*      SELECT SINGLE reslo INTO l_reslo FROM ekpo  WHERE ebeln = l_ebeln2 AND ebelp = l_ebelp2.
*      IF l_reslo(1) = 'R'.
*        CONTINUE.
*      ENDIF.
*    ENDIF.


    CLEAR: i_mail,l_netpr,l_peinh,l_waers,l_ebeln,l_ebelp,l_ukurs2,l_beskz,l_newactcost,l_stprs_s,l_peinh551.

    MOVE-CORRESPONDING it_gp_down TO i_mail.
*    CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'
*      EXPORTING
*        input  = it_gp_down-matnr
*      IMPORTING
*        output = it_gp_down-matnr.


    "it_gp_down-totalgp CNYCNY
    CLEAR:l_month_first,exrate_gdatu.
*    if it_gp_down-cedatu is initial or it_gp_down-cedatu = '00000000' or it_gp_down-cedatu = '' .
*      it_gp_down-cedatu = sy-datum.
*    endif.
    it_gp_down-cedatu = sy-datum.
    CONCATENATE it_gp_down-cedatu(6) '01' INTO l_month_first.
    CONVERT DATE l_month_first INTO INVERTED-DATE exrate_gdatu.
    CLEAR:l_ukurs,l_ukurs3.
*    IF it_gp_down-curr = 'EUR'.
*      SELECT SINGLE ukurs INTO l_ukurs FROM tcurr
*    WHERE kurst = 'EURX' AND fcurr = it_gp_down-curr AND tcurr = 'TWD' AND  gdatu = exrate_gdatu.
    IF it_gp_down-curr = 'CNY'. "20241104 DIVID ZERO ERROR
      l_ukurs = 1.
    ELSEIF it_gp_down-curr = 'EUR'.
      SELECT SINGLE ukurs INTO l_ukurs FROM tcurr
    WHERE kurst = 'EURX' AND fcurr = it_gp_down-curr AND tcurr = 'CNY' AND  gdatu = exrate_gdatu.
    ELSE.
      SELECT SINGLE ukurs INTO l_ukurs FROM tcurr
       WHERE kurst = 'M' AND fcurr = it_gp_down-curr AND tcurr = 'CNY' AND  gdatu = exrate_gdatu.
    ENDIF.

*    SELECT SINGLE ukurs INTO l_ukurs3 FROM tcurr
*     WHERE kurst = 'M' AND fcurr = 'CNY' AND tcurr = it_gp_down-curr AND  gdatu = exrate_gdatu.
*    IF l_ukurs3 < 0.
*      l_ukurs3 = l_ukurs3 * ( -1 ).
*    ENDIF.
    IF l_ukurs < 0.
      l_ukurs = l_ukurs * ( -1 ).
      i_mail-totalgp_cny = it_gp_down-totalgp / l_ukurs.

    ELSE.
      IF it_gp_down-curr = 'CNY'.
        i_mail-totalgp_cny = it_gp_down-totalgp.
      ELSE."CNYCNY
        i_mail-totalgp_cny = it_gp_down-totalgp * l_ukurs.
      ENDIF.
    ENDIF.

    "CKB6 ZRAWSPK2Ejane
    CLEAR:l_beskz.
    IF it_gp_down-splant = 'CKB6' AND it_gp_down-mtart = 'ZRAW'. "MAKE BY ADVANTECH.
      SELECT SINGLE beskz INTO l_beskz FROM marc WHERE matnr = it_gp_down-matnr AND werks = it_gp_down-splant.
    ENDIF.

    "MBEWH
    CLEAR l_lbkum."BALANCE STOCK
    SELECT SINGLE lbkum INTO l_lbkum FROM mbewh
            WHERE matnr = it_gp_down-matnr
              AND bwkey = it_gp_down-splant
              AND lfgja = l_year
              AND lfmon = l_month
              AND vprsv = 'V'.
    "BEGINMD04SHIPPING NOTICE
    IF ( it_gp_down-kbmeng - l_lbkum ) > 0  AND  l_beskz <> 'E'. "A1>A2ACTUAL PRICEshipping notice NETPR
      "CK*ZSEMshipping noticeZRAWZBCO55
      CLEAR:l_beskz,l_newactcost,l_stprs_s,l_peinh551.
      SELECT SINGLE beskz INTO l_beskz FROM marc WHERE matnr = it_gp_down-matnr AND werks = it_gp_down-splant.

      IF it_gp_down-werks(2) = 'CK' AND it_gp_down-mtart = 'ZSEM' AND  l_beskz = 'E'. "MAKE BY ADVANTECH.
*        CLEAR:l_beskz.
*        SELECT SINGLE beskz INTO l_beskz FROM marc WHERE matnr = it_gp_down-matnr AND werks = it_gp_down-splant.
*        IF l_beskz = 'E'. "MAKE BY ADVANTECH
        CLEAR:l_stprs_s,l_peinh551.
        SELECT SINGLE stprs_s peinh INTO ( l_stprs_s,l_peinh551 ) FROM ztco_zbco551
          WHERE matnr = it_gp_down-matnr AND werks = it_gp_down-splant AND budat = sy-datum.
        IF l_peinh551 = 0.
          l_peinh551 = 1.
        ENDIF.
        l_newactcost = l_stprs_s / l_peinh551.
        IF it_gp_down-curr <> 'CNY'.
          l_newactcost = l_newactcost / l_ukurs.
        ENDIF.
        IF l_newactcost = 0.
          i_mail-supplypo_up = it_gp_down-actcost.
        ELSE.
          i_mail-supplypo_up = l_newactcost.
        ENDIF.


        i_mail-totalgp2 = ( it_gp_down-netpr -  i_mail-supplypo_up ) * i_mail-kbmeng. "act costtotalgp
        IF it_gp_down-curr = 'CNY'.
          i_mail-totalgp_cny = i_mail-totalgp2.
        ELSE.
          i_mail-totalgp_cny = i_mail-totalgp2 * l_ukurs.
        ENDIF.

        IF ( it_gp_down-opamt - 0 ) <> 0.
          i_mail-gp_perc =  ( i_mail-totalgp2 * 100 ) / it_gp_down-opamt.
          " concatenate i_mail-gp_perc '%' into i_mail-gp_perc.
        ELSE.
          i_mail-gp_perc = 0.
        ENDIF.
        "  ENDIF.
      ELSE.


        ""A1>A2A1<(A2+A3)"  A3:GR SUM(QTY)
        CLEAR:l_strdate,l_bdate.
        CONCATENATE sy-datum(6) '01' INTO l_strdate.
        l_bdate = l_strdate.

        CLEAR:l_sum_menge,l_sum_dmbtr,l_newactcost.


        "CNY,CNY,USD
        SELECT SUM( menge ) SUM( dmbtr ) INTO ( l_sum_menge,l_sum_dmbtr ) FROM ekbe  "CNY.AMT,ORIGIN.AMT,CUT
        WHERE matnr = it_gp_down-matnr AND werks = it_gp_down-splant  AND vgabe = '1' AND shkzg = 'S' AND wrbtr > 0 AND budat BETWEEN l_bdate AND sy-datum.

        IF it_gp_down-splant(2) = 'TW'.                     "20250328
          l_sum_dmbtr = ( l_sum_dmbtr * 100 ) / ( 45 / 10 ).  "100 20250418 for daniel17

        ENDIF.
        " i_mail-supplypo_up = (A2*B2+A3*B3)/(A2+A3)
        "l_newactcost = ( l_lbkum * it_gp_down-actcost + l_SUM_dmbtr ) / ( L_SUM_menge + l_lbkum ).
        IF it_gp_down-curr = 'CNY'.   ""A1>A2A1<(A2+A3)"  A3:GR SUM(QTY)
          l_newactcost = ( l_lbkum * it_gp_down-actcost + l_sum_dmbtr ) / ( l_sum_menge + l_lbkum ).
          i_mail-supplypo_up = l_newactcost.
        ELSE. "cny*
          IF l_ukurs = 0.

            CONCATENATE it_gp_down-vbeln '-' it_gp_down-posnr '-' it_gp_down-curr INTO l_errorstr .
            MESSAGE  l_errorstr  TYPE 'I'.
            WRITE l_errorstr.
            BREAK-POINT.
          ENDIF.
          l_sum_dmbtr = l_sum_dmbtr / l_ukurs.
          l_newactcost = ( l_lbkum * it_gp_down-actcost + l_sum_dmbtr ) / ( l_sum_menge + l_lbkum ).
          i_mail-supplypo_up = l_newactcost.
        ENDIF.
        CLEAR:l_lbkum_menge.
        l_lbkum_menge = ( l_lbkum + l_sum_menge ).  "= + 

        IF ( it_gp_down-kbmeng - l_lbkum_menge ) <= 0.
          IF ( i_mail-supplypo_up - 0 ) = 0.
            i_mail-supplypo_up = i_mail-actcost.
          ENDIF.
          i_mail-totalgp2 = ( it_gp_down-netpr -  i_mail-supplypo_up ) * i_mail-kbmeng. "act costtotalgp
          "i_mail-totalgp_CNY,l_ukurs
          IF it_gp_down-curr = 'CNY'.
            i_mail-totalgp_cny = i_mail-totalgp2.
          ELSE.
            i_mail-totalgp_cny = i_mail-totalgp2 * l_ukurs.
          ENDIF.
          IF ( it_gp_down-opamt - 0 ) <> 0.
            i_mail-gp_perc =  ( i_mail-totalgp2 * 100 ) / it_gp_down-opamt.
            " concatenate i_mail-gp_perc '%' into i_mail-gp_perc.
          ELSE.
            i_mail-gp_perc = 0.
          ENDIF.
        ELSE. "MD04 SHIPPING NOTICE
          CLEAR: i_mdez,t_berid.
          REFRESH: i_mdez.
          t_berid = it_gp_down-splant.
          t_matnr = it_gp_down-matnr.
          t_werks = it_gp_down-splant.
          CALL FUNCTION 'MD_STOCK_REQUIREMENTS_LIST_API'
            EXPORTING
              matnr                    = t_matnr
              werks                    = t_werks
              berid                    = t_berid
            TABLES
              mdpsx                    = i_mdez
            EXCEPTIONS
              material_plant_not_found = 1
              plant_not_found          = 2
              OTHERS                   = 3.

          SORT i_mdez BY dat00.
          CLEAR:l_ebeln,l_ebelp,l_sum_netwr,l_sum_mdmenge,g_flag.
          LOOP AT i_mdez WHERE  delkz = 'LA'.
            l_ebeln = i_mdez-delnr.   "ebeln
            l_ebelp = i_mdez-delps.    "ebelp

            CLEAR: l_netwr,l_menge,l_waers,l_netpr,l_peinh.
            SELECT SINGLE waers INTO l_waers FROM ekko WHERE ebeln = l_ebeln.
            SELECT SINGLE netpr peinh  INTO ( l_netpr,l_peinh )   FROM ekpo WHERE ebeln = l_ebeln AND ebelp = l_ebelp.

            IF l_peinh IS INITIAL OR l_peinh = 0.
              l_peinh = 1.
            ENDIF.
            IF l_waers = 'TWD'.
              l_netpr = l_netpr * 100. "TWD100100 "20250425
            ENDIF.
            l_netwr = ( l_netpr / l_peinh ) * i_mdez-mng01. "MD04 QTY MAY BE DIFF WITH PO QTY,SO REDO IT FOR SUM AMOUNT OF MD04 .
            IF it_gp_down-curr = l_waers. "CURRENCY SAME,
              l_sum_netwr = l_sum_netwr + l_netwr.

            ELSE.  "CURRENCY different,",POit_gp_down
              CLEAR:l_ukurs2.
              IF ( l_waers = 'CNY' AND it_gp_down-curr = 'EUR' ). "OR ( l_waers = 'EUR' AND it_gp_down-curr = 'TWD').
                SELECT SINGLE ukurs INTO l_ukurs2 FROM tcurr
               WHERE kurst = 'EURX' AND fcurr = l_waers  AND tcurr = it_gp_down-curr AND  gdatu = exrate_gdatu.
              ELSE.
                SELECT SINGLE ukurs INTO l_ukurs2 FROM tcurr
                  WHERE kurst = 'M' AND fcurr = l_waers  AND tcurr = it_gp_down-curr AND  gdatu = exrate_gdatu.
                IF sy-subrc <> 0.
                  SELECT SINGLE ukurs INTO l_ukurs2 FROM tcurr
                   WHERE  fcurr = l_waers  AND tcurr = it_gp_down-curr AND  gdatu = exrate_gdatu.
                ENDIF.
              ENDIF.
              IF l_ukurs2 < 0.  "
                l_ukurs2 = l_ukurs2 * ( -1 ).
                l_sum_netwr = l_sum_netwr + ( l_netwr / l_ukurs2 ).
              ELSE.
                l_sum_netwr = l_sum_netwr + l_netwr * l_ukurs2.
              ENDIF.
            ENDIF.
            l_sum_mdmenge = l_sum_mdmenge + i_mdez-mng01.
            "
            CLEAR:l_lbkum_menge.
            l_lbkum_menge = ( l_sum_menge + l_lbkum + l_sum_mdmenge ).  "= + 
            IF ( l_lbkum_menge - it_gp_down-kbmeng ) >= 0.
              g_flag = 'X'.   "unbilling qty
              EXIT.
            ENDIF.
          ENDLOOP.


          "(A2*B2+A3*B3+A4*B4)/(A2+A3+A4)
          CLEAR:l_newactcost.

          IF g_flag = 'X'. "MD04unbilling qty
            l_newactcost = ( l_lbkum * it_gp_down-actcost + l_sum_dmbtr + l_sum_netwr ) / ( l_sum_menge + l_lbkum + l_sum_mdmenge ).
          ELSE.            "MD04unbilling qty,,A1>(A2+A3+A4),B2().
            l_newactcost = it_gp_down-actcost.
          ENDIF.

          i_mail-supplypo_up = l_newactcost.

          IF ( i_mail-supplypo_up - 0 )  = 0. "MD04,,"20221201
            i_mail-totalgp2 = i_mail-totalgp.
          ELSE.
            i_mail-totalgp2 = ( it_gp_down-netpr - i_mail-supplypo_up ) * i_mail-kbmeng. "act costtotalgp
          ENDIF.
          "i_mail-totalgp_CNY,l_ukurs
          IF it_gp_down-curr = 'CNY'.
            i_mail-totalgp_cny = i_mail-totalgp2.
          ELSE.
            i_mail-totalgp_cny = i_mail-totalgp2 * l_ukurs.
          ENDIF.

          IF ( it_gp_down-opamt - 0 ) <> 0.
            i_mail-gp_perc =  ( i_mail-totalgp2 * 100 ) / it_gp_down-opamt.
          ELSE.
            i_mail-gp_perc = 0.
          ENDIF.

        ENDIF.



*      CLEAR: i_mdez,t_berid.
*      REFRESH: i_mdez.
*      t_berid = it_gp_down-splant.
*      t_matnr = it_gp_down-matnr.
*      t_werks = it_gp_down-splant.
*      CALL FUNCTION 'MD_STOCK_REQUIREMENTS_LIST_API'
*        EXPORTING
*          matnr                    = t_matnr
*          werks                    = t_werks
*          berid                    = t_berid
*        TABLES
*          mdezx                    = i_mdez
*        EXCEPTIONS
*          material_plant_not_found = 1
*          plant_not_found          = 2
*          OTHERS                   = 3.
*
*      SORT i_mdez BY sort0.
*      CLEAR:L_ebeln,L_ebelp.
*      LOOP AT i_mdez WHERE  delkz = 'LA'.
*        L_ebeln = i_mdez-extra(10).  "ebeln
*        L_ebelp = i_mdez-extra+11(5). "ebelp
*        EXIT.
*      ENDLOOP.
*      "shipping notice run jobGR
*      IF L_ebeln IS INITIAL.
*        CLEAR:l_strdate,l_bdate.
*        CONCATENATE sy-datum(6) '01' INTO l_strdate.
*        l_bdate = l_strdate.
*        SELECT ebeln ebelp INTO ( L_ebeln,L_ebelp ) FROM ekbe
*          WHERE matnr = it_gp_down-matnr AND vgabe = '1' AND shkzg = 'S' AND wrbtr > 0 AND budat BETWEEN l_bdate AND sy-datum
*          ORDER BY budat.
*          EXIT.
*        ENDSELECT.
*      ENDIF.
*
*
*      CLEAR: l_NETPR,l_PEINH,l_waers.
*      SELECT SINGLE waers INTO l_waers FROM ekko WHERE ebeln = L_ebeln.
*      SELECT SINGLE netpr peinh  INTO ( l_NETPR,l_PEINH )  FROM ekpo WHERE ebeln = L_ebeln AND ebelp = L_ebelp.
*      i_mail-curr2 = l_waers.
*
*
*      IF l_NETPR = 0. "PO up is zero totalgp
*        " 2.GP%----GP%=GP/
*        IF it_gp_down-opamt <> 0.
*          i_mail-gp_perc =  ( it_gp_down-totalgp * 100 ) / it_gp_down-opamt.
*          " concatenate i_mail-gp_perc '%' into i_mail-gp_perc.
*        ELSE.
*          i_mail-gp_perc = 0.
*        ENDIF.
*      ELSE.
*        IF it_gp_down-curr = l_waers. "CURRENCY SAME
*          IF l_PEINH <> 0.
*            i_mail-supplypo_up = l_NETPR / l_PEINH.
*          ENDIF.
*          " it_gp_down-totalgp = ( netpr -  actcost ) * Unbilling Qty.  "JANE
*          i_mail-totalgp2 = ( it_gp_down-netpr -  i_mail-supplypo_up ) * i_mail-kbmeng. "act costtotalgp
*          IF it_gp_down-opamt <> 0.
*            i_mail-gp_perc =  ( i_mail-totalgp2 * 100 ) / it_gp_down-opamt.
*            " concatenate i_mail-gp_perc '%' into i_mail-gp_perc.
*          ELSE.
*            i_mail-gp_perc = 0.
*          ENDIF.
*        ELSE.  "CURRENCY different,
*          IF l_PEINH <> 0.
*            i_mail-supplypo_up = l_NETPR / l_PEINH.
*          ENDIF.
*          ",POit_gp_down
*          CLEAR:l_ukurs2.
*
*          SELECT SINGLE ukurs INTO l_ukurs2 FROM tcurr
*            WHERE kurst = 'M' AND fcurr = l_waers  AND tcurr = it_gp_down-curr AND  gdatu = exrate_gdatu.
*          i_mail-supplypo_up = i_mail-supplypo_up *  l_ukurs2.
*
*
*          "it_gp_down
*          i_mail-totalgp2 = ( it_gp_down-netpr -  i_mail-supplypo_up ) * i_mail-kbmeng. "act costtotalgp
*
*          IF it_gp_down-opamt <> 0.
*            i_mail-gp_perc =  ( i_mail-totalgp2 * 100 ) / it_gp_down-opamt.
*            " concatenate i_mail-gp_perc '%' into i_mail-gp_perc.
*          ELSE.
*            i_mail-gp_perc = 0.
*          ENDIF.
*          "i_mail-totalgp_CNY,l_ukurs
*          IF it_gp_down-curr = 'CNY'.
*            i_mail-totalgp_cny = i_mail-totalgp2.
*          ELSE.
*            i_mail-totalgp_cny = i_mail-totalgp2 * l_ukurs.
*          ENDIF.
*        ENDIF.
*      ENDIF.
*      i_mail-supplypo   = L_ebeln.
*      i_mail-supplyitem = L_ebelp.
      ENDIF.
    ELSE.

      " 2.GP%----GP%=GP/
      IF ( it_gp_down-opamt - 0 ) <> 0.
        i_mail-gp_perc =  ( it_gp_down-totalgp * 100 ) / it_gp_down-opamt.
        " concatenate i_mail-gp_perc '%' into i_mail-gp_perc.
      ELSE.
        i_mail-gp_perc = 0.
      ENDIF.

    ENDIF.
    "ENDMD04SHIPPING NOTICE

    " 4.total GP>500GP%>5%(GP%>5%),GP<-500
    " clear l_gp_perc.
    " l_gp_perc = i_mail-gp_perc.  "
    IF ( ( i_mail-totalgp_cny - 0 ) > 500 AND ( i_mail-gp_perc - 0 ) > 6 ) OR ( ( i_mail-totalgp_cny - 0 ) < -500 AND ( i_mail-gp_perc - 0 ) < -6  )  ." 20250418 for daniel17,5->6 20250428
    ELSE.
      CLEAR: i_mail,l_netpr,l_peinh,l_waers,l_ebeln,l_ebelp,l_ukurs2,l_ukurs,l_ebeln2,l_ebelp2.
      CONTINUE.
    ENDIF.

    CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
      CHANGING
        value = i_mail-totalgp_cny.
    CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
      CHANGING
        value = i_mail-gp_perc.

    CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
      CHANGING
        value = i_mail-supplypo_up.

    CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
      CHANGING
        value = i_mail-totalgp2.
    IF i_mail-werks(3) = 'CEH'.
      g_ceh = 'X'.
    ENDIF.
    IF i_mail-matnr CS 'E-'.
      CONCATENATE '/' i_mail-matnr INTO i_mail-matnr.
    ENDIF.
    APPEND i_mail.
    CLEAR: i_mail,l_netpr,l_peinh,l_waers,l_ebeln,l_ebelp,l_ukurs2,l_ukurs.
  ENDLOOP.

  IF g_ceh = 'X'.  "CERMATE PM Fendi
    " lt_mailrecipients-receiver = 'Fendi.Fan@advantech.com.cn'.
    lt_mailrecipients-receiver = 'Daisy.Cai@advantech.com.cn'.
    lt_mailrecipients-rec_type = 'U'.
    lt_mailrecipients-com_type = 'INT'.
    lt_mailrecipients-notif_del = 'X'.
    lt_mailrecipients-notif_ndel = 'X'.
    APPEND lt_mailrecipients.
    CLEAR lt_mailrecipients.
  ENDIF.


  CLASS cl_abap_char_utilities DEFINITION LOAD.
  CLEAR lt_attachment.
  REFRESH lt_attachment.

  DATA: i_record  LIKE solisti1 OCCURS 0 WITH HEADER LINE.
  DATA filelen TYPE i.
  DATA: tmpstr TYPE string .
  CLEAR: tmpstr.
  PERFORM itabtostr TABLES i_mail USING tmpstr.
  PERFORM strtorecord TABLES i_record USING tmpstr filelen.
  APPEND LINES OF i_record TO lt_attachment.


  CLEAR lt_packing_list.
  REFRESH lt_packing_list.
  lt_packing_list-transf_bin  = space.
  lt_packing_list-head_start  = 1.
  lt_packing_list-head_num    = 0.
  lt_packing_list-body_start  = 1.
  lt_packing_list-body_num    = lines( lt_mailtxt ).
  lt_packing_list-doc_type    = 'RAW'.
  APPEND lt_packing_list.
  CLEAR lt_packing_list.
  lt_packing_list-transf_bin  = 'X'.
  lt_packing_list-head_start  = 1.
  lt_packing_list-head_num    = 1.
  lt_packing_list-body_start  = 1.
  lt_packing_list-body_num    = lines( lt_attachment ).
  lt_packing_list-doc_type    = 'XLS'.
  lt_packing_list-obj_name    = l_object.
  lt_packing_list-obj_descr   = l_object.
  lt_packing_list-doc_size    = lt_packing_list-body_num * 255.
  APPEND lt_packing_list.
  CLEAR lt_packing_list.
  lt_mailsubject-obj_name     = 'GPZRSD28B(TW)'.
  lt_mailsubject-obj_langu    = sy-langu.
  lt_mailsubject-obj_descr    = 'GPZRSD28B(TW)'.
  lt_mailsubject-sensitivty   = 'F'.
  gv_cnt = lines( lt_attachment ).
  lt_mailsubject-doc_size     = ( gv_cnt - 1 ) * 255 + strlen(
   lt_attachment ).
  CALL FUNCTION 'SO_NEW_DOCUMENT_ATT_SEND_API1'
    EXPORTING
      document_data              = lt_mailsubject
      put_in_outbox              = 'X'
      commit_work                = 'X'
    TABLES
      packing_list               = lt_packing_list
      contents_bin               = lt_attachment
      contents_txt               = lt_mailtxt
      receivers                  = lt_mailrecipients
    EXCEPTIONS
      too_many_receivers         = 1
      document_not_sent          = 2
      document_type_not_exist    = 3
      operation_no_authorization = 4
      parameter_error            = 5
      x_error                    = 6
      enqueue_error              = 7
      OTHERS                     = 8.
ENDFORM.                    "send_mail FOR TWM*



***************************
*insert add-on table "20241101 ADD BY DOUBLE
***************************
FORM process-addontable-data-cn10.
  DATA: l_str_menge1(16) TYPE c.
  DATA: l_str_menge2(16) TYPE c.
  DATA: l_pwerk LIKE afpo-pwerk.
  DATA: l_werks LIKE marc-werks.
  DATA: l_posnr LIKE ekpo-ebelp.
  DATA: i_zgetcost TYPE  zgetcost2.
  DATA: l_string(6) TYPE c.
  DATA: BEGIN OF itab_plant OCCURS 0 ,

          werks LIKE marc-werks,
        END OF itab_plant.

  REFRESH: output_itab2_addon_cnh.

  LOOP AT a1.
    IF a1-vbeln IS INITIAL.
      CONTINUE.
    ENDIF.
    MOVE-CORRESPONDING a1 TO output_itab2_addon_cnh.



    "output_itab2_ADDON_CNH-erdat = sy-datum.  "create date for data
    output_itab2_addon_cnh-create_date = sy-datum.   "create owner for data
    output_itab2_addon_cnh-create_by = sy-uname.   "create owner for data
    output_itab2_addon_cnh-create_time = sy-uzeit.   "create TIME for data

    APPEND output_itab2_addon_cnh.
    CLEAR  output_itab2_addon_cnh.

  ENDLOOP.



  IF output_itab2_addon_cnh[] IS NOT INITIAL.

    DELETE FROM ztsd_zrsd28b_cnh.
    MODIFY ztsd_zrsd28b_cnh FROM TABLE output_itab2_addon_cnh.

    IF sy-subrc <> 0.
      MESSAGE w000(zmm) WITH 'INSERT ADD-ON TABLE ztsd_zrsd28b_CNH FAILED!'.
    ELSE.
      MESSAGE  'INSERT ADD-ON TABLE ztsd_zrsd28b_CNH Success!'  TYPE 'I'.
    ENDIF.

  ENDIF.

ENDFORM.                    "PREPARE-DATA


"for CKB8 RAW MATERIAL STO ATP 20251014

*&---------------------------------------------------------------------*
*&      Form  download3_file
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM download_file_ckbx_raw.

  DATA l_monat LIKE bkpf-monat.
  DATA l_year  LIKE bkpf-gjahr.
  DATA: l_normt LIKE mara-normt.
  DATA: l_mtart LIKE mara-mtart.

* Download detial
  DATA mtext TYPE string.
  DATA : BEGIN OF i_soli OCCURS 0,
           line(5000) TYPE c,
         END OF i_soli.
  FIELD-SYMBOLS : <fs>.
  DATA : wi_file LIKE i_soli OCCURS 0 WITH HEADER LINE.
  DATA : w_tmp(80) TYPE c.
  DATA : con_tab TYPE c VALUE cl_abap_char_utilities=>horizontal_tab.

* 


  LOOP AT output_itab2_addon.
    DO.
      ASSIGN COMPONENT sy-index OF STRUCTURE output_itab2_addon TO <fs>.
      IF sy-subrc NE 0.
        EXIT.
      ENDIF.
      IF sy-index = 1.
        CONDENSE <fs>.
        wi_file = <fs>.
      ELSE.
        MOVE <fs> TO w_tmp.
        CONDENSE w_tmp.
        CONCATENATE wi_file con_tab w_tmp INTO wi_file.
      ENDIF.

    ENDDO.
    APPEND wi_file. CLEAR wi_file.
  ENDLOOP.

  OPEN DATASET p_file2 FOR OUTPUT IN TEXT MODE ENCODING DEFAULT.
  IF sy-subrc <> 0.
    MESSAGE e398 WITH mtext.
  ENDIF.
  LOOP AT wi_file.
    TRANSFER wi_file TO p_file2.
  ENDLOOP.
  CLOSE DATASET p_file2.


ENDFORM.                    " DOWNLOAD
